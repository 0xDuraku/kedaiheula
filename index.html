<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Kedai Heula - Aplikasi manajemen bisnis kuliner lengkap: hitung HPP, kelola menu, analisa penjualan, dan strategi promo">
<title>Kedai Heula ‚Äì Jajanan Mantap Pisani</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root {
    --red: #E03027;
    --orange: #F47C20;
    --yellow: #F5C518;
    --dark: #1A1A1A;
    --bg: #FFF4E6;
    --card: #FFFAF5;
    --muted: #888;
    --border: #FFE4CC;
    --green: #27AE60;
    --light-red: #FFF0EF;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    color: var(--dark);
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: linear-gradient(135deg, var(--red) 0%, var(--orange) 60%, var(--yellow) 100%);
    padding: 24px 32px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 4px 20px rgba(224,48,39,0.3);
  }

  header .logo-text {
    font-family: 'Fredoka One', cursive;
    font-size: 28px;
    color: white;
    text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
    line-height: 1;
  }

  header .logo-sub {
    font-size: 12px;
    color: rgba(255,255,255,0.85);
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 2px;
  }

  header .badge {
    margin-left: auto;
    background: rgba(255,255,255,0.2);
    color: white;
    font-size: 11px;
    font-weight: 800;
    padding: 6px 14px;
    border-radius: 20px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.3);
  }

  /* TABS */
  .tabs-wrapper {
    background: var(--card);
    padding: 20px 16px 16px;
    border-bottom: 1px solid var(--border);
  }
  .tab-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 12px;
    max-width: 640px;
    margin: 0 auto;
  }
  
  /* Mobile portrait - responsive */
  @media (max-width: 480px) {
    .tab-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
  }

  .tab-icon {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: 16px;
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Nunito', sans-serif;
  }
  .tab-icon:hover {
    border-color: var(--orange);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  .tab-icon.active {
    background: linear-gradient(135deg, #FFF8F0, #FFE4CC);
    border-color: var(--orange);
    box-shadow: 0 2px 8px rgba(244,124,32,0.2);
  }
  .ti-icon {
    font-size: 32px;
    line-height: 1;
  }
  .ti-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--dark);
    text-align: center;
    line-height: 1.3;
  }

  /* MAIN */
  .main { padding: 24px; max-width: 960px; margin: 0 auto; }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* SECTION TITLE */
  .section-title {
    font-family: 'Fredoka One', cursive;
    font-size: 22px;
    color: var(--red);
    margin-bottom: 6px;
  }

  .section-sub {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 20px;
    font-weight: 600;
  }

  /* CARD */
  .card {
    background: var(--card);
    border-radius: 16px;
    border: 2px solid var(--border);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.04);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .card-title {
    font-size: 14px;
    font-weight: 900;
    color: var(--dark);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* FORM ELEMENTS */
  label {
    display: block;
    font-size: 12px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }

  input[type="text"], input[type="number"], select {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid var(--border);
    border-radius: 10px;
    font-family: 'Nunito', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--dark);
    background: var(--bg);
    transition: border-color 0.2s;
    outline: none;
  }

  input:focus, select:focus {
    border-color: var(--orange);
    background: var(--card);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
  }

  .form-row.three { grid-template-columns: 2fr 1fr 1fr; }
  .form-row.four { grid-template-columns: 2fr 1fr 1fr 40px; align-items: end; }

  .form-group { margin-bottom: 12px; }

  /* BUTTONS */
  .btn {
    padding: 10px 20px;
    border-radius: 10px;
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 13px;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--red), var(--orange));
    color: white;
    box-shadow: 0 3px 12px rgba(224,48,39,0.3);
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 5px 16px rgba(224,48,39,0.4);
  }

  .btn-secondary {
    background: var(--bg);
    color: var(--dark);
    border: 2px solid var(--border);
  }

  .btn-secondary:hover { border-color: var(--orange); color: var(--orange); }

  .btn-danger {
    background: var(--light-red);
    color: var(--red);
    border: 2px solid #FFCCCB;
    padding: 8px 10px;
    font-size: 15px;
  }

  .btn-danger:hover { background: #FFE0DF; }

  .btn-add {
    background: var(--card);
    color: var(--orange);
    border: 2px dashed var(--orange);
    width: 100%;
    justify-content: center;
    padding: 10px;
    margin-top: 8px;
  }

  .btn-add:hover { background: #FFF5EC; }

  /* BAHAN ITEM */
  .bahan-row {
    display: grid;
    grid-template-columns: 2.5fr 1fr 1fr 1fr 36px;
    gap: 8px;
    align-items: end;
    margin-bottom: 8px;
    animation: fadeIn 0.2s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .bahan-header {
    display: grid;
    grid-template-columns: 2.5fr 1fr 1fr 1fr 36px;
    gap: 8px;
    margin-bottom: 6px;
  }

  .bahan-header span {
    font-size: 10px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0 4px;
  }

  /* BIAYA ITEM */
  .biaya-row {
    display: grid;
    grid-template-columns: 2fr 1fr 36px;
    gap: 8px;
    align-items: end;
    margin-bottom: 8px;
  }

  /* RESULT BOX */
  .result-box {
    background: linear-gradient(135deg, var(--red) 0%, var(--orange) 100%);
    border-radius: 16px;
    padding: 24px;
    color: white;
    margin-bottom: 20px;
  }

  .result-box h3 {
    font-family: 'Fredoka One', cursive;
    font-size: 18px;
    margin-bottom: 16px;
    opacity: 0.9;
  }

  .result-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .result-item {
    background: rgba(255,255,255,0.15);
    border-radius: 12px;
    padding: 14px;
    text-align: center;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.2);
  }

  .result-item .label {
    font-size: 10px;
    font-weight: 800;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    display: block;
    color: white;
  }

  .result-item .value {
    font-family: 'Fredoka One', cursive;
    font-size: 22px;
    line-height: 1;
  }

  .result-item .sub {
    font-size: 10px;
    opacity: 0.7;
    margin-top: 4px;
  }

  /* BREAKDOWN TABLE */
  .breakdown-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .breakdown-table th {
    text-align: left;
    padding: 10px 12px;
    font-size: 11px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border);
  }

  .breakdown-table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
  }

  .breakdown-table tr:last-child td { border-bottom: none; }

  .breakdown-table tr:hover td { background: var(--bg); }

  .text-right { text-align: right; }

  .total-row td {
    font-weight: 900 !important;
    color: var(--red);
    border-top: 2px solid var(--border) !important;
    border-bottom: none !important;
  }

  /* PRICE SUGGESTION */
  .price-suggestion {
    background: #F0FDF4;
    border: 2px solid #86EFAC;
    border-radius: 14px;
    padding: 16px;
    margin-top: 12px;
  }

  .price-suggestion h4 {
    font-size: 13px;
    font-weight: 900;
    color: var(--green);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .price-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }

  .price-option {
    background: var(--card);
    border-radius: 10px;
    padding: 12px;
    text-align: center;
    border: 2px solid #D1FAE5;
    cursor: pointer;
    transition: all 0.2s;
  }

  .price-option:hover {
    border-color: var(--green);
    transform: translateY(-1px);
  }

  .price-option .po-label {
    font-size: 10px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .price-option .po-value {
    font-family: 'Fredoka One', cursive;
    font-size: 18px;
    color: var(--green);
  }

  .price-option .po-margin {
    font-size: 10px;
    color: var(--muted);
    margin-top: 2px;
    font-weight: 700;
  }

  /* SUMMARY TAB */
  .menu-card {
    background: var(--card);
    border-radius: 14px;
    border: 2px solid var(--border);
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    transition: all 0.2s;
    cursor: pointer;
  }

  .menu-card:hover {
    border-color: var(--orange);
    box-shadow: 0 4px 12px rgba(244,124,32,0.1);
  }

  .menu-card .mc-left .mc-name {
    font-weight: 900;
    font-size: 16px;
  }

  .menu-card .mc-left .mc-category {
    font-size: 11px;
    color: var(--muted);
    font-weight: 700;
    text-transform: uppercase;
    margin-top: 2px;
  }

  .menu-card .mc-right {
    text-align: right;
  }

  .menu-card .mc-hpp {
    font-size: 13px;
    color: var(--muted);
    font-weight: 700;
  }

  .menu-card .mc-price {
    font-family: 'Fredoka One', cursive;
    font-size: 22px;
    color: var(--red);
  }

  .menu-card .mc-margin {
    font-size: 11px;
    color: var(--green);
    font-weight: 800;
  }

  .tag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-right: 4px;
  }

  .tag-takoyaki { background: #FFF3CD; color: #856404; }
  .tag-dimsum { background: #FFE0D0; color: #B94A00; }
  .tag-ayam { background: #D4EDDA; color: #155724; }
  .tag-lainnya { background: #E0E0FF; color: #3030B0; }

  /* SETTING HPP */
  .info-box {
    background: #FFF8E1;
    border: 2px solid #FFD54F;
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 20px;
    font-size: 13px;
    font-weight: 600;
    color: #7B5800;
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }

  .info-box .info-icon { font-size: 18px; flex-shrink: 0; }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--muted);
  }

  .empty-state .es-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; font-weight: 700; }
  .empty-state small { font-size: 12px; display: block; margin-top: 4px; }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--dark);
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 700;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s;
    z-index: 100;
    pointer-events: none;
  }

  .toast.show { opacity: 1; transform: translateY(0); }

  /* RESPONSIVE */
  @media (max-width: 600px) {
    .main { padding: 16px; }
    .bahan-row { grid-template-columns: 1fr 1fr 36px; }
    .bahan-row .col-harga-satuan, .bahan-row .col-subtotal { display: none; }
    .bahan-header .col-harga-satuan, .bahan-header .col-subtotal { display: none; }
    .result-grid { grid-template-columns: 1fr 1fr; }
    .price-grid { grid-template-columns: 1fr; }
    .form-row.three { grid-template-columns: 1fr 1fr; }
    .form-row.four { grid-template-columns: 1fr 1fr 36px; }
  }

  /* Print / export note */
  .export-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  /* ===================== */
  /* PROMO TAB             */
  /* ===================== */
  .promo-type-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }

  .promo-type-btn {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: 14px;
    padding: 14px 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Nunito', sans-serif;
  }

  .promo-type-btn:hover { border-color: var(--orange); }

  .promo-type-btn.active {
    border-color: var(--red);
    background: var(--light-red);
  }

  .promo-type-btn .pt-icon { font-size: 26px; margin-bottom: 6px; }
  .promo-type-btn .pt-label { font-size: 12px; font-weight: 800; color: var(--dark); }
  .promo-type-btn .pt-desc { font-size: 10px; color: var(--muted); margin-top: 2px; font-weight: 600; }

  .promo-panel { display: none; }
  .promo-panel.active { display: block; }

  .promo-result-box {
    border-radius: 16px;
    padding: 20px;
    margin-top: 16px;
  }

  .promo-result-box.profit { background: linear-gradient(135deg, #27AE60, #2ECC71); color: white; }
  .promo-result-box.warning { background: linear-gradient(135deg, #F39C12, #F1C40F); color: white; }
  .promo-result-box.danger { background: linear-gradient(135deg, #E03027, #F47C20); color: white; }

  .promo-result-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 14px;
  }

  .promo-result-item {
    background: rgba(255,255,255,0.2);
    border-radius: 12px;
    padding: 12px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.3);
  }

  .promo-result-item .pri-label {
    font-size: 10px;
    font-weight: 800;
    opacity: 0.85;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
    display: block;
    color: white;
  }

  .promo-result-item .pri-value {
    font-family: 'Fredoka One', cursive;
    font-size: 20px;
    line-height: 1;
  }

  .promo-result-item .pri-sub {
    font-size: 10px;
    opacity: 0.75;
    margin-top: 3px;
  }

  .verdict-box {
    background: rgba(255,255,255,0.25);
    border-radius: 12px;
    padding: 14px;
    margin-top: 12px;
    font-size: 14px;
    font-weight: 700;
    border: 1px solid rgba(255,255,255,0.3);
    line-height: 1.6;
  }

  .verdict-box .verdict-title {
    font-family: 'Fredoka One', cursive;
    font-size: 16px;
    margin-bottom: 6px;
  }

  .slider-wrapper {
    margin: 12px 0;
  }

  .slider-wrapper input[type="range"] {
    width: 100%;
    accent-color: var(--red);
    height: 6px;
    border: none;
    background: none;
    padding: 0;
    cursor: pointer;
  }

  .slider-label {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    font-weight: 800;
    color: var(--muted);
    margin-top: 4px;
  }

  .slider-value {
    font-family: 'Fredoka One', cursive;
    font-size: 32px;
    color: var(--red);
    text-align: center;
    margin: 4px 0;
  }

  .beli-dapat-grid {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 10px;
    align-items: center;
    margin-bottom: 12px;
  }

  .beli-dapat-grid .separator {
    font-family: 'Fredoka One', cursive;
    font-size: 18px;
    color: var(--orange);
    text-align: center;
  }

  .bundle-item-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 60px 36px;
    gap: 8px;
    align-items: end;
    margin-bottom: 10px;
  }

  .bundle-item-header {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 60px 36px;
    gap: 8px;
    margin-bottom: 6px;
  }

  .bundle-item-header span {
    font-size: 10px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0 4px;
  }

  @media (max-width: 600px) {
    .promo-type-grid { grid-template-columns: 1fr 1fr; }
    .promo-result-grid { grid-template-columns: 1fr 1fr; }
    .bundle-item-row { grid-template-columns: 1fr 1fr 36px; }  }
  /* ===================== */
  /* MODAL                 */
  /* ===================== */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 200;
    align-items: center;
    justify-content: center;
    padding: 16px;
    backdrop-filter: blur(4px);
  }

  .modal-box {
    background: var(--card);
    border-radius: 20px;
    width: 100%;
    max-width: 680px;
    max-height: 88vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: modalIn 0.25s ease;
  }

  @keyframes modalIn {
    from { opacity:0; transform: scale(0.95) translateY(10px); }
    to { opacity:1; transform: scale(1) translateY(0); }
  }

  .modal-header {
    position: sticky;
    top: 0;
    background: var(--card);
    padding: 18px 20px 14px;
    border-bottom: 2px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 1;
    border-radius: 20px 20px 0 0;
  }

  .modal-header .modal-title {
    font-family: 'Fredoka One', cursive;
    font-size: 18px;
    color: var(--red);
  }

  .modal-close {
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 50%;
    width: 34px; height: 34px;
    font-size: 16px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    font-family: sans-serif;
  }

  .modal-close:hover { background: var(--light-red); border-color: var(--red); }

  .modal-body { padding: 20px; }

  .modal-footer {
    position: sticky;
    bottom: 0;
    background: var(--card);
    padding: 14px 20px;
    border-top: 2px solid var(--border);
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    border-radius: 0 0 20px 20px;
  }

  .edit-hpp-preview {
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 13px;
    font-weight: 700;
    color: var(--dark);
    margin-top: 8px;
  }

  /* ===================== */
  /* PRINT                 */
  /* ===================== */
  #print-area { display: none; }

  @media print {
    header, .tabs-wrapper, .main, .modal-overlay, .toast, #print-area ~ * { display: none !important; }
    #print-area {
      display: block !important;
      font-family: Arial, sans-serif;
      color: #1A1A1A;
      font-size: 13px;
      padding: 0;
    }
    @page { margin: 15mm; size: A4; }

    #print-area .doc-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: 14px;
      border-bottom: 3px solid #E03027;
      margin-bottom: 20px;
    }
    #print-area .brand { font-size: 20px; font-weight: 900; color: #E03027; }
    #print-area .brand-sub { font-size: 10px; color: #888; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }
    #print-area .doc-meta { text-align: right; }
    #print-area .doc-meta .menu-name { font-size: 18px; font-weight: 900; }
    #print-area .doc-meta .meta-sub { font-size: 10px; color: #888; margin-top: 3px; }

    #print-area .summary-bar { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; margin-bottom: 20px; }
    #print-area .sum-box { background: #FFF8F0; border: 2px solid #F0E0CC; border-radius: 8px; padding: 10px; text-align: center; }
    #print-area .sum-label { font-size: 9px; font-weight: 700; color: #888; text-transform: uppercase; display: block; }
    #print-area .sum-value { font-size: 15px; font-weight: 900; color: #E03027; display: block; margin-top: 3px; }
    #print-area .sum-sub { font-size: 9px; color: #888; display: block; margin-top: 1px; }

    #print-area h3 { font-size: 13px; font-weight: 900; color: #E03027; margin: 18px 0 8px; padding-bottom: 5px; border-bottom: 2px solid #F0E0CC; }
    #print-area h3:first-of-type { margin-top: 0; }
    #print-area table { width: 100%; border-collapse: collapse; margin-bottom: 4px; }
    #print-area thead tr { background: #F47C20 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #print-area thead th { padding: 7px 9px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    #print-area tbody tr:nth-child(even) { background: #FFF8F0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #print-area tbody td { padding: 7px 9px; border-bottom: 1px solid #F0E0CC; }
    #print-area .pr-num { text-align: right; }
    #print-area .total-row td { background: #FFF3E0 !important; font-weight: 700; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

    #print-area .harga-section { margin-top: 20px; }
    #print-area .harga-title { font-size: 13px; font-weight: 900; color: #E03027; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid #F0E0CC; }
    #print-area .harga-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; }
    #print-area .harga-box { border-radius: 8px; padding: 10px; text-align: center; border: 2px solid; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #print-area .harga-box.ekonomis { background: #FFF9E6 !important; border-color: #F5C518; }
    #print-area .harga-box.standar  { background: #E8F5E9 !important; border-color: #27AE60; }
    #print-area .harga-box.premium  { background: #FFF0EF !important; border-color: #E03027; }
    #print-area .hb-label { font-size: 9px; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 4px; }
    #print-area .ekonomis .hb-label { color: #B8860B; }
    #print-area .standar  .hb-label { color: #1B5E20; }
    #print-area .premium  .hb-label { color: #E03027; }
    #print-area .hb-value { font-size: 17px; font-weight: 900; display: block; margin-bottom: 2px; }
    #print-area .hb-margin { font-size: 10px; color: #888; display: block; }

    /* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #login-screen {
    position: fixed; inset: 0; z-index: 99999;
    background: linear-gradient(135deg, #E03027 0%, #F47C20 60%, #FFC107 100%);
    display: flex; align-items: flex-start; justify-content: center; 
    padding: 20px; overflow-y: auto;
    min-height: 100vh; width: 100vw;
  }
  #login-screen.hidden { display: none !important; }
  /* === FLOATING FOOD PARTICLES === */
  .login-particle {
    position: absolute; font-size: 28px; opacity: 0.12;
    animation: floatUp 8s ease-in-out infinite;
    pointer-events: none; user-select: none;
  }
  @keyframes floatUp {
    0%   { transform: translateY(0) rotate(0deg); opacity: 0.12; }
    50%  { opacity: 0.2; }
    100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
  }
  /* === LOGIN BOX === */
  .login-box {
    position: relative; z-index: 1;
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 28px; padding: 40px 32px;
    width: 100%; max-width: 400px;
    box-shadow: 0 32px 80px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.2);
  }
  .login-logo { text-align: center; margin-bottom: 32px; }
  .login-logo-icon {
    width: 80px; height: 80px; border-radius: 24px; margin: 0 auto 16px;
    background: linear-gradient(135deg, #E03027, #F47C20);
    display: flex; align-items: center; justify-content: center;
    font-size: 40px; box-shadow: 0 8px 24px rgba(224,48,39,0.5);
  }
  .login-logo h1 {
    font-family: 'Fredoka One', cursive; font-size: 30px; color: white;
    text-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  .login-logo p { font-size: 13px; color: rgba(255,255,255,0.65); margin-top: 6px; font-weight: 600; }
  
  .login-divider {
    height: 1px; background: rgba(255,255,255,0.15); margin: 24px 0;
  }
  .login-field { margin-bottom: 16px; }
  .login-field label {
    display: block; font-size: 11px; font-weight: 800; margin-bottom: 8px;
    color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px;
  }
  .login-field-wrap {
    position: relative; display: flex; align-items: center;
  }
  .login-field-icon {
    position: absolute; left: 14px; font-size: 16px; pointer-events: none;
  }
  .login-field input {
    width: 100%; padding: 13px 14px 13px 42px; border-radius: 14px;
    border: 1.5px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: white; font-size: 15px; font-family: 'Nunito', sans-serif; font-weight: 600;
    outline: none; transition: all 0.2s;
    backdrop-filter: blur(4px);
  }
  .login-field input::placeholder { color: rgba(255,255,255,0.4); }
  .login-field input:focus {
    border-color: rgba(255,255,255,0.6);
    background: rgba(255,255,255,0.15);
    box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
  }
  .login-btn {
    width: 100%; padding: 15px; border-radius: 14px; border: none;
    background: linear-gradient(135deg, #E03027 0%, #F47C20 100%);
    color: white; font-size: 16px; font-weight: 800; font-family: 'Nunito', sans-serif;
    cursor: pointer; margin-top: 8px;
    box-shadow: 0 6px 20px rgba(224,48,39,0.5);
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .login-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(224,48,39,0.6); }
  .login-btn:active { transform: translateY(1px); box-shadow: 0 3px 12px rgba(224,48,39,0.4); }
  .login-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .login-error {
    background: rgba(224,48,39,0.2); border: 1.5px solid rgba(224,48,39,0.6); border-radius: 12px;
    padding: 10px 14px; font-size: 13px; color: #FFB3B0; font-weight: 700;
    margin-top: 12px; display: none; text-align: center;
  }
  /* User badge di header */
  #user-badge {
    display: flex; align-items: center; gap: 8px;
    background: rgba(255,255,255,0.2); border-radius: 20px; padding: 6px 14px;
    cursor: pointer; transition: background 0.2s;
  }
  #user-badge:hover { background: rgba(255,255,255,0.3); }
  #user-badge .ub-name { color: white; font-size: 13px; font-weight: 800; }
  #user-badge .ub-role { color: rgba(255,255,255,0.8); font-size: 11px; }
  /* Tab kasir-only mode */
  .tab-admin-only { display: none; }
  body.role-admin .tab-admin-only { display: flex; }
  /* Modal kelola akun */
  .akun-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 14px; border-radius: 12px; background: var(--bg);
    border: 2px solid var(--border); margin-bottom: 8px;
  }
  .akun-row .ar-info { flex: 1; }
  .akun-row .ar-id { font-weight: 800; font-size: 14px; }
  .akun-row .ar-role { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .role-badge {
    padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 800;
  }
  .role-badge.admin { background: #FFF0EF; color: var(--red); }
  .role-badge.kasir { background: #E8F5E9; color: var(--green); }

</style>
</head>
<body>

<!-- ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="login-screen">
  <!-- Floating food particles -->
  <span class="login-particle" style="left:8%;top:90%;animation-delay:0s;animation-duration:9s;">üç±</span>
  <span class="login-particle" style="left:20%;top:85%;animation-delay:1.5s;animation-duration:11s;font-size:22px;">üêô</span>
  <span class="login-particle" style="left:35%;top:92%;animation-delay:3s;animation-duration:8s;font-size:20px;">ü•ü</span>
  <span class="login-particle" style="left:55%;top:88%;animation-delay:0.8s;animation-duration:13s;">üçó</span>
  <span class="login-particle" style="left:70%;top:93%;animation-delay:2.2s;animation-duration:10s;font-size:20px;">üßÜ</span>
  <span class="login-particle" style="left:85%;top:87%;animation-delay:4s;animation-duration:9s;font-size:22px;">üç¢</span>
  <span class="login-particle" style="left:92%;top:91%;animation-delay:1s;animation-duration:12s;font-size:18px;">‚≠ê</span>

  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-icon">üç±</div>
      <h1>Kedai Heula</h1>
      <p>Manajemen Bisnis Kuliner</p>
    </div>

    <div class="login-divider"></div>

    <div class="login-field">
      <label>ID Pengguna</label>
      <div class="login-field-wrap">
        <span class="login-field-icon">üë§</span>
        <input type="text" id="login-id" placeholder="Masukkan ID kamu..."
          autocomplete="username"
          onkeydown="if(event.key==='Enter')document.getElementById('login-pass').focus()" />
      </div>
    </div>
    <div class="login-field">
      <label>Password</label>
      <div class="login-field-wrap">
        <span class="login-field-icon">üîí</span>
        <input type="password" id="login-pass" placeholder="Masukkan password..."
          autocomplete="current-password"
          onkeydown="if(event.key==='Enter')doLoginClick()" />
      </div>
    </div>

    <button class="login-btn" id="login-btn" onclick="doLoginClick()">
      üîì &nbsp;Masuk
    </button>
    <div class="login-error" id="login-error"></div>
  </div>
</div>

<div id="app-wrapper" style="display:none;">
<header>
  <div style="display:flex;align-items:center;gap:12px;">
    <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--red),var(--orange));display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 2px 8px rgba(224,48,39,0.3);">üç±</div>
    <div>
      <div class="logo-text">Kedai Heula</div>
      <div class="logo-sub">Manajemen Bisnis Kuliner ‚Äì Jajanan Mantap Pisan!</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <div id="user-badge" onclick="bukaMenuUser()">
      <div>
        <div class="ub-name" id="ub-name">‚Äî</div>
        <div class="ub-role" id="ub-role">‚Äî</div>
      </div>
      <span style="color:white;font-size:18px;">‚ñæ</span>
    </div>
  </div>
</header>

<div class="tabs-wrapper">
  <div class="tab-grid">
    <button class="tab-icon tab-admin-only" onclick="switchTab('hitung')">
      <div class="ti-icon">üßÆ</div>
      <div class="ti-label">Hitung HPP</div>
    </button>
    <button class="tab-icon tab-admin-only" onclick="switchTab('ringkasan')">
      <div class="ti-icon">üìã</div>
      <div class="ti-label">Ringkasan Menu</div>
    </button>
    <button class="tab-icon tab-admin-only" onclick="switchTab('laporan')">
      <div class="ti-icon">üìä</div>
      <div class="ti-label">Laporan</div>
    </button>
    <button class="tab-icon tab-admin-only" onclick="switchTab('promo')">
      <div class="ti-icon">üè∑Ô∏è</div>
      <div class="ti-label">Promo</div>
    </button>
    <button class="tab-icon" id="tab-btn-pos" onclick="switchTab('pos')">
      <div class="ti-icon">üí∞</div>
      <div class="ti-label">Kasir (POS)</div>
    </button>
    <button class="tab-icon tab-admin-only" onclick="switchTab('panduan')">
      <div class="ti-icon">üìñ</div>
      <div class="ti-label">Panduan</div>
    </button>
    <button class="tab-icon tab-admin-only" onclick="switchTab('akun')">
      <div class="ti-icon">üë•</div>
      <div class="ti-label">Kelola Akun</div>
    </button>
  </div>
</div>

<div class="main">

  <!-- TAB HITUNG HPP -->
  <div id="tab-hitung" class="tab-content active">

    <div class="info-box">
      <span class="info-icon">üí°</span>
      <div>
        <strong>Cara pakai:</strong> Isi info produk ‚Üí tambah bahan-bahan ‚Üí tambah biaya operasional ‚Üí klik <strong>Hitung HPP</strong>. Hasilnya langsung tersimpan dan bisa diakses di tab <strong>Ringkasan Menu</strong>, <strong>Laporan Penjualan</strong>, dan <strong>Kalkulator Promo</strong>!
      </div>
    </div>

    <!-- INFO PRODUK -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">üì¶ Info Produk</div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Nama Menu</label>
          <input type="text" id="nama-menu" placeholder="cth: Takoyaki Original" />
        </div>
        <div class="form-group">
          <label>Kategori</label>
          <select id="kategori-menu">
            <option value="takoyaki">üêô Takoyaki</option>
            <option value="dimsum">ü•ü Dimsum</option>
            <option value="ayam">üçó Ayam Crispy</option>
            <option value="lainnya">üç± Lainnya</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Foto Menu (Opsional)</label>
        <input type="file" id="foto-menu" accept="image/*" onchange="previewFoto(this, 'preview-foto')" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        <div id="preview-foto" style="margin-top:8px;"></div>
      </div>
      <div class="form-row three">
        <div class="form-group">
          <label>Porsi / Batch (pcs)</label>
          <input type="number" id="porsi" value="6" min="1" placeholder="6" />
        </div>
        <div class="form-group">
          <label>Sat. Porsi</label>
          <select id="satuan-porsi">
            <option>pcs</option>
            <option>porsi</option>
            <option>box</option>
            <option>pack</option>
          </select>
        </div>
        <div class="form-group">
          <label>Kemasan (Rp)</label>
          <input type="number" id="biaya-kemasan" value="500" min="0" placeholder="500" />
        </div>
      </div>
    </div>

    <!-- BAHAN BAKU -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">üßÖ Bahan Baku</div>
      </div>

      <div class="bahan-header">
        <span>Nama Bahan</span>
        <span>Qty Dipakai</span>
        <span class="col-harga-satuan">Harga Beli (Rp)</span>
        <span class="col-harga-satuan">Ukuran Beli</span>
        <span class="col-subtotal"></span>
      </div>

      <div id="bahan-list"></div>

      <button class="btn btn-add" onclick="tambahBahan()">
        Ôºã Tambah Bahan
      </button>
    </div>

    <!-- BIAYA OPERASIONAL -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">‚öôÔ∏è Biaya Operasional per Batch</div>
      </div>

      <div id="biaya-list"></div>

      <button class="btn btn-add" onclick="tambahBiaya()">
        Ôºã Tambah Biaya (gas, listrik, dll)
      </button>
    </div>

    <!-- TOMBOL HITUNG -->
    <div style="display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="hitungHPP()">
        üßÆ Hitung HPP Sekarang
      </button>
      <button class="btn btn-secondary" onclick="resetForm()">
        üîÑ Reset Form
      </button>
    </div>

    <!-- HASIL -->
    <div id="hasil-section" style="display:none;">

      <div class="result-box">
        <h3>üìä Hasil Kalkulasi HPP</h3>
        <div class="result-grid">
          <div class="result-item">
            <span class="label">Total Biaya Batch</span>
            <div class="value" id="res-total-batch">Rp 0</div>
            <div class="sub" id="res-batch-info">untuk 6 pcs</div>
          </div>
          <div class="result-item">
            <span class="label">HPP per Pcs</span>
            <div class="value" id="res-hpp">Rp 0</div>
            <div class="sub">harga pokok produksi</div>
          </div>
          <div class="result-item">
            <span class="label">Min. BEP Harga Jual</span>
            <div class="value" id="res-bep">Rp 0</div>
            <div class="sub">HPP + platform fee 30%</div>
          </div>
        </div>
      </div>

      <!-- BREAKDOWN -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üîç Detail Breakdown Biaya</div>
        </div>
        <table class="breakdown-table">
          <thead>
            <tr>
              <th>Komponen</th>
              <th>Keterangan</th>
              <th class="text-right">Biaya (Rp)</th>
              <th class="text-right">%</th>
            </tr>
          </thead>
          <tbody id="breakdown-body"></tbody>
        </table>
      </div>

      <!-- SARAN HARGA JUAL -->
      <div class="price-suggestion">
        <h4>üí° Rekomendasi Harga Jual</h4>

        <!-- Step 1: Pilih Kategori -->
        <div style="margin-bottom:14px;">
          <div style="font-size:11px;font-weight:800;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Pilih Kategori Harga:</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
            <div id="btn-kategori-30" onclick="pilihKategoriHarga(30)" style="background:#FFF9E6;border:2px solid #F5C518;border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:20px;margin-bottom:4px;">üü°</div>
              <div style="font-size:12px;font-weight:800;color:#B8860B;">EKONOMIS</div>
              <div style="font-size:10px;color:#999;margin-top:2px;">Margin 30%</div>
            </div>
            <div id="btn-kategori-50" onclick="pilihKategoriHarga(50)" style="background:#E8F5E9;border:2px solid #27AE60;border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(39,174,96,0.2);">
              <div style="font-size:20px;margin-bottom:4px;">üü¢</div>
              <div style="font-size:12px;font-weight:800;color:#1B5E20;">STANDAR ‚≠ê</div>
              <div style="font-size:10px;color:#999;margin-top:2px;">Margin 50%</div>
            </div>
            <div id="btn-kategori-70" onclick="pilihKategoriHarga(70)" style="background:#FFF0EF;border:2px solid #E03027;border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:20px;margin-bottom:4px;">üî•</div>
              <div style="font-size:12px;font-weight:800;color:#E03027;">PREMIUM</div>
              <div style="font-size:10px;color:#999;margin-top:2px;">Margin 70%</div>
            </div>
          </div>
        </div>

        <!-- Step 2: Pilih Channel (muncul setelah pilih kategori) -->
        <div id="channel-selector" style="display:none;">
          <div style="font-size:11px;font-weight:800;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Pilih Channel Penjualan:</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
            <div id="btn-channel-offline" onclick="pilihChannelHarga('offline')" style="background:var(--card);border:2px solid var(--border);border-radius:12px;padding:14px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:22px;margin-bottom:4px;">üè™</div>
              <div style="font-size:13px;font-weight:800;">OFFLINE</div>
              <div style="font-size:10px;color:#999;margin-top:2px;">Tanpa platform fee</div>
            </div>
            <div id="btn-channel-online" onclick="pilihChannelHarga('online')" style="background:var(--card);border:2px solid var(--border);border-radius:12px;padding:14px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:22px;margin-bottom:4px;">üì±</div>
              <div style="font-size:13px;font-weight:800;">ONLINE</div>
              <div style="font-size:10px;color:#999;margin-top:2px;">GoFood / Shopee</div>
            </div>
          </div>

          <!-- Hasil Harga Terpilih -->
          <div id="harga-terpilih-display" style="display:none;background:linear-gradient(135deg,var(--green),#2ECC71);border-radius:14px;padding:16px;text-align:center;color:white;margin-bottom:8px;">
            <div style="font-size:11px;font-weight:800;opacity:0.85;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;" id="harga-terpilih-label">Harga Jual</div>
            <div style="font-family:'Fredoka One',cursive;font-size:36px;line-height:1;" id="harga-terpilih-nilai">Rp 0</div>
            <div style="font-size:11px;opacity:0.8;margin-top:4px;" id="harga-terpilih-info">profit per pcs</div>
          </div>

          <div style="font-size:11px;color:#666;margin-top:6px;">
            ‚ÑπÔ∏è <strong>Harga online 25% lebih tinggi</strong> untuk cover platform fee ~20%.
          </div>
        </div>

        <!-- Hidden inputs to track selection (used by hitungHPP) -->
        <input type="hidden" id="harga-30-offline" value="0" />
        <input type="hidden" id="harga-30-online" value="0" />
        <input type="hidden" id="harga-50-offline" value="0" />
        <input type="hidden" id="harga-50-online" value="0" />
        <input type="hidden" id="harga-70-offline" value="0" />
        <input type="hidden" id="harga-70-online" value="0" />
      </div>

      <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="simpanMenu()">
          üíæ Simpan ke Ringkasan Menu
        </button>
        <button class="btn btn-secondary" onclick="konfirmasiMenuBaru()">
          ‚ûï Input Menu Baru
        </button>
      </div>
    </div>
  </div>

  <!-- TAB RINGKASAN -->
  <div id="tab-ringkasan" class="tab-content">
    <div class="section-title">üìã Ringkasan Semua Menu</div>
    <div class="section-sub">Semua menu yang sudah dihitung HPP-nya ada di sini.</div>

    <!-- CLOUD SYNC BAR -->
    <div id="sync-bar" style="background:#FFFAF5;border:2px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <div style="flex:1;min-width:160px;">
        <div style="font-size:13px;font-weight:800;color:var(--dark);">‚òÅÔ∏è Cloud Backup (Google Sheets)</div>
        <div id="sync-status" style="font-size:11px;color:var(--muted);font-weight:700;margin-top:2px;">Menyinkronkan...</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <button class="btn btn-secondary" style="font-size:12px;padding:8px 14px;" onclick="bukaSyncConfig()">‚öôÔ∏è Setup URL</button>
        <button class="btn btn-secondary" style="font-size:12px;padding:8px 14px;" onclick="syncManual()">üîÑ Sync Sekarang</button>
        <button class="btn btn-secondary" style="font-size:12px;padding:8px 14px;background:#FFF0F0;color:var(--red);border-color:var(--red);" onclick="bersihkanDuplikat()">üßπ Bersihkan Duplikat</button>
      </div>
    </div>

    <div id="ringkasan-list">
      <div class="empty-state">
        <div class="es-icon">üç±</div>
        <p>Belum ada menu tersimpan</p>
        <small>Hitung HPP dulu di tab "Hitung HPP", lalu klik "Simpan ke Ringkasan Menu"</small>
      </div>
    </div>
  </div>

  <!-- MODAL SYNC CONFIG -->
  <div class="modal-overlay" id="modal-sync" onclick="if(event.target===this)tutupSyncConfig()">
    <div class="modal-box" style="max-width:520px;">
      <div class="modal-header">
        <div class="modal-title">‚öôÔ∏è Setup Cloud Backup</div>
        <button class="modal-close" onclick="tutupSyncConfig()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="info-box" style="background:#E3F2FD;border-left:4px solid #2196F3;padding:12px 14px;border-radius:10px;margin-bottom:16px;font-size:13px;">
          <span style="font-size:18px;">üí°</span>
          <div style="margin-left:10px;">Data kamu tersimpan ke <strong>Google Sheets</strong> milikmu sendiri via Apps Script. URL sudah tersimpan ‚Äî tinggal klik <strong>Simpan & Test</strong> untuk verifikasi koneksi.</div>
        </div>

        <div style="font-size:13px;font-weight:800;margin-bottom:10px;color:var(--dark);">Jika perlu ganti URL Apps Script:</div>
        <ol style="font-size:13px;color:#444;padding-left:18px;line-height:2;">
          <li>Buka <a href="https://script.google.com" target="_blank" style="color:var(--red);font-weight:700;">script.google.com</a> ‚Üí buka project Kedai Heula</li>
          <li>Klik <strong>Deploy ‚Üí Manage deployments</strong></li>
          <li>Copy URL deployment yang aktif, paste di bawah</li>
        </ol>

        <div class="form-group" style="margin-top:14px;">
          <label style="font-size:13px;font-weight:800;">URL Apps Script Web App</label>
          <input type="text" id="sheets-url-input"
            placeholder="https://script.google.com/macros/s/xxx/exec"
            style="width:100%;padding:10px 12px;border-radius:8px;border:2px solid var(--border);font-size:13px;margin-top:6px;outline:none;" />
        </div>

        <!-- Debug Log -->
        <div id="debug-log" style="display:none;margin-top:12px;padding:10px;background:#1E1E2E;color:#CDD6F4;border-radius:8px;font-family:monospace;font-size:11px;max-height:150px;overflow-y:auto;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="tutupSyncConfig()">Batal</button>
        <button class="btn btn-primary" onclick="simpanSyncConfig()">üíæ Simpan & Test</button>
      </div>
    </div>
  </div>

  <!-- TAB LAPORAN PENJUALAN -->
  <div id="tab-laporan" class="tab-content">
    <div class="section-title">üìä Laporan Penjualan</div>
    <div class="section-sub">Catat transaksi harian dan lihat profit bisnis kamu</div>

    <!-- ACTION BUTTONS -->
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="exportLaporanPDF()" style="font-size:13px;padding:10px 16px;">
        üìÑ Export PDF
      </button>
      <button class="btn btn-secondary" onclick="syncTransaksiKeSheets()" style="font-size:13px;padding:10px 16px;">
        ‚¨ÜÔ∏è Backup Transaksi
      </button>
      <button class="btn btn-secondary" onclick="restoreTransaksiFromSheets()" style="font-size:13px;padding:10px 16px;">
        ‚¨áÔ∏è Restore Transaksi
      </button>
    </div>

    <!-- PERIOD SELECTOR -->
    <div class="card" style="margin-bottom:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px;">
        <div style="font-size:15px;font-weight:800;color:var(--dark);">üìÖ Periode Laporan</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('hari')" id="btn-period-hari" style="font-size:12px;padding:6px 14px;">Hari Ini</button>
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('minggu')" id="btn-period-minggu" style="font-size:12px;padding:6px 14px;">7 Hari</button>
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('bulan')" id="btn-period-bulan" style="font-size:12px;padding:6px 14px;">Bulan Ini</button>
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('semua')" id="btn-period-semua" style="font-size:12px;padding:6px 14px;">Semua</button>
        </div>
      </div>
      
      <!-- SUMMARY CARDS -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;">
        <div style="background:linear-gradient(135deg,#27AE60,#2ECC71);border-radius:12px;padding:14px;color:white;">
          <div style="font-size:10px;opacity:0.85;font-weight:800;text-transform:uppercase;">üí∞ Total Profit</div>
          <div style="font-family:'Fredoka One',cursive;font-size:20px;margin-top:4px;" id="lap-profit">Rp 0</div>
        </div>
        <div style="background:linear-gradient(135deg,#2980B9,#3498DB);border-radius:12px;padding:14px;color:white;">
          <div style="font-size:10px;opacity:0.85;font-weight:800;text-transform:uppercase;">üì¶ Total Transaksi</div>
          <div style="font-family:'Fredoka One',cursive;font-size:20px;margin-top:4px;" id="lap-transaksi">0</div>
        </div>
        <div style="background:linear-gradient(135deg,#E67E22,#F39C12);border-radius:12px;padding:14px;color:white;">
          <div style="font-size:10px;opacity:0.85;font-weight:800;text-transform:uppercase;">üç± Item Terjual</div>
          <div style="font-family:'Fredoka One',cursive;font-size:20px;margin-top:4px;" id="lap-item">0</div>
        </div>
      </div>
    </div>

    <!-- BREAKDOWN PER MENU -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:12px;">üìä Breakdown per Menu</div>
      <div id="breakdown-menu"></div>
    </div>

    <!-- INPUT TRANSAKSI -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:12px;">‚ûï Catat Transaksi Baru</div>
      
      <div class="info-box" style="background:#E8F5E9;border-left:4px solid var(--green);padding:10px 12px;border-radius:10px;margin-bottom:14px;font-size:12px;">
        <span style="font-size:16px;">üí°</span>
        <div style="margin-left:8px;"><strong>Input transaksi masa lalu:</strong> Kamu bisa input transaksi kemarin atau tanggal lain dengan ganti tanggal secara manual. Gunakan tombol shortcut <strong>Kemarin</strong> untuk cepat.</div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Tanggal</label>
          <div style="display:flex;gap:6px;align-items:stretch;">
            <input type="date" id="transaksi-tanggal" style="flex:1;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
            <button class="btn btn-secondary" onclick="setTanggalTransaksi('kemarin')" style="font-size:11px;padding:6px 10px;white-space:nowrap;">Kemarin</button>
            <button class="btn btn-secondary" onclick="setTanggalTransaksi('hari-ini')" style="font-size:11px;padding:6px 10px;white-space:nowrap;">Hari Ini</button>
          </div>
        </div>
        <div class="form-group">
          <label>Menu</label>
          <select id="transaksi-menu" onchange="isiHargaTransaksi()" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;">
            <option value="">-- Pilih Menu --</option>
          </select>
        </div>
      </div>

      <div class="form-row three">
        <div class="form-group">
          <label>Jumlah (pcs)</label>
          <input type="number" id="transaksi-qty" min="1" value="1" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        </div>
        <div class="form-group">
          <label>HPP/pcs</label>
          <input type="number" id="transaksi-hpp" readonly style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;background:#F5F5F5;" />
        </div>
        <div class="form-group">
          <label>Harga Jual/pcs</label>
          <input type="number" id="transaksi-harga" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <button class="btn btn-primary" onclick="simpanTransaksi()">üíæ Simpan Transaksi</button>
      </div>
    </div>

    <!-- CHART -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:12px;">üìà Tren Profit</div>
      <canvas id="chart-profit" style="max-height:280px;"></canvas>
    </div>

    <!-- TABEL TRANSAKSI -->
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;">üìã Riwayat Transaksi</div>
      <div id="tabel-transaksi" style="overflow-x:auto;"></div>
    </div>
  </div>

  <!-- TAB PROMO -->
  <div id="tab-promo" class="tab-content">

    <div class="section-title">üè∑Ô∏è Kalkulator Promo</div>
    <div class="section-sub">Hitung apakah promo kamu masih untung atau malah boncos!</div>

    <div class="info-box">
      <span class="info-icon">üí°</span>
      <div>
        Pilih jenis promo di bawah, isi angkanya, dan kalkulator akan langsung tunjukkin <strong>profit/rugi per transaksi</strong> + rekomendasi apakah promo layak dijalankan.
      </div>
    </div>

    <!-- PILIH TIPE PROMO -->
    <div class="promo-type-grid">
      <div class="promo-type-btn active" onclick="switchPromo('diskon', this)">
        <div class="pt-icon">%</div>
        <div class="pt-label">Diskon %</div>
        <div class="pt-desc">Potong harga sekian persen</div>
      </div>
      <div class="promo-type-btn" onclick="switchPromo('bundling', this)">
        <div class="pt-icon">üì¶</div>
        <div class="pt-label">Bundling</div>
        <div class="pt-desc">Paket beberapa menu</div>
      </div>
      <div class="promo-type-btn" onclick="switchPromo('beli-dapat', this)">
        <div class="pt-icon">üéÅ</div>
        <div class="pt-label">Beli X Gratis Y</div>
        <div class="pt-desc">Gratis item/cashback</div>
      </div>
      <div class="promo-type-btn" onclick="switchPromo('aktif', this)">
        <div class="pt-icon">üìã</div>
        <div class="pt-label">Promo Aktif</div>
        <div class="pt-desc">Kelola promo tersimpan</div>
      </div>
    </div>

    <!-- PANEL: DISKON % -->
    <div id="panel-diskon" class="promo-panel active">
      <div class="card">
        <div class="card-title" style="margin-bottom:16px;">‚úÇÔ∏è Simulasi Diskon Persen</div>

        <!-- PILIH DARI RINGKASAN -->
        <div class="form-group" style="margin-bottom:14px;">
          <label>Pilih Menu dari Ringkasan <span style="color:var(--orange)">‚òÖ</span></label>
          <div style="display:flex;gap:10px;align-items:center;">
            <select id="d-pilih-menu" onchange="isiDariRingkasan()" style="flex:1;">
              <option value="">‚Äî Pilih menu yang sudah dihitung HPP-nya ‚Äî</option>
            </select>
            <button class="btn btn-secondary" onclick="refreshDropdownDiskon()" title="Refresh daftar menu" style="padding:10px 14px;white-space:nowrap;">üîÑ Refresh</button>
          </div>
        </div>

        <!-- INFO MENU TERPILIH -->
        <div id="d-menu-info" style="display:none; margin-bottom:14px;">
          <div style="background:linear-gradient(135deg,var(--red),var(--orange));border-radius:12px;padding:14px 18px;color:white;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
            <div>
              <div style="font-family:'Fredoka One',cursive;font-size:18px;" id="d-menu-info-nama">‚Äî</div>
              <div style="font-size:11px;opacity:0.85;margin-top:2px;" id="d-menu-info-kategori">‚Äî</div>
            </div>
            <div style="display:flex;gap:16px;flex-wrap:wrap;">
              <div style="text-align:center;">
                <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">HPP/pcs</div>
                <div style="font-family:'Fredoka One',cursive;font-size:20px;" id="d-menu-info-hpp">‚Äî</div>
              </div>
              <div style="text-align:center;">
                <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">Harga Jual</div>
                <div style="font-family:'Fredoka One',cursive;font-size:20px;" id="d-menu-info-hj">‚Äî</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ATAU INPUT MANUAL -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
          <div style="flex:1;height:1px;background:var(--border);"></div>
          <span style="font-size:11px;font-weight:800;color:var(--muted);white-space:nowrap;">atau input manual</span>
          <div style="flex:1;height:1px;background:var(--border);"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nama Menu</label>
            <input type="text" id="d-nama" placeholder="cth: Takoyaki Original" />
          </div>
          <div class="form-group">
            <label>HPP per Pcs (Rp) <span style="color:var(--orange)">*</span></label>
            <input type="number" id="d-hpp" placeholder="5000" min="0" oninput="hitungDiskon()" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Harga Jual Normal (Rp)</label>
            <input type="number" id="d-harga-normal" placeholder="12000" min="0" oninput="hitungDiskon()" />
          </div>
          <div class="form-group">
            <label>Platform Fee (%) ‚Äî GoFood/Shopee</label>
            <input type="number" id="d-platform-fee" value="20" min="0" max="100" oninput="hitungDiskon()" />
          </div>
        </div>

        <div class="form-group">
          <label>Besar Diskon: <span id="d-diskon-label" style="color:var(--red);font-size:16px;font-family:'Fredoka One',cursive;">20%</span></label>
          <div class="slider-wrapper">
            <input type="range" id="d-diskon" min="5" max="70" value="20" step="5" oninput="updateDiskonSlider(); hitungDiskon();" />
            <div class="slider-label"><span>5%</span><span>70%</span></div>
          </div>
        </div>

        <div id="diskon-result" style="display:none;"></div>
        
        <!-- Form Simpan Promo -->
        <div id="form-simpan-diskon" style="display:none;margin-top:20px;background:var(--bg);padding:16px;border-radius:12px;border:2px dashed var(--orange);">
          <div style="font-weight:800;margin-bottom:12px;font-size:14px;">üíæ Simpan Promo Ini</div>
          
          <div class="form-group" style="margin-bottom:12px;">
            <label style="font-weight:700;">Nama Promo</label>
            <input type="text" id="diskon-nama-promo" placeholder="cth: Diskon 20% Weekend" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
          </div>
          
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Mulai</label>
              <input type="date" id="diskon-tgl-mulai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Selesai</label>
              <input type="date" id="diskon-tgl-selesai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <button onclick="resetFormDiskon()" class="btn" style="background:var(--muted);color:white;">
              üîÑ Reset
            </button>
            <button onclick="simpanPromoDiskon()" class="btn btn-primary">
              ‚úÖ Simpan Promo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL: BUNDLING -->
    <div id="panel-bundling" class="promo-panel">
      <div class="card">
        <div class="card-title" style="margin-bottom:16px;">üì¶ Simulasi Harga Bundling / Paket</div>

        <div class="info-box" style="margin-bottom:16px;">
          <span class="info-icon">‚ÑπÔ∏è</span>
          <div>Pilih item dari <strong>Ringkasan Menu</strong> ‚Äî HPP dan harga jual otomatis terisi.</div>
        </div>

        <div class="bundle-item-header">
          <span>Pilih / Nama Item</span>
          <span>HPP/pcs</span>
          <span>Harga Jual</span>
          <span>Qty</span>
          <span></span>
        </div>
        <div id="bundle-list"></div>
        <button class="btn btn-add" onclick="tambahBundleItem()">Ôºã Tambah Item dari Ringkasan</button>

        <div id="bundling-result" style="margin-top:16px;"></div>
        
        <!-- Form Simpan Promo Bundling -->
        <div id="form-simpan-bundling" style="margin-top:20px;background:var(--bg);padding:16px;border-radius:12px;border:2px dashed var(--orange);">
          <div style="font-weight:800;margin-bottom:12px;font-size:14px;">üíæ Simpan Promo Bundling</div>
          
          <div class="form-group" style="margin-bottom:12px;">
            <label style="font-weight:700;">Nama Promo</label>
            <input type="text" id="bundling-nama-promo" placeholder="cth: Paket Hemat 3 Menu" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
          </div>
          
          <div style="margin-bottom:16px;">
            <label style="font-weight:700;display:block;margin-bottom:8px;">üí∞ Pilih Harga Bundling</label>
            <div id="bundling-harga-options" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
          
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Mulai</label>
              <input type="date" id="bundling-tgl-mulai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Selesai</label>
              <input type="date" id="bundling-tgl-selesai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <button onclick="resetFormBundling()" class="btn" style="background:var(--muted);color:white;">
              üîÑ Reset
            </button>
            <button onclick="simpanPromoBundling()" class="btn btn-primary">
              ‚úÖ Simpan Promo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL: PROMO AKTIF -->
    <div id="panel-aktif" class="promo-panel">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div class="card-title" style="margin:0;">üìã Daftar Promo Tersimpan</div>
          <button onclick="exportPromosPDF()" class="btn btn-secondary" style="padding:8px 14px;font-size:12px;">
            üìÑ Export PDF
          </button>
        </div>

        <!-- Filter Status -->
        <div style="display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;">
          <button onclick="filterPromos('all')" id="filter-all" class="btn btn-secondary" style="padding:8px 16px;font-size:13px;white-space:nowrap;background:var(--orange);color:white;">
            üìã Semua
          </button>
          <button onclick="filterPromos('active')" id="filter-active" class="btn btn-secondary" style="padding:8px 16px;font-size:13px;white-space:nowrap;">
            ‚úÖ Aktif
          </button>
          <button onclick="filterPromos('upcoming')" id="filter-upcoming" class="btn btn-secondary" style="padding:8px 16px;font-size:13px;white-space:nowrap;">
            üïí Upcoming
          </button>
          <button onclick="filterPromos('expired')" id="filter-expired" class="btn btn-secondary" style="padding:8px 16px;font-size:13px;white-space:nowrap;">
            ‚è∞ Expired
          </button>
          <button onclick="restorePromosFromCloud()" class="btn btn-secondary" style="padding:8px 16px;font-size:13px;white-space:nowrap;">
            ‚¨áÔ∏è Restore Cloud
          </button>
        </div>

        <!-- List Promo -->
        <div id="promo-list-container"></div>
      </div>
    </div>

    <!-- PANEL: BELI X GRATIS Y -->
    <div id="panel-beli-dapat" class="promo-panel">
      <div class="card">
        <div class="card-title" style="margin-bottom:16px;">üéÅ Simulasi Beli X Gratis Y</div>

        <div class="info-box" style="margin-bottom:16px;">
          <span class="info-icon">‚ÑπÔ∏è</span>
          <div>Pilih menu dari <strong>Ringkasan Menu</strong> untuk auto-fill HPP dan harga jual.</div>
        </div>

        <div class="form-group" style="margin-bottom:16px;">
          <label>Pilih Menu (opsional)</label>
          <select id="bg-menu-select" onchange="isiBeliGratis()" style="padding:12px;border-radius:12px;border:2px solid var(--border);font-size:14px;font-weight:700;width:100%;">
            <option value="">üîç Pilih dari Ringkasan Menu...</option>
          </select>
        </div>

        <div class="beli-dapat-grid">
          <div class="form-group">
            <label>Beli (pcs)</label>
            <input type="number" id="bg-beli" value="2" min="1" oninput="hitungBeliGratis()" />
          </div>
          <div class="separator">‚Üí Gratis</div>
          <div class="form-group">
            <label>Gratis (pcs)</label>
            <input type="number" id="bg-gratis" value="1" min="1" oninput="hitungBeliGratis()" />
          </div>
        </div>

        <div class="form-group" style="margin-bottom:16px;">
          <label style="font-weight:700;margin-bottom:8px;display:block;">Channel Penjualan</label>
          <select id="bg-channel" onchange="toggleBeliGratisChannel()" style="padding:12px;border-radius:12px;border:2px solid var(--border);font-size:14px;font-weight:700;width:100%;background:var(--card);">
            <option value="">-- Pilih Channel Penjualan --</option>
            <option value="offline">üè™ Offline (tanpa platform fee)</option>
            <option value="online">üì± Online (GoFood/Shopee/Grab)</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>HPP per Pcs (Rp)</label>
            <input type="number" id="bg-hpp" placeholder="5000" min="0" oninput="hitungBeliGratis()" />
          </div>
          <div class="form-group">
            <label>Harga Jual Normal per Pcs (Rp)</label>
            <input type="number" id="bg-harga" placeholder="12000" min="0" oninput="hitungBeliGratis()" />
          </div>
        </div>
        <div class="form-row" id="bg-fee-row" style="display:none;">
          <div class="form-group">
            <label>Platform Fee (%) ‚Äî GoFood/Shopee</label>
            <input type="number" id="bg-fee" value="20" min="0" max="100" oninput="hitungBeliGratis()" />
          </div>
          <div class="form-group">
            <label>Estimasi Transaksi per Hari</label>
            <input type="number" id="bg-transaksi" value="10" min="1" oninput="hitungBeliGratis()" />
          </div>
        </div>

        <div id="beli-gratis-result" style="display:none; margin-top:16px;"></div>
        
        <!-- Form Simpan Promo Beli Gratis -->
        <div id="form-simpan-beli-gratis" style="margin-top:20px;background:var(--bg);padding:16px;border-radius:12px;border:2px dashed var(--orange);">
          <div style="font-weight:800;margin-bottom:12px;font-size:14px;">üíæ Simpan Promo Beli X Gratis Y</div>
          
          <div class="form-group" style="margin-bottom:12px;">
            <label style="font-weight:700;">Nama Promo</label>
            <input type="text" id="beli-gratis-nama-promo" placeholder="cth: Beli 2 Gratis 1" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
          </div>
          
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Mulai</label>
              <input type="date" id="beli-gratis-tgl-mulai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Selesai</label>
              <input type="date" id="beli-gratis-tgl-selesai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <button onclick="resetFormBeliGratis()" class="btn" style="background:var(--muted);color:white;">
              üîÑ Reset
            </button>
            <button onclick="simpanPromoBeliGratis()" class="btn btn-primary">
              ‚úÖ Simpan Promo
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- TAB POS (KASIR) -->
  <div id="tab-pos" class="tab-content">
    <!-- Summary Bar (compact) -->
    <div style="background:linear-gradient(135deg, var(--orange), var(--red));padding:12px 16px;margin:-24px -24px 16px;display:flex;justify-content:space-around;text-align:center;color:white;">
      <div>
        <div style="font-size:10px;opacity:0.9;">PENJUALAN</div>
        <div style="font-size:18px;font-weight:800;" id="pos-total-revenue">Rp 0</div>
      </div>
      <div>
        <div style="font-size:10px;opacity:0.9;">PROFIT</div>
        <div style="font-size:18px;font-weight:800;" id="pos-total-profit">Rp 0</div>
      </div>
      <div>
        <div style="font-size:10px;opacity:0.9;">TRANSAKSI</div>
        <div style="font-size:18px;font-weight:800;" id="pos-total-trx">0</div>
      </div>
    </div>

    <!-- Item Grid (touch-friendly) -->
    <div style="margin-bottom:24px;">
      <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;color:var(--muted);">ITEM SATUAN</h3>
      <div id="pos-menu-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;"></div>
    </div>

    <!-- Bundling Promo Grid -->
    <div id="pos-bundling-section" style="margin-bottom:24px;">
      <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;color:var(--red);">üì¶ ITEM PROMO (BUNDLING)</h3>
      <div id="pos-bundling-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;"></div>
    </div>

    <!-- Cart Button (floating) -->
    <button onclick="togglePOSCart()" id="pos-cart-btn" style="position:fixed;bottom:24px;right:24px;width:64px;height:64px;border-radius:50%;background:var(--orange);color:white;border:none;box-shadow:0 4px 16px rgba(224,48,39,0.4);font-size:24px;cursor:pointer;z-index:100;display:flex;align-items:center;justify-content:center;font-weight:800;">
      üõí<span id="pos-cart-count" style="position:absolute;top:-4px;right:-4px;background:var(--red);width:24px;height:24px;border-radius:50%;font-size:12px;display:flex;align-items:center;justify-content:center;">0</span>
    </button>
  </div>

  <!-- SIDEBAR CART -->
  <div id="pos-cart-sidebar" style="position:fixed;top:0;right:-100%;width:100%;max-width:400px;height:100vh;background:var(--card);box-shadow:-4px 0 20px rgba(0,0,0,0.2);z-index:200;transition:right 0.3s;overflow-y:auto;">
    <div style="padding:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h3 style="font-size:20px;font-weight:800;">üõí Keranjang</h3>
        <button onclick="togglePOSCart()" style="background:none;border:none;font-size:28px;cursor:pointer;color:var(--muted);">‚úï</button>
      </div>

      <!-- Cart Items -->
      <div id="pos-cart-items" style="margin-bottom:20px;"></div>

      <!-- Promo Selector (hanya muncul kalau cart isi item satuan saja) -->
      <div id="pos-promo-section" style="background:var(--bg);border-radius:12px;padding:12px;margin-bottom:16px;display:none;">
        <label style="font-weight:700;display:block;margin-bottom:8px;font-size:13px;">üè∑Ô∏è Gunakan Promo?</label>
        <select id="pos-promo-select" onchange="applyPromoToPOS()" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;background:var(--card);">
          <option value="">Tanpa Promo</option>
        </select>
      </div>

      <!-- Summary -->
      <div style="background:var(--bg);border-radius:12px;padding:16px;margin-bottom:20px;">
        <div id="pos-promo-discount" style="display:none;margin-bottom:8px;padding-bottom:8px;border-bottom:1px dashed var(--border);">
          <div style="display:flex;justify-content:space-between;font-size:14px;color:var(--red);">
            <span>Diskon Promo:</span>
            <span style="font-weight:700;" id="pos-discount-amount">- Rp 0</span>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span style="font-weight:700;">Subtotal:</span>
          <span style="font-weight:800;font-size:20px;" id="pos-subtotal">Rp 0</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:14px;color:var(--green);">
          <span>Profit:</span>
          <span id="pos-profit" style="font-weight:700;">Rp 0</span>
        </div>
      </div>

      <!-- Payment -->
      <div style="margin-bottom:20px;">
        <label style="font-weight:700;display:block;margin-bottom:8px;">üíµ Uang Dibayar</label>
        <input type="number" id="pos-bayar" placeholder="50000" oninput="hitungKembalianPOS()" style="width:100%;padding:14px;border-radius:12px;border:2px solid var(--border);font-size:18px;font-weight:700;background:var(--card);" />
      </div>

      <div style="background:var(--bg);border-radius:12px;padding:12px;margin-bottom:20px;text-align:center;">
        <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Kembalian</div>
        <div id="pos-kembalian" style="font-size:24px;font-weight:800;color:var(--green);">Rp 0</div>
      </div>

      <!-- Buttons -->
      <button onclick="lihatDetailOrderCart()" style="width:100%;padding:12px;border-radius:12px;border:2px solid var(--orange);background:var(--card);color:var(--orange);font-weight:800;cursor:pointer;font-size:14px;margin-bottom:10px;">
        üßæ Lihat Detail Order
      </button>
      <button onclick="simpanTransaksiPOS()" class="btn btn-primary" style="width:100%;padding:16px;font-size:16px;font-weight:800;margin-bottom:12px;">
        ‚úÖ SELESAI - Simpan Transaksi
      </button>
      <button onclick="clearPOSCart()" style="width:100%;padding:12px;border-radius:12px;border:2px solid var(--border);background:var(--card);color:var(--red);font-weight:700;cursor:pointer;font-size:14px;">
        üóëÔ∏è Kosongkan Keranjang
      </button>
    </div>
  </div>

  <!-- TAB PANDUAN -->
  <div id="tab-panduan" class="tab-content">
    <div class="section-title">üìñ Panduan Penggunaan</div>
    <div class="section-sub">Tips dan penjelasan cara pakai kalkulator ini.</div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">Apa itu HPP?</div>
      <p style="font-size:14px;line-height:1.7;color:#444;font-weight:600;">
        <strong>HPP (Harga Pokok Produksi)</strong> adalah total biaya yang dikeluarkan untuk memproduksi satu porsi/pcs makanan. HPP mencakup:
      </p>
      <br>
      <ul style="font-size:14px;line-height:2;color:#444;font-weight:600;padding-left:20px;">
        <li>üí∞ <strong>Bahan baku</strong> ‚Äì semua bahan yang dipakai</li>
        <li>üì¶ <strong>Kemasan</strong> ‚Äì box, plastik, tusuk, dll</li>
        <li>‚öôÔ∏è <strong>Biaya operasional</strong> ‚Äì gas, listrik, dll per batch</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üßÆ Rumus Dasar</div>
      <div style="background:var(--bg);border-radius:10px;padding:16px;font-size:13px;font-weight:700;line-height:2;">
        <div>üìå <strong>Total Biaya Batch</strong> = Œ£(Biaya Bahan) + Kemasan + Biaya Operasional</div>
        <div>üìå <strong>HPP per Pcs</strong> = Total Biaya Batch √∑ Jumlah Porsi</div>
        <div>üìå <strong>Harga Jual</strong> = HPP √∑ (1 - margin%)</div>
        <div>üìå <strong>BEP Online</strong> = HPP √∑ (1 - 30%) ‚Üí karena GoFood/ShopeeFood potong ~20-30%</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üí° Tips Buat Kedai Heula</div>
      <ul style="font-size:14px;line-height:2;color:#444;font-weight:600;padding-left:20px;">
        <li>üêô <strong>Takoyaki:</strong> HPP biasanya Rp 2.500‚Äì4.000/pcs. Jual Rp 7.000‚Äì12.000/pcs (isi 6‚Äì8) oke!</li>
        <li>ü•ü <strong>Dimsum:</strong> HPP bervariasi sesuai isian. Mentai sauce nambahin cost tapi bisa jual lebih mahal.</li>
        <li>üçó <strong>Ayam Crispy:</strong> Perhatiin yield (susut saat goreng ~20-30% dari berat mentah).</li>
        <li>üì¶ <strong>Kemasan:</strong> Jangan anggap remeh! Kemasan keren = boleh jual lebih mahal.</li>
        <li>üõµ <strong>Platform fee:</strong> GoFood/ShopeeFood potong 20-30%. Harga di app harus udah cover ini!</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üì± Cara Hitung Bahan yang Beli Kemasan Besar</div>
      <p style="font-size:14px;line-height:1.7;color:#444;font-weight:600;">
        Contoh: Tepung terigu beli 1 kg = Rp 12.000, tapi satu batch cuma pakai 150 gram.
      </p>
      <br>
      <div style="background:var(--bg);border-radius:10px;padding:16px;font-size:13px;font-weight:700;line-height:2;">
        <div>Isi kolom <strong>Qty Dipakai</strong> = 150</div>
        <div>Isi kolom <strong>Harga Beli</strong> = 12000</div>
        <div>Isi kolom <strong>Ukuran Beli</strong> = 1000 (gram)</div>
        <div>‚Üí Kalkulator otomatis hitung: 150/1000 √ó 12.000 = <strong>Rp 1.800</strong></div>
      </div>
    </div>

    <!-- ======================== -->
    <!-- TIPS KALKULATOR PROMO   -->
    <!-- ======================== -->
    <div style="margin-top:28px;">
      <div class="section-title">üè∑Ô∏è Panduan Kalkulator Promo</div>
      <div class="section-sub">Tips biar promo Kedai Heula tetap untung, bukan boncos!</div>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üß† Prinsip Dasar Promo yang Sehat</div>
      <p style="font-size:14px;line-height:1.7;color:#444;font-weight:600;">
        Promo bukan berarti harus rugi. Tujuannya adalah menarik perhatian pelanggan baru atau mendorong volume penjualan, tapi margin tetap harus dijaga. Aturan praktisnya:
      </p>
      <br>
      <div style="background:var(--bg);border-radius:10px;padding:16px;font-size:13px;font-weight:700;line-height:2.2;">
        <div>üü¢ <strong>Margin ‚â• 20%</strong> setelah promo ‚Üí Aman, bisa jalan terus</div>
        <div>üü° <strong>Margin 10‚Äì20%</strong> ‚Üí Hati-hati, batasi durasi 7‚Äì14 hari</div>
        <div>üî¥ <strong>Margin &lt; 10% atau minus</strong> ‚Üí Evaluasi ulang, promo ini boncos!</div>
        <div>üìå <strong>Selalu hitung platform fee</strong> (GoFood/Shopee ~20‚Äì30%) sebelum tentukan harga promo</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">‚úÇÔ∏è Tips Promo Diskon %</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li><strong>Diskon 10‚Äì20%</strong> ‚Üí Paling aman, masih untung lumayan. Cocok buat promo rutin mingguan.</li>
        <li><strong>Diskon 25‚Äì30%</strong> ‚Üí Menarik perhatian tapi pastiin HPP-mu sudah efisien. Cek dulu di kalkulator.</li>
        <li><strong>Diskon &gt; 40%</strong> ‚Üí Risiko boncos tinggi. Hanya pakai buat <em>grand opening</em> atau flash sale 1‚Äì2 hari saja.</li>
        <li>üí° Trik: <strong>Naikkan harga normal dulu 10‚Äì15%</strong> sebelum bikin promo diskon, biar margin tetap aman.</li>
        <li>üõµ Kalau promo lewat GoFood/Shopee, pastikan harga promo di app sudah dikurangi platform fee. Jangan sampai harga promonya malah lebih kecil dari HPP!</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üì¶ Tips Promo Bundling</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li><strong>Bundling beda kategori</strong> jauh lebih menarik daripada bundling item sama. Contoh: Takoyaki + Dimsum = "Paket Jajan Duo" lebih menggoda dari 2x Takoyaki.</li>
        <li>Tujuan bundling bukan cuma diskon ‚Äî tapi juga <strong>naikin nilai transaksi per pelanggan</strong>. Kalau biasanya orang beli 1 item, dengan bundling bisa beli 2‚Äì3 item sekaligus.</li>
        <li>Harga bundling ideal: <strong>hemat 10‚Äì20%</strong> dibanding beli satuan. Lebih dari itu, cek margin dulu!</li>
        <li>üí° Nama paket yang kreatif bikin bundling lebih laku. Contoh: <em>"Paket Mantap Pisan"</em>, <em>"Combo Heula"</em>, <em>"Box Jajan Bareng"</em>.</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üéÅ Tips Promo Beli X Gratis Y</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li><strong>Beli 2 Gratis 1</strong> = diskon efektif 33%. Ini promo paling populer dan mudah dipahami pelanggan.</li>
        <li><strong>Beli 3 Gratis 1</strong> = diskon efektif 25%, lebih aman di margin tapi tetap terasa "wow" buat pelanggan.</li>
        <li>Item yang digratiskan sebaiknya <strong>item dengan HPP paling rendah</strong> dalam daftar menu kamu, biar ruginya minimal.</li>
        <li>Promo ini sangat efektif buat <strong>mendorong repeat order</strong>. Pelanggan cenderung balik lagi karena merasa dapat nilai lebih.</li>
        <li>üí° Batasi promo ini pada jam sepi (misal: weekday siang) supaya margin harian tetap terjaga saat jam ramai.</li>
        <li>‚ö†Ô∏è Jangan jalankan promo ini tanpa hitung estimasi transaksi harian dulu. Kalau ramai, kerugian per transaksi bisa numpuk cepat!</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üìÖ Kapan Waktu Terbaik Promo?</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="background:#FFF3CD;border-radius:12px;padding:14px;border:2px solid #FFD54F;">
          <div style="font-size:13px;font-weight:900;color:#856404;margin-bottom:8px;">üöÄ Grand Opening</div>
          <div style="font-size:12px;font-weight:700;color:#7B5800;line-height:1.8;">Diskon besar (30‚Äì40%) boleh, tapi batasi 3‚Äì7 hari saja. Tujuannya bikin orang penasaran dan nyobain.</div>
        </div>
        <div style="background:#D4EDDA;border-radius:12px;padding:14px;border:2px solid #86EFAC;">
          <div style="font-size:13px;font-weight:900;color:#155724;margin-bottom:8px;">üìÜ Promo Rutin</div>
          <div style="font-size:12px;font-weight:700;color:#1a6b30;line-height:1.8;">Diskon 10‚Äì20% atau bundling ringan. Jadwal tetap (misal: Senin‚ÄìRabu) biar pelanggan hafal dan balik lagi.</div>
        </div>
        <div style="background:#FFE0D0;border-radius:12px;padding:14px;border:2px solid #FFAB91;">
          <div style="font-size:13px;font-weight:900;color:#B94A00;margin-bottom:8px;">‚ö° Flash Sale</div>
          <div style="font-size:12px;font-weight:700;color:#8B3A00;line-height:1.8;">Diskon besar tapi durasi pendek (2‚Äì4 jam). Efektif buat ngabisin stok atau nge-boost order di jam sepi.</div>
        </div>
        <div style="background:#E0E0FF;border-radius:12px;padding:14px;border:2px solid #B0B0FF;">
          <div style="font-size:13px;font-weight:900;color:#3030B0;margin-bottom:8px;">üéâ Momen Spesial</div>
          <div style="font-size:12px;font-weight:700;color:#252580;line-height:1.8;">Harbolnas, ulang tahun toko, Lebaran, dll. Kombinasi bundling + diskon ringan untuk maksimal dampak.</div>
        </div>
      </div>
    </div>

    <div class="card" style="background:linear-gradient(135deg,#FFF8F0,#FFF0E0);border-color:var(--orange);">
      <div class="card-title" style="margin-bottom:10px;color:var(--red);">‚ö†Ô∏è Kesalahan Promo yang Sering Terjadi</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li>‚ùå <strong>Promo tanpa hitung HPP dulu</strong> ‚Üí Ujung-ujungnya boncos tanpa sadar.</li>
        <li>‚ùå <strong>Promo terlalu lama</strong> ‚Üí Pelanggan jadi gak mau beli di harga normal.</li>
        <li>‚ùå <strong>Lupa hitung platform fee</strong> ‚Üí Harga promo di GoFood/Shopee masih harus cover potongan 20‚Äì30%.</li>
        <li>‚ùå <strong>Promo semua menu sekaligus</strong> ‚Üí Lebih baik promo 1‚Äì2 menu andalan saja, biar ada yang beli menu lain juga.</li>
        <li>‚úÖ <strong>Yang bener:</strong> Hitung di kalkulator dulu ‚Üí tentukan durasi ‚Üí evaluasi setelah promo selesai!</li>
      </ul>
    </div>

  </div>

</div>

<!-- MODAL DETAIL BAHAN -->
<div class="modal-overlay" id="modal-detail" onclick="if(event.target===this)tutupDetail()">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üîç Detail Bahan Baku</div>
      <button class="modal-close" onclick="tutupDetail()">‚úï</button>
    </div>
    <div class="modal-body" id="modal-detail-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="tutupDetail()">Tutup</button>
      <button class="btn btn-primary" onclick="exportDetailPDF()" style="background:linear-gradient(135deg,#E03027,#F47C20);">
        üìÑ Export PDF
      </button>
    </div>
  </div>
</div>

<!-- TAB KELOLA AKUN (admin only) -->
<div id="tab-akun" class="tab-content">
  <div class="section-title">üë• Kelola Akun</div>
  <div class="section-sub">Tambah, hapus, dan kelola akun kasir</div>

  <!-- Info akun saya -->
  <div class="card" style="margin-bottom:16px;">
    <div class="card-title" style="margin-bottom:12px;">üôã Akun Saya</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
      <div style="flex:1;">
        <div style="font-size:15px;font-weight:800;" id="akun-saya-nama">‚Äî</div>
        <div style="font-size:12px;color:var(--muted);">ID: <span id="akun-saya-id">‚Äî</span></div>
      </div>
      <button class="btn btn-secondary" style="font-size:13px;" onclick="bukaGantiPassword()">üîë Ganti Password</button>
    </div>
  </div>

  <!-- Tambah akun baru -->
  <div class="card" style="margin-bottom:16px;">
    <div class="card-title" style="margin-bottom:14px;">‚ûï Tambah Akun Kasir</div>
    <div class="form-row" style="margin-bottom:12px;">
      <div class="form-group">
        <label>ID Pengguna <span style="color:var(--muted);font-weight:400;">(unik, tidak bisa diubah)</span></label>
        <input type="text" id="new-user-id" placeholder="cth: kasir01" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
      <div class="form-group">
        <label>Nama Tampilan</label>
        <input type="text" id="new-user-nama" placeholder="cth: Siti" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
    </div>
    <div class="form-row" style="margin-bottom:12px;">
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="new-user-pass" placeholder="Min. 6 karakter" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
      <div class="form-group">
        <label>Role</label>
        <select id="new-user-role" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;background:var(--card);">
          <option value="kasir">üí∞ Kasir (POS saja)</option>
          <option value="admin">‚öôÔ∏è Admin (akses penuh)</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" onclick="tambahAkun()" style="font-size:14px;padding:10px 20px;">‚ûï Tambah Akun</button>
  </div>

  <!-- Daftar akun -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <div class="card-title">üìã Daftar Akun</div>
      <button class="btn btn-secondary" style="font-size:12px;padding:6px 12px;" onclick="muatDaftarAkun()">üîÑ Refresh</button>
    </div>
    <div id="daftar-akun-list">
      <div style="text-align:center;color:var(--muted);padding:20px;font-size:13px;">Memuat...</div>
    </div>
  </div>
</div>

<!-- Modal Ganti Password -->
<div class="modal-overlay" id="modal-ganti-pass" onclick="if(event.target===this)tutupGantiPassword()">
  <div class="modal-box" style="max-width:400px;">
    <div class="modal-header">
      <div class="modal-title">üîë Ganti Password</div>
      <button class="modal-close" onclick="tutupGantiPassword()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom:12px;">
        <label>Password Lama</label>
        <input type="password" id="ganti-pass-lama" placeholder="Password saat ini" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
      <div class="form-group" style="margin-bottom:12px;">
        <label>Password Baru</label>
        <input type="password" id="ganti-pass-baru" placeholder="Min. 6 karakter" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
      <div class="form-group">
        <label>Konfirmasi Password Baru</label>
        <input type="password" id="ganti-pass-konfirm" placeholder="Ulangi password baru" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="tutupGantiPassword()">Batal</button>
      <button class="btn btn-primary" onclick="simpanGantiPassword()">üíæ Simpan</button>
    </div>
  </div>
</div>

<!-- Modal User Menu (logout dll) -->
<div class="modal-overlay" id="modal-user-menu" onclick="if(event.target===this)tutupMenuUser()">
  <div class="modal-box" style="max-width:320px;">
    <div class="modal-header">
      <div class="modal-title" id="user-menu-title">Akun</div>
      <button class="modal-close" onclick="tutupMenuUser()">‚úï</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:10px;">
      <button class="btn btn-secondary" style="width:100%;text-align:left;" onclick="tutupMenuUser();bukaGantiPassword()">üîë Ganti Password</button>
      <button class="btn btn-secondary" style="width:100%;text-align:left;color:var(--red);border-color:var(--red);" onclick="doLogoutClick()">üö™ Keluar</button>
    </div>
  </div>
</div>

<!-- MODAL EDIT MENU -->
<div class="modal-overlay" id="modal-edit" onclick="if(event.target===this)tutupEdit()">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è Edit Menu</div>
      <button class="modal-close" onclick="tutupEdit()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-idx" />

      <div class="form-row" style="margin-bottom:12px;">
        <div class="form-group">
          <label>Nama Menu</label>
          <input type="text" id="edit-nama" />
        </div>
        <div class="form-group">
          <label>Kategori</label>
          <select id="edit-kategori">
            <option value="takoyaki">üêô Takoyaki</option>
            <option value="dimsum">ü•ü Dimsum</option>
            <option value="ayam">üçó Ayam Crispy</option>
            <option value="lainnya">üç± Lainnya</option>
          </select>
        </div>
      </div>

      <div class="form-group" style="margin-bottom:16px;">
        <label>Foto Menu</label>
        <input type="file" id="edit-foto-menu" accept="image/*" onchange="previewFoto(this, 'preview-edit-foto')" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        <div id="preview-edit-foto" style="margin-top:8px;"></div>
      </div>

      <div class="form-row" style="margin-bottom:16px;">
        <div class="form-group">
          <label>Porsi / Batch (pcs)</label>
          <input type="number" id="edit-porsi" min="1" oninput="hitungEditHPP()" />
        </div>
        <div class="form-group">
          <label>Biaya Kemasan / pcs (Rp)</label>
          <input type="number" id="edit-kemasan" min="0" oninput="hitungEditHPP()" />
        </div>
      </div>

      <!-- BAHAN BAKU -->
      <div class="card" style="margin-bottom:12px;">
        <div class="card-header">
          <div class="card-title">üßÖ Bahan Baku</div>
        </div>
        <div class="bahan-header">
          <span>Nama Bahan</span>
          <span>Qty Pakai</span>
          <span class="col-harga-satuan">Harga Beli (Rp)</span>
          <span class="col-harga-satuan">Ukuran Beli</span>
          <span></span>
        </div>
        <div id="edit-bahan-list"></div>
        <button class="btn btn-add" onclick="tambahEditBahan()">Ôºã Tambah Bahan</button>
      </div>

      <!-- BIAYA OPERASIONAL -->
      <div class="card" style="margin-bottom:12px;">
        <div class="card-header">
          <div class="card-title">‚öôÔ∏è Biaya Operasional / Batch</div>
        </div>
        <div id="edit-biaya-list"></div>
        <button class="btn btn-add" onclick="tambahEditBiaya()">Ôºã Tambah Biaya</button>
      </div>

      <!-- HARGA JUAL -->
      <div class="form-group" style="margin-bottom:8px;">
        <label>Harga Jual (Rp) ‚Äî bisa disesuaikan manual</label>
        <input type="number" id="edit-harga-jual" min="0" />
      </div>

      <!-- HPP PREVIEW -->
      <div class="edit-hpp-preview" id="edit-hpp-preview">‚Äî</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="tutupEdit()">Batal</button>
      <button class="btn btn-primary" onclick="simpanEdit()">üíæ Simpan Perubahan</button>
    </div>
  </div>
</div>

<!-- PRINT AREA -->
<div id="print-area"></div>

<!-- MODAL KONFIRMASI CUSTOM (pengganti confirm() yang diblok di sandbox) -->
<div id="modal-konfirmasi" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);">
  <div style="background:var(--card);border-radius:20px;width:100%;max-width:360px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;">
    <div style="padding:20px 20px 0;">
      <div style="font-size:36px;text-align:center;margin-bottom:10px;" id="konfirmasi-icon">‚ö†Ô∏è</div>
      <div style="font-family:'Fredoka One',cursive;font-size:18px;color:var(--dark);text-align:center;margin-bottom:8px;" id="konfirmasi-title">Konfirmasi</div>
      <div style="font-size:14px;color:var(--muted);text-align:center;font-weight:600;line-height:1.5;margin-bottom:20px;" id="konfirmasi-message">Yakin?</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:2px solid var(--border);">
      <button id="konfirmasi-batal" onclick="tutupKonfirmasi()" style="padding:16px;border:none;background:transparent;font-family:'Nunito',sans-serif;font-weight:800;font-size:14px;color:var(--muted);cursor:pointer;border-right:1px solid var(--border);">Batal</button>
      <button id="konfirmasi-ok" onclick="eksekusiKonfirmasi()" style="padding:16px;border:none;background:transparent;font-family:'Nunito',sans-serif;font-weight:800;font-size:14px;color:var(--red);cursor:pointer;">Ya, Lanjutkan</button>
    </div>
  </div>
</div>

<!-- MODAL NOTA / DETAIL ORDER -->
<div id="modal-nota" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:300;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(4px);">
  <div style="background:var(--card);border-radius:20px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
    <div style="position:sticky;top:0;background:var(--card);padding:16px 20px 12px;border-bottom:2px solid var(--border);display:flex;justify-content:space-between;align-items:center;border-radius:20px 20px 0 0;">
      <div style="font-family:'Fredoka One',cursive;font-size:18px;color:var(--red);">üßæ Detail Order</div>
      <button onclick="tutupNota()" style="background:var(--bg);border:2px solid var(--border);border-radius:50%;width:34px;height:34px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
    </div>
    <div id="nota-body" style="padding:20px;"></div>
    <div style="position:sticky;bottom:0;background:var(--card);padding:14px 20px;border-top:2px solid var(--border);display:flex;gap:10px;border-radius:0 0 20px 20px;">
      <button onclick="printNota()" class="btn btn-primary" style="flex:1;">üñ®Ô∏è Print Nota</button>
      <button onclick="tutupNota()" class="btn btn-secondary" style="flex:1;">Tutup</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">‚úÖ Tersimpan!</div>

<script>
// =====================
// AUTH STATE
// =====================
let _authUser = null; // { userId, username, role, token }
let _sessionCheckTimer = null;

function getAuthHeaders() {
  if (!_authUser) return {};
  return { userId: _authUser.userId, token: _authUser.token };
}

function authFetchUrl(url) {
  if (!_authUser) return url;
  const sep = url.includes('?') ? '&' : '?';
  return `${url}${sep}userId=${encodeURIComponent(_authUser.userId)}&token=${encodeURIComponent(_authUser.token)}`;
}

function authPostBody(body) {
  if (!_authUser) return body;
  return { ...body, userId: _authUser.userId, token: _authUser.token };
}

// -- Login ------------------------------------------------------------------
async function doLoginClick() {
  const userId   = document.getElementById('login-id').value.trim();
  const password = document.getElementById('login-pass').value;
  const btn      = document.getElementById('login-btn');
  const errEl    = document.getElementById('login-error');

  if (!userId || !password) { showLoginError('ID dan password tidak boleh kosong'); return; }

  btn.disabled = true; btn.textContent = '‚è≥ Masuk...';
  errEl.style.display = 'none';

  try {
    const url = getSheetsUrl();
    if (!url) { showLoginError('URL Apps Script belum dikonfigurasi'); btn.disabled = false; btn.textContent = 'üîì Masuk'; return; }

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'login', userId, password }),
      redirect: 'follow'
    });
    const result = await res.json();

    if (result.status === 'ok') {
      _authUser = { userId: result.userId, username: result.username, role: result.role, token: result.token };
      localStorage.setItem('kedaiHeula_auth', JSON.stringify(_authUser));
      onLoginSuccess();
    } else {
      showLoginError(result.message || 'Login gagal');
    }
  } catch(e) {
    showLoginError('Gagal terhubung ke server: ' + e.message);
  } finally {
    btn.disabled = false; btn.textContent = 'üîì Masuk';
  }
}

function showLoginError(msg) {
  const el = document.getElementById('login-error');
  el.textContent = '‚ö†Ô∏è ' + msg;
  el.style.display = 'block';
}

function onLoginSuccess() {
  // Sembunyikan login screen, tampilkan app
  document.getElementById('login-screen').classList.add('hidden');
  const appWrapper = document.getElementById('app-wrapper');
  if (appWrapper) appWrapper.style.display = '';
  document.getElementById('login-pass').value = '';

  // Set role di body untuk CSS
  document.body.classList.remove('role-admin', 'role-kasir');
  document.body.classList.add('role-' + _authUser.role);

  // Update user badge
  document.getElementById('ub-name').textContent = _authUser.username;
  document.getElementById('ub-role').textContent = _authUser.role === 'admin' ? '‚öôÔ∏è Admin' : 'üí∞ Kasir';

  // Update halaman akun saya
  document.getElementById('akun-saya-nama').textContent = _authUser.username;
  document.getElementById('akun-saya-id').textContent = _authUser.userId;

  // Aktifkan tab yang sesuai
  if (_authUser.role === 'kasir') {
    // Kasir langsung ke POS
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-icon').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-pos').classList.add('active');
    document.getElementById('tab-btn-pos').classList.add('active');
    renderPOSGrid(); renderPOSBundling(); updatePOSSummary(); refreshPromoDropdown();
    if (localStorage.getItem('kedaiHeula_sheetsUrl')) pullTrxFromCloud();
  } else {
    // Admin ke hitung HPP
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-icon').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-hitung').classList.add('active');
    const firstAdminTab = document.querySelector('.tab-admin-only');
    if (firstAdminTab) firstAdminTab.classList.add('active');
    if (localStorage.getItem('kedaiHeula_sheetsUrl')) autoSyncOnLoad();
  }

  // Mulai session check setiap 30 detik
  startSessionCheck();
}

// -- Session Check (deteksi kick) -------------------------------------------
let _kickCountdownTimer = null;
let _kickCountdownSeconds = 30;

function startSessionCheck() {
  clearInterval(_sessionCheckTimer);
  _sessionCheckTimer = setInterval(async () => {
    if (!_authUser) return;
    try {
      const url = getSheetsUrl();
      if (!url) return;
      const res = await fetch(authFetchUrl(url + '?action=ping'), { redirect: 'follow' });
      const result = await res.json();
      if (result.status === 'unauthorized') {
        clearInterval(_sessionCheckTimer);
        startKickCountdown();
      }
    } catch(e) {} // silent fail jika offline
  }, 30000);
}

function startKickCountdown() {
  if (_kickCountdownTimer) return; // sudah berjalan

  _kickCountdownSeconds = 30;
  showKickBanner(_kickCountdownSeconds);

  _kickCountdownTimer = setInterval(() => {
    _kickCountdownSeconds--;
    updateKickBanner(_kickCountdownSeconds);
    if (_kickCountdownSeconds <= 0) {
      clearInterval(_kickCountdownTimer);
      _kickCountdownTimer = null;
      tutupKickBanner();
      forceLogout('Sesi berakhir - akun ini sudah login di perangkat lain.');
    }
  }, 1000);
}

function showKickBanner(secs) {
  let el = document.getElementById('kick-banner');
  if (!el) {
    el = document.createElement('div');
    el.id = 'kick-banner';
    el.style.cssText = `
      position:fixed;bottom:0;left:0;right:0;z-index:99999;
      background:linear-gradient(135deg,#E03027,#F47C20);
      color:white;padding:16px 20px;
      display:flex;align-items:center;gap:14px;flex-wrap:wrap;
      box-shadow:0 -4px 20px rgba(224,48,39,0.4);
      font-family:'Nunito',sans-serif;
    `;
    document.body.appendChild(el);
  }
  el.innerHTML = `
    <div style="flex:1;min-width:200px;">
      <div style="font-size:15px;font-weight:800;">‚ö†Ô∏è Perangkat Lain Login</div>
      <div style="font-size:13px;opacity:0.9;">Akun ini baru saja login di perangkat lain. Sesi ini akan berakhir dalam <strong id="kick-countdown">${secs}</strong> detik.</div>
    </div>
    <button onclick="tetapDisini()" style="
      background:white;color:var(--red);border:none;border-radius:10px;
      padding:10px 18px;font-size:13px;font-weight:800;cursor:pointer;
      font-family:'Nunito',sans-serif;white-space:nowrap;
    ">‚úã Tetap di Sini</button>
    <button onclick="logoutSekarang()" style="
      background:rgba(0,0,0,0.2);color:white;border:2px solid rgba(255,255,255,0.4);
      border-radius:10px;padding:10px 18px;font-size:13px;font-weight:800;cursor:pointer;
      font-family:'Nunito',sans-serif;white-space:nowrap;
    ">üö™ Logout Sekarang</button>
  `;
}

function updateKickBanner(secs) {
  const el = document.getElementById('kick-countdown');
  if (el) el.textContent = secs;
}

function tutupKickBanner() {
  const el = document.getElementById('kick-banner');
  if (el) el.remove();
}

// User klik "Tetap di Sini" -- login ulang di background untuk rebut session
async function tetapDisini() {
  clearInterval(_kickCountdownTimer);
  _kickCountdownTimer = null;
  tutupKickBanner();

  // Re-login dengan token yang tersimpan tidak bisa, harus minta password
  // Tampilkan dialog konfirmasi password
  showKonfirmasi({
    icon: 'üîë',
    title: 'Konfirmasi Password',
    message: 'Masukkan password untuk tetap aktif di perangkat ini. Perangkat lain akan dikeluarkan.',
    labelOk: 'Tetap di Sini',
    onOk: async () => {
      // Ambil password via prompt sederhana -- minta re-login
      const pass = prompt('Masukkan password kamu:');
      if (!pass) return;
      try {
        const url = getSheetsUrl();
        const res = await fetch(url, {
          method: 'POST', headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'login', userId: _authUser.userId, password: pass }),
          redirect: 'follow'
        });
        const result = await res.json();
        if (result.status === 'ok') {
          _authUser = { ..._authUser, token: result.token };
          localStorage.setItem('kedaiHeula_auth', JSON.stringify(_authUser));
          showToast('‚úÖ Sesi dipulihkan - perangkat lain telah dikeluarkan');
          startSessionCheck();
        } else {
          showToast('‚ùå Password salah');
        }
      } catch(e) { showToast('‚ùå Gagal: ' + e.message); }
    }
  });
}

function logoutSekarang() {
  clearInterval(_kickCountdownTimer);
  _kickCountdownTimer = null;
  tutupKickBanner();
  doLogoutClick();
}

function forceLogout(msg) {
  clearInterval(_kickCountdownTimer);
  _kickCountdownTimer = null;
  tutupKickBanner();
  _authUser = null;
  localStorage.removeItem('kedaiHeula_auth');
  document.getElementById('login-screen').classList.remove('hidden');
  const appWrap = document.getElementById('app-wrapper');
  if (appWrap) appWrap.style.display = 'none';
  document.body.classList.remove('role-admin', 'role-kasir');
  showLoginError(msg || 'Sesi berakhir, silakan login kembali.');
}

// -- Logout -----------------------------------------------------------------
async function doLogoutClick() {
  tutupMenuUser();
  if (!_authUser) return;
  try {
    const url = getSheetsUrl();
    if (url) {
      await fetch(url, {
        method: 'POST', headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'logout', userId: _authUser.userId, token: _authUser.token }),
        redirect: 'follow'
      });
    }
  } catch(e) {}
  clearInterval(_sessionCheckTimer);
  _authUser = null;
  localStorage.removeItem('kedaiHeula_auth');
  document.getElementById('login-screen').classList.remove('hidden');
  const appWrap = document.getElementById('app-wrapper');
  if (appWrap) appWrap.style.display = 'none';
  document.body.classList.remove('role-admin', 'role-kasir');
  document.getElementById('login-id').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('login-error').style.display = 'none';
  showToast('‚úÖ Berhasil keluar');
}

function bukaMenuUser() {
  if (!_authUser) return;
  document.getElementById('user-menu-title').textContent = _authUser.username + ' (' + _authUser.role + ')';
  document.getElementById('modal-user-menu').style.display = 'flex';
}
function tutupMenuUser() { document.getElementById('modal-user-menu').style.display = 'none'; }

// -- Kelola Akun ------------------------------------------------------------
async function muatDaftarAkun() {
  const url = getSheetsUrl();
  if (!url || !_authUser) return;
  const container = document.getElementById('daftar-akun-list');
  container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;font-size:13px;">‚è≥ Memuat...</div>';
  try {
    const res = await fetch(authFetchUrl(url + '?action=getUsers'), { redirect: 'follow' });
    const result = await res.json();
    if (result.status === 'ok' && Array.isArray(result.data)) {
      if (result.data.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;font-size:13px;">Belum ada akun</div>';
        return;
      }
      container.innerHTML = result.data.map(u => `
        <div class="akun-row">
          <div class="ar-info">
            <div class="ar-id">${u.username} <span class="role-badge ${u.role}">${u.role}</span></div>
            <div class="ar-role">ID: ${u.userId} ¬∑ Dibuat: ${u.createdAt ? u.createdAt.split('T')[0] : '-'}</div>
          </div>
          ${u.userId !== 'admin' ? `<button class="btn btn-secondary" style="font-size:12px;padding:6px 12px;color:var(--red);border-color:var(--red);" onclick="hapusAkun('${u.userId}','${u.username}')">üóëÔ∏è Hapus</button>` : '<span style="font-size:11px;color:var(--muted);">Admin utama</span>'}
        </div>
      `).join('');
    } else if (result.status === 'unauthorized') {
      forceLogout(); 
    }
  } catch(e) { container.innerHTML = '<div style="color:var(--red);padding:10px;font-size:13px;">‚ùå Gagal memuat: ' + e.message + '</div>'; }
}

async function tambahAkun() {
  const userId   = document.getElementById('new-user-id').value.trim();
  const username = document.getElementById('new-user-nama').value.trim();
  const password = document.getElementById('new-user-pass').value;
  const role     = document.getElementById('new-user-role').value;

  if (!userId || !username || !password) { showToast('‚ö†Ô∏è Lengkapi semua field'); return; }
  if (password.length < 6) { showToast('‚ö†Ô∏è Password minimal 6 karakter'); return; }
  if (!/^[a-zA-Z0-9_]+$/.test(userId)) { showToast('‚ö†Ô∏è ID hanya boleh huruf, angka, dan underscore'); return; }

  const url = getSheetsUrl();
  try {
    const res = await fetch(url, {
      method: 'POST', headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(authPostBody({ action: 'createUser', newUserId: userId, username, password, role })),
      redirect: 'follow'
    });
    const result = await res.json();
    if (result.status === 'ok') {
      showToast('‚úÖ Akun berhasil dibuat!');
      document.getElementById('new-user-id').value = '';
      document.getElementById('new-user-nama').value = '';
      document.getElementById('new-user-pass').value = '';
      muatDaftarAkun();
    } else if (result.status === 'unauthorized') {
      forceLogout();
    } else {
      showToast('‚ùå ' + (result.message || 'Gagal membuat akun'));
    }
  } catch(e) { showToast('‚ùå Error: ' + e.message); }
}

async function hapusAkun(userId, username) {
  showKonfirmasi({
    icon: 'üóëÔ∏è', title: 'Hapus Akun?',
    message: `Akun "${username}" (ID: ${userId}) akan dihapus permanen dan langsung logout dari semua device.`,
    labelOk: 'Ya, Hapus',
    onOk: async () => {
      const url = getSheetsUrl();
      try {
        const res = await fetch(url, {
          method: 'POST', headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(authPostBody({ action: 'deleteUser', targetUserId: userId })),
          redirect: 'follow'
        });
        const result = await res.json();
        if (result.status === 'ok') { showToast('‚úÖ Akun dihapus'); muatDaftarAkun(); }
        else showToast('‚ùå ' + (result.message || 'Gagal'));
      } catch(e) { showToast('‚ùå Error: ' + e.message); }
    }
  });
}

function bukaGantiPassword() {
  document.getElementById('ganti-pass-lama').value = '';
  document.getElementById('ganti-pass-baru').value = '';
  document.getElementById('ganti-pass-konfirm').value = '';
  document.getElementById('modal-ganti-pass').style.display = 'flex';
}
function tutupGantiPassword() { document.getElementById('modal-ganti-pass').style.display = 'none'; }

async function simpanGantiPassword() {
  const lama    = document.getElementById('ganti-pass-lama').value;
  const baru    = document.getElementById('ganti-pass-baru').value;
  const konfirm = document.getElementById('ganti-pass-konfirm').value;
  if (!lama || !baru) { showToast('‚ö†Ô∏è Isi semua field'); return; }
  if (baru.length < 6) { showToast('‚ö†Ô∏è Password baru minimal 6 karakter'); return; }
  if (baru !== konfirm) { showToast('‚ö†Ô∏è Konfirmasi password tidak cocok'); return; }

  const url = getSheetsUrl();
  try {
    const res = await fetch(url, {
      method: 'POST', headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(authPostBody({ action: 'changePassword', oldPassword: lama, newPassword: baru })),
      redirect: 'follow'
    });
    const result = await res.json();
    if (result.status === 'ok') { tutupGantiPassword(); showToast('‚úÖ Password berhasil diubah!'); }
    else showToast('‚ùå ' + (result.message || 'Gagal'));
  } catch(e) { showToast('‚ùå Error: ' + e.message); }
}

// =====================
// STATE
// =====================
let bahanCount = 0;
let biayaCount = 0;
let menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
let lastHPP = 0;
let lastPorsi = 0;
let lastNama = '';

// =====================
// INIT
// =====================
// Ensure all functions are defined before DOM ready
window.onload = () => {
  try {
    tambahBahan(); tambahBahan(); tambahBahan();
    tambahBiaya();

    // Migrasi data lama: pastikan semua menu punya id unik
    const existingMenu = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
    let needsMigration = false;
    existingMenu.forEach(item => {
      if (!item.id) {
        item.id = 'menu_' + Date.now() + '_' + Math.floor(Math.random() * 9999);
        needsMigration = true;
      }
    });
    if (needsMigration) {
      localStorage.setItem('kedaiHeula_menu', JSON.stringify(existingMenu));
      menuList = existingMenu;
    }

    renderRingkasan();
    tambahBundleItem();
    tambahBundleItem();

    // Set URL default
    const DEFAULT_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdqBg7rvkD8ZdGRdAn-m-8-SG-b1j22zfZmGkjHUEjfN0RhNROT4KM5VkcA05e2T9t/exec';
    if (!localStorage.getItem('kedaiHeula_sheetsUrl')) {
      localStorage.setItem('kedaiHeula_sheetsUrl', DEFAULT_APPS_SCRIPT_URL);
    }

    // Cek saved session - verify ke server dulu sebelum masuk
    const savedAuth = localStorage.getItem('kedaiHeula_auth');
    if (savedAuth) {
      try {
        const parsed = JSON.parse(savedAuth);
        const url = localStorage.getItem('kedaiHeula_sheetsUrl');
        if (url && parsed.userId && parsed.token) {
          // Verify session ke server
          const verifyUrl = url + '?action=ping&userId=' + encodeURIComponent(parsed.userId) + '&token=' + encodeURIComponent(parsed.token);
          fetch(verifyUrl).then(r => r.json()).then(result => {
            if (result.status === 'ok') {
              _authUser = parsed;
              onLoginSuccess();
            } else {
              // Session tidak valid - hapus dan tampilkan login
              localStorage.removeItem('kedaiHeula_auth');
            }
          }).catch(() => {
            // Offline / server error - tetap masuk dengan saved session
            _authUser = parsed;
            onLoginSuccess();
          });
        } else {
          // Tidak ada URL atau data tidak lengkap - hapus saved auth, paksa login
          localStorage.removeItem('kedaiHeula_auth');
        }
      } catch(e) {
        localStorage.removeItem('kedaiHeula_auth');
      }
    }
    // Kalau tidak ada saved session, login screen sudah visible by default
  } catch(e) {
    console.error('Init error:', e);
  }

  window.onafterprint = () => {
    document.getElementById('print-area').innerHTML = '';
  };
};

// =====================
// TAB
// =====================
function switchTab(id) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-icon').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  event.currentTarget.classList.add('active');

  if (id === 'ringkasan') { renderRingkasan(); updateSyncStatus(); }
  if (id === 'laporan') initLaporan();

  // Fix 1: Pull promo terbaru dari cloud saat buka tab Promo
  if (id === 'promo') {
    refreshDropdownDiskon();
    refreshAllBundleDropdowns();
    refreshDropdownBeliGratis();
    renderPromoList();
    if (localStorage.getItem('kedaiHeula_sheetsUrl')) pullPromosFromCloud();
  }

  if (id === 'akun') {
    document.getElementById('akun-saya-nama').textContent = _authUser ? _authUser.username : '-';
    document.getElementById('akun-saya-id').textContent = _authUser ? _authUser.userId : '-';
    muatDaftarAkun();
  }
  if (id === 'pos') {
    renderPOSGrid();
    renderPOSBundling();
    updatePOSSummary();
    refreshPromoDropdown();
    if (localStorage.getItem('kedaiHeula_sheetsUrl')) pullTrxFromCloud();
  }
}



// =====================
// BAHAN
// =====================
function tambahBahan() {
  bahanCount++;
  const id = bahanCount;
  const div = document.createElement('div');
  div.className = 'bahan-row';
  div.id = 'bahan-' + id;
  div.innerHTML = `
    <input type="text" placeholder="cth: Tepung takoyaki" />
    <input type="number" min="0" step="any" placeholder="150" title="Qty yang dipakai per batch" />
    <input type="number" min="0" step="any" placeholder="12000" title="Harga beli total (Rp)" class="col-harga-satuan" />
    <input type="number" min="0" step="any" placeholder="1000" title="Ukuran/berat kemasan beli" class="col-harga-satuan" />
    <button class="btn btn-danger" onclick="hapusBahan(${id})" title="Hapus">‚úï</button>
  `;
  document.getElementById('bahan-list').appendChild(div);
}

function hapusBahan(id) {
  const el = document.getElementById('bahan-' + id);
  if (el) el.remove();
}

// =====================
// BIAYA OPERASIONAL
// =====================
function tambahBiaya() {
  biayaCount++;
  const id = biayaCount;
  const div = document.createElement('div');
  div.className = 'biaya-row';
  div.id = 'biaya-' + id;
  div.innerHTML = `
    <input type="text" placeholder="cth: Gas LPG per batch" />
    <input type="number" min="0" step="any" placeholder="1000" title="Biaya (Rp)" />
    <button class="btn btn-danger" onclick="hapusBiaya(${id})" title="Hapus">‚úï</button>
  `;
  document.getElementById('biaya-list').appendChild(div);
}

function hapusBiaya(id) {
  const el = document.getElementById('biaya-' + id);
  if (el) el.remove();
}

// =====================
// HITUNG HPP
// =====================
let lastSnapshot = {}; // simpan raw data bahan untuk disimpan ke ringkasan

function hitungHPP() {
  const nama = document.getElementById('nama-menu').value.trim() || 'Menu Tanpa Nama';
  const kategori = document.getElementById('kategori-menu').value;
  const porsi = parseFloat(document.getElementById('porsi').value) || 1;
  const kemasan = parseFloat(document.getElementById('biaya-kemasan').value) || 0;

  // Hitung bahan -- scope ke #bahan-list supaya tidak baca dari modal edit
  let totalBahan = 0;
  const bahanRows = document.querySelectorAll('#bahan-list .bahan-row');
  const bahanDetail = [];
  const bahanRaw = [];

  bahanRows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    const namaBahan = inputs[0].value.trim();
    const qty = parseFloat(inputs[1].value) || 0;
    const hargaBeli = parseFloat(inputs[2].value) || 0;
    const ukuranBeli = parseFloat(inputs[3].value) || 1;
    if (!namaBahan || qty === 0 || hargaBeli === 0) return;

    const biayaBahan = (qty / ukuranBeli) * hargaBeli;
    totalBahan += biayaBahan;
    bahanDetail.push({ nama: namaBahan, biaya: biayaBahan });
    bahanRaw.push({ nama: namaBahan, qty, hargaBeli, ukuranBeli, biaya: biayaBahan });
  });

  // Hitung biaya operasional -- scope ke #biaya-list supaya tidak baca dari modal edit
  let totalOperasional = 0;
  const biayaRows = document.querySelectorAll('#biaya-list .biaya-row');
  const biayaDetail = [];
  const biayaRaw = [];

  biayaRows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    const namaB = inputs[0].value.trim();
    const nominal = parseFloat(inputs[1].value) || 0;
    if (!namaB || nominal === 0) return;
    totalOperasional += nominal;
    biayaDetail.push({ nama: namaB, biaya: nominal });
    biayaRaw.push({ nama: namaB, biaya: nominal });
  });

  const totalKemasan = kemasan * porsi;
  const totalBatch = Math.round(totalBahan + totalKemasan + totalOperasional);
  const hpp = Math.round(totalBatch / porsi);
  const bep = Math.round(hpp / (1 - 0.30));

  lastHPP = hpp;
  lastPorsi = porsi;
  lastNama = nama;

  // Simpan snapshot lengkap untuk disimpan ke ringkasan
  lastSnapshot = { nama, kategori, porsi, kemasan, bahanRaw, biayaRaw, totalBatch, hpp, foto: currentFotoBase64 };

  // Update UI
  document.getElementById('res-total-batch').textContent = formatRp(totalBatch);
  document.getElementById('res-batch-info').textContent = `untuk ${porsi} pcs / batch`;
  document.getElementById('res-hpp').textContent = formatRp(hpp);
  document.getElementById('res-bep').textContent = formatRp(bep);

  // Saran harga jual - offline & online
  const harga30 = roundHargaMakanan(hpp / (1 - 0.30));
  const harga50 = roundHargaMakanan(hpp / (1 - 0.50));
  const harga70 = roundHargaMakanan(hpp / (1 - 0.70));

  // Simpan ke hidden input (dipakai oleh updateHargaTerpilih)
  document.getElementById('harga-30-offline').value = harga30;
  document.getElementById('harga-50-offline').value = harga50;
  document.getElementById('harga-70-offline').value = harga70;
  document.getElementById('harga-30-online').value = roundHargaMakanan(harga30 * 1.25);
  document.getElementById('harga-50-online').value = roundHargaMakanan(harga50 * 1.25);
  document.getElementById('harga-70-online').value = roundHargaMakanan(harga70 * 1.25);

  // Set default ke STANDAR & OFFLINE, lalu update tampilan
  selectedMargin = 50;
  selectedChannel = 'offline';
  selectedHargaJual = harga50;

  // Highlight tombol STANDAR sebagai default
  [30, 50, 70].forEach(m => {
    const btn = document.getElementById('btn-kategori-' + m);
    if (!btn) return;
    btn.style.boxShadow = m === 50 ? '0 4px 12px rgba(0,0,0,0.15)' : '';
    btn.style.transform = m === 50 ? 'scale(1.05)' : '';
  });

  // Tampilkan channel selector
  document.getElementById('channel-selector').style.display = 'block';
  updateHargaTerpilih();

  // Breakdown table
  const tbody = document.getElementById('breakdown-body');
  tbody.innerHTML = '';

  const addRow = (nama, keterangan, biaya) => {
    const pct = totalBatch > 0 ? ((biaya / totalBatch) * 100).toFixed(1) : '0.0';
    tbody.innerHTML += `
      <tr>
        <td>${nama}</td>
        <td style="color:var(--muted);font-size:12px;">${keterangan}</td>
        <td class="text-right">${formatRp(biaya)}</td>
        <td class="text-right" style="color:var(--muted);">${pct}%</td>
      </tr>
    `;
  };

  bahanDetail.forEach(b => addRow(b.nama, 'Bahan baku', b.biaya));
  if (totalKemasan > 0) addRow('Kemasan', `${formatRp(kemasan)} √ó ${porsi} pcs`, totalKemasan);
  biayaDetail.forEach(b => addRow(b.nama, 'Biaya operasional', b.biaya));

  tbody.innerHTML += `
    <tr class="total-row">
      <td colspan="2"><strong>TOTAL BIAYA BATCH</strong></td>
      <td class="text-right"><strong>${formatRp(totalBatch)}</strong></td>
      <td class="text-right"><strong>100%</strong></td>
    </tr>
    <tr class="total-row">
      <td colspan="2"><strong>HPP PER PCS</strong></td>
      <td class="text-right"><strong>${formatRp(hpp)}</strong></td>
      <td></td>
    </tr>
  `;

  document.getElementById('hasil-section').style.display = 'block';
  document.getElementById('hasil-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// =====================
// SIMPAN
// =====================
function simpanMenu() {
  const nama = lastSnapshot.nama || document.getElementById('nama-menu').value.trim() || 'Menu Tanpa Nama';
  const kategori = lastSnapshot.kategori || document.getElementById('kategori-menu').value;
  const hpp = lastHPP;
  
  // Pakai harga yang dipilih user, fallback ke STANDAR offline jika belum pilih
  const hargaJual = selectedHargaJual > 0
    ? selectedHargaJual
    : roundHargaMakanan(hpp / (1 - 0.50));
  const margin = selectedHargaJual > 0 ? selectedMargin : 50;

  const obj = {
    id: null, // akan diisi di bawah
    nama, kategori,
    porsi: lastSnapshot.porsi,
    kemasan: lastSnapshot.kemasan,
    hpp, hargaJual, margin,
    channel: selectedChannel,
    tanggal: getWIBDateTimeString(),
    totalBatch: lastSnapshot.totalBatch,
    bahanRaw: lastSnapshot.bahanRaw || [],
    biayaRaw: lastSnapshot.biayaRaw || [],
    foto: lastSnapshot.foto || null,
  };

  // Cari existing berdasarkan id (jika ada) atau nama sebagai fallback
  const existing = menuList.findIndex(m =>
    (lastSnapshot.id && m.id === lastSnapshot.id) ||
    (!lastSnapshot.id && m.nama === nama)
  );

  if (existing >= 0) {
    obj.id = menuList[existing].id || ('menu_' + Date.now()); // Pertahankan id lama
    menuList[existing] = obj;
  } else {
    obj.id = 'menu_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
    menuList.push(obj);
  }

  localStorage.setItem('kedaiHeula_menu', JSON.stringify(menuList));
  showToast(`‚úÖ "${nama}" tersimpan!`);
  autoSyncPush('menu'); // Auto push ke cloud

  setTimeout(() => {
    showKonfirmasi({
      icon: 'üéâ',
      title: `"${nama}" Tersimpan!`,
      message: 'Mau langsung input menu baru? Atau tetap di halaman ini.',
      labelOk: '‚ûï Input Menu Baru',
      onOk: () => {
        resetForm();
        lastSnapshot = {};
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
    document.getElementById('konfirmasi-batal').textContent = 'Tetap di sini';
  }, 300);
}

function renderRingkasan() {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const container = document.getElementById('ringkasan-list');

  if (menuList.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="es-icon">üç±</div>
        <p>Belum ada menu tersimpan</p>
        <small>Hitung HPP dulu di tab "Hitung HPP", lalu klik "Simpan ke Ringkasan Menu"</small>
      </div>`;
    return;
  }

  let html = '';

  const totalMenu = menuList.length;
  const rataHPP = menuList.reduce((s, m) => s + m.hpp, 0) / totalMenu;
  html += `
    <div class="result-box" style="margin-bottom:20px;">
      <h3>üìä Statistik Menu</h3>
      <div class="result-grid">
        <div class="result-item">
          <span class="label">Total Menu</span>
          <div class="value">${totalMenu}</div>
          <div class="sub">menu terdaftar</div>
        </div>
        <div class="result-item">
          <span class="label">Rata-rata HPP</span>
          <div class="value">${formatRp(rataHPP)}</div>
          <div class="sub">per pcs</div>
        </div>
        <div class="result-item">
          <span class="label">Rata-rata Harga Jual</span>
          <div class="value">${formatRp(menuList.reduce((s, m) => s + m.hargaJual, 0) / totalMenu)}</div>
          <div class="sub">margin 50%</div>
        </div>
      </div>
    </div>
  `;

  menuList.forEach((m, i) => {
    const hj = m.hargaJual;
    const profit = hj - m.hpp;
    const hasBahan = m.bahanRaw && m.bahanRaw.length > 0;
    const h30 = roundHargaMakanan(m.hpp / (1 - 0.30));
    const h50 = roundHargaMakanan(m.hpp / (1 - 0.50));
    const h70 = roundHargaMakanan(m.hpp / (1 - 0.70));
    const bep  = Math.round(m.hpp / (1 - 0.30));
    html += `
      <div class="menu-card" style="cursor:default;flex-direction:column;align-items:stretch;gap:14px;">
        <!-- Baris atas: foto + info + angka -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;">
          ${m.foto ? `
            <div style="flex-shrink:0;">
              <img src="${m.foto}" style="width:80px;height:80px;object-fit:cover;border-radius:12px;border:2px solid var(--border);" />
            </div>
          ` : ''}
          <div class="mc-left" style="flex:1;min-width:200px;">
            <div class="mc-name">${m.nama}</div>
            <div style="margin-top:4px;">
              <span class="tag tag-${m.kategori}">${getCategoryLabel(m.kategori)}</span>
              <span style="font-size:11px;color:var(--muted);font-weight:700;">${m.tanggal}</span>
              ${hasBahan ? `<span style="font-size:10px;background:#E8F5E9;color:#2E7D32;font-weight:800;padding:2px 8px;border-radius:10px;margin-left:4px;">üìã Ada ${m.bahanRaw.length} bahan</span>` : ''}
            </div>
          </div>
          <div class="mc-right">
            <div class="mc-hpp">HPP: ${formatRp(m.hpp)}/pcs</div>
            <div class="mc-price">${formatRp(hj)}</div>
            <div class="mc-margin">+${formatRp(profit)} profit/pcs</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px;">${m.porsi} pcs/batch</div>
          </div>
        </div>

        <!-- Rekomendasi harga -->
        <div style="background:var(--bg);border-radius:12px;padding:12px;">
          <div style="font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">üí° Rekomendasi Harga</div>
          
          <!-- Header kolom -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;margin-bottom:6px;font-size:9px;font-weight:700;color:#666;">
            <div></div>
            <div style="text-align:center;">üè™ OFFLINE</div>
            <div style="text-align:center;">üì± ONLINE</div>
          </div>

          <!-- Ekonomis -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;margin-bottom:4px;">
            <div style="font-size:8px;font-weight:700;color:#999;display:flex;align-items:center;">üü° 30%</div>
            <div style="background:#FFF9E6;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(h30)}</div>
            </div>
            <div style="background:#FFF9E6;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(roundHargaMakanan(h30*1.25))}</div>
            </div>
          </div>

          <!-- Standar -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;margin-bottom:4px;">
            <div style="font-size:8px;font-weight:700;color:#999;display:flex;align-items:center;">üü¢ 50%</div>
            <div style="background:#E8F5E9;border:2px solid ${Math.round(hj)===h50?'#27AE60':'#C8E6C9'};border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(h50)}</div>
            </div>
            <div style="background:#E8F5E9;border:2px solid ${Math.round(hj)===roundHargaMakanan(h50*1.25)?'#27AE60':'#C8E6C9'};border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(roundHargaMakanan(h50*1.25))}</div>
            </div>
          </div>

          <!-- Premium -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;">
            <div style="font-size:8px;font-weight:700;color:#999;display:flex;align-items:center;">üî• 70%</div>
            <div style="background:#FFF0EF;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(h70)}</div>
            </div>
            <div style="background:#FFF0EF;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(roundHargaMakanan(h70*1.25))}</div>
            </div>
          </div>
        </div>

        <!-- Tombol aksi -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 12px;" onclick="lihatDetail(${i})">üîç Detail Bahan</button>
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 12px;" onclick="editMenu(${i})">‚úèÔ∏è Edit</button>
          <button class="btn btn-danger" style="font-size:11px;padding:6px 12px;" onclick="hapusItem(${i})">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });

  html += `
    <div style="text-align:right;margin-top:8px;">
      <button class="btn btn-secondary" onclick="hapusSemua()">üóëÔ∏è Hapus Semua</button>
    </div>
  `;

  container.innerHTML = html;
}

function hapusSemua() {
  showKonfirmasi({
    icon: 'üóëÔ∏è',
    title: 'Hapus Semua Menu?',
    message: 'Semua data menu yang tersimpan akan dihapus permanen.',
    labelOk: 'Ya, Hapus Semua',
    onOk: () => {
      menuList = [];
      localStorage.removeItem('kedaiHeula_menu');
      renderRingkasan();
      showToast('üóëÔ∏è Semua menu dihapus');
      autoSyncPush('menu');
    }
  });
}

function hapusItem(i) {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  if (!menuList[i]) return;
  showKonfirmasi({
    icon: 'üóëÔ∏è',
    title: `Hapus "${menuList[i].nama}"?`,
    message: 'Menu ini akan dihapus dari Ringkasan secara permanen.',
    labelOk: 'Ya, Hapus',
    onOk: () => {
      menuList.splice(i, 1);
      localStorage.setItem('kedaiHeula_menu', JSON.stringify(menuList));
      renderRingkasan();
      showToast('üóëÔ∏è Menu dihapus');
      autoSyncPush('menu');
    }
  });
}

// =====================
// DETAIL BAHAN MODAL
// =====================
function lihatDetail(i) {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const m = menuList[i];
  if (!m) return;

  const totalBahan = (m.bahanRaw || []).reduce((s, b) => s + b.biaya, 0);
  const totalBiaya = (m.biayaRaw || []).reduce((s, b) => s + b.biaya, 0);
  const totalKemasan = (m.kemasan || 0) * (m.porsi || 1);

  let bahanRows = (m.bahanRaw || []).map(b => `
    <tr>
      <td>${b.nama}</td>
      <td class="text-right">${b.qty}</td>
      <td class="text-right">${b.ukuranBeli}</td>
      <td class="text-right">${formatRp(b.hargaBeli)}</td>
      <td class="text-right" style="font-weight:800;">${formatRp(b.biaya)}</td>
    </tr>`).join('');

  if (!bahanRows) bahanRows = `<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:16px;">Tidak ada data bahan tersimpan</td></tr>`;

  let biayaRows = (m.biayaRaw || []).map(b => `
    <tr><td>${b.nama}</td><td colspan="3"></td><td class="text-right" style="font-weight:800;">${formatRp(b.biaya)}</td></tr>
  `).join('');

  document.getElementById('modal-detail-body').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
      <div>
        <div style="font-family:'Fredoka One',cursive;font-size:22px;color:var(--red);">${m.nama}</div>
        <div style="margin-top:4px;">
          <span class="tag tag-${m.kategori}">${getCategoryLabel(m.kategori)}</span>
          <span style="font-size:12px;color:var(--muted);font-weight:700;margin-left:6px;">Tersimpan ${m.tanggal}</span>
        </div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:12px;color:var(--muted);font-weight:700;">HPP / pcs</div>
        <div style="font-family:'Fredoka One',cursive;font-size:26px;color:var(--red);">${formatRp(m.hpp)}</div>
        <div style="font-size:11px;color:var(--muted);">Batch: ${m.porsi} pcs ¬∑ Kemasan: ${formatRp(m.kemasan)}/pcs</div>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <div class="card-title" style="margin-bottom:12px;">üßÖ Bahan Baku</div>
      <table class="breakdown-table">
        <thead>
          <tr>
            <th>Nama Bahan</th>
            <th class="text-right">Qty Pakai</th>
            <th class="text-right">Ukuran Beli</th>
            <th class="text-right">Harga Beli</th>
            <th class="text-right">Biaya</th>
          </tr>
        </thead>
        <tbody>
          ${bahanRows}
          <tr class="total-row">
            <td colspan="4"><strong>Total Bahan</strong></td>
            <td class="text-right"><strong>${formatRp(totalBahan)}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>

    ${m.biayaRaw && m.biayaRaw.length > 0 ? `
    <div class="card" style="margin-bottom:12px;">
      <div class="card-title" style="margin-bottom:12px;">‚öôÔ∏è Biaya Operasional</div>
      <table class="breakdown-table">
        <thead><tr><th>Keterangan</th><th colspan="3"></th><th class="text-right">Biaya</th></tr></thead>
        <tbody>
          ${biayaRows}
          <tr class="total-row">
            <td colspan="4"><strong>Total Operasional</strong></td>
            <td class="text-right"><strong>${formatRp(totalBiaya)}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>` : ''}

    <div style="background:linear-gradient(135deg,var(--red),var(--orange));border-radius:14px;padding:16px;color:white;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;">
      <div>
        <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">Total Biaya Batch</div>
        <div style="font-family:'Fredoka One',cursive;font-size:18px;">${formatRp(m.totalBatch || (totalBahan + totalBiaya + totalKemasan))}</div>
      </div>
      <div>
        <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">HPP / pcs</div>
        <div style="font-family:'Fredoka One',cursive;font-size:18px;">${formatRp(m.hpp)}</div>
      </div>
      <div>
        <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">Harga Jual</div>
        <div style="font-family:'Fredoka One',cursive;font-size:18px;">${formatRp(m.hargaJual)}</div>
      </div>
    </div>
  `;

  document.getElementById('modal-detail').style.display = 'flex';
  // Simpan index ke modal supaya bisa dipakai tombol export
  document.getElementById('modal-detail').dataset.menuIdx = i;
}

function tutupDetail() {
  document.getElementById('modal-detail').style.display = 'none';
}

function exportDetailPDF() {
  try {
    const i = parseInt(document.getElementById('modal-detail').dataset.menuIdx);
    menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
    const m = menuList[i];
    if (!m) {
      showToast('‚ùå Menu tidak ditemukan');
      return;
    }

    const totalBahan   = (m.bahanRaw  || []).reduce((s, b) => s + (b.biaya || 0), 0);
    const totalBiaya   = (m.biayaRaw  || []).reduce((s, b) => s + (b.biaya || 0), 0);
    const totalKemasan = (m.kemasan   || 0) * (m.porsi || 1);
    const totalBatch   = m.totalBatch || (totalBahan + totalBiaya + totalKemasan);
    const h30 = roundHargaMakanan(m.hpp / (1 - 0.30));
    const h50 = roundHargaMakanan(m.hpp / (1 - 0.50));
    const h70 = roundHargaMakanan(m.hpp / (1 - 0.70));
    const bep = Math.round(m.hpp / (1 - 0.30));

  const bahanRows = (m.bahanRaw || []).map(b => `
    <tr>
      <td>${b.nama}</td>
      <td class="pr-num">${b.qty}</td>
      <td class="pr-num">${b.ukuranBeli}</td>
      <td class="pr-num">${formatRp(b.hargaBeli)}</td>
      <td class="pr-num"><strong>${formatRp(b.biaya)}</strong></td>
    </tr>`).join('') || `<tr><td colspan="5" style="text-align:center;color:#999;padding:12px;">Tidak ada data bahan</td></tr>`;

  const kemasanRow = m.kemasan > 0 ? `
    <tr>
      <td>Kemasan</td>
      <td colspan="3" style="color:#888;font-size:11px;">${formatRp(m.kemasan)} √ó ${m.porsi} pcs</td>
      <td class="pr-num"><strong>${formatRp(totalKemasan)}</strong></td>
    </tr>` : '';

  const biayaRows = (m.biayaRaw || []).map(b => `
    <tr>
      <td>${b.nama}</td>
      <td colspan="3"></td>
      <td class="pr-num"><strong>${formatRp(b.biaya)}</strong></td>
    </tr>`).join('');

  const biayaSection = (m.biayaRaw && m.biayaRaw.length > 0) ? `
    <h3>‚öôÔ∏è Biaya Operasional per Batch</h3>
    <table>
      <thead><tr><th>Keterangan</th><th colspan="3"></th><th class="pr-num">Biaya</th></tr></thead>
      <tbody>
        ${biayaRows}
        <tr class="total-row">
          <td colspan="4"><strong>Total Operasional</strong></td>
          <td class="pr-num"><strong>${formatRp(totalBiaya)}</strong></td>
        </tr>
      </tbody>
    </table>` : '';

  const tanggalCetak = new Date().toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });

  const printContent = `
    <div class="doc-header">
      <div>
        <div class="brand">üç± Kedai Heula</div>
        <div class="brand-sub">Kalkulator HPP - Referensi Bahan Baku</div>
      </div>
      <div class="doc-meta">
        <div class="menu-name">${m.nama}</div>
        <div class="meta-sub">${getCategoryLabel(m.kategori)} ¬∑ Tersimpan ${m.tanggal} ¬∑ ${m.porsi} pcs/batch</div>
      </div>
    </div>

    <div class="summary-bar">
      <div class="sum-box">
        <span class="sum-label">Total Biaya Batch</span>
        <span class="sum-value">${formatRp(totalBatch)}</span>
        <span class="sum-sub">${m.porsi} pcs</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">HPP / pcs</span>
        <span class="sum-value">${formatRp(m.hpp)}</span>
        <span class="sum-sub">harga pokok</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">Min. BEP</span>
        <span class="sum-value">${formatRp(bep)}</span>
        <span class="sum-sub">incl. platform fee</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">Harga Jual</span>
        <span class="sum-value">${formatRp(m.hargaJual)}</span>
        <span class="sum-sub">tersimpan</span>
      </div>
    </div>

    <h3>üßÖ Bahan Baku</h3>
    <table>
      <thead>
        <tr>
          <th>Nama Bahan</th>
          <th class="pr-num">Qty Pakai</th>
          <th class="pr-num">Ukuran Beli</th>
          <th class="pr-num">Harga Beli</th>
          <th class="pr-num">Biaya</th>
        </tr>
      </thead>
      <tbody>
        ${bahanRows}
        ${kemasanRow}
        <tr class="total-row">
          <td colspan="4"><strong>Total Bahan + Kemasan</strong></td>
          <td class="pr-num"><strong>${formatRp(totalBahan + totalKemasan)}</strong></td>
        </tr>
      </tbody>
    </table>

    ${biayaSection}

    <div class="harga-section">
      <div class="harga-title">‚úÖ Rekomendasi Harga Jual</div>
      <div class="harga-grid">
        <div class="harga-box ekonomis">
          <span class="hb-label">üü° Ekonomis</span>
          <span class="hb-value">${formatRp(h30)}</span>
          <span class="hb-margin">Margin 30%</span>
        </div>
        <div class="harga-box standar">
          <span class="hb-label">üü¢ Standar</span>
          <span class="hb-value">${formatRp(h50)}</span>
          <span class="hb-margin">Margin 50%</span>
        </div>
        <div class="harga-box premium">
          <span class="hb-label">üî• Premium</span>
          <span class="hb-value">${formatRp(h70)}</span>
          <span class="hb-margin">Margin 70%</span>
        </div>
      </div>
    </div>

    <div class="doc-footer">
      <span>Kedai Heula - Manajemen Bisnis Kuliner</span>
      <span>Dicetak: ${tanggalCetak}</span>
    </div>
  `;

  const printArea = document.getElementById('print-area');
  if (!printArea) {
    showToast('‚ùå Error: print-area tidak ditemukan');
    console.error('print-area element tidak ada');
    return;
  }
  
  printArea.innerHTML = printContent;
  
  // Deteksi platform
  const isTelegram = /telegram/i.test(navigator.userAgent.toLowerCase());
  const isMobile = isMobileOrTelegram();
  
  if (isMobile && isTelegram) {
    // Telegram Mobile: kasih tau fitur tidak tersedia
    showToast('‚ÑπÔ∏è Export PDF: Gunakan Telegram Desktop atau screenshot halaman ini');
  } else {
    // Desktop atau mobile browser biasa: print
    window.print();
  }
  
  } catch (error) {
    console.error('Error di exportDetailPDF:', error);
    showToast('‚ùå Error: ' + error.message);
  }
}

// =====================
// EDIT MENU MODAL
// =====================
function editMenu(i) {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const m = menuList[i];
  if (!m) return;

  console.log('üìù Edit menu:', m.nama);
  console.log('üßÖ bahanRaw:', m.bahanRaw);
  console.log('‚öôÔ∏è biayaRaw:', m.biayaRaw);

  document.getElementById('edit-idx').value = i;
  document.getElementById('edit-nama').value = m.nama;
  document.getElementById('edit-kategori').value = m.kategori;
  document.getElementById('edit-porsi').value = m.porsi;
  document.getElementById('edit-kemasan').value = m.kemasan || 0;
  document.getElementById('edit-harga-jual').value = Math.round(m.hargaJual);

  // Load foto jika ada
  const previewEdit = document.getElementById('preview-edit-foto');
  if (m.foto) {
    currentFotoBase64 = m.foto; // Set foto saat ini
    previewEdit.innerHTML = `
      <div style="position:relative;display:inline-block;">
        <img src="${m.foto}" style="max-width:200px;max-height:200px;border-radius:12px;border:2px solid var(--border);" />
        <button onclick="hapusFoto('preview-edit-foto', 'edit-foto-menu')" style="position:absolute;top:4px;right:4px;background:var(--red);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-weight:bold;font-size:12px;">√ó</button>
      </div>
    `;
  } else {
    currentFotoBase64 = null;
    previewEdit.innerHTML = '';
    document.getElementById('edit-foto-menu').value = '';
  }

  // Render bahan
  const bahanContainer = document.getElementById('edit-bahan-list');
  bahanContainer.innerHTML = '';
  const bahanData = m.bahanRaw || [];
  console.log(`üîÑ Rendering ${bahanData.length} bahan...`);
  bahanData.forEach((b, j) => {
    console.log(`  - ${b.nama}: ${b.qty} @ Rp ${b.hargaBeli}`);
    bahanContainer.appendChild(buatEditBahanRow(j, b));
  });

  // Render biaya
  const biayaContainer = document.getElementById('edit-biaya-list');
  biayaContainer.innerHTML = '';
  const biayaData = m.biayaRaw || [];
  console.log(`üîÑ Rendering ${biayaData.length} biaya...`);
  biayaData.forEach((b, j) => {
    console.log(`  - ${b.nama}: Rp ${b.biaya}`);
    biayaContainer.appendChild(buatEditBiayaRow(j, b));
  });

  hitungEditHPP();
  document.getElementById('modal-edit').style.display = 'flex';
}

let editBahanCount = 0;
let editBiayaCount = 0;

function buatEditBahanRow(j, b) {
  editBahanCount++;
  const id = editBahanCount;
  const div = document.createElement('div');
  div.className = 'bahan-row';
  div.id = 'edit-bahan-' + id;
  div.innerHTML = `
    <input type="text" value="${b.nama}" placeholder="Nama bahan" oninput="hitungEditHPP()" />
    <input type="number" value="${b.qty}" min="0" step="any" placeholder="Qty" oninput="hitungEditHPP()" />
    <input type="number" value="${b.hargaBeli}" min="0" step="any" placeholder="Harga beli" class="col-harga-satuan" oninput="hitungEditHPP()" />
    <input type="number" value="${b.ukuranBeli}" min="0" step="any" placeholder="Ukuran beli" class="col-harga-satuan" oninput="hitungEditHPP()" />
    <button class="btn btn-danger" onclick="document.getElementById('edit-bahan-${id}').remove(); hitungEditHPP();">‚úï</button>
  `;
  return div;
}

function buatEditBiayaRow(j, b) {
  editBiayaCount++;
  const id = editBiayaCount;
  const div = document.createElement('div');
  div.className = 'biaya-row';
  div.id = 'edit-biaya-' + id;
  div.innerHTML = `
    <input type="text" value="${b.nama}" placeholder="Nama biaya" oninput="hitungEditHPP()" />
    <input type="number" value="${b.biaya}" min="0" step="any" placeholder="Biaya (Rp)" oninput="hitungEditHPP()" />
    <button class="btn btn-danger" onclick="document.getElementById('edit-biaya-${id}').remove(); hitungEditHPP();">‚úï</button>
  `;
  return div;
}

function tambahEditBahan() {
  const container = document.getElementById('edit-bahan-list');
  container.appendChild(buatEditBahanRow(editBahanCount, { nama:'', qty:0, hargaBeli:0, ukuranBeli:1, biaya:0 }));
}

function tambahEditBiaya() {
  const container = document.getElementById('edit-biaya-list');
  container.appendChild(buatEditBiayaRow(editBiayaCount, { nama:'', biaya:0 }));
}

function hitungEditHPP() {
  const porsi = parseFloat(document.getElementById('edit-porsi').value) || 1;
  const kemasan = parseFloat(document.getElementById('edit-kemasan').value) || 0;

  let totalBahan = 0;
  document.querySelectorAll('#edit-bahan-list .bahan-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const qty = parseFloat(inputs[1].value) || 0;
    const hargaBeli = parseFloat(inputs[2].value) || 0;
    const ukuranBeli = parseFloat(inputs[3].value) || 1;
    totalBahan += (qty / ukuranBeli) * hargaBeli;
  });

  let totalBiaya = 0;
  document.querySelectorAll('#edit-biaya-list .biaya-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    totalBiaya += parseFloat(inputs[1].value) || 0;
  });

  const totalKemasan = kemasan * porsi;
  const totalBatch = Math.round(totalBahan + totalKemasan + totalBiaya);
  const hpp = Math.round(totalBatch / porsi);
  const bep = Math.round(hpp / (1 - 0.30));

  const h30 = roundHargaMakanan(hpp / (1 - 0.30));
  const h50 = roundHargaMakanan(hpp / (1 - 0.50));
  const h70 = roundHargaMakanan(hpp / (1 - 0.70));

  document.getElementById('edit-hpp-preview').innerHTML = hpp <= 0 ? '-' : `
    <div style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:baseline;flex-wrap:wrap;gap:4px;">
      <span style="font-size:13px;font-weight:800;color:var(--dark);">
        HPP: <span style="color:var(--red);font-size:16px;">${formatRp(hpp)}/pcs</span>
      </span>
      <span style="font-size:11px;color:var(--muted);font-weight:700;">
        Total batch: ${formatRp(totalBatch)} &nbsp;¬∑&nbsp; Min. BEP: ${formatRp(bep)}
      </span>
    </div>
    <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">
      ‚úÖ Klik untuk pakai sebagai harga jual
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
      <div onclick="pakeHargaEdit(${Math.round(h30)})" style="background:linear-gradient(135deg,#FFF9E6,#FFF3CC);border:2px solid #F5C518;border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:10px;font-weight:800;color:#B8860B;">üü° EKONOMIS</div>
        <div style="font-family:'Fredoka One',cursive;font-size:17px;color:var(--dark);margin:3px 0;">${formatRp(h30)}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:700;">Margin 30%</div>
      </div>
      <div onclick="pakeHargaEdit(${Math.round(h50)})" style="background:linear-gradient(135deg,#E8F5E9,#C8E6C9);border:2px solid #27AE60;border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:10px;font-weight:800;color:#1B5E20;">üü¢ STANDAR</div>
        <div style="font-family:'Fredoka One',cursive;font-size:17px;color:var(--dark);margin:3px 0;">${formatRp(h50)}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:700;">Margin 50%</div>
      </div>
      <div onclick="pakeHargaEdit(${Math.round(h70)})" style="background:linear-gradient(135deg,#FFF0EF,#FFD5D3);border:2px solid var(--red);border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:10px;font-weight:800;color:var(--red);">üî• PREMIUM</div>
        <div style="font-family:'Fredoka One',cursive;font-size:17px;color:var(--dark);margin:3px 0;">${formatRp(h70)}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:700;">Margin 70%</div>
      </div>
    </div>
  `;
}

function pakeHargaEdit(harga) {
  document.getElementById('edit-harga-jual').value = harga;
  // Feedback visual singkat
  const input = document.getElementById('edit-harga-jual');
  input.style.borderColor = 'var(--green)';
  input.style.background = '#F0FDF4';
  setTimeout(() => { input.style.borderColor = ''; input.style.background = ''; }, 1200);
}

function simpanEdit() {
  const i = parseInt(document.getElementById('edit-idx').value);
  const m = menuList[i];
  if (!m) return;

  const porsi = parseFloat(document.getElementById('edit-porsi').value) || 1;
  const kemasan = parseFloat(document.getElementById('edit-kemasan').value) || 0;

  const bahanRaw = [];
  document.querySelectorAll('#edit-bahan-list .bahan-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const nama = inputs[0].value.trim();
    const qty = parseFloat(inputs[1].value) || 0;
    const hargaBeli = parseFloat(inputs[2].value) || 0;
    const ukuranBeli = parseFloat(inputs[3].value) || 1;
    if (!nama || qty === 0) return;
    bahanRaw.push({ nama, qty, hargaBeli, ukuranBeli, biaya: (qty / ukuranBeli) * hargaBeli });
  });

  const biayaRaw = [];
  document.querySelectorAll('#edit-biaya-list .biaya-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const nama = inputs[0].value.trim();
    const biaya = parseFloat(inputs[1].value) || 0;
    if (!nama || biaya === 0) return;
    biayaRaw.push({ nama, biaya });
  });

  const totalBahan = bahanRaw.reduce((s, b) => s + b.biaya, 0);
  const totalBiaya = biayaRaw.reduce((s, b) => s + b.biaya, 0);
  const totalKemasan = kemasan * porsi;
  const totalBatch = totalBahan + totalKemasan + totalBiaya;
  const hpp = totalBatch / porsi;
  const hargaJual = parseFloat(document.getElementById('edit-harga-jual').value) || hpp / (1 - 0.5);

  menuList[i] = {
    ...m,
    id: m.id || ('menu_' + Date.now() + '_' + Math.floor(Math.random() * 1000)), // Pertahankan id lama, buat baru jika belum ada
    nama: document.getElementById('edit-nama').value.trim() || m.nama,
    kategori: document.getElementById('edit-kategori').value,
    porsi, kemasan, bahanRaw, biayaRaw,
    totalBatch, hpp, hargaJual,
    tanggal: getWIBDateTimeString(),
    foto: currentFotoBase64,
  };

  localStorage.setItem('kedaiHeula_menu', JSON.stringify(menuList));
  tutupEdit();
  renderRingkasan();
  showToast(`‚úÖ "${menuList[i].nama}" diperbarui!`);
  autoSyncPush('menu');
}

function tutupEdit() {
  document.getElementById('modal-edit').style.display = 'none';
}


// =====================
// POS (POINT OF SALE) - Grid + Sidebar Cart
// =====================
let posCart = {}; // { menuIdx: qty }

// Global Laporan variables
let currentPeriode = 'hari';
let chartProfit = null;

// Global bundling harga (populated by hitungBundling)
let bundlingHargaData = {
  offlineHemat: 0,
  offlineStandar: 0,
  offlinePremium: 0,
  onlineHemat: 0,
  onlineStandar: 0,
  onlinePremium: 0,
  profitOfflineHemat: 0,
  profitOfflineStandar: 0,
  profitOfflinePremium: 0,
  profitOnlineHemat: 0,
  profitOnlineStandar: 0,
  profitOnlinePremium: 0
};

function renderPOSGrid() {
  const grid = document.getElementById('pos-menu-grid');
  if (!grid) return;
  
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  
  if (data.length === 0) {
    grid.innerHTML = `
      <div style="grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--muted);">
        <div style="font-size:48px;margin-bottom:12px;">üç±</div>
        <p style="font-weight:700;">Belum ada menu</p>
        <small>Hitung HPP dulu di tab "Hitung HPP"</small>
      </div>
    `;
    return;
  }
  
  let html = '';
  const cartType = getCartType();
  const isBlocked = cartType === 'bundling'; // item satuan diblok kalau cart ada bundling

  data.forEach((menu, idx) => {
    const inCart = posCart[idx] || 0;
    const fotoUrl = menu.foto || '';
    const blocked = isBlocked;
    const opacity = blocked ? '0.4' : '1';
    const cursor = blocked ? 'not-allowed' : 'pointer';
    const borderColor = inCart > 0 ? 'var(--orange)' : 'var(--border)';
    
    html += `
      <div onclick="addToCart(${idx})" title="${blocked ? 'Kosongkan keranjang dulu untuk tambah item satuan' : ''}" style="background:var(--card);border:2px solid ${borderColor};border-radius:16px;padding:12px;cursor:${cursor};transition:all 0.2s;position:relative;opacity:${opacity};" ${!blocked ? `onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'"` : ''}>
        ${fotoUrl ? `<img src="${fotoUrl}" style="width:100%;height:100px;object-fit:cover;border-radius:12px;margin-bottom:8px;" />` : `<div style="width:100%;height:100px;background:linear-gradient(135deg,var(--bg),var(--border));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:48px;margin-bottom:8px;">${getCategoryEmoji(menu.kategori)}</div>`}
        <div style="font-weight:800;font-size:13px;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${menu.nama}</div>
        <div style="font-weight:800;color:var(--orange);font-size:14px;">${formatRp(menu.hargaJual)}</div>
        ${inCart > 0 ? `<div style="position:absolute;top:8px;right:8px;background:var(--orange);color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;">${inCart}</div>` : ''}
        ${blocked ? `<div style="position:absolute;inset:0;border-radius:14px;display:flex;align-items:center;justify-content:center;"><span style="background:rgba(0,0,0,0.55);color:white;font-size:10px;font-weight:800;padding:4px 8px;border-radius:8px;">üö´ Item Promo Aktif</span></div>` : ''}
      </div>
    `;
  });
  
  grid.innerHTML = html;
}

function renderPOSBundling() {
  const grid = document.getElementById('pos-bundling-grid');
  const section = document.getElementById('pos-bundling-section');
  if (!grid || !section) return;
  
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const today = new Date().toISOString().split('T')[0];
  
  // Filter active bundling promos only
  const activeBundling = promos.filter(p => 
    p.type === 'bundling' && 
    p.periodeMulai <= today && 
    p.periodeSelesai >= today
  );
  
  if (activeBundling.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  
  let html = '';
  const cartType = getCartType();
  const isBlocked = cartType === 'satuan'; // bundling diblok kalau cart ada item satuan

  activeBundling.forEach((promo, idx) => {
    const inCart = posCart['b-' + promo.id] || 0;
    const blocked = isBlocked;
    const opacity = blocked ? '0.4' : '1';
    const cursor = blocked ? 'not-allowed' : 'pointer';

    html += `
      <div onclick="addBundlingToCart('${promo.id}')" title="${blocked ? 'Kosongkan keranjang dulu untuk tambah item promo' : ''}" style="background:linear-gradient(135deg,#FFF4E6,#FFEBCD);border:2px solid ${inCart > 0 ? 'var(--red)' : 'var(--orange)'};border-radius:16px;padding:12px;cursor:${cursor};transition:all 0.2s;position:relative;opacity:${opacity};" ${!blocked ? `onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'"` : ''}>
        <div style="width:100%;height:100px;background:linear-gradient(135deg,var(--orange),var(--red));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:48px;margin-bottom:8px;">üì¶</div>
        <div style="font-weight:800;font-size:13px;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${promo.nama}</div>
        <div style="font-weight:800;color:var(--red);font-size:14px;">${formatRp(promo.harga || 0)}</div>
        <div style="position:absolute;top:8px;right:8px;background:var(--red);color:white;padding:4px 8px;border-radius:8px;font-weight:700;font-size:10px;">PROMO</div>
        ${inCart > 0 ? `<div style="position:absolute;top:8px;left:8px;background:var(--orange);color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;">${inCart}</div>` : ''}
        ${blocked ? `<div style="position:absolute;inset:0;border-radius:14px;display:flex;align-items:center;justify-content:center;"><span style="background:rgba(0,0,0,0.55);color:white;font-size:10px;font-weight:800;padding:4px 8px;border-radius:8px;">üö´ Item Satuan Aktif</span></div>` : ''}
      </div>
    `;
  });
  
  grid.innerHTML = html;
}

// Bangun objek transaksi dari cart aktif (tanpa simpan)
function buildTransaksiFromCart() {
  const cartKeys = Object.keys(posCart);
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const subtotalEl = document.getElementById('pos-subtotal');
  const subtotal = parseFloat((subtotalEl?.textContent || '').replace(/[^0-9]/g, '')) || 0;
  const bayar = parseFloat(document.getElementById('pos-bayar')?.value) || 0;

  const items = cartKeys.map(key => {
    const qty = posCart[key];
    const isBundling = key.toString().startsWith('b-');
    if (isBundling) {
      const promo = promos.find(p => p.id == key.slice(2));
      if (!promo) return null;
      return { nama: 'üì¶ ' + promo.nama, kategori: 'bundling', qty, hpp: 0, harga: promo.harga || 0, subtotal: (promo.harga || 0) * qty, profit: (promo.harga || 0) * qty };
    } else {
      const menu = data[parseInt(key)];
      if (!menu) return null;
      return { nama: menu.nama, kategori: menu.kategori, qty, hpp: menu.hpp, harga: menu.hargaJual, subtotal: menu.hargaJual * qty, profit: (menu.hargaJual - menu.hpp) * qty };
    }
  }).filter(Boolean);

  return { id: 'PREVIEW-' + Date.now(), timestamp: new Date().toISOString(), items, total: subtotal, bayar, kembalian: Math.max(0, bayar - subtotal) };
}

function lihatDetailOrderCart() {
  if (Object.keys(posCart).length === 0) {
    showToast('‚ö†Ô∏è Keranjang masih kosong');
    return;
  }
  const t = buildTransaksiFromCart();
  lihatNota(t);
}
function getCartType() {
  const keys = Object.keys(posCart);
  if (keys.length === 0) return 'empty';
  const hasBundling = keys.some(k => k.toString().startsWith('b-'));
  const hasSatuan   = keys.some(k => !k.toString().startsWith('b-'));
  if (hasBundling) return 'bundling';
  if (hasSatuan)   return 'satuan';
  return 'empty';
}

function addBundlingToCart(promoId) {
  // Cek konflik: kalau cart sudah ada item satuan, tolak
  const cartType = getCartType();
  if (cartType === 'satuan') {
    showToast('‚ö†Ô∏è Kosongkan keranjang dulu sebelum tambah item promo');
    return;
  }

  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const promo = promos.find(p => p.id == promoId);
  if (!promo) { showToast('‚ö†Ô∏è Promo tidak ditemukan'); return; }

  const key = 'b-' + promoId;
  if (!posCart[key]) posCart[key] = 0;
  posCart[key]++;

  renderPOSGrid();
  renderPOSBundling();
  updateCartSidebar();
  showToast(`‚ûï ${promo.nama} ditambahkan`);
}

function addToCart(menuIdx) {
  // Cek konflik: kalau cart sudah ada item bundling, tolak
  const cartType = getCartType();
  if (cartType === 'bundling') {
    showToast('‚ö†Ô∏è Kosongkan keranjang dulu sebelum tambah item satuan');
    return;
  }

  if (!posCart[menuIdx]) posCart[menuIdx] = 0;
  posCart[menuIdx]++;
  
  renderPOSGrid();
  renderPOSBundling();
  updateCartSidebar();
  showToast('‚ûï Item ditambahkan');
}

function updateCartQty(menuIdx, qty) {
  if (qty <= 0) {
    delete posCart[menuIdx];
  } else {
    posCart[menuIdx] = qty;
  }
  
  renderPOSGrid();
  renderPOSBundling();
  updateCartSidebar();
}

function updateCartSidebar() {
  const container = document.getElementById('pos-cart-items');
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  
  const cartKeys = Object.keys(posCart);
  const totalQty = cartKeys.reduce((s, k) => s + posCart[k], 0);
  
  document.getElementById('pos-cart-count').textContent = totalQty;
  
  if (cartKeys.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:var(--muted);">
        <div style="font-size:48px;margin-bottom:12px;">üõí</div>
        <p>Keranjang kosong</p>
      </div>
    `;
    document.getElementById('pos-subtotal').textContent = 'Rp 0';
    document.getElementById('pos-profit').textContent = 'Rp 0';
    return;
  }
  
  let html = '';
  let subtotal = 0;
  let totalHPP = 0;
  
  cartKeys.forEach(key => {
    const qty = posCart[key];
    const isBundling = key.startsWith('b-');

    if (isBundling) {
      // Item bundling
      const promoId = key.slice(2);
      const promo = promos.find(p => p.id == promoId);
      if (!promo) return;
      const harga = promo.harga || 0;
      const itemTotal = harga * qty;
      subtotal += itemTotal;
      // HPP bundling tidak diketahui secara tepat, set 0 (profit = harga bundling)
      html += `
        <div style="background:linear-gradient(135deg,#FFF4E6,#FFEBCD);border:2px solid var(--orange);border-radius:12px;padding:12px;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;">
                <span style="background:var(--red);color:white;font-size:9px;font-weight:800;padding:2px 6px;border-radius:6px;">PROMO</span>
                <span style="font-weight:800;">üì¶ ${promo.nama}</span>
              </div>
              <div style="font-size:13px;color:var(--muted);">${formatRp(harga)} √ó ${qty}</div>
            </div>
            <div style="font-weight:800;color:var(--orange);">${formatRp(itemTotal)}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button onclick="updateCartQty('${key}', ${qty - 1})" style="width:32px;height:32px;border-radius:8px;border:2px solid var(--border);background:var(--card);font-size:18px;font-weight:800;cursor:pointer;">‚àí</button>
            <input type="number" value="${qty}" onchange="updateCartQty('${key}', parseInt(this.value) || 0)" style="width:60px;text-align:center;padding:6px;border-radius:8px;border:2px solid var(--border);font-weight:800;background:var(--card);" />
            <button onclick="updateCartQty('${key}', ${qty + 1})" style="width:32px;height:32px;border-radius:8px;border:2px solid var(--border);background:var(--card);font-size:18px;font-weight:800;cursor:pointer;">+</button>
            <button onclick="updateCartQty('${key}', 0)" style="margin-left:auto;padding:6px 12px;border-radius:8px;border:none;background:var(--light-red);color:var(--red);font-weight:700;cursor:pointer;">üóëÔ∏è</button>
          </div>
        </div>
      `;
    } else {
      // Item menu biasa
      const menu = data[parseInt(key)];
      if (!menu) return;
      const itemTotal = menu.hargaJual * qty;
      const itemHPP = menu.hpp * qty;
      subtotal += itemTotal;
      totalHPP += itemHPP;
      html += `
        <div style="background:var(--bg);border-radius:12px;padding:12px;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
            <div style="flex:1;">
              <div style="font-weight:800;margin-bottom:4px;">${menu.nama}</div>
              <div style="font-size:13px;color:var(--muted);">${formatRp(menu.hargaJual)} √ó ${qty}</div>
            </div>
            <div style="font-weight:800;color:var(--orange);">${formatRp(itemTotal)}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button onclick="updateCartQty(${key}, ${qty - 1})" style="width:32px;height:32px;border-radius:8px;border:2px solid var(--border);background:var(--card);font-size:18px;font-weight:800;cursor:pointer;">‚àí</button>
            <input type="number" value="${qty}" onchange="updateCartQty(${key}, parseInt(this.value) || 0)" style="width:60px;text-align:center;padding:6px;border-radius:8px;border:2px solid var(--border);font-weight:800;background:var(--card);" />
            <button onclick="updateCartQty(${key}, ${qty + 1})" style="width:32px;height:32px;border-radius:8px;border:2px solid var(--border);background:var(--card);font-size:18px;font-weight:800;cursor:pointer;">+</button>
            <button onclick="updateCartQty(${key}, 0)" style="margin-left:auto;padding:6px 12px;border-radius:8px;border:none;background:var(--light-red);color:var(--red);font-weight:700;cursor:pointer;">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }
  });
  
  container.innerHTML = html;
  
  const profit = subtotal - totalHPP;
  document.getElementById('pos-subtotal').textContent = formatRp(subtotal);
  document.getElementById('pos-profit').textContent = formatRp(profit);

  // Tampilkan/sembunyikan "Gunakan Promo?" berdasarkan tipe cart
  const cartType = getCartType();
  const promoSection = document.getElementById('pos-promo-section');
  if (promoSection) {
    if (cartType === 'satuan') {
      promoSection.style.display = 'block';
      refreshPromoDropdown();
    } else {
      promoSection.style.display = 'none';
      // Reset diskon kalau disembunyikan
      document.getElementById('pos-promo-discount').style.display = 'none';
      document.getElementById('pos-promo-select').value = '';
    }
  }
  
  hitungKembalianPOS();
}

function togglePOSCart() {
  const sidebar = document.getElementById('pos-cart-sidebar');
  const currentRight = sidebar.style.right;
  
  if (currentRight === '0px') {
    sidebar.style.right = '-100%';
  } else {
    sidebar.style.right = '0px';
  }
}

function clearPOSCart() {
  showKonfirmasi({
    icon: 'üóëÔ∏è',
    title: 'Kosongkan Keranjang?',
    message: 'Semua item di keranjang akan dihapus.',
    labelOk: 'Ya, Kosongkan',
    onOk: () => {
      posCart = {};
      renderPOSGrid();
      renderPOSBundling();
      updateCartSidebar();
      showToast('üóëÔ∏è Keranjang dikosongkan');
    }
  });
}

function hitungKembalianPOS() {
  const subtotalText = document.getElementById('pos-subtotal').textContent;
  const subtotal = parseFloat(subtotalText.replace(/[^0-9]/g, '')) || 0;
  const bayar = parseFloat(document.getElementById('pos-bayar').value) || 0;
  const kembalian = bayar - subtotal;
  
  const kembalianEl = document.getElementById('pos-kembalian');
  kembalianEl.textContent = formatRp(kembalian >= 0 ? kembalian : 0);
  kembalianEl.style.color = kembalian >= 0 ? 'var(--green)' : 'var(--red)';
}

function simpanTransaksiPOS() {
  const cartKeys = Object.keys(posCart);
  
  if (cartKeys.length === 0) {
    showToast('‚ö†Ô∏è Keranjang kosong');
    return;
  }
  
  const subtotalText = document.getElementById('pos-subtotal').textContent;
  const subtotal = parseFloat(subtotalText.replace(/[^0-9]/g, '')) || 0;
  const bayar = parseFloat(document.getElementById('pos-bayar').value) || 0;
  
  if (bayar < subtotal) {
    showToast('‚ö†Ô∏è Uang dibayar kurang!');
    return;
  }
  
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const transaksi = {
    id: Date.now(),
    timestamp: new Date().toISOString(),
    items: cartKeys.map(key => {
      const qty = posCart[key];
      const isBundling = key.toString().startsWith('b-');
      if (isBundling) {
        const promoId = key.slice(2);
        const promo = promos.find(p => p.id == promoId);
        if (!promo) return null;
        return {
          nama: 'üì¶ ' + promo.nama,
          kategori: 'bundling',
          qty: qty,
          hpp: 0,
          harga: promo.harga || 0,
          subtotal: (promo.harga || 0) * qty,
          profit: (promo.harga || 0) * qty
        };
      } else {
        const menu = data[parseInt(key)];
        if (!menu) return null;
        return {
          nama: menu.nama,
          kategori: menu.kategori,
          qty: qty,
          hpp: menu.hpp,
          harga: menu.hargaJual,
          subtotal: menu.hargaJual * qty,
          profit: (menu.hargaJual - menu.hpp) * qty
        };
      }
    }).filter(Boolean),
    total: subtotal,
    bayar: bayar,
    kembalian: bayar - subtotal
  };
  
  const today = new Date().toISOString().split('T')[0];
  const key = `kedaiHeula_pos_${today}`;
  const existing = JSON.parse(localStorage.getItem(key) || '[]');
  existing.push(transaksi);
  localStorage.setItem(key, JSON.stringify(existing));
  
  // Reset cart & UI
  posCart = {};
  document.getElementById('pos-bayar').value = '';
  renderPOSGrid();
  renderPOSBundling();
  updateCartSidebar();
  updatePOSSummary();

  // Fix 3: Langsung update tab Laporan agar data masuk realtime
  renderLaporan();
  autoSyncPush('transaksi'); // Auto push transaksi ke cloud

  // Langsung tampilkan nota untuk print
  lihatNota(transaksi);
  showToast('‚úÖ Transaksi berhasil!');
}

function updatePOSSummary() {
  const today = new Date().toISOString().split('T')[0];
  const key = `kedaiHeula_pos_${today}`;
  const transaksi = JSON.parse(localStorage.getItem(key) || '[]');
  
  let totalRevenue = 0;
  let totalProfit = 0;
  
  transaksi.forEach(t => {
    totalRevenue += t.total;
    t.items.forEach(item => totalProfit += item.profit);
  });
  
  document.getElementById('pos-total-revenue').textContent = formatRp(totalRevenue);
  document.getElementById('pos-total-profit').textContent = formatRp(totalProfit);
  document.getElementById('pos-total-trx').textContent = transaksi.length;
}

// =====================
// PROMO MANAGEMENT
// =====================
// Simpan Promo Diskon
function simpanPromoDiskon() {
  const nama = document.getElementById('diskon-nama-promo')?.value?.trim();
  const mulai = document.getElementById('diskon-tgl-mulai')?.value;
  const selesai = document.getElementById('diskon-tgl-selesai')?.value;
  
  if (!nama || !mulai || !selesai) {
    showToast('‚ö†Ô∏è Lengkapi semua field (nama, tanggal mulai & selesai)');
    return;
  }
  
  // Get data from simulation form
  const menuNama = document.getElementById('d-nama')?.value || '';
  const persen = parseFloat(document.getElementById('d-diskon')?.value) || 0;
  const hargaNormal = parseFloat(document.getElementById('d-harga-normal')?.value) || 0;
  
  if (!menuNama || persen <= 0 || hargaNormal <= 0) {
    showToast('‚ö†Ô∏è Harap lakukan simulasi terlebih dahulu');
    return;
  }
  
  const hargaPromo = Math.round(hargaNormal * (1 - persen/100));
  
  const promo = {
    id: Date.now(),
    nama,
    type: 'diskon',
    periodeMulai: mulai,
    periodeSelesai: selesai,
    menuNama,
    persen,
    hargaNormal,
    hargaPromo,
    created: new Date().toISOString()
  };
  
  savePromo(promo);
}

// Helper untuk highlight selected harga bundling
function selectBundlingHarga(radio) {
  // Reset all labels
  document.querySelectorAll('input[name="bundling-harga-promo"]').forEach(r => {
    const lbl = r.closest('label');
    if (lbl) {
      lbl.style.borderColor = 'var(--border)';
      lbl.style.background = 'var(--card)';
    }
  });
  
  // Check radio dan highlight label yang dipilih
  radio.checked = true;
  const lbl = radio.closest('label');
  if (lbl) {
    lbl.style.borderColor = 'var(--orange)';
    lbl.style.background = '#FFF4E6';
  }
}

// Simpan Promo Bundling
function simpanPromoBundling() {
  const nama = document.getElementById('bundling-nama-promo')?.value?.trim();
  const mulai = document.getElementById('bundling-tgl-mulai')?.value;
  const selesai = document.getElementById('bundling-tgl-selesai')?.value;
  
  if (!nama || !mulai || !selesai) {
    showToast('‚ö†Ô∏è Lengkapi semua field');
    return;
  }
  
  // Get selected harga
  const selectedHarga = document.querySelector('input[name="bundling-harga-promo"]:checked');
  if (!selectedHarga) {
    showToast('‚ö†Ô∏è Pilih harga bundling');
    return;
  }
  
  const harga = parseFloat(selectedHarga.value);
  const hargaLabel = selectedHarga.getAttribute('data-label');
  
  const promo = {
    id: Date.now(),
    nama,
    type: 'bundling',
    periodeMulai: mulai,
    periodeSelesai: selesai,
    harga,
    hargaLabel,
    created: new Date().toISOString()
  };
  
  savePromo(promo);
}

// Simpan Promo Beli Gratis
function simpanPromoBeliGratis() {
  const nama = document.getElementById('beli-gratis-nama-promo')?.value?.trim();
  const mulai = document.getElementById('beli-gratis-tgl-mulai')?.value;
  const selesai = document.getElementById('beli-gratis-tgl-selesai')?.value;
  
  if (!nama || !mulai || !selesai) {
    showToast('‚ö†Ô∏è Lengkapi semua field');
    return;
  }
  
  const beli = parseInt(document.getElementById('bg-beli')?.value) || 0;
  const gratis = parseInt(document.getElementById('bg-gratis')?.value) || 0;
  
  if (beli <= 0 || gratis <= 0) {
    showToast('‚ö†Ô∏è Masukkan jumlah beli dan gratis');
    return;
  }
  
  const promo = {
    id: Date.now(),
    nama,
    type: 'beli-gratis',
    periodeMulai: mulai,
    periodeSelesai: selesai,
    beli,
    gratis,
    created: new Date().toISOString()
  };
  
  savePromo(promo);
}

// Helper save promo
function savePromo(promo) {
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  promos.push(promo);
  localStorage.setItem('kedaiHeula_promos', JSON.stringify(promos));
  
  showToast(`‚úÖ Promo "${promo.nama}" disimpan!`);
  refreshPromoDropdown();
  renderPromoList();
  syncPromosToCloud();
  autoSyncPush('promo');
  
  // Reset form simpan & simulasi ke default
  if (promo.type === 'diskon') {
    document.getElementById('diskon-nama-promo').value = '';
    document.getElementById('diskon-tgl-mulai').value = '';
    document.getElementById('diskon-tgl-selesai').value = '';
    document.getElementById('form-simpan-diskon').style.display = 'none';
    // Reset simulasi diskon
    document.getElementById('d-nama').value = '';
    document.getElementById('d-hpp').value = '';
    document.getElementById('d-harga-normal').value = '';
    document.getElementById('d-diskon').value = '20';
    document.getElementById('d-diskon-label').textContent = '20%';
    document.getElementById('diskon-result').style.display = 'none';
    document.getElementById('diskon-result').innerHTML = '';
    const dMenuSel = document.getElementById('d-menu-select');
    if (dMenuSel) dMenuSel.value = '';
  } else if (promo.type === 'bundling') {
    document.getElementById('bundling-nama-promo').value = '';
    document.getElementById('bundling-tgl-mulai').value = '';
    document.getElementById('bundling-tgl-selesai').value = '';
    // Reset pilihan harga bundling
    document.querySelectorAll('input[name="bundling-harga-promo"]').forEach(r => {
      r.checked = false;
      const lbl = r.closest('label');
      if (lbl) { lbl.style.borderColor = 'var(--border)'; lbl.style.background = 'var(--card)'; }
    });
    // Reset simulasi bundling
    document.getElementById('bundling-result').innerHTML = '';
    document.getElementById('bundling-result').style.display = 'none';
    // Reset item bundling ke default
    bundleCount = 0;
    document.getElementById('bundle-items-list').innerHTML = '';
    tambahBundleItem(); tambahBundleItem();
  } else if (promo.type === 'beli-gratis') {
    document.getElementById('beli-gratis-nama-promo').value = '';
    document.getElementById('beli-gratis-tgl-mulai').value = '';
    document.getElementById('beli-gratis-tgl-selesai').value = '';
    // Reset simulasi beli gratis
    document.getElementById('bg-beli').value = '2';
    document.getElementById('bg-gratis').value = '1';
    document.getElementById('bg-hpp').value = '';
    document.getElementById('bg-harga').value = '';
    document.getElementById('bg-channel').value = '';
    document.getElementById('beli-gratis-result').style.display = 'none';
    document.getElementById('beli-gratis-result').innerHTML = '';
    const bgMenuSel = document.getElementById('bg-menu-select');
    if (bgMenuSel) bgMenuSel.value = '';
  }
}



function refreshPromoDropdown() {
  const sel = document.getElementById('pos-promo-select');
  if (!sel) return;
  
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const today = new Date().toISOString().split('T')[0];
  
  // Filter hanya promo aktif
  const activePromos = promos.filter(p => 
    p.periodeMulai <= today && p.periodeSelesai >= today
  );
  
  let html = '<option value="">Tanpa Promo</option>';
  activePromos.forEach(p => {
    const idx = promos.indexOf(p);
    const label = p.type === 'diskon' ? `${p.persen}%` : 
                  p.type === 'bundling' ? 'Paket' : 
                  p.type === 'beli-dapat' ? 'Beli X Gratis Y' : '';
    html += `<option value="${idx}">üè∑Ô∏è ${p.nama} ${label ? `(${label})` : ''}</option>`;
  });
  
  if (activePromos.length === 0) {
    html += '<option value="" disabled>‚ö†Ô∏è Tidak ada promo aktif</option>';
  }
  
  sel.innerHTML = html;
}

function applyPromoToPOS() {
  const sel = document.getElementById('pos-promo-select');
  const idx = sel.value;
  
  if (idx === '') {
    // No promo
    document.getElementById('pos-promo-discount').style.display = 'none';
    updateCartSidebar();
    return;
  }
  
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const promo = promos[parseInt(idx)];
  
  if (!promo) return;
  
  // Calculate discount
  const subtotalText = document.getElementById('pos-subtotal').textContent;
  const subtotal = parseFloat(subtotalText.replace(/[^0-9]/g, '')) || 0;
  
  let discount = 0;
  if (promo.type === 'diskon') {
    discount = subtotal * (promo.persen / 100);
  }
  
  // Show discount
  document.getElementById('pos-promo-discount').style.display = 'block';
  document.getElementById('pos-discount-amount').textContent = '- ' + formatRp(discount);
  
  // Update subtotal
  const newSubtotal = subtotal - discount;
  document.getElementById('pos-subtotal').textContent = formatRp(newSubtotal);
  
  hitungKembalianPOS();
}

// Render daftar promo
function renderPromoList(filter = 'all') {
  const container = document.getElementById('promo-list-container');
  if (!container) return;
  
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const today = new Date().toISOString().split('T')[0];
  
  let filtered = promos.filter(p => {
    if (filter === 'all') return true;
    if (filter === 'active') return p.periodeMulai <= today && p.periodeSelesai >= today;
    if (filter === 'upcoming') return p.periodeMulai > today;
    if (filter === 'expired') return p.periodeSelesai < today;
    return true;
  });
  
  if (filtered.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="es-icon">üè∑Ô∏è</div>
        <p>Belum ada promo tersimpan</p>
        <small>Buat promo di tab Diskon/Bundling/Beli Gratis, lalu klik Simpan</small>
      </div>
    `;
    return;
  }
  
  let html = '';
  filtered.forEach((p, idx) => {
    const isActive = p.periodeMulai <= today && p.periodeSelesai >= today;
    const isUpcoming = p.periodeMulai > today;
    const status = isActive ? '‚úÖ Aktif' : isUpcoming ? 'üïí Upcoming' : '‚è∞ Expired';
    const statusColor = isActive ? 'var(--green)' : isUpcoming ? 'var(--orange)' : 'var(--muted)';
    
    // Find real index in full promos array
    const realIdx = promos.findIndex(promo => promo.id === p.id);
    
    html += `
      <div style="background:var(--card);border:2px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
          <div style="flex:1;">
            <div style="font-weight:800;font-size:15px;margin-bottom:4px;">${p.nama}</div>
            <div style="font-size:12px;color:${statusColor};font-weight:700;">${status}</div>
          </div>
          <span style="background:var(--bg);padding:6px 12px;border-radius:8px;font-size:12px;font-weight:700;">
            ${p.type === 'diskon' ? `${p.persen}%` : p.type}
          </span>
        </div>
        
        <div style="font-size:13px;color:var(--muted);margin-bottom:10px;">
          üìÖ ${formatTanggal(p.periodeMulai)} - ${formatTanggal(p.periodeSelesai)}
        </div>
        
        ${p.menuNama ? `<div style="font-size:13px;margin-bottom:10px;">Menu: <strong>${p.menuNama}</strong></div>` : ''}
        ${p.harga ? `<div style="font-size:13px;margin-bottom:10px;">Harga: <strong>${formatRp(p.harga)}</strong> ${p.hargaLabel ? `(${p.hargaLabel})` : ''}</div>` : ''}
        
        <div style="display:flex;gap:8px;">
          <button onclick="hapusPromo('${p.id}')" style="padding:8px 14px;font-size:12px;border-radius:8px;border:none;background:var(--light-red);color:var(--red);font-weight:700;cursor:pointer;">üóëÔ∏è Hapus</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function filterPromos(filter) {
  // Update button styles
  ['all', 'active', 'upcoming', 'expired'].forEach(f => {
    const btn = document.getElementById(`filter-${f}`);
    if (btn) {
      if (f === filter) {
        btn.style.background = 'var(--orange)';
        btn.style.color = 'white';
      } else {
        btn.style.background = '';
        btn.style.color = '';
      }
    }
  });
  
  renderPromoList(filter);
}

// Reset Form Functions
function resetFormDiskon() {
  document.getElementById('diskon-nama-promo').value = '';
  document.getElementById('diskon-tgl-mulai').value = '';
  document.getElementById('diskon-tgl-selesai').value = '';
  document.getElementById('d-nama').value = '';
  document.getElementById('d-hpp').value = '';
  document.getElementById('d-harga-normal').value = '';
  document.getElementById('d-diskon').value = '10';
  document.getElementById('d-platform-fee').value = '0';
  document.getElementById('diskon-result').style.display = 'none';
  showToast('üîÑ Form direset');
}

function resetFormBundling() {
  document.getElementById('bundling-nama-promo').value = '';
  document.getElementById('bundling-tgl-mulai').value = '';
  document.getElementById('bundling-tgl-selesai').value = '';
  // Reset bundle items to default 2 items
  bundleCount = 0;
  tambahBundleItem();
  tambahBundleItem();
  showToast('üîÑ Form direset');
}

function resetFormBeliGratis() {
  document.getElementById('beli-gratis-nama-promo').value = '';
  document.getElementById('beli-gratis-tgl-mulai').value = '';
  document.getElementById('beli-gratis-tgl-selesai').value = '';
  document.getElementById('bg-menu-select').value = '';
  document.getElementById('bg-beli').value = '2';
  document.getElementById('bg-gratis').value = '1';
  document.getElementById('bg-channel').value = '';
  document.getElementById('bg-hpp').value = '';
  document.getElementById('bg-harga').value = '';
  document.getElementById('bg-fee').value = '20';
  document.getElementById('bg-transaksi').value = '10';
  document.getElementById('bg-fee-row').style.display = 'none';
  document.getElementById('beli-gratis-result').style.display = 'none';
  document.getElementById('beli-gratis-result').innerHTML = '';
  showToast('üîÑ Form direset');
}

function editPromo(promoId) {
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const idx = promos.findIndex(p => p.id == promoId);
  const promo = promos[idx];
  if (!promo) return;
  
  const nama = prompt('Nama promo:', promo.nama);
  if (!nama) return;
  
  const mulai = prompt('Tanggal mulai (YYYY-MM-DD):', promo.periodeMulai);
  if (!mulai) return;
  
  const selesai = prompt('Tanggal selesai (YYYY-MM-DD):', promo.periodeSelesai);
  if (!selesai) return;
  
  promo.nama = nama;
  promo.periodeMulai = mulai;
  promo.periodeSelesai = selesai;
  
  promos[idx] = promo;
  localStorage.setItem('kedaiHeula_promos', JSON.stringify(promos));
  
  showToast('‚úÖ Promo diupdate!');
  renderPromoList();
  syncPromosToCloud();
}

function hapusPromo(promoId) {
  showKonfirmasi({
    icon: 'üóëÔ∏è',
    title: 'Hapus Promo?',
    message: 'Promo ini akan dihapus permanen dari daftar.',
    labelOk: 'Ya, Hapus',
    onOk: () => {
      const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
      const filtered = promos.filter(p => p.id != promoId);
      localStorage.setItem('kedaiHeula_promos', JSON.stringify(filtered));
      showToast('üóëÔ∏è Promo dihapus');
      renderPromoList();
      refreshPromoDropdown();
      syncPromosToCloud();
      autoSyncPush('promo');
    }
  });
}

function exportPromosPDF() {
  showToast('üìÑ Export PDF coming soon...');
  // TODO: Implement PDF export
}

function syncPromosToCloud() {
  const sheetsURL = localStorage.getItem('kedaiHeula_sheetsURL');
  if (!sheetsURL) return;
  
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  
  fetch(sheetsURL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      action: 'syncPromos',
      data: promos
    })
  }).catch(err => console.error('Sync error:', err));
}

// =====================
// HELPERS

// HELPER FUNCTIONS
// =====================

let currentFotoBase64 = null; // Store foto saat ini

// Deteksi apakah di mobile/Telegram
function isMobileOrTelegram() {
  const ua = navigator.userAgent.toLowerCase();
  return /mobile|android|iphone|ipad|telegram/i.test(ua) || window.innerWidth < 768;
}

// Preview foto yang diupload
function previewFoto(input, previewId) {
  const preview = document.getElementById(previewId);
  
  if (input.files && input.files[0]) {
    const file = input.files[0];
    
    // Validasi ukuran (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
      alert('Ukuran foto terlalu besar! Maksimal 2MB.');
      input.value = '';
      preview.innerHTML = '';
      currentFotoBase64 = null;
      return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const original = e.target.result;
      
      // Tampilkan preview dulu (pakai original)
      preview.innerHTML = `
        <div style="position:relative;display:inline-block;">
          <img src="${original}" style="max-width:200px;max-height:200px;border-radius:12px;border:2px solid var(--border);" />
          <button onclick="hapusFoto('${previewId}', '${input.id}')" style="position:absolute;top:4px;right:4px;background:var(--red);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-weight:bold;font-size:12px;">√ó</button>
          <div style="font-size:10px;color:var(--muted);margin-top:4px;">‚è≥ Mengompres foto...</div>
        </div>
      `;
      
      // Kompres foto untuk sync (async)
      try {
        kompresGambar(original, 400, 400, 0.7, (compressed) => {
          currentFotoBase64 = compressed;
          // Update preview message
          const msg = preview.querySelector('div[style*="font-size:10px"]');
          if (msg) msg.textContent = '‚úì Siap untuk sync';
        });
      } catch (err) {
        console.error('Kompresi gagal, pakai original:', err);
        currentFotoBase64 = original; // Fallback ke original
      }
    };
    
    reader.readAsDataURL(file);
  } else {
    preview.innerHTML = '';
    currentFotoBase64 = null;
  }
}

// Kompres gambar untuk mengurangi ukuran base64
function kompresGambar(base64, maxWidth, maxHeight, quality, callback) {
  try {
    const img = new Image();
    
    img.onerror = function() {
      console.error('Gagal load image untuk kompresi');
      callback(base64); // Fallback ke original
    };
    
    img.onload = function() {
      try {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // Hitung resize ratio
        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width = Math.round(width * ratio);
          height = Math.round(height * ratio);
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // Convert ke base64 dengan kompresi
        const compressed = canvas.toDataURL('image/jpeg', quality);
        callback(compressed);
      } catch (err) {
        console.error('Gagal kompres canvas:', err);
        callback(base64); // Fallback ke original
      }
    };
    
    img.src = base64;
  } catch (err) {
    console.error('Error di kompresGambar:', err);
    callback(base64); // Fallback ke original
  }
}

// Hapus foto
function hapusFoto(previewId, inputId) {
  document.getElementById(previewId).innerHTML = '';
  document.getElementById(inputId).value = '';
  currentFotoBase64 = null;
}

// Get current date/time in WIB (UTC+7)
function getWIBDate() {
  const now = new Date();
  // Offset UTC ke WIB (+7 jam = +420 menit)
  const wibOffset = 7 * 60; // menit
  const localOffset = now.getTimezoneOffset(); // offset browser dalam menit (negatif untuk timezones di timur UTC)
  const wibTime = new Date(now.getTime() + (wibOffset + localOffset) * 60000);
  return wibTime;
}

// Format WIB date ke YYYY-MM-DD (untuk input type="date")
function getWIBDateString() {
  const wib = getWIBDate();
  const year = wib.getFullYear();
  const month = String(wib.getMonth() + 1).padStart(2, '0');
  const day = String(wib.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// Format WIB datetime untuk display (DD/MM/YYYY HH:MM)
function getWIBDateTimeString() {
  const wib = getWIBDate();
  return wib.toLocaleString('id-ID', { 
    timeZone: 'Asia/Jakarta',
    year: 'numeric',
    month: '2-digit', 
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Parse tanggal string YYYY-MM-DD dengan asumsi WIB
function parseWIBDate(dateStr) {
  // Parse sebagai midnight WIB, bukan UTC
  return new Date(dateStr + 'T00:00:00+07:00');
}

// Bulatkan harga makanan ke kelipatan yang lebih realistis
function roundHargaMakanan(harga) {
  const rounded = Math.round(harga);
  
  if (rounded < 1000) {
    // Di bawah 1000: bulatkan ke kelipatan 100
    return Math.round(rounded / 100) * 100;
  } else if (rounded < 5000) {
    // 1000-5000: bulatkan ke kelipatan 500
    return Math.round(rounded / 500) * 500;
  } else if (rounded < 10000) {
    // 5000-10000: bulatkan ke kelipatan 1000
    return Math.round(rounded / 1000) * 1000;
  } else {
    // Di atas 10000: bulatkan ke kelipatan 1000
    return Math.round(rounded / 1000) * 1000;
  }
}

function formatRp(num) {
  if (isNaN(num) || !isFinite(num)) return 'Rp 0';
  return 'Rp ' + Math.round(num).toLocaleString('id-ID');
}

function formatTanggal(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  const options = { day: 'numeric', month: 'short', year: 'numeric' };
  return date.toLocaleDateString('id-ID', options);
}

function getCategoryLabel(cat) {
  const map = { takoyaki: 'üêô Takoyaki', dimsum: 'ü•ü Dimsum', ayam: 'üçó Ayam Crispy', lainnya: 'üç± Lainnya' };
  return map[cat] || cat;
}

function getCategoryEmoji(cat) {
  const map = { takoyaki: 'üêô', dimsum: 'ü•ü', ayam: 'üçó', lainnya: 'üç±' };
  return map[cat] || 'üçΩÔ∏è';
}

// State untuk pilihan harga
let selectedMargin = 50;
let selectedChannel = 'offline';
let selectedHargaJual = 0;

function pilihKategoriHarga(margin) {
  selectedMargin = margin;
  
  // Reset highlight semua tombol kategori
  [30, 50, 70].forEach(m => {
    const btn = document.getElementById('btn-kategori-' + m);
    if (!btn) return;
    if (m === 30) { btn.style.boxShadow = ''; btn.style.transform = ''; btn.style.borderColor = '#F5C518'; }
    if (m === 50) { btn.style.boxShadow = ''; btn.style.transform = ''; btn.style.borderColor = '#27AE60'; }
    if (m === 70) { btn.style.boxShadow = ''; btn.style.transform = ''; btn.style.borderColor = '#E03027'; }
  });
  
  // Highlight tombol terpilih
  const selected = document.getElementById('btn-kategori-' + margin);
  if (selected) {
    selected.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    selected.style.transform = 'scale(1.05)';
  }

  // Tampilkan channel selector
  document.getElementById('channel-selector').style.display = 'block';
  
  // Update tampilan harga jika channel sudah dipilih
  updateHargaTerpilih();
}

function pilihChannelHarga(channel) {
  selectedChannel = channel;

  // Reset highlight tombol channel
  ['offline', 'online'].forEach(c => {
    const btn = document.getElementById('btn-channel-' + c);
    if (btn) {
      btn.style.background = 'var(--card)';
      btn.style.borderColor = 'var(--border)';
      btn.style.color = '';
    }
  });

  // Highlight yang dipilih
  const sel = document.getElementById('btn-channel-' + channel);
  if (sel) {
    sel.style.background = channel === 'online' ? '#E8F5E9' : '#EFF8FF';
    sel.style.borderColor = channel === 'online' ? '#27AE60' : '#2196F3';
  }

  updateHargaTerpilih();
}

function updateHargaTerpilih() {
  const hargaEl = document.getElementById('harga-terpilih-display');
  const nilaiEl = document.getElementById('harga-terpilih-nilai');
  const labelEl = document.getElementById('harga-terpilih-label');
  const infoEl  = document.getElementById('harga-terpilih-info');

  if (!hargaEl || !nilaiEl) return;

  // Ambil nilai dari hidden input
  const offlineVal = parseFloat(document.getElementById('harga-' + selectedMargin + '-offline').value) || 0;
  const onlineVal  = parseFloat(document.getElementById('harga-' + selectedMargin + '-online').value) || 0;

  if (offlineVal === 0 && onlineVal === 0) return; // Belum ada data HPP

  const harga = selectedChannel === 'online' ? onlineVal : offlineVal;
  const hpp = lastHPP || 0;
  const profitPerPcs = selectedChannel === 'online'
    ? Math.round(harga * (1 - 0.20)) - hpp  // estimasi setelah fee 20%
    : harga - hpp;

  const kategoriLabel = selectedMargin === 30 ? 'üü° EKONOMIS' : selectedMargin === 50 ? 'üü¢ STANDAR' : 'üî• PREMIUM';
  const channelLabel  = selectedChannel === 'online' ? 'üì± Online (GoFood/Shopee)' : 'üè™ Offline';

  labelEl.textContent = `${kategoriLabel} ¬∑ ${channelLabel}`;
  nilaiEl.textContent = formatRp(harga);
  infoEl.textContent  = `Profit: ${formatRp(profitPerPcs)}/pcs ¬∑ Margin ${selectedMargin}%${selectedChannel === 'online' ? ' (setelah fee ~20%)' : ''}`;

  hargaEl.style.display = 'block';

  // Simpan ke selectedHargaJual untuk dipakai saat simpanMenu
  selectedHargaJual = harga;
}

function pilihHarga(el, type) {
  // Fungsi lama -- sekarang tidak dipakai tapi tetap ada untuk backward compat
}

function resetForm() {
  document.getElementById('nama-menu').value = '';
  document.getElementById('porsi').value = '6';
  document.getElementById('biaya-kemasan').value = '500';
  document.getElementById('bahan-list').innerHTML = '';
  document.getElementById('biaya-list').innerHTML = '';
  document.getElementById('hasil-section').style.display = 'none';
  
  // Reset foto
  document.getElementById('foto-menu').value = '';
  document.getElementById('preview-foto').innerHTML = '';
  currentFotoBase64 = null;
  
  // Reset pilihan harga
  selectedHargaJual = 0;
  selectedMargin = 50;
  selectedChannel = 'offline';
  const channelSel = document.getElementById('channel-selector');
  if (channelSel) channelSel.style.display = 'none';
  const hargaDisp = document.getElementById('harga-terpilih-display');
  if (hargaDisp) hargaDisp.style.display = 'none';
  
  bahanCount = 0; biayaCount = 0;
  tambahBahan(); tambahBahan(); tambahBahan();
  tambahBiaya();
}

function konfirmasiMenuBaru() {
  showKonfirmasi({
    icon: '‚ûï',
    title: 'Input Menu Baru?',
    message: 'Reset form untuk menu baru. Data yang belum disimpan ke Ringkasan akan hilang.',
    labelOk: 'Ya, Reset Form',
    onOk: () => {
      resetForm();
      lastSnapshot = {};
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });
}

function cetakHasil() {
  window.print();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// =====================
// MODAL KONFIRMASI CUSTOM
// =====================
let _konfirmasiCallback = null;

function showKonfirmasi({ icon = '‚ö†Ô∏è', title = 'Konfirmasi', message = 'Yakin?', labelOk = 'Ya, Lanjutkan', onOk }) {
  _konfirmasiCallback = onOk;
  document.getElementById('konfirmasi-icon').textContent = icon;
  document.getElementById('konfirmasi-title').textContent = title;
  document.getElementById('konfirmasi-message').textContent = message;
  document.getElementById('konfirmasi-ok').textContent = labelOk;
  document.getElementById('modal-konfirmasi').style.display = 'flex';
}

function tutupKonfirmasi() {
  document.getElementById('modal-konfirmasi').style.display = 'none';
  _konfirmasiCallback = null;
}

function eksekusiKonfirmasi() {
  document.getElementById('modal-konfirmasi').style.display = 'none';
  if (_konfirmasiCallback) _konfirmasiCallback();
  _konfirmasiCallback = null;
}

// =====================
// MODAL NOTA / DETAIL ORDER
// =====================
let _notaTransaksi = null;

function lihatNota(transaksiObj) {
  _notaTransaksi = transaksiObj;
  renderNotaBody(transaksiObj);
  document.getElementById('modal-nota').style.display = 'flex';
}

function tutupNota() {
  document.getElementById('modal-nota').style.display = 'none';
}

function renderNotaBody(t) {
  const tglDisplay = new Date(t.timestamp).toLocaleString('id-ID', {
    timeZone: 'Asia/Jakarta',
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  });

  let itemRows = '';
  t.items.forEach(item => {
    itemRows += `
      <div style="display:flex;justify-content:space-between;align-items:start;padding:8px 0;border-bottom:1px dashed var(--border);">
        <div style="flex:1;">
          <div style="font-weight:700;font-size:14px;">${item.nama}</div>
          <div style="font-size:12px;color:var(--muted);">${formatRp(item.harga)} √ó ${item.qty}</div>
        </div>
        <div style="font-weight:800;font-size:14px;">${formatRp(item.subtotal)}</div>
      </div>`;
  });

  const profit = t.items.reduce((s, i) => s + (i.profit || 0), 0);

  document.getElementById('nota-body').innerHTML = `
    <!-- Header Nota -->
    <div style="text-align:center;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid var(--border);">
      <div style="font-family:'Fredoka One',cursive;font-size:24px;color:var(--red);">üç± Kedai Heula</div>
      <div style="font-size:11px;color:var(--muted);font-weight:700;margin-top:4px;">Jajanan Mantap Pisan!</div>
      <div style="font-size:12px;color:var(--muted);margin-top:6px;">üìÖ ${tglDisplay}</div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px;">#${t.id}</div>
    </div>

    <!-- Item List -->
    <div style="margin-bottom:16px;">${itemRows}</div>

    <!-- Summary -->
    <div style="background:var(--bg);border-radius:12px;padding:14px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:15px;font-weight:800;">
        <span>Total</span>
        <span style="color:var(--red);">${formatRp(t.total)}</span>
      </div>
      <div style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:13px;color:var(--muted);font-weight:700;">
        <span>üíµ Dibayar</span>
        <span>${formatRp(t.bayar)}</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--green);font-weight:700;">
        <span>üí∞ Kembalian</span>
        <span>${formatRp(t.kembalian)}</span>
      </div>
    </div>

    <div style="text-align:center;margin-top:16px;font-size:12px;color:var(--muted);font-weight:700;">
      - Terima kasih sudah belanja! -
    </div>
  `;
}

function printNota() {
  if (!_notaTransaksi) return;
  const t = _notaTransaksi;
  const tglDisplay = new Date(t.timestamp).toLocaleString('id-ID', {
    timeZone: 'Asia/Jakarta',
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  });

  let itemRows = t.items.map(item => `
    <tr>
      <td style="padding:4px 0;">${item.nama}</td>
      <td style="text-align:center;padding:4px 6px;">${item.qty}x</td>
      <td style="text-align:right;padding:4px 0;">${formatRp(item.harga)}</td>
      <td style="text-align:right;padding:4px 0;font-weight:700;">${formatRp(item.subtotal)}</td>
    </tr>`).join('');

  const htmlParts = [
    '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Nota Kedai Heula<\/title>',
    '<style>* { box-sizing: border-box; margin: 0; padding: 0; }',
    'body { font-family: \'Courier New\', monospace; font-size: 12px; width: 80mm; padding: 8px; }',
    '.center { text-align: center; } .bold { font-weight: bold; }',
    '.line { border-top: 1px dashed #000; margin: 6px 0; }',
    'table { width: 100%; border-collapse: collapse; }',
    '.total-row td { font-weight: bold; font-size: 14px; border-top: 1px solid #000; padding-top: 6px; }',
    '@media print { body { margin: 0; } }',
    '<\/style><\/head><body>',
    '<div class="center bold" style="font-size:16px;margin-bottom:4px;">KEDAI HEULA<\/div>',
    '<div class="center" style="font-size:10px;margin-bottom:2px;">Jajanan Mantap Pisan!<\/div>',
    '<div class="center" style="font-size:10px;">' + tglDisplay + '<\/div>',
    '<div class="center" style="font-size:10px;margin-bottom:6px;">#' + t.id + '<\/div>',
    '<div class="line"><\/div>',
    '<table><tbody>' + itemRows + '<\/tbody>',
    '<tr class="total-row"><td colspan="3">TOTAL<\/td><td style="text-align:right;">' + formatRp(t.total) + '<\/td><\/tr>',
    '<\/table><div class="line"><\/div>',
    '<table>',
    '<tr><td>Dibayar<\/td><td style="text-align:right;">' + formatRp(t.bayar) + '<\/td><\/tr>',
    '<tr><td>Kembalian<\/td><td style="text-align:right;font-weight:bold;">' + formatRp(t.kembalian) + '<\/td><\/tr>',
    '<\/table><div class="line"><\/div>',
    '<div class="center" style="margin-top:8px;font-size:11px;">-- Terima kasih! --<\/div>'
  ];
  const htmlContent = htmlParts.join('') + '<scr' + 'ipt>window.onload=function(){window.print();window.onafterprint=function(){window.close();};}<\/scr' + 'ipt><\/body><\/html>';

  // Buka di popup window terpisah agar layout utama tidak terpengaruh
  const popup = window.open('', 'nota_print', 'width=350,height=600,menubar=no,toolbar=no,status=no');
  if (popup) {
    popup.document.write(htmlContent);
    popup.document.close();
  } else {
    showToast('‚ö†Ô∏è Popup diblok browser. Izinkan popup untuk print nota.');
  }
}

// =====================
// PROMO - SWITCH PANEL
// =====================
let bundleCount = 0;

function switchPromo(type, el) {
  document.querySelectorAll('.promo-type-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.promo-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-' + type).classList.add('active');
  if (type === 'diskon') refreshDropdownDiskon();
  if (type === 'bundling') refreshAllBundleDropdowns();
  if (type === 'aktif') renderPromoList('all');
}

function refreshAllBundleDropdowns() {
  document.querySelectorAll('.bundle-item-row').forEach(row => {
    const idMatch = row.id.match(/bundle-(\d+)/);
    if (!idMatch) return;
    const id = idMatch[1];
    const sel = row.querySelector('select');
    if (!sel) return;
    const currentNama = (document.getElementById('bname-' + id) || {}).value || '';
    sel.innerHTML = getBundleMenuOptions(currentNama);
  });
}

// =====================
// DROPDOWN DARI RINGKASAN
// =====================
function refreshDropdownDiskon() {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const sel = document.getElementById('d-pilih-menu');
  const current = sel.value;

  sel.innerHTML = '<option value="">- Pilih menu yang sudah dihitung HPP-nya -</option>';

  if (data.length === 0) {
    sel.innerHTML += '<option value="" disabled>‚ö†Ô∏è Belum ada menu tersimpan di Ringkasan</option>';
    return;
  }

  data.forEach((m, i) => {
    const label = getCategoryLabel(m.kategori);
    sel.innerHTML += `<option value="${i}">${label} ${m.nama} - HPP: ${formatRp(m.hpp)}</option>`;
  });

  // Pertahankan pilihan sebelumnya jika masih ada
  if (current !== '') sel.value = current;
}

function isiDariRingkasan() {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const idx = document.getElementById('d-pilih-menu').value;

  if (idx === '') {
    document.getElementById('d-menu-info').style.display = 'none';
    return;
  }

  const menu = data[parseInt(idx)];
  if (!menu) return;

  // Isi form
  document.getElementById('d-nama').value = menu.nama;
  document.getElementById('d-hpp').value = Math.round(menu.hpp);
  document.getElementById('d-harga-normal').value = Math.round(menu.hargaJual);

  // Tampilkan info card
  document.getElementById('d-menu-info').style.display = 'block';
  document.getElementById('d-menu-info-nama').textContent = menu.nama;
  document.getElementById('d-menu-info-kategori').textContent = getCategoryLabel(menu.kategori) + ' ¬∑ Tersimpan ' + menu.tanggal;
  document.getElementById('d-menu-info-hpp').textContent = formatRp(menu.hpp);
  document.getElementById('d-menu-info-hj').textContent = formatRp(menu.hargaJual);

  // Langsung hitung
  hitungDiskon();
}

// =====================
// PROMO - DISKON %
// =====================
function updateDiskonSlider() {
  const val = document.getElementById('d-diskon').value;
  document.getElementById('d-diskon-label').textContent = val + '%';
}

function hitungDiskon() {
  const hpp = parseFloat(document.getElementById('d-hpp').value) || 0;
  const hargaNormal = parseFloat(document.getElementById('d-harga-normal').value) || 0;
  const diskon = parseFloat(document.getElementById('d-diskon').value) || 0;
  const platformFee = parseFloat(document.getElementById('d-platform-fee').value) || 0;
  const nama = document.getElementById('d-nama').value || 'Menu';

  if (hpp === 0 || hargaNormal === 0) return;

  const hargaSetelahDiskon = hargaNormal * (1 - diskon / 100);
  const pendapatanBersih = hargaSetelahDiskon * (1 - platformFee / 100);
  const profitPerPcs = pendapatanBersih - hpp;
  const marginNormal = ((hargaNormal * (1 - platformFee / 100) - hpp) / (hargaNormal * (1 - platformFee / 100))) * 100;
  const marginPromo = pendapatanBersih > 0 ? ((profitPerPcs) / pendapatanBersih) * 100 : 0;
  const minHargaDiskon = hpp / (1 - platformFee / 100);

  const isProfit = profitPerPcs > 0;
  const isDangerous = profitPerPcs < 0;
  const isWarning = profitPerPcs >= 0 && profitPerPcs < hpp * 0.1;

  let boxClass = isProfit && !isWarning ? 'profit' : isWarning ? 'warning' : 'danger';

  let verdictText = '';
  if (isDangerous) {
    verdictText = `‚ö†Ô∏è <strong>BONCOS!</strong> Promo diskon ${diskon}% ini bikin kamu rugi ${formatRp(Math.abs(profitPerPcs))} per pcs. Minimal harga jual setelah diskon harus <strong>${formatRp(Math.ceil(minHargaDiskon))}</strong> biar balik modal.`;
  } else if (isWarning) {
    verdictText = `üò¨ <strong>Hati-hati!</strong> Masih untung tipis (${marginPromo.toFixed(1)}%). Promo ini oke buat menarik pelanggan baru tapi jangan kelamaan ya. Maksimal 7-14 hari.`;
  } else {
    verdictText = `‚úÖ <strong>Aman dijalankan!</strong> Margin promo masih ${marginPromo.toFixed(1)}%, turun dari ${marginNormal.toFixed(1)}% normal. Cocok buat promo pembukaan atau flash sale!`;
  }

  const el = document.getElementById('diskon-result');
  el.style.display = 'block';
  el.innerHTML = `
    <div class="promo-result-box ${boxClass}">
      <div style="font-family:'Fredoka One',cursive;font-size:17px;margin-bottom:12px;">
        üìä Hasil Simulasi: ${nama} Diskon ${diskon}%
      </div>
      <div class="promo-result-grid">
        <div class="promo-result-item">
          <span class="pri-label">Harga Normal</span>
          <div class="pri-value">${formatRp(hargaNormal)}</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Harga Setelah Diskon</span>
          <div class="pri-value">${formatRp(hargaSetelahDiskon)}</div>
          <div class="pri-sub">hemat ${formatRp(hargaNormal - hargaSetelahDiskon)}</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Pendapatan Bersih/pcs</span>
          <div class="pri-value">${formatRp(pendapatanBersih)}</div>
          <div class="pri-sub">setelah platform fee ${platformFee}%</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Profit / Rugi per Pcs</span>
          <div class="pri-value">${profitPerPcs >= 0 ? '+' : ''}${formatRp(profitPerPcs)}</div>
          <div class="pri-sub">margin ${marginPromo.toFixed(1)}%</div>
        </div>
      </div>
      <div class="verdict-box">
        <div class="verdict-title">Verdict</div>
        ${verdictText}
      </div>
    </div>
  `;
  
  // Show form simpan promo
  const formSimpan = document.getElementById('form-simpan-diskon');
  if (formSimpan) formSimpan.style.display = 'block';
}

// =====================
// PROMO - BUNDLING
// =====================
function getBundleMenuOptions(selectedNama = '') {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  let opts = `<option value="">- Pilih dari ringkasan -</option>`;
  data.forEach((m, i) => {
    const sel = m.nama === selectedNama ? 'selected' : '';
    opts += `<option value="${i}" ${sel}>${getCategoryLabel(m.kategori)} ${m.nama}</option>`;
  });
  if (data.length === 0) opts += `<option value="" disabled>‚ö†Ô∏è Belum ada menu tersimpan</option>`;
  return opts;
}

function tambahBundleItem() {
  bundleCount++;
  const id = bundleCount;
  const div = document.createElement('div');
  div.className = 'bundle-item-row';
  div.id = 'bundle-' + id;
  div.innerHTML = `
    <select onchange="isiBundle(${id}, this)" style="font-size:13px;padding:10px 12px;border:2px solid var(--border);border-radius:10px;font-family:'Nunito',sans-serif;font-weight:700;background:var(--bg);outline:none;width:100%;">
      ${getBundleMenuOptions()}
    </select>
    <div style="display:flex;flex-direction:column;gap:4px;">
      <div id="bhpp-display-${id}" style="font-size:10px;font-weight:800;color:var(--muted);padding:2px 4px;min-height:16px;"></div>
      <input type="number" id="bhpp-${id}" min="0" step="any" placeholder="HPP/pcs" oninput="hitungBundling()" style="font-size:13px;" />
    </div>
    <div style="display:flex;flex-direction:column;gap:4px;">
      <div id="bhj-display-${id}" style="font-size:10px;font-weight:800;color:var(--green);padding:2px 4px;min-height:16px;"></div>
      <input type="number" id="bhj-${id}" min="0" step="any" placeholder="Harga jual" oninput="hitungBundling()" style="font-size:13px;" />
    </div>
    <input type="number" id="bqty-${id}" min="1" step="1" value="1" oninput="hitungBundling()" style="font-size:13px;" />
    <button class="btn btn-danger" onclick="hapusBundleItem(${id})">‚úï</button>
  `;
  document.getElementById('bundle-list').appendChild(div);
  hitungBundling();
}

function isiBundle(id, selectEl) {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const idx = selectEl.value;
  if (idx === '') return;
  const menu = data[parseInt(idx)];
  if (!menu) return;

  // Set HPP dan Harga Jual
  document.getElementById('bhpp-' + id).value = Math.round(menu.hpp);
  document.getElementById('bhj-' + id).value = Math.round(menu.hargaJual);
  document.getElementById('bhpp-display-' + id).textContent = 'HPP: ' + formatRp(menu.hpp);
  document.getElementById('bhj-display-' + id).innerHTML = 'üí∞ Jual: ' + formatRp(menu.hargaJual);
  
  hitungBundling();
}

function hapusBundleItem(id) {
  const el = document.getElementById('bundle-' + id);
  if (el) { el.remove(); hitungBundling(); }
}

function hitungBundling() {
  let totalHPP = 0;
  let totalHargaJualNormal = 0;
  const itemDetail = [];

  // Cari semua row bundle
  const rows = document.querySelectorAll('.bundle-item-row');
  rows.forEach(row => {
    const idMatch = row.id.match(/bundle-(\d+)/);
    if (!idMatch) return;
    const id = idMatch[1];

    const selectEl  = row.querySelector('select');
    const hppInput  = document.getElementById('bhpp-' + id);
    const hjInput   = document.getElementById('bhj-' + id);
    const qtyInput  = document.getElementById('bqty-' + id);

    if (!selectEl || !hppInput) return;

    const nama  = selectEl.options[selectEl.selectedIndex]?.text || '';
    const hpp   = parseFloat(hppInput.value) || 0;
    const hj    = parseFloat(hjInput ? hjInput.value : 0) || 0;
    const qty   = parseFloat(qtyInput ? qtyInput.value : 1) || 1;

    if (!nama || hpp === 0 || selectEl.value === '') return;

    const subtotalHPP = hpp * qty;
    const subtotalHJ  = hj * qty;
    totalHPP += subtotalHPP;
    totalHargaJualNormal += subtotalHJ;
    itemDetail.push({ nama, hpp, hj, qty, subtotalHPP, subtotalHJ });
  });

  if (totalHPP === 0) {
    document.getElementById('bundling-result').style.display = 'none';
    return;
  }

  const platformFee = 20; // Platform fee default GoFood/Shopee

  // REKOMENDASI OFFLINE (tanpa platform fee)
  const offlineHemat = roundHargaMakanan(totalHPP / (1 - 0.10)); // Margin 10%
  const offlineStandar = roundHargaMakanan(totalHPP / (1 - 0.25)); // Margin 25%
  const offlinePremium = roundHargaMakanan(totalHPP / (1 - 0.35)); // Margin 35%

  // REKOMENDASI ONLINE (dengan platform fee, markup 1.25x dari offline)
  const onlineHemat = roundHargaMakanan(offlineHemat * 1.25); // 25% markup dari offline
  const onlineStandar = roundHargaMakanan(offlineStandar * 1.25);
  const onlinePremium = roundHargaMakanan(offlinePremium * 1.25);

  // Hitung profit untuk setiap skenario
  const profitOfflineHemat = offlineHemat - totalHPP;
  const profitOfflineStandar = offlineStandar - totalHPP;
  const profitOfflinePremium = offlinePremium - totalHPP;

  const profitOnlineHemat = (onlineHemat * (1 - platformFee/100)) - totalHPP;
  const profitOnlineStandar = (onlineStandar * (1 - platformFee/100)) - totalHPP;
  const profitOnlinePremium = (onlinePremium * (1 - platformFee/100)) - totalHPP;
  
  // Save to global for form populate
  bundlingHargaData = {
    offlineHemat, offlineStandar, offlinePremium,
    onlineHemat, onlineStandar, onlinePremium,
    profitOfflineHemat, profitOfflineStandar, profitOfflinePremium,
    profitOnlineHemat, profitOnlineStandar, profitOnlinePremium
  };

  const normalInfo = totalHargaJualNormal > 0
    ? `<div style="font-size:12px;color:#666;margin-bottom:12px;">üí∞ Total harga satuan: <strong>${formatRp(totalHargaJualNormal)}</strong> -> hemat <strong>${formatRp(totalHargaJualNormal - offlineStandar)}</strong> dengan paket standar</div>`
    : '';

  const el = document.getElementById('bundling-result');
  el.style.display = 'block';
  el.innerHTML = `
    ${normalInfo}
    
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;">üîç Detail Item Bundling</div>
      <table class="breakdown-table">
        <thead>
          <tr>
            <th>Item</th>
            <th class="text-right">Qty</th>
            <th class="text-right">HPP/pcs</th>
            <th class="text-right">Harga Jual/pcs</th>
            <th class="text-right">Subtotal HPP</th>
          </tr>
        </thead>
        <tbody>
          ${itemDetail.map(i => `
            <tr>
              <td>${i.nama}</td>
              <td class="text-right">${i.qty}x</td>
              <td class="text-right">${formatRp(i.hpp)}</td>
              <td class="text-right">${i.hj > 0 ? formatRp(i.hj) : '<span style="color:var(--muted)">-</span>'}</td>
              <td class="text-right">${formatRp(i.subtotalHPP)}</td>
            </tr>`).join('')}
          <tr style="border-top:2px solid var(--border);font-weight:800;">
            <td colspan="4" style="text-align:right;padding-top:8px;">Total HPP Paket:</td>
            <td class="text-right" style="padding-top:8px;color:var(--red);">${formatRp(totalHPP)}</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
  
  // Populate pilihan harga bundling  
  const hargaOptions = document.getElementById('bundling-harga-options');
  if (hargaOptions) {
    hargaOptions.innerHTML = `
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${offlineHemat}" data-label="Offline Hemat ~10%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">üü° Offline Hemat</div>
          <div style="color:var(--orange);">${formatRp(offlineHemat)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOfflineHemat)}</div>
        </div>
      </label>
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${onlineHemat}" data-label="Online Hemat ~10%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">üì± Online Hemat</div>
          <div style="color:var(--orange);">${formatRp(onlineHemat)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOnlineHemat)}</div>
        </div>
      </label>
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${offlineStandar}" data-label="Offline Standar ~25%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">üü¢ Offline Standar</div>
          <div style="color:var(--green);">${formatRp(offlineStandar)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOfflineStandar)}</div>
        </div>
      </label>
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${onlineStandar}" data-label="Online Standar ~25%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">üì± Online Standar</div>
          <div style="color:var(--green);">${formatRp(onlineStandar)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOnlineStandar)}</div>
        </div>
      </label>
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${offlinePremium}" data-label="Offline Premium ~35%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">üî• Offline Premium</div>
          <div style="color:var(--red);">${formatRp(offlinePremium)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOfflinePremium)}</div>
        </div>
      </label>
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${onlinePremium}" data-label="Online Premium ~35%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">üì± Online Premium</div>
          <div style="color:var(--red);">${formatRp(onlinePremium)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOnlinePremium)}</div>
        </div>
      </label>
    `;
  }
}


// =====================
// PROMO - BELI X GRATIS Y
// =====================
function refreshDropdownBeliGratis() {
  // Populate dropdown menu untuk Beli X Gratis Y
  const menuData = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const sel = document.getElementById('bg-menu-select');
  if (!sel) return;
  
  let html = '<option value="">-- Pilih Menu --</option>';
  menuData.forEach((m, idx) => {
    html += `<option value="${idx}">${m.nama} - ${formatRp(m.hargaJual || 0)}</option>`;
  });
  sel.innerHTML = html;
}

  

function isiBeliGratis() {
  const sel = document.getElementById('bg-menu-select');
  const idx = sel.value;
  if (idx === '') return;
  
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const menu = data[parseInt(idx)];
  if (!menu) return;
  
  document.getElementById('bg-hpp').value = Math.round(menu.hpp);
  document.getElementById('bg-harga').value = Math.round(menu.hargaJual);
  hitungBeliGratis();
  showToast(`‚úÖ ${menu.nama} dipilih`);
}

function toggleBeliGratisChannel() {
  const channel = document.getElementById('bg-channel').value;
  const feeRow = document.getElementById('bg-fee-row');
  
  if (channel === 'online') {
    // Online - show platform fee
    if (feeRow) feeRow.style.display = 'grid';
    document.getElementById('bg-fee').value = 20;
  } else {
    // Offline or neutral - hide platform fee
    if (feeRow) feeRow.style.display = 'none';
    document.getElementById('bg-fee').value = 0;
  }
  
  hitungBeliGratis();
}

function hitungBeliGratis() {
  const beli = parseFloat(document.getElementById('bg-beli').value) || 1;
  const gratis = parseFloat(document.getElementById('bg-gratis').value) || 1;
  const hpp = parseFloat(document.getElementById('bg-hpp').value) || 0;
  const harga = parseFloat(document.getElementById('bg-harga').value) || 0;
  const fee = parseFloat(document.getElementById('bg-fee').value) || 0;
  const transaksiPerHari = parseFloat(document.getElementById('bg-transaksi').value) || 1;

  if (hpp === 0 || harga === 0) return;

  const totalUnit = beli + gratis;
  const totalBayar = beli * harga;
  const totalHPP = totalUnit * hpp;
  const pendapatanBersih = totalBayar * (1 - fee / 100);
  const profitPerTransaksi = pendapatanBersih - totalHPP;
  const marginPerTransaksi = pendapatanBersih > 0 ? (profitPerTransaksi / pendapatanBersih) * 100 : 0;
  const hargaEfektif = totalBayar / totalUnit; // harga rata-rata yang dibayar per pcs
  const diskonEfektif = ((harga - hargaEfektif) / harga) * 100;

  // Estimasi dampak harian
  const profitHarian = profitPerTransaksi * transaksiPerHari;
  const profitHarianNormal = (harga * (1 - fee / 100) - hpp) * beli * transaksiPerHari;

  const isProfit = profitPerTransaksi > 0;
  const isWarning = profitPerTransaksi >= 0 && marginPerTransaksi < 10;
  let boxClass = !isProfit ? 'danger' : isWarning ? 'warning' : 'profit';

  let verdict = '';
  if (!isProfit) {
    verdict = `‚ö†Ô∏è <strong>Boncos!</strong> Promo beli ${beli} gratis ${gratis} ini rugi ${formatRp(Math.abs(profitPerTransaksi))} per transaksi. Harga jualmu terlalu rendah untuk menanggung item gratis. Coba naikkan harga jual ke minimal ${formatRp(Math.ceil(totalHPP / (1 - fee / 100) / beli))} per pcs.`;
  } else if (isWarning) {
    verdict = `üò¨ <strong>Margin sangat tipis (${marginPerTransaksi.toFixed(1)}%).</strong> Masih bisa jalan tapi riskan. Promo ini setara diskon efektif ${diskonEfektif.toFixed(1)}%. Batasi durasi promo maksimal 1 minggu.`;
  } else {
    verdict = `‚úÖ <strong>Promo ini layak!</strong> Beli ${beli} gratis ${gratis} = diskon efektif ${diskonEfektif.toFixed(1)}% di mata pelanggan. Kamu tetap untung ${formatRp(profitPerTransaksi)} per transaksi!`;
  }

  const el = document.getElementById('beli-gratis-result');
  el.style.display = 'block';
  el.innerHTML = `
    <div class="promo-result-box ${boxClass}">
      <div style="font-family:'Fredoka One',cursive;font-size:17px;margin-bottom:12px;">
        üéÅ Hasil: Beli ${beli} Gratis ${gratis}
      </div>
      <div class="promo-result-grid">
        <div class="promo-result-item">
          <span class="pri-label">Total Unit Keluar</span>
          <div class="pri-value">${totalUnit} pcs</div>
          <div class="pri-sub">beli ${beli} + gratis ${gratis}</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Pendapatan per Transaksi</span>
          <div class="pri-value">${formatRp(pendapatanBersih)}</div>
          <div class="pri-sub">bayar ${beli}x${formatRp(harga)}, fee ${fee}%</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Diskon Efektif</span>
          <div class="pri-value">${diskonEfektif.toFixed(1)}%</div>
          <div class="pri-sub">persepsi pelanggan</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Profit per Transaksi</span>
          <div class="pri-value">${profitPerTransaksi >= 0 ? '+' : ''}${formatRp(profitPerTransaksi)}</div>
          <div class="pri-sub">margin ${marginPerTransaksi.toFixed(1)}%</div>
        </div>
      </div>
      <div class="verdict-box">
        <div class="verdict-title">Verdict</div>
        ${verdict}
        <div style="margin-top:8px;font-size:12px;opacity:0.9;">
          üìÖ Estimasi dampak harian (${transaksiPerHari} transaksi/hari): 
          <strong>${profitHarian >= 0 ? '+' : ''}${formatRp(profitHarian)}</strong> profit
          vs <strong>+${formatRp(profitHarianNormal)}</strong> tanpa promo
        </div>
      </div>
    </div>
  `;
  
  // Show form simpan promo
  const formBeliGratis = document.getElementById('form-simpan-beli-gratis');
  if (formBeliGratis) formBeliGratis.style.display = 'block';
}

// =====================
// AUTO SYNC REALTIME
// =====================

// Debounce timer untuk auto-push
let _autoSyncTimer = null;

// -- Helper: parse tanggal WIB string ke timestamp number -------------------
function parseTanggal(str) {
  if (!str) return 0;
  // Format: "21/02/2026, 05.34" atau ISO string
  try {
    if (str.includes('/')) {
      const [tgl, jam] = str.split(', ');
      const [d, m, y] = tgl.split('/');
      const [h, mn] = (jam || '00.00').split('.');
      return new Date(`${y}-${m}-${d}T${h}:${mn}:00`).getTime();
    }
    return new Date(str).getTime() || 0;
  } catch(e) { return 0; }
}

// -- Deduplikasi array menu: per id, ambil yang tanggal paling baru ----------
function dedupMenu(arr) {
  const map = {};
  arr.forEach(item => {
    if (!item.id) {
      // Item lama tanpa id: pakai nama+hpp sebagai fallback key
      item.id = 'menu_' + btoa(encodeURIComponent((item.nama || '') + '_' + (item.hpp || 0))).substring(0, 20);
    }
    const existing = map[item.id];
    if (!existing) {
      map[item.id] = item;
    } else {
      // Ambil yang lebih baru berdasarkan tanggal
      if (parseTanggal(item.tanggal) > parseTanggal(existing.tanggal)) {
        map[item.id] = item;
      }
    }
  });
  return Object.values(map);
}

// -- Dipanggil saat app pertama kali dibuka ----------------------------------
async function autoSyncOnLoad() {
  const url = getSheetsUrl();
  if (!url) return;

  const statusEl = document.getElementById('sync-status');
  if (statusEl) { statusEl.textContent = 'üîÑ Menyinkronkan data...'; statusEl.style.color = 'var(--orange)'; }

  try {
    // 1. Pull menu dari cloud
    const resMenu = await fetch(authFetchUrl(url + '?action=restore'), { redirect: 'follow' });
    if (resMenu.ok) {
      const result = await resMenu.json();
      if (result.status === 'ok' && Array.isArray(result.data)) {
        const lokal = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
        // Gabungkan cloud + lokal, deduplikasi by id (timestamp terbaru menang)
        const merged = dedupMenu([...result.data, ...lokal]);
        localStorage.setItem('kedaiHeula_menu', JSON.stringify(merged));
        menuList = merged;
        renderRingkasan();
        // Push hasil merged kembali ke cloud agar bersih
        if (merged.length !== result.data.length) {
          fetch(url, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(authPostBody({ action: 'backup', data: merged })), redirect: 'follow' }).catch(() => {});
        }
      }
    }

    // 2. Pull promo dari cloud
    const resPromo = await fetch(authFetchUrl(url + '?action=restore_promos'), { redirect: 'follow' });
    if (resPromo.ok) {
      const result = await resPromo.json();
      if (result.status === 'ok' && Array.isArray(result.data)) {
        const lokal = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
        const cloudMap = {};
        result.data.forEach(p => { if (p.id) cloudMap[p.id] = p; });
        lokal.forEach(p => { if (p.id && !cloudMap[p.id]) cloudMap[p.id] = p; });
        const merged = Object.values(cloudMap);
        localStorage.setItem('kedaiHeula_promos', JSON.stringify(merged));
        renderPromoList();
        refreshPromoDropdown();
      }
    }

    const now = getWIBDateTimeString();
    localStorage.setItem('kedaiHeula_lastSync', now);
    updateSyncStatus();

  } catch(e) {
    console.warn('Auto sync failed:', e.message);
    updateSyncStatus();
  }
}

// -- Sync manual: pull cloud -> merge (timestamp wins) -> push merged ke cloud -
async function syncManual() {
  const url = getSheetsUrl();
  if (!url) { bukaSyncConfig(); return; }

  const statusEl = document.getElementById('sync-status');
  if (statusEl) { statusEl.textContent = 'üîÑ Menyinkronkan...'; statusEl.style.color = 'var(--orange)'; }

  try {
    // STEP 1: Pull dari cloud dulu
    const [resMenu, resPromo] = await Promise.all([
      fetch(authFetchUrl(url + '?action=restore'), { redirect: 'follow' }),
      fetch(authFetchUrl(url + '?action=restore_promos'), { redirect: 'follow' }),
    ]);

    // STEP 2: Merge menu -- timestamp terbaru menang, deduplikasi
    let finalMenu = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
    if (resMenu.ok) {
      const r = await resMenu.json();
      if (r.status === 'ok' && Array.isArray(r.data)) {
        finalMenu = dedupMenu([...r.data, ...finalMenu]);
      }
    }

    // STEP 3: Merge promo -- id unik, cloud + lokal
    let finalPromo = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
    if (resPromo.ok) {
      const r = await resPromo.json();
      if (r.status === 'ok' && Array.isArray(r.data)) {
        const map = {};
        r.data.forEach(p => { if (p.id) map[p.id] = p; });
        finalPromo.forEach(p => { if (p.id && !map[p.id]) map[p.id] = p; });
        finalPromo = Object.values(map);
      }
    }

    // STEP 4: Simpan hasil merge ke lokal
    localStorage.setItem('kedaiHeula_menu', JSON.stringify(finalMenu));
    menuList = finalMenu;
    localStorage.setItem('kedaiHeula_promos', JSON.stringify(finalPromo));

    // STEP 5: Push hasil merged (bersih) ke cloud
    const allKeys = Object.keys(localStorage).filter(k => k.startsWith('kedaiHeula_pos_'));
    let allTrx = [];
    allKeys.forEach(k => { try { allTrx = allTrx.concat(JSON.parse(localStorage.getItem(k) || '[]')); } catch(e) {} });

    await Promise.allSettled([
      fetch(url, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(authPostBody({ action: 'backup', data: finalMenu })), redirect: 'follow' }),
      fetch(url, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(authPostBody({ action: 'syncPromos', data: finalPromo })), redirect: 'follow' }),
      allTrx.length > 0 && fetch(url, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(authPostBody({ action: 'backup_transaksi_v2', data: allTrx })), redirect: 'follow' }),
    ]);

    // STEP 6: Update UI
    renderRingkasan();
    renderPromoList();
    refreshPromoDropdown();
    await pullTrxFromCloud();

    const now = getWIBDateTimeString();
    localStorage.setItem('kedaiHeula_lastSync', now);
    updateSyncStatus();
    showToast('‚úÖ Sync selesai! Data sudah bersih.');
  } catch(e) {
    showToast('‚ùå Sync gagal: ' + e.message);
    if (statusEl) { statusEl.textContent = '‚ùå Sync gagal'; statusEl.style.color = 'var(--red)'; }
  }
}
// Bersihkan duplikat di localStorage dan sync ke cloud
async function bersihkanDuplikat() {
  showKonfirmasi({
    icon: 'üßπ',
    title: 'Bersihkan Duplikat?',
    message: 'Data duplikat di lokal dan Google Sheets akan dihapus. Proses ini aman - hanya menghapus salinan ganda, data asli tetap ada.',
    labelOk: 'Ya, Bersihkan',
    onOk: async () => {
      const url = getSheetsUrl();
      const lokal = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
      const sebelum = lokal.length;
      
      // Deduplikasi lokal
      const bersih = dedupMenu(lokal);
      const sesudah = bersih.length;
      
      localStorage.setItem('kedaiHeula_menu', JSON.stringify(bersih));
      menuList = bersih;
      renderRingkasan();

      // Push yang sudah bersih ke cloud
      if (url) {
        try {
          showToast('üßπ Membersihkan... harap tunggu');
          await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(authPostBody({ action: 'backup', data: bersih })),
            redirect: 'follow'
          });
          const now = getWIBDateTimeString();
          localStorage.setItem('kedaiHeula_lastSync', now);
          updateSyncStatus();
          showToast(`‚úÖ Selesai! ${sebelum - sesudah} duplikat dihapus. Tersisa ${sesudah} menu.`);
        } catch(e) {
          showToast(`‚úÖ Lokal bersih (${sebelum - sesudah} duplikat dihapus), tapi gagal update cloud: ` + e.message);
        }
      } else {
        showToast(`‚úÖ ${sebelum - sesudah} duplikat dihapus dari lokal. Setup cloud untuk sync.`);
      }
    }
  });
}

async function pullPromosFromCloud() {
  const url = getSheetsUrl();
  if (!url) return;
  try {
    const res = await fetch(authFetchUrl(url + '?action=restore_promos'), { redirect: 'follow' });
    if (!res.ok) return;
    const result = await res.json();
    if (result.status === 'ok' && Array.isArray(result.data) && result.data.length > 0) {
      const lokal = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
      const map = {};
      result.data.forEach(p => { if (p.id) map[p.id] = p; });
      lokal.forEach(p => { if (p.id && !map[p.id]) map[p.id] = p; });
      const merged = Object.values(map);
      localStorage.setItem('kedaiHeula_promos', JSON.stringify(merged));
      renderPromoList();
      refreshPromoDropdown();
      refreshAllBundleDropdowns();
      refreshDropdownDiskon();
      refreshDropdownBeliGratis();
    }
  } catch(e) { console.warn('Pull promo failed:', e.message); }
}

// Pull transaksi POS dari cloud (dipanggil saat buka tab POS)
async function pullTrxFromCloud() {
  const url = getSheetsUrl();
  if (!url) return;
  try {
    const res = await fetch(url + '?action=restore_transaksi_v2', { redirect: 'follow' });
    if (!res.ok) return;
    const result = await res.json();
    if (result.status === 'ok' && Array.isArray(result.data) && result.data.length > 0) {
      // Simpan ke localStorage per tanggal
      const byDate = {};
      result.data.forEach(t => {
        if (!t.timestamp) return;
        const tgl = t.timestamp.split('T')[0];
        if (!byDate[tgl]) byDate[tgl] = [];
        byDate[tgl].push(t);
      });

      Object.entries(byDate).forEach(([tgl, trxList]) => {
        const key = `kedaiHeula_pos_${tgl}`;
        const lokal = JSON.parse(localStorage.getItem(key) || '[]');
        const merged = [...lokal];
        trxList.forEach(t => {
          if (!merged.some(m => String(m.id) === String(t.id))) merged.push(t);
        });
        localStorage.setItem(key, JSON.stringify(merged));
      });

      // Update summary POS
      updatePOSSummary();
    }
  } catch(e) { console.warn('Pull transaksi failed:', e.message); }
}
function autoSyncPush(type = 'menu') {
  clearTimeout(_autoSyncTimer);
  _autoSyncTimer = setTimeout(() => {
    const url = getSheetsUrl();
    if (!url) return;

    if (type === 'menu') {
      const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(authPostBody({ action: 'backup', data })),
        redirect: 'follow'
      }).then(r => r.json()).then(result => {
        if (result.status === 'ok') {
          const now = getWIBDateTimeString();
          localStorage.setItem('kedaiHeula_lastSync', now);
          updateSyncStatus();
        }
      }).catch(e => console.warn('Auto push menu failed:', e));

    } else if (type === 'promo') {
      syncPromosToCloud();

    } else if (type === 'transaksi') {
      // Kumpulkan semua transaksi POS
      const allKeys = Object.keys(localStorage).filter(k => k.startsWith('kedaiHeula_pos_'));
      let allTrx = [];
      allKeys.forEach(k => {
        try { allTrx = allTrx.concat(JSON.parse(localStorage.getItem(k) || '[]')); } catch(e) {}
      });
      if (allTrx.length === 0) return;
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(authPostBody({ action: 'backup_transaksi_v2', data: allTrx })),
        redirect: 'follow'
      }).catch(e => console.warn('Auto push transaksi failed:', e));
    }
  }, 2000); // Tunggu 2 detik setelah perubahan terakhir
}

// =====================
// CLOUD SYNC (Google Sheets)
// =====================

function debugLog(msg, isError = false) {
  const debugEl = document.getElementById('debug-log');
  if (debugEl) {
    debugEl.style.display = 'block';
    const time = new Date().toLocaleTimeString('id-ID');
    const color = isError ? '#F38BA8' : '#A6E3A1';
    debugEl.innerHTML += `<div style="color:${color};margin-bottom:4px;">[${time}] ${msg}</div>`;
    debugEl.scrollTop = debugEl.scrollHeight;
  }
}

function getSheetsUrl() {
  return localStorage.getItem('kedaiHeula_sheetsUrl') || '';
}

function updateSyncStatus() {
  const url = getSheetsUrl();
  const lastSync = localStorage.getItem('kedaiHeula_lastSync');
  const el = document.getElementById('sync-status');
  if (!el) return;
  if (!url) {
    el.textContent = 'Belum dikonfigurasi - klik Setup untuk mulai';
    el.style.color = 'var(--muted)';
  } else if (lastSync) {
    el.textContent = '‚úÖ Terakhir sync: ' + lastSync;
    el.style.color = 'var(--green)';
  } else {
    el.textContent = '‚ö†Ô∏è URL tersimpan, belum pernah sync';
    el.style.color = 'var(--orange)';
  }
}

function bukaSyncConfig() {
  const url = getSheetsUrl();
  const input = document.getElementById('sheets-url-input');
  // Pre-fill dengan URL yang tersimpan, atau URL default jika belum ada
  if (url) {
    input.value = url;
  }
  
  // Clear debug log
  const debugEl = document.getElementById('debug-log');
  if (debugEl) {
    debugEl.innerHTML = '';
    debugEl.style.display = 'none';
  }
  
  document.getElementById('modal-sync').style.display = 'flex';
}

function tutupSyncConfig() {
  document.getElementById('modal-sync').style.display = 'none';
}

async function simpanSyncConfig() {
  const url = document.getElementById('sheets-url-input').value.trim();
  if (!url || !url.startsWith('https://script.google.com')) {
    showToast('‚ö†Ô∏è URL tidak valid');
    return;
  }
  localStorage.setItem('kedaiHeula_sheetsUrl', url);
  tutupSyncConfig();
  showToast('‚úÖ URL tersimpan! Mencoba koneksi...');
  await syncKeSheets(true);
}

async function syncKeSheets(isTest = false) {
  const url = getSheetsUrl();
  if (!url) {
    bukaSyncConfig();
    return;
  }
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  if (!isTest && data.length === 0) {
    showToast('‚ö†Ô∏è Tidak ada data untuk di-backup');
    return;
  }

  const btnSync = document.getElementById('btn-sync');
  const origText = btnSync.innerHTML;
  btnSync.innerHTML = '‚è≥ Menyimpan...';
  btnSync.disabled = true;

  try {
    debugLog('üîÑ Mulai backup...');
    debugLog('üìç URL: ' + url.substring(0, 50) + '...');
    debugLog('üì¶ Data: ' + data.length + ' menu');
    
    // Log ukuran foto untuk debug
    data.forEach((item, i) => {
      if (item.foto) {
        const sizeKB = Math.round(item.foto.length / 1024);
        debugLog(`üì∏ ${item.nama}: foto ${sizeKB}KB`);
      }
    });
    
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(authPostBody({ action: 'backup', data: data })),
      redirect: 'follow'
    });
    
    debugLog('üì° Response status: ' + res.status);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const result = await res.json();
    debugLog('‚úÖ Response: ' + JSON.stringify(result).substring(0, 100));
    
    if (result.status === 'ok') {
      const now = getWIBDateTimeString();
      localStorage.setItem('kedaiHeula_lastSync', now);
      updateSyncStatus();
      debugLog('‚úÖ Backup berhasil!');
      showToast(isTest ? '‚úÖ Koneksi berhasil! Data tersimpan.' : `‚úÖ Backup berhasil! ${data.length} menu tersimpan.`);
    } else {
      throw new Error(result.message || 'Unknown error');
    }
  } catch (e) {
    debugLog('‚ùå ERROR: ' + e.message, true);
    
    let errorMsg = 'Gagal backup';
    
    if (e.message.includes('Failed to fetch')) {
      errorMsg += ': Cek URL atau deploy ulang Apps Script';
      debugLog('üí° TIP: Buka Setup -> cek URL sudah benar', true);
    } else if (e.message.includes('HTTP 404')) {
      errorMsg += ': URL tidak ditemukan';
      debugLog('üí° TIP: Deploy ulang Apps Script -> copy URL baru', true);
    } else if (e.message.includes('HTTP 403')) {
      errorMsg += ': Permission ditolak';
      debugLog('üí° TIP: Set "Who has access" = Anyone di Apps Script', true);
    } else {
      errorMsg += ': ' + e.message;
    }
    
    showToast('‚ùå ' + errorMsg);
  } finally {
    btnSync.innerHTML = origText;
    btnSync.disabled = false;
  }
}

async function restoreFromSheets() {
  const url = getSheetsUrl();
  if (!url) {
    bukaSyncConfig();
    return;
  }
  
  const lokal = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const lokalCount = lokal.length;
  
  let confirmMsg = 'Restore data dari Google Sheets?';
  if (lokalCount > 0) {
    confirmMsg += `\n\nData lokal: ${lokalCount} menu.\nData akan digabung (tidak dihapus).`;
  } else {
    confirmMsg += '\n\nData lokal kosong, akan diisi dari cloud.';
  }
  
  showKonfirmasi({
    icon: '‚òÅÔ∏è',
    title: 'Restore dari Cloud?',
    message: lokalCount > 0
      ? `Data lokal: ${lokalCount} menu. Data cloud akan digabung (tidak menghapus data lokal).`
      : 'Data lokal kosong. Data akan diisi dari cloud.',
    labelOk: 'Ya, Restore',
    onOk: async () => {

  const btnRestore = document.getElementById('btn-restore');
  const origText = btnRestore.innerHTML;
  btnRestore.innerHTML = '‚è≥ Memuat...';
  btnRestore.disabled = true;

  try {
    // CRITICAL: tambahkan ?action=restore ke URL untuk GET request
    const fetchUrl = url.includes('?') ? url + '&action=restore' : url + '?action=restore';
    const res = await fetch(fetchUrl, { 
      method: 'GET',
      redirect: 'follow'
    });
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const result = await res.json();
    
    if (result.status === 'ok' && Array.isArray(result.data)) {
      const cloud = result.data;
      
      if (cloud.length === 0) {
        showToast('‚ö†Ô∏è Tidak ada data di Google Sheets. Backup dulu sebelum restore.');
        return;
      }
      
      // Merge berdasarkan id (bukan nama+tanggal)
      const cloudMap = {};
      cloud.forEach(item => {
        if (!item.id) item.id = 'menu_' + Date.now() + '_' + Math.floor(Math.random() * 9999);
        cloudMap[item.id] = item;
      });
      lokal.forEach(item => {
        if (!item.id) item.id = 'menu_' + Date.now() + '_' + Math.floor(Math.random() * 9999);
        if (!cloudMap[item.id]) cloudMap[item.id] = item;
      });
      const merged = Object.values(cloudMap);
      const added = merged.length - cloud.length;
      
      localStorage.setItem('kedaiHeula_menu', JSON.stringify(merged));
      menuList = merged;
      renderRingkasan();
      
      showToast(`‚úÖ Restore berhasil! ${cloud.length} menu dari cloud, ${added > 0 ? added + ' menu lokal ditambahkan. ' : ''}Total: ${merged.length} menu.`);
    } else {
      throw new Error(result.message || 'Data tidak valid dari server');
    }
  } catch (e) {
    showToast('‚ùå Gagal restore: ' + e.message);
    console.error('Restore error:', e);
  } finally {
    btnRestore.innerHTML = origText;
    btnRestore.disabled = false;
  }
  } // end onOk
  }); // end showKonfirmasi
}

// =====================


function initLaporan() {
  // Set tanggal hari ini (WIB)
  document.getElementById('transaksi-tanggal').value = getWIBDateString();
  
  // Populate dropdown menu
  const menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const select = document.getElementById('transaksi-menu');
  select.innerHTML = '<option value="">-- Pilih Menu --</option>' +
    menuList.map((m, i) => `<option value="${i}">${m.nama} (${formatRp(m.hargaJual)})</option>`).join('');
  
  setPeriodeLaporan('semua'); // Default: tampilkan semua transaksi
}

function setTanggalTransaksi(mode) {
  const input = document.getElementById('transaksi-tanggal');
  const wib = getWIBDate();
  
  if (mode === 'kemarin') {
    wib.setDate(wib.getDate() - 1);
  }
  // mode 'hari-ini' tidak perlu ubah date
  
  const year = wib.getFullYear();
  const month = String(wib.getMonth() + 1).padStart(2, '0');
  const day = String(wib.getDate()).padStart(2, '0');
  input.value = `${year}-${month}-${day}`;
}

function isiHargaTransaksi() {
  const idx = parseInt(document.getElementById('transaksi-menu').value);
  if (isNaN(idx)) return;
  const menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const m = menuList[idx];
  if (!m) return;
  document.getElementById('transaksi-hpp').value = m.hpp;
  document.getElementById('transaksi-harga').value = m.hargaJual;
}

function simpanTransaksi() {
  const tanggal = document.getElementById('transaksi-tanggal').value;
  const menuIdx = parseInt(document.getElementById('transaksi-menu').value);
  const qty     = parseInt(document.getElementById('transaksi-qty').value) || 0;
  const hpp     = parseFloat(document.getElementById('transaksi-hpp').value) || 0;
  const harga   = parseFloat(document.getElementById('transaksi-harga').value) || 0;

  if (!tanggal || isNaN(menuIdx) || qty <= 0 || hpp <= 0 || harga <= 0) {
    alert('Isi semua field dengan benar');
    return;
  }

  const menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const menu = menuList[menuIdx];
  if (!menu) return;

  const transaksi = {
    id: Date.now() + Math.floor(Math.random() * 1000), // Tambah random untuk hindari collision
    tanggal: tanggal,
    menu: menu.nama,
    qty: qty,
    hpp: hpp,
    hargaJual: harga,
    profit: (harga - hpp) * qty,
    timestamp: getWIBDateTimeString() // WIB timezone
  };

  const listTransaksi = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  listTransaksi.push(transaksi);
  localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(listTransaksi));

  console.log('Transaksi tersimpan:', transaksi);
  console.log('Total transaksi di localStorage:', listTransaksi.length);

  showToast(`‚úÖ Transaksi tersimpan! Profit: ${formatRp(transaksi.profit)}`);
  
  // Reset form
  document.getElementById('transaksi-qty').value = 1;
  document.getElementById('transaksi-menu').value = '';
  document.getElementById('transaksi-hpp').value = '';
  document.getElementById('transaksi-harga').value = '';
  
  // Re-render laporan untuk update tampilan
  renderLaporan();
}

function setPeriodeLaporan(periode) {
  currentPeriode = periode;
  ['hari', 'minggu', 'bulan', 'semua'].forEach(p => {
    const btn = document.getElementById(`btn-period-${p}`);
    if (btn) {
      if (p === periode) {
        btn.style.background = 'linear-gradient(135deg, var(--red), var(--orange))';
        btn.style.color = 'white';
        btn.style.borderColor = 'transparent';
      } else {
        btn.style.background = 'white';
        btn.style.color = 'var(--dark)';
        btn.style.borderColor = 'var(--border)';
      }
    }
  });
  renderLaporan();
}

function filterTransaksiByPeriode(transaksiList) {
  if (currentPeriode === 'semua') {
    return transaksiList; // Return semua tanpa filter
  }
  
  const wibNow = getWIBDate();
  wibNow.setHours(0, 0, 0, 0); // Reset ke awal hari
  const today = getWIBDateString(); // Format YYYY-MM-DD
  
  return transaksiList.filter(t => {
    const tDate = parseWIBDate(t.tanggal); // Parse dengan timezone WIB
    tDate.setHours(0, 0, 0, 0);
    
    if (currentPeriode === 'hari') {
      return t.tanggal === today;
    } else if (currentPeriode === 'minggu') {
      // 7 hari terakhir termasuk hari ini
      const weekAgo = new Date(wibNow);
      weekAgo.setDate(weekAgo.getDate() - 6);
      return tDate >= weekAgo && tDate <= wibNow;
    } else {
      // Bulan ini = dari tanggal 1 bulan ini sampai hari ini
      const startOfMonth = new Date(wibNow.getFullYear(), wibNow.getMonth(), 1);
      return tDate >= startOfMonth && tDate <= wibNow;
    }
  });
}

function renderLaporan() {
  const allTransaksi = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  const filtered = filterTransaksiByPeriode(allTransaksi);

  // Summary
  const totalProfit = filtered.reduce((s, t) => s + t.profit, 0);
  const totalTransaksi = filtered.length;
  const totalItem = filtered.reduce((s, t) => s + t.qty, 0);

  document.getElementById('lap-profit').textContent = formatRp(totalProfit);
  document.getElementById('lap-transaksi').textContent = totalTransaksi;
  document.getElementById('lap-item').textContent = totalItem + ' pcs';

  // Breakdown per menu
  renderBreakdownMenu(filtered);

  // Chart
  renderChart(filtered);

  // Tabel
  renderTabelTransaksi(filtered);
}

function renderBreakdownMenu(transaksiList) {
  const container = document.getElementById('breakdown-menu');
  
  if (transaksiList.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px;">Belum ada transaksi</p>';
    return;
  }

  // Group by menu
  const byMenu = {};
  transaksiList.forEach(t => {
    if (!byMenu[t.menu]) {
      byMenu[t.menu] = { qty: 0, profit: 0, transaksi: 0 };
    }
    byMenu[t.menu].qty += t.qty;
    byMenu[t.menu].profit += t.profit;
    byMenu[t.menu].transaksi += 1;
  });

  // Sort by profit descending
  const menuList = Object.keys(byMenu).map(menu => ({
    menu: menu,
    ...byMenu[menu]
  })).sort((a, b) => b.profit - a.profit);

  const totalProfit = menuList.reduce((s, m) => s + m.profit, 0);

  let html = `<table class="breakdown-table">
    <thead>
      <tr>
        <th>Menu</th>
        <th class="text-right">Qty Terjual</th>
        <th class="text-right">Transaksi</th>
        <th class="text-right">Total Profit</th>
        <th class="text-right">% Kontribusi</th>
        <th class="text-right">Avg/Item</th>
      </tr>
    </thead>
    <tbody>`;

  menuList.forEach((item, idx) => {
    const avgProfit = item.profit / item.qty;
    const percentage = totalProfit > 0 ? (item.profit / totalProfit * 100) : 0;
    const isTop = idx < 3; // Top 3 menu
    
    const bgColor = isTop ? '#FFF8E6' : '';
    const badge = isTop ? ['ü•á','ü•à','ü•â'][idx] : '';
    
    html += `<tr style="background:${bgColor};">
      <td>
        ${badge ? `<span style="font-size:16px;margin-right:6px;">${badge}</span>` : ''}
        <strong style="color:${isTop ? 'var(--orange)' : 'inherit'};">${item.menu}</strong>
      </td>
      <td class="text-right">${item.qty} pcs</td>
      <td class="text-right">${item.transaksi}x</td>
      <td class="text-right" style="font-weight:800;color:var(--green);">${formatRp(item.profit)}</td>
      <td class="text-right">
        <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
          <div style="background:#E8F5E9;height:20px;width:${Math.min(percentage, 100)}%;min-width:2px;border-radius:4px;"></div>
          <span style="font-weight:700;font-size:11px;color:var(--green);">${percentage.toFixed(1)}%</span>
        </div>
      </td>
      <td class="text-right">${formatRp(avgProfit)}</td>
    </tr>`;
  });

  // Total row
  const totalQty = menuList.reduce((s, m) => s + m.qty, 0);
  const totalTransaksi = menuList.reduce((s, m) => s + m.transaksi, 0);

  html += `<tr class="total-row">
    <td><strong>Total</strong></td>
    <td class="text-right"><strong>${totalQty} pcs</strong></td>
    <td class="text-right"><strong>${totalTransaksi}x</strong></td>
    <td class="text-right"><strong>${formatRp(totalProfit)}</strong></td>
    <td class="text-right"><strong>100%</strong></td>
    <td class="text-right">-</td>
  </tr>`;

  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderChart(transaksiList) {
  const ctx = document.getElementById('chart-profit');
  if (!ctx) return;

  if (transaksiList.length === 0) {
    if (chartProfit) chartProfit.destroy();
    ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
    return;
  }

  // Group by date
  const byDate = {};
  transaksiList.forEach(t => {
    if (!byDate[t.tanggal]) byDate[t.tanggal] = 0;
    byDate[t.tanggal] += t.profit;
  });

  // Sort tanggal ascending (dari lama ke baru)
  const dates = Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b));
  const profits = dates.map(d => byDate[d]);

  // Format label tanggal
  const labels = dates.map(d => {
    const date = new Date(d + 'T00:00:00');
    return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
  });

  if (chartProfit) chartProfit.destroy();

  chartProfit = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Profit (Rp)',
        data: profits,
        borderColor: '#E03027',
        backgroundColor: 'rgba(224, 48, 39, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.3,
        pointBackgroundColor: '#E03027',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => 'Profit: Rp ' + ctx.parsed.y.toLocaleString('id-ID')
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => 'Rp ' + val.toLocaleString('id-ID')
          }
        }
      }
    }
  });
}

function renderTabelTransaksi(transaksiList) {
  const container = document.getElementById('tabel-transaksi');
  if (transaksiList.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px;">Belum ada transaksi</p>';
    return;
  }

  let html = `<table class="breakdown-table">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Menu</th>
        <th class="text-right">Qty</th>
        <th class="text-right">HPP</th>
        <th class="text-right">Harga Jual</th>
        <th class="text-right">Profit</th>
        <th></th>
      </tr>
    </thead>
    <tbody>`;

  transaksiList.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).forEach(t => {
    const displayDate = parseWIBDate(t.tanggal).toLocaleDateString('id-ID', { timeZone: 'Asia/Jakarta' });
    html += `<tr>
      <td>${displayDate}</td>
      <td>${t.menu}</td>
      <td class="text-right">${t.qty} pcs</td>
      <td class="text-right">${formatRp(t.hpp)}</td>
      <td class="text-right">${formatRp(t.hargaJual)}</td>
      <td class="text-right" style="font-weight:800;color:var(--green);">${formatRp(t.profit)}</td>
      <td><button class="btn-hapus-transaksi" data-id="${t.id}" title="Klik 2x untuk hapus" style="background:var(--red);color:white;border:none;border-radius:6px;font-size:11px;padding:4px 8px;cursor:pointer;font-weight:700;">üóëÔ∏è</button></td>
    </tr>`;
  });

  html += '</tbody></table>';
  container.innerHTML = html;

  // Attach event listeners dengan double-click protection
  container.querySelectorAll('.btn-hapus-transaksi').forEach(btn => {
    let clickCount = 0;
    let clickTimer = null;
    
    btn.addEventListener('click', function() {
      const id = parseInt(this.getAttribute('data-id'));
      clickCount++;
      
      if (clickCount === 1) {
        // First click - warning visual
        this.style.background = '#F39C12';
        this.textContent = '‚ö†Ô∏è Klik lagi';
        
        clickTimer = setTimeout(() => {
          // Reset after 2 seconds
          clickCount = 0;
          this.style.background = 'var(--red)';
          this.textContent = 'üóëÔ∏è';
        }, 2000);
        
      } else if (clickCount === 2) {
        // Second click - delete
        clearTimeout(clickTimer);
        clickCount = 0;
        
        let list = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
        const before = list.length;
        
        list = list.filter(t => t.id !== id);
        const after = list.length;
        
        if (before === after) {
          console.error('Transaksi tidak ditemukan, ID:', id);
          showToast('‚ùå Transaksi tidak ditemukan');
          return;
        }
        
        localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(list));
        console.log(`Transaksi ID ${id} dihapus. Sisa: ${after} transaksi`);
        
        renderLaporan();
        showToast('üóëÔ∏è Transaksi dihapus');
      }
    });
  });
}

// =====================
// EXPORT LAPORAN PDF
// =====================

function syncTransaksiKeSheets() {
  const url = getSheetsUrl();
  if (!url) {
    showToast('‚ö†Ô∏è Setup Google Sheets dulu di Ringkasan Menu -> Setup Cloud');
    bukaSyncConfig();
    return;
  }

  // Kumpulkan semua transaksi POS dari localStorage (format V2 multi-item)
  const allKeys = Object.keys(localStorage).filter(k => k.startsWith('kedaiHeula_pos_'));
  let allTransaksi = [];
  allKeys.forEach(k => {
    try {
      const data = JSON.parse(localStorage.getItem(k) || '[]');
      allTransaksi = allTransaksi.concat(data);
    } catch(e) {}
  });

  if (allTransaksi.length === 0) {
    showToast('‚ö†Ô∏è Tidak ada transaksi POS untuk di-backup');
    return;
  }

  showKonfirmasi({
    icon: '‚òÅÔ∏è',
    title: 'Backup Transaksi POS?',
    message: `${allTransaksi.length} transaksi akan di-backup ke Google Sheets.`,
    labelOk: 'Ya, Backup',
    onOk: () => {
      showToast('‚òÅÔ∏è Menyimpan transaksi...');
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(authPostBody({ action: 'backup_transaksi_v2', data: allTransaksi })),
        redirect: 'follow'
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === 'ok') {
          const now = getWIBDateTimeString();
          localStorage.setItem('kedaiHeula_lastSyncTransaksi', now);
          showToast(`‚úÖ ${result.count} transaksi baru berhasil disimpan ke Sheets!`);
        } else {
          throw new Error(result.message || 'Unknown error');
        }
      })
      .catch(e => {
        showToast('‚ùå Gagal backup transaksi: ' + e.message);
        console.error(e);
      });
    }
  });
}

async function restoreTransaksiFromSheets() {
  const url = getSheetsUrl();
  if (!url) {
    showToast('‚ö†Ô∏è Setup Google Sheets dulu');
    bukaSyncConfig();
    return;
  }

  const lokal = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  const lokalCount = lokal.length;
  
  const pesanConfirm = lokalCount > 0
    ? `Data lokal: ${lokalCount} transaksi. Data cloud akan digabung (tidak menghapus data lokal).`
    : 'Data lokal kosong. Data akan diisi dari cloud.';

  showKonfirmasi({
    icon: '‚òÅÔ∏è',
    title: 'Restore Transaksi?',
    message: pesanConfirm,
    labelOk: 'Ya, Restore',
    onOk: async () => {

  showToast('‚è≥ Memuat transaksi dari cloud...');

  try {
    const fetchUrl = url.includes('?') ? url + '&action=restore_transaksi' : url + '?action=restore_transaksi';
    const res = await fetch(fetchUrl, { 
      method: 'GET',
      redirect: 'follow'
    });
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const result = await res.json();
    
    if (result.status === 'ok' && Array.isArray(result.data)) {
      const cloud = result.data;
      
      if (cloud.length === 0) {
        showToast('‚ö†Ô∏è Tidak ada transaksi di Google Sheets. Backup dulu sebelum restore.');
        return;
      }
      
      // Merge: gabungkan data cloud dengan lokal, hindari duplikat berdasarkan id
      const merged = [...lokal];
      let added = 0;
      
      cloud.forEach(item => {
        const exists = merged.some(t => t.id === item.id);
        if (!exists) {
          merged.push(item);
          added++;
        }
      });
      
      localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(merged));
      
      showToast(`‚úÖ Restore berhasil! ${cloud.length} transaksi dari cloud, ${added} transaksi baru ditambahkan. Total: ${merged.length} transaksi.`);
      
      // Re-render laporan
      renderLaporan();
    } else {
      throw new Error(result.message || 'Data tidak valid dari server');
    }
  } catch (e) {
    showToast('‚ùå Gagal restore: ' + e.message);
    console.error('Restore error:', e);
  }

  } // end onOk
  }); // end showKonfirmasi
}

// Sync promo ke Google Sheets
function syncPromosToCloud() {
  const url = getSheetsUrl();
  if (!url) return; // silent fail jika belum setup

  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(authPostBody({ action: 'syncPromos', data: promos })),
    redirect: 'follow'
  }).catch(err => console.warn('Sync promo error:', err));
}

// Restore promo dari Google Sheets
async function restorePromosFromCloud() {
  const url = getSheetsUrl();
  if (!url) {
    showToast('‚ö†Ô∏è Setup Google Sheets dulu');
    bukaSyncConfig();
    return;
  }

  const lokal = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');

  showKonfirmasi({
    icon: 'üè∑Ô∏è',
    title: 'Restore Promo dari Cloud?',
    message: lokal.length > 0
      ? `Ada ${lokal.length} promo lokal. Data cloud akan digabung.`
      : 'Data promo akan diisi dari cloud.',
    labelOk: 'Ya, Restore',
    onOk: async () => {
      showToast('‚è≥ Memuat promo dari cloud...');
      try {
        const fetchUrl = url.includes('?') ? url + '&action=restore_promos' : url + '?action=restore_promos';
        const res = await fetch(fetchUrl, { method: 'GET', redirect: 'follow' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const result = await res.json();
        if (result.status === 'ok' && Array.isArray(result.data)) {
          const merged = [...lokal];
          let added = 0;
          result.data.forEach(p => {
            if (!merged.some(m => m.id == p.id)) { merged.push(p); added++; }
          });
          localStorage.setItem('kedaiHeula_promos', JSON.stringify(merged));
          renderPromoList();
          refreshPromoDropdown();
          showToast(`‚úÖ ${added} promo baru ditambahkan dari cloud!`);
        } else {
          throw new Error(result.message || 'Data tidak valid');
        }
      } catch(e) {
        showToast('‚ùå Gagal restore promo: ' + e.message);
      }
    }
  });
}

function exportLaporanPDF() {
  try {
    const allTransaksi = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
    const filtered = filterTransaksiByPeriode(allTransaksi);
    
    if (filtered.length === 0) {
      showToast('‚ö†Ô∏è Tidak ada transaksi untuk di-export');
      return;
    }

  // Summary data
  const totalProfit = filtered.reduce((s, t) => s + t.profit, 0);
  const totalTransaksi = filtered.length;
  const totalItem = filtered.reduce((s, t) => s + t.qty, 0);

  // Breakdown per menu
  const byMenu = {};
  filtered.forEach(t => {
    if (!byMenu[t.menu]) {
      byMenu[t.menu] = { qty: 0, profit: 0, transaksi: 0 };
    }
    byMenu[t.menu].qty += t.qty;
    byMenu[t.menu].profit += t.profit;
    byMenu[t.menu].transaksi += 1;
  });

  const menuList = Object.keys(byMenu).map(menu => ({
    menu: menu,
    ...byMenu[menu]
  })).sort((a, b) => b.profit - a.profit);

  // Periode label
  const periodeLabel = {
    'hari': 'Hari Ini',
    'minggu': '7 Hari Terakhir',
    'bulan': 'Bulan Ini',
    'semua': 'Semua Periode'
  }[currentPeriode] || 'Periode Terpilih';

  const tanggalCetak = getWIBDateTimeString();

  // Build breakdown table
  let breakdownRows = '';
  menuList.forEach((item, idx) => {
    const avgProfit = item.profit / item.qty;
    const percentage = totalProfit > 0 ? (item.profit / totalProfit * 100) : 0;
    const isTop = idx < 3;
    const badge = isTop ? ['ü•á','ü•à','ü•â'][idx] : '';
    
    breakdownRows += `
      <tr style="background:${isTop ? '#FFF8E6' : 'white'};">
        <td>${badge} <strong>${item.menu}</strong></td>
        <td class="pr-num">${item.qty} pcs</td>
        <td class="pr-num">${item.transaksi}x</td>
        <td class="pr-num"><strong>${formatRp(item.profit)}</strong></td>
        <td class="pr-num">${percentage.toFixed(1)}%</td>
        <td class="pr-num">${formatRp(avgProfit)}</td>
      </tr>`;
  });

  // Build transaksi table
  let transaksiRows = '';
  filtered.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).forEach(t => {
    const displayDate = parseWIBDate(t.tanggal).toLocaleDateString('id-ID', { timeZone: 'Asia/Jakarta' });
    transaksiRows += `
      <tr>
        <td>${displayDate}</td>
        <td>${t.menu}</td>
        <td class="pr-num">${t.qty} pcs</td>
        <td class="pr-num">${formatRp(t.hpp)}</td>
        <td class="pr-num">${formatRp(t.hargaJual)}</td>
        <td class="pr-num"><strong>${formatRp(t.profit)}</strong></td>
      </tr>`;
  });

  const printContent = `
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: Arial, sans-serif; color: #1A1A1A; font-size: 12px; }

      .doc-header { display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 3px solid #E03027; margin-bottom: 16px; }
      .brand { font-size: 18px; font-weight: 900; color: #E03027; }
      .brand-sub { font-size: 9px; color: #888; font-weight: 700; text-transform: uppercase; margin-top: 2px; }
      .doc-meta { text-align: right; }
      .doc-meta .meta-title { font-size: 14px; font-weight: 900; }
      .doc-meta .meta-sub { font-size: 9px; color: #888; margin-top: 2px; }

      .summary-bar { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 16px; }
      .sum-box { background: #FFF8F0; border: 2px solid #F0E0CC; border-radius: 8px; padding: 10px; text-align: center; }
      .sum-label { font-size: 8px; font-weight: 700; color: #888; text-transform: uppercase; display: block; }
      .sum-value { font-size: 14px; font-weight: 900; color: #E03027; display: block; margin-top: 3px; }

      h3 { font-size: 12px; font-weight: 900; color: #E03027; margin: 14px 0 6px; padding-bottom: 4px; border-bottom: 2px solid #F0E0CC; }
      h3:first-of-type { margin-top: 0; }
      
      table { width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 10px; }
      thead tr { background: #F47C20 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      thead th { padding: 6px 8px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
      tbody tr:nth-child(even) { background: #FFF8F0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      tbody td { padding: 6px 8px; border-bottom: 1px solid #F0E0CC; }
      .pr-num { text-align: right; }
      .total-row td { background: #FFF3E0 !important; font-weight: 700; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

      .doc-footer { margin-top: 16px; padding-top: 8px; border-top: 2px solid #F0E0CC; display: flex; justify-content: space-between; font-size: 9px; color: #aaa; }
    <\/style>

    <div class="doc-header">
      <div>
        <div class="brand">üç± Kedai Heula</div>
        <div class="brand-sub">Laporan Penjualan</div>
      </div>
      <div class="doc-meta">
        <div class="meta-title">${periodeLabel}</div>
        <div class="meta-sub">${totalTransaksi} transaksi ¬∑ ${totalItem} pcs terjual</div>
      </div>
    </div>

    <div class="summary-bar">
      <div class="sum-box">
        <span class="sum-label">üí∞ Total Profit</span>
        <span class="sum-value">${formatRp(totalProfit)}</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">üì¶ Total Transaksi</span>
        <span class="sum-value">${totalTransaksi}</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">üç± Item Terjual</span>
        <span class="sum-value">${totalItem} pcs</span>
      </div>
    </div>

    <h3>üìä Breakdown per Menu</h3>
    <table>
      <thead>
        <tr>
          <th>Menu</th>
          <th class="pr-num">Qty</th>
          <th class="pr-num">Transaksi</th>
          <th class="pr-num">Total Profit</th>
          <th class="pr-num">% Kontribusi</th>
          <th class="pr-num">Avg/Item</th>
        </tr>
      </thead>
      <tbody>
        ${breakdownRows}
        <tr class="total-row">
          <td><strong>Total</strong></td>
          <td class="pr-num"><strong>${totalItem} pcs</strong></td>
          <td class="pr-num"><strong>${totalTransaksi}x</strong></td>
          <td class="pr-num"><strong>${formatRp(totalProfit)}</strong></td>
          <td class="pr-num"><strong>100%</strong></td>
          <td class="pr-num">-</td>
        </tr>
      </tbody>
    </table>

    <h3>üìã Riwayat Transaksi</h3>
    <table>
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Menu</th>
          <th class="pr-num">Qty</th>
          <th class="pr-num">HPP</th>
          <th class="pr-num">Harga Jual</th>
          <th class="pr-num">Profit</th>
        </tr>
      </thead>
      <tbody>
        ${transaksiRows}
      </tbody>
    </table>

    <div class="doc-footer">
      <span>Kedai Heula - Laporan Penjualan</span>
      <span>Dicetak: ${tanggalCetak}</span>
    </div>
  `;

  const printArea = document.getElementById('print-area');
  if (!printArea) {
    showToast('‚ùå Error: print-area tidak ditemukan');
    console.error('print-area element tidak ada');
    return;
  }
  
  printArea.innerHTML = printContent;
  
  const isTelegram = /telegram/i.test(navigator.userAgent.toLowerCase());
  const isMobile = isMobileOrTelegram();
  
  if (isMobile && isTelegram) {
    showToast('‚ÑπÔ∏è Export PDF: Gunakan Telegram Desktop atau screenshot halaman ini');
  } else {
    window.print();
  }
  
  } catch (error) {
    console.error('Error di exportLaporanPDF:', error);
    showToast('‚ùå Error: ' + error.message);
  }
}

// Init: sudah digabung di window.onload di atas
</script>
</div><!-- end app-wrapper -->
</body>
</html>
