<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Kedai Heula - Aplikasi manajemen bisnis kuliner lengkap: hitung HPP, kelola menu, analisa penjualan, dan strategi promo">
<title>Kedai Heula â€“ Jajanan Mantap Pisani</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root {
    --red: #E03027;
    --orange: #F47C20;
    --yellow: #F5C518;
    --dark: #1A1A1A;
    --bg: #FFF4E6;
    --card: #FFFAF5;
    --muted: #888;
    --border: #FFE4CC;
    --green: #27AE60;
    --light-red: #FFF0EF;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    color: var(--dark);
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: linear-gradient(135deg, var(--red) 0%, var(--orange) 60%, var(--yellow) 100%);
    padding: 16px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    box-shadow: 0 4px 20px rgba(224,48,39,0.3);
    position: sticky;
    top: 0;
    z-index: 50;
  }

  header .logo-text {
    font-family: 'Fredoka One', cursive;
    font-size: 28px;
    color: white;
    text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
    line-height: 1;
  }

  header .logo-sub {
    font-size: 12px;
    color: rgba(255,255,255,0.85);
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 2px;
  }

  header .badge {
    margin-left: auto;
    background: rgba(255,255,255,0.2);
    color: white;
    font-size: 11px;
    font-weight: 800;
    padding: 6px 14px;
    border-radius: 20px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.3);
  }

  /* TABS */
  /* ===== SIDEBAR LAYOUT ===== */
  .app-layout {
    display: flex;
    min-height: calc(100vh - 72px);
  }

  /* Sidebar */
  .tabs-wrapper {
    width: 200px;
    flex-shrink: 0;
    background: var(--card);
    border-right: 1.5px solid var(--border);
    padding: 20px 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    position: sticky;
    top: 72px;
    height: calc(100vh - 72px);
    overflow-y: auto;
    box-shadow: 2px 0 8px rgba(0,0,0,0.04);
  }

  .sidebar-section-label {
    font-size: 10px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 12px 10px 6px;
    margin-top: 4px;
  }

  .sidebar-section-label:first-child { margin-top: 0; padding-top: 0; }

  .tab-grid {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     TAB NAVIGATION
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tab-icon {
    background: transparent;
    border: none;
    border-radius: 12px;
    padding: 11px 14px;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: all 0.18s ease;
    font-family: 'Nunito', sans-serif;
    width: 100%;
    text-align: left;
    min-width: 0;
  }
  .tab-icon:hover { background: var(--bg); }
  .tab-icon.active {
    background: linear-gradient(135deg, rgba(224,48,39,0.12), rgba(244,124,32,0.12));
    border-left: 3px solid var(--orange);
    padding-left: 11px;
  }
  .tab-icon.active .ti-label { color: var(--orange); font-weight: 900; }
  .ti-icon { font-size: 20px; line-height: 1; flex-shrink: 0; }
  .ti-label { font-size: 13px; font-weight: 700; color: var(--dark); line-height: 1.2; }



  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     MAIN CONTENT
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main {
    flex: 1;
    padding: 24px;
    min-width: 0;
    overflow-x: hidden;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     MOBILE (â‰¤768px): sidebar â†’ bottom scrollable navbar
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 768px) {
    .app-layout { flex-direction: column; min-height: unset; }

    .tabs-wrapper {
      width: 100%; height: auto;
      position: static;
      border-right: none;
      border-bottom: 1.5px solid var(--border);
      padding: 10px 12px 8px;
      flex-direction: row;
      overflow-x: auto; overflow-y: hidden;
      gap: 0;
      -webkit-overflow-scrolling: touch;
    }
    .tabs-wrapper::-webkit-scrollbar { display: none; }
    .sidebar-section-label { display: none !important; }
    .tab-grid { flex-direction: row; gap: 4px; flex-wrap: nowrap; }
    .tab-icon {
      flex-direction: column;
      padding: 8px 10px;
      border-radius: 10px;
      gap: 4px;
      min-width: 68px;
      align-items: center;
      border-left: none !important;
    }
    .tab-icon.active {
      border-left: none !important;
      border-bottom: 3px solid var(--orange);
      border-radius: 10px 10px 0 0;
      padding-left: 10px;
    }
    .ti-icon { font-size: 20px; }
    .ti-label { font-size: 10px; text-align: center; }
    .main { padding: 16px; }

    /* KASIR MOBILE: sembunyikan navbar, full screen POS */
    body.role-kasir .tabs-wrapper { display: none !important; }
    body.role-kasir .app-layout   { display: block !important; }
    body.role-kasir .main         { padding: 0 !important; max-width: 100% !important; }
    body.role-kasir header        { padding: 10px 14px !important; }
    body.role-kasir .logo-sub     { display: none !important; }
  }

  /* KASIR DESKTOP: sidebar 72px, hanya ikon POS */
  @media (min-width: 769px) {
    body.role-kasir .tabs-wrapper {
      width: 72px !important;
      padding: 16px 8px !important;
    }
    body.role-kasir #tab-btn-pos {
      flex-direction: column !important;
      gap: 4px !important;
      padding: 10px 6px !important;
      width: 56px !important;
      align-items: center !important;
    }
    body.role-kasir #tab-btn-pos .ti-label {
      font-size: 10px !important;
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     POS LAYOUT â€” SPLIT DESKTOP / STACKED MOBILE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #tab-pos { margin: -24px; padding: 0; overflow: hidden; }
  #pos-layout { display: flex; flex-direction: row; height: calc(100vh - 72px); overflow: hidden; }
  #pos-menu-area { flex: 1; min-width: 0; overflow-y: auto; padding: 16px; -webkit-overflow-scrolling: touch; }
  #pos-menu-grid, #pos-bundling-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
  }

  /* Cart panel: kanan desktop */
  #pos-cart-panel {
    width: 290px; min-width: 260px; max-width: 290px;
    flex-shrink: 0;
    display: flex; flex-direction: column;
    border-left: 2px solid var(--border);
    background: var(--card);
    overflow: hidden;
  }
  #pos-cart-items { flex: 1; overflow-y: auto; padding: 8px 12px; }

  /* Floating button: HIDDEN di desktop */
  #pos-cart-btn   { display: none !important; }
  #pos-cart-overlay { display: none; }
  #pos-cart-overlay.active {
    display: block; position: fixed; inset: 0;
    background: rgba(0,0,0,0.5); z-index: 499;
    backdrop-filter: blur(2px);
  }

  /* SELESAI button */
  #btn-selesai-pos { transition: all 0.2s; }
  #btn-selesai-pos:disabled { opacity: 0.35; cursor: not-allowed; box-shadow: none !important; }

  /* POS MOBILE (â‰¤768px): stacked, cart slide dari bawah */
  @media (max-width: 768px) {
    #tab-pos    { margin: 0 !important; padding: 0 !important; overflow: visible !important; }
    #pos-layout { display: block !important; height: auto !important; overflow: visible !important; }
    #pos-menu-area { display: block !important; width: 100% !important; overflow: visible !important; padding: 12px 12px 90px !important; }
    #pos-menu-grid, #pos-bundling-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px !important; }

    /* Cart panel: tersembunyi, muncul dari bawah */
    #pos-cart-panel {
      display: none !important;
      position: fixed !important; bottom: 0 !important; left: 0 !important; right: 0 !important;
      width: 100% !important; max-width: 100% !important; min-width: unset !important;
      height: 88vh !important; border-left: none !important;
      border-top: 2px solid var(--border) !important;
      border-radius: 20px 20px 0 0 !important;
      box-shadow: 0 -8px 40px rgba(0,0,0,0.25) !important;
      z-index: 500 !important; overflow: hidden !important;
    }
    #pos-cart-panel.mobile-open {
      display: flex !important;
      animation: slideUpCart 0.28s ease !important;
    }
    @keyframes slideUpCart {
      from { transform: translateY(100%); }
      to   { transform: translateY(0); }
    }

    /* Floating cart button: VISIBLE di mobile */
    #pos-cart-btn {
      display: flex !important;
      position: fixed !important; bottom: 20px !important; right: 20px !important;
      width: 60px !important; height: 60px !important;
      border-radius: 50% !important;
      background: linear-gradient(135deg, var(--orange), var(--red)) !important;
      color: white !important; border: none !important;
      box-shadow: 0 4px 20px rgba(224,48,39,0.5) !important;
      font-size: 22px !important; cursor: pointer !important;
      z-index: 200 !important; align-items: center !important; justify-content: center !important;
    }
  }

  /* POS DESKTOP: force cart panel di kanan */
  @media (min-width: 769px) {
    #pos-cart-panel { display: flex !important; position: static !important; }
    #pos-cart-btn   { display: none !important; }
    #pos-layout     { flex-direction: row !important; }
  }

  /* Kelola Akun */
  #tab-akun { max-width: 680px; margin: 0 auto; width: 100%; }
  @media (max-width: 520px) {
    #tab-akun .form-row { grid-template-columns: 1fr !important; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ROLE-BASED: ini HARUS di baris paling bawah CSS
     agar menang dari semua rule di atas
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .tab-admin-only { display: none !important; }
  body.role-admin .tab-admin-only { display: flex !important; }
  body.role-admin div.tab-admin-only { display: block !important; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<!-- â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-screen" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;background:#FFF4E6;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;">

  <div style="width:100%;max-width:400px;background:#FFFAF5;border-radius:24px;box-shadow:0 8px 40px rgba(224,48,39,0.15),0 2px 8px rgba(0,0,0,0.08);border:1.5px solid #FFE4CC;overflow:hidden;font-family:'Nunito',sans-serif;">

    <!-- Banner merah gradient -->
    <div style="background:linear-gradient(135deg,#E03027 0%,#F47C20 60%,#F5C518 100%);padding:28px 28px 24px;text-align:center;">
      <div style="width:64px;height:64px;margin:0 auto 12px;background:rgba(255,255,255,0.2);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:34px;box-shadow:0 4px 16px rgba(0,0,0,0.2);">ğŸ±</div>
      <div style="font-family:'Fredoka One',cursive;font-size:24px;color:white;text-shadow:0 1px 4px rgba(0,0,0,0.2);">Kedai Heula</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.85);margin-top:4px;font-weight:600;">Manajemen Bisnis Kuliner â€” Jajanan Mantap Pisan!</div>
    </div>

    <!-- Form body -->
    <div style="padding:24px 24px 20px;">

      <!-- ID field -->
      <div style="margin-bottom:16px;">
        <label style="display:block;font-size:11px;font-weight:800;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">ID Pengguna</label>
        <div style="position:relative;">
          <span style="position:absolute;left:13px;top:50%;transform:translateY(-50%);font-size:15px;opacity:0.45;pointer-events:none;">ğŸ‘¤</span>
          <input type="text" id="login-id"
            placeholder="Masukkan ID kamu..."
            autocomplete="username"
            onkeydown="if(event.key==='Enter')document.getElementById('login-pass').focus()"
            style="width:100%;padding:12px 14px 12px 40px;border-radius:12px;border:2px solid #FFE4CC;background:#FFF4E6;color:#1A1A1A;font-size:14px;font-family:'Nunito',sans-serif;font-weight:600;outline:none;box-sizing:border-box;" />
        </div>
      </div>

      <!-- Password field -->
      <div style="margin-bottom:20px;">
        <label style="display:block;font-size:11px;font-weight:800;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Password</label>
        <div style="position:relative;">
          <span style="position:absolute;left:13px;top:50%;transform:translateY(-50%);font-size:15px;opacity:0.45;pointer-events:none;">ğŸ”’</span>
          <input type="password" id="login-pass"
            placeholder="Masukkan password..."
            autocomplete="current-password"
            onkeydown="if(event.key==='Enter')doLoginClick()"
            style="width:100%;padding:12px 14px 12px 40px;border-radius:12px;border:2px solid #FFE4CC;background:#FFF4E6;color:#1A1A1A;font-size:14px;font-family:'Nunito',sans-serif;font-weight:600;outline:none;box-sizing:border-box;" />
        </div>
      </div>

      <!-- Tombol -->
      <button id="login-btn" onclick="doLoginClick()"
        style="width:100%;padding:13px;border-radius:12px;border:none;background:linear-gradient(135deg,#E03027,#F47C20);color:white;font-size:15px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;box-shadow:0 4px 14px rgba(224,48,39,0.35);">
        ğŸ”“ &nbsp;Masuk
      </button>

      <!-- Error -->
      <div id="login-error" style="display:none;margin-top:12px;padding:10px 14px;background:#FFF0EF;border:2px solid #E03027;border-radius:10px;font-size:13px;color:#E03027;font-weight:700;text-align:center;"></div>
    </div>

    <!-- Setup URL Panel (collapsible) -->
    

    <!-- Footer -->
    <div style="padding:12px 24px 18px;border-top:2px solid #FFE4CC;text-align:center;">
      
      <div style="font-size:11px;color:#888;font-weight:600;line-height:1.7;">
        Developed by <a href="https://github.com/0xduraku" target="_blank" style="color:#F47C20;text-decoration:none;font-weight:700;">0xduraku</a>
        &nbsp;Â·&nbsp; Â© 2025 Kedai Heula<br>
        Sistem manajemen HPP &amp; kasir untuk UMKM kuliner
      </div>
      <span style="display:inline-block;margin-top:6px;font-size:10px;color:#888;background:#FFE4CC;border-radius:20px;padding:2px 10px;font-weight:700;">v2.0 Â· Auth Edition</span>
    </div>
  </div>
</div>

<div id="app-wrapper" style="display:none;">
<header>
  <div style="display:flex;align-items:center;gap:12px;">
    <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--red),var(--orange));display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 2px 8px rgba(224,48,39,0.3);">ğŸ±</div>
    <div>
      <div class="logo-text">Kedai Heula</div>
      <div class="logo-sub">Manajemen Bisnis Kuliner â€“ Jajanan Mantap Pisan!</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <button id="user-badge" onclick="bukaMenuUser()" style="display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.18);border:1.5px solid rgba(255,255,255,0.3);border-radius:14px;padding:8px 14px 8px 10px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.28)'" onmouseout="this.style.background='rgba(255,255,255,0.18)'">
      <div style="width:32px;height:32px;border-radius:10px;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:17px;">ğŸ‘¤</div>
      <div style="text-align:left;">
        <div class="ub-name" id="ub-name" style="color:white;font-size:13px;font-weight:800;line-height:1.2;">â€”</div>
        <div class="ub-role" id="ub-role" style="color:rgba(255,255,255,0.75);font-size:10px;font-weight:600;"></div>
      </div>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-left:2px;"><polyline points="6 9 12 15 18 9"></polyline></svg>
    </button>
  </div>
</header>

<div class="app-layout">
<div class="tabs-wrapper">
  <div class="tab-grid">
    <div class="sidebar-section-label tab-admin-only">Manajemen</div>
    <button class="tab-icon tab-admin-only" onclick="switchTab('hitung')">
      <div class="ti-icon">ğŸ§®</div>
      <div class="ti-label">Hitung HPP</div>
    </button>
    <button class="tab-icon tab-admin-only" onclick="switchTab('ringkasan')">
      <div class="ti-icon">ğŸ“‹</div>
      <div class="ti-label">Ringkasan Menu</div>
    </button>
    <button class="tab-icon tab-admin-only" onclick="switchTab('laporan')">
      <div class="ti-icon">ğŸ“Š</div>
      <div class="ti-label">Laporan</div>
    </button>
    <button class="tab-icon tab-admin-only" onclick="switchTab('promo')">
      <div class="ti-icon">ğŸ·ï¸</div>
      <div class="ti-label">Promo</div>
    </button>
    <div class="sidebar-section-label">Operasional</div>
    <button class="tab-icon" id="tab-btn-pos" onclick="switchTab('pos')">
      <div class="ti-icon">ğŸ’°</div>
      <div class="ti-label">Kasir (POS)</div>
    </button>
    <div class="sidebar-section-label tab-admin-only">Lainnya</div>
    <button class="tab-icon tab-admin-only" onclick="switchTab('panduan')">
      <div class="ti-icon">ğŸ“–</div>
      <div class="ti-label">Panduan</div>
    </button>
    <button class="tab-icon tab-admin-only" onclick="switchTab('akun')">
      <div class="ti-icon">ğŸ‘¥</div>
      <div class="ti-label">Kelola Akun</div>
    </button>
  </div>
</div>

<div class="main">

  <!-- TAB HITUNG HPP -->
  <div id="tab-hitung" class="tab-content active">

    <div class="section-header" style="margin-bottom:20px;">
      <div class="section-title">ğŸ§® Hitung HPP</div>
      <div class="section-sub">Hitung Harga Pokok Produksi untuk setiap menu secara akurat.</div>
    </div>

    <div class="info-box">
      <span class="info-icon">ğŸ’¡</span>
      <div>
        <strong>Cara pakai:</strong> Isi info produk â†’ tambah bahan-bahan â†’ tambah biaya operasional â†’ klik <strong>Hitung HPP</strong>. Hasilnya langsung tersimpan dan bisa diakses di tab <strong>Ringkasan Menu</strong>, <strong>Laporan Penjualan</strong>, dan <strong>Kalkulator Promo</strong>!
      </div>
    </div>

    <!-- INFO PRODUK -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ“¦ Info Produk</div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Nama Menu</label>
          <input type="text" id="nama-menu" placeholder="cth: Takoyaki Original" />
        </div>
        <div class="form-group">
          <label>Kategori</label>
          <select id="kategori-menu">
            <option value="takoyaki">ğŸ™ Takoyaki</option>
            <option value="dimsum">ğŸ¥Ÿ Dimsum</option>
            <option value="ayam">ğŸ— Ayam Crispy</option>
            <option value="lainnya">ğŸ± Lainnya</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Foto Menu (Opsional)</label>
        <input type="file" id="foto-menu" accept="image/*" onchange="previewFoto(this, 'preview-foto')" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        <div id="preview-foto" style="margin-top:8px;"></div>
      </div>
      <div class="form-row three">
        <div class="form-group">
          <label>Porsi / Batch (pcs)</label>
          <input type="number" id="porsi" value="6" min="1" placeholder="6" />
        </div>
        <div class="form-group">
          <label>Sat. Porsi</label>
          <select id="satuan-porsi">
            <option>pcs</option>
            <option>porsi</option>
            <option>box</option>
            <option>pack</option>
          </select>
        </div>
        <div class="form-group">
          <label>Kemasan (Rp)</label>
          <input type="number" id="biaya-kemasan" value="500" min="0" placeholder="500" />
        </div>
      </div>
    </div>

    <!-- BAHAN BAKU -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ§… Bahan Baku</div>
      </div>

      <div class="bahan-header">
        <span>Nama Bahan</span>
        <span>Qty Dipakai</span>
        <span class="col-harga-satuan">Harga Beli (Rp)</span>
        <span class="col-harga-satuan">Ukuran Beli</span>
        <span class="col-subtotal"></span>
      </div>

      <div id="bahan-list"></div>

      <button class="btn btn-add" onclick="tambahBahan()">
        ï¼‹ Tambah Bahan
      </button>
    </div>

    <!-- BIAYA OPERASIONAL -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">âš™ï¸ Biaya Operasional per Batch</div>
      </div>

      <div id="biaya-list"></div>

      <button class="btn btn-add" onclick="tambahBiaya()">
        ï¼‹ Tambah Biaya (gas, listrik, dll)
      </button>
    </div>

    <!-- TOMBOL HITUNG -->
    <div style="display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="hitungHPP()">
        ğŸ§® Hitung HPP Sekarang
      </button>
      <button class="btn btn-secondary" onclick="resetForm()">
        ğŸ”„ Reset Form
      </button>
    </div>

    <!-- HASIL -->
    <div id="hasil-section" style="display:none;">

      <div class="result-box">
        <h3>ğŸ“Š Hasil Kalkulasi HPP</h3>
        <div class="result-grid">
          <div class="result-item">
            <span class="label">Total Biaya Batch</span>
            <div class="value" id="res-total-batch">Rp 0</div>
            <div class="sub" id="res-batch-info">untuk 6 pcs</div>
          </div>
          <div class="result-item">
            <span class="label">HPP per Pcs</span>
            <div class="value" id="res-hpp">Rp 0</div>
            <div class="sub">harga pokok produksi</div>
          </div>
          <div class="result-item">
            <span class="label">Min. BEP Harga Jual</span>
            <div class="value" id="res-bep">Rp 0</div>
            <div class="sub">HPP + platform fee 30%</div>
          </div>
        </div>
      </div>

      <!-- BREAKDOWN -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ” Detail Breakdown Biaya</div>
        </div>
        <table class="breakdown-table">
          <thead>
            <tr>
              <th>Komponen</th>
              <th>Keterangan</th>
              <th class="text-right">Biaya (Rp)</th>
              <th class="text-right">%</th>
            </tr>
          </thead>
          <tbody id="breakdown-body"></tbody>
        </table>
      </div>

      <!-- SARAN HARGA JUAL -->
      <div class="price-suggestion">
        <h4>ğŸ’¡ Rekomendasi Harga Jual</h4>

        <!-- Step 1: Pilih Kategori -->
        <div style="margin-bottom:14px;">
          <div style="font-size:11px;font-weight:800;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Pilih Kategori Harga:</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
            <div id="btn-kategori-30" onclick="pilihKategoriHarga(30)" style="background:#FFF9E6;border:2px solid #F5C518;border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:20px;margin-bottom:4px;">ğŸŸ¡</div>
              <div style="font-size:12px;font-weight:800;color:#B8860B;">EKONOMIS</div>
              <div style="font-size:10px;color:#999;margin-top:2px;">Margin 30%</div>
            </div>
            <div id="btn-kategori-50" onclick="pilihKategoriHarga(50)" style="background:#E8F5E9;border:2px solid #27AE60;border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(39,174,96,0.2);">
              <div style="font-size:20px;margin-bottom:4px;">ğŸŸ¢</div>
              <div style="font-size:12px;font-weight:800;color:#1B5E20;">STANDAR â­</div>
              <div style="font-size:10px;color:#999;margin-top:2px;">Margin 50%</div>
            </div>
            <div id="btn-kategori-70" onclick="pilihKategoriHarga(70)" style="background:#FFF0EF;border:2px solid #E03027;border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:20px;margin-bottom:4px;">ğŸ”¥</div>
              <div style="font-size:12px;font-weight:800;color:#E03027;">PREMIUM</div>
              <div style="font-size:10px;color:#999;margin-top:2px;">Margin 70%</div>
            </div>
          </div>
        </div>

        <!-- Step 2: Pilih Channel (muncul setelah pilih kategori) -->
        <div id="channel-selector" style="display:none;">
          <div style="font-size:11px;font-weight:800;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Pilih Channel Penjualan:</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
            <div id="btn-channel-offline" onclick="pilihChannelHarga('offline')" style="background:var(--card);border:2px solid var(--border);border-radius:12px;padding:14px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:22px;margin-bottom:4px;">ğŸª</div>
              <div style="font-size:13px;font-weight:800;">OFFLINE</div>
              <div style="font-size:10px;color:#999;margin-top:2px;">Tanpa platform fee</div>
            </div>
            <div id="btn-channel-online" onclick="pilihChannelHarga('online')" style="background:var(--card);border:2px solid var(--border);border-radius:12px;padding:14px;text-align:center;cursor:pointer;transition:all 0.2s;">
              <div style="font-size:22px;margin-bottom:4px;">ğŸ“±</div>
              <div style="font-size:13px;font-weight:800;">ONLINE</div>
              <div style="font-size:10px;color:#999;margin-top:2px;">GoFood / Shopee</div>
            </div>
          </div>

          <!-- Hasil Harga Terpilih -->
          <div id="harga-terpilih-display" style="display:none;background:linear-gradient(135deg,var(--green),#2ECC71);border-radius:14px;padding:16px;text-align:center;color:white;margin-bottom:8px;">
            <div style="font-size:11px;font-weight:800;opacity:0.85;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;" id="harga-terpilih-label">Harga Jual</div>
            <div style="font-family:'Fredoka One',cursive;font-size:36px;line-height:1;" id="harga-terpilih-nilai">Rp 0</div>
            <div style="font-size:11px;opacity:0.8;margin-top:4px;" id="harga-terpilih-info">profit per pcs</div>
          </div>

          <div style="font-size:11px;color:#666;margin-top:6px;">
            â„¹ï¸ <strong>Harga online 25% lebih tinggi</strong> untuk cover platform fee ~20%.
          </div>
        </div>

        <!-- Hidden inputs to track selection (used by hitungHPP) -->
        <input type="hidden" id="harga-30-offline" value="0" />
        <input type="hidden" id="harga-30-online" value="0" />
        <input type="hidden" id="harga-50-offline" value="0" />
        <input type="hidden" id="harga-50-online" value="0" />
        <input type="hidden" id="harga-70-offline" value="0" />
        <input type="hidden" id="harga-70-online" value="0" />
      </div>

      <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="simpanMenu()">
          ğŸ’¾ Simpan ke Ringkasan Menu
        </button>
        <button class="btn btn-secondary" onclick="konfirmasiMenuBaru()">
          â• Input Menu Baru
        </button>
      </div>
    </div>
  </div>

  <!-- TAB RINGKASAN -->
  <div id="tab-ringkasan" class="tab-content">
    <div class="section-title">ğŸ“‹ Ringkasan Semua Menu</div>
    <div class="section-sub">Semua menu yang sudah dihitung HPP-nya ada di sini.</div>

    <!-- CLOUD SYNC BAR -->
    

    <div id="ringkasan-list">
      <div class="empty-state">
        <div class="es-icon">ğŸ±</div>
        <p>Belum ada menu tersimpan</p>
        <small>Hitung HPP dulu di tab "Hitung HPP", lalu klik "Simpan ke Ringkasan Menu"</small>
      </div>
    </div>
  </div>

  <!-- MODAL SYNC CONFIG -->
  <div class="modal-overlay" id="modal-sync" onclick="if(event.target===this)tutupSyncConfig()">
    <div class="modal-box" style="max-width:520px;">
      <div class="modal-header">
        
        <button class="modal-close" onclick="tutupSyncConfig()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="info-box" style="background:#E3F2FD;border-left:4px solid #2196F3;padding:12px 14px;border-radius:10px;margin-bottom:16px;font-size:13px;">
          <span style="font-size:18px;">ğŸ’¡</span>
          <div style="margin-left:10px;">Data kamu tersimpan ke <strong>Google Sheets</strong> milikmu sendiri via Apps Script. URL sudah tersimpan â€” tinggal klik <strong>Simpan & Test</strong> untuk verifikasi koneksi.</div>
        </div>

        <div style="font-size:13px;font-weight:800;margin-bottom:10px;color:var(--dark);">Jika perlu ganti URL Apps Script:</div>
        <ol style="font-size:13px;color:#444;padding-left:18px;line-height:2;">
          <li>Buka <a href="https://script.google.com" target="_blank" style="color:var(--red);font-weight:700;">script.google.com</a> â†’ buka project Kedai Heula</li>
          <li>Klik <strong>Deploy â†’ Manage deployments</strong></li>
          <li>Copy URL deployment yang aktif, paste di bawah</li>
        </ol>

        <div class="form-group" style="margin-top:14px;">
          <label style="font-size:13px;font-weight:800;">URL Apps Script Web App</label>
          <input type="text" id="sheets-url-input"
            placeholder="https://script.google.com/macros/s/xxx/exec"
            style="width:100%;padding:10px 12px;border-radius:8px;border:2px solid var(--border);font-size:13px;margin-top:6px;outline:none;" />
        </div>

        <!-- Debug Log -->
        <div id="debug-log" style="display:none;margin-top:12px;padding:10px;background:#1E1E2E;color:#CDD6F4;border-radius:8px;font-family:monospace;font-size:11px;max-height:150px;overflow-y:auto;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="tutupSyncConfig()">Batal</button>
        <button class="btn btn-primary" onclick="simpanSyncConfig()">ğŸ’¾ Simpan & Test</button>
      </div>
    </div>
  </div>

  <!-- TAB LAPORAN PENJUALAN -->
  <div id="tab-laporan" class="tab-content">
    <div class="section-title">ğŸ“Š Laporan Penjualan</div>
    <div class="section-sub">Catat transaksi harian dan lihat profit bisnis kamu</div>

    <!-- ACTION BUTTONS -->
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="exportLaporanPDF()" style="font-size:13px;padding:10px 16px;">
        ğŸ“„ Export PDF
      </button>
      
      
    </div>

    <!-- PERIOD SELECTOR -->
    <div class="card" style="margin-bottom:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px;">
        <div style="font-size:15px;font-weight:800;color:var(--dark);">ğŸ“… Periode Laporan</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('hari')" id="btn-period-hari" style="font-size:12px;padding:6px 14px;">Hari Ini</button>
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('minggu')" id="btn-period-minggu" style="font-size:12px;padding:6px 14px;">7 Hari</button>
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('bulan')" id="btn-period-bulan" style="font-size:12px;padding:6px 14px;">Bulan Ini</button>
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('semua')" id="btn-period-semua" style="font-size:12px;padding:6px 14px;">Semua</button>
        </div>
      </div>
      
      <!-- SUMMARY CARDS -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;">
        <div style="background:linear-gradient(135deg,#27AE60,#2ECC71);border-radius:12px;padding:14px;color:white;">
          <div style="font-size:10px;opacity:0.85;font-weight:800;text-transform:uppercase;">ğŸ’° Total Profit</div>
          <div style="font-family:'Fredoka One',cursive;font-size:20px;margin-top:4px;" id="lap-profit">Rp 0</div>
        </div>
        <div style="background:linear-gradient(135deg,#2980B9,#3498DB);border-radius:12px;padding:14px;color:white;">
          <div style="font-size:10px;opacity:0.85;font-weight:800;text-transform:uppercase;">ğŸ“¦ Total Transaksi</div>
          <div style="font-family:'Fredoka One',cursive;font-size:20px;margin-top:4px;" id="lap-transaksi">0</div>
        </div>
        <div style="background:linear-gradient(135deg,#E67E22,#F39C12);border-radius:12px;padding:14px;color:white;">
          <div style="font-size:10px;opacity:0.85;font-weight:800;text-transform:uppercase;">ğŸ± Item Terjual</div>
          <div style="font-family:'Fredoka One',cursive;font-size:20px;margin-top:4px;" id="lap-item">0</div>
        </div>
      </div>
    </div>

    <!-- BREAKDOWN PER MENU -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:12px;">ğŸ“Š Breakdown per Menu</div>
      <div id="breakdown-menu"></div>
    </div>

    <!-- INPUT TRANSAKSI -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:12px;">â• Catat Transaksi Baru</div>
      
      <div class="info-box" style="background:#E8F5E9;border-left:4px solid var(--green);padding:10px 12px;border-radius:10px;margin-bottom:14px;font-size:12px;">
        <span style="font-size:16px;">ğŸ’¡</span>
        <div style="margin-left:8px;"><strong>Input transaksi masa lalu:</strong> Kamu bisa input transaksi kemarin atau tanggal lain dengan ganti tanggal secara manual. Gunakan tombol shortcut <strong>Kemarin</strong> untuk cepat.</div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Tanggal</label>
          <div style="display:flex;gap:6px;align-items:stretch;">
            <input type="date" id="transaksi-tanggal" style="flex:1;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
            <button class="btn btn-secondary" onclick="setTanggalTransaksi('kemarin')" style="font-size:11px;padding:6px 10px;white-space:nowrap;">Kemarin</button>
            <button class="btn btn-secondary" onclick="setTanggalTransaksi('hari-ini')" style="font-size:11px;padding:6px 10px;white-space:nowrap;">Hari Ini</button>
          </div>
        </div>
        <div class="form-group">
          <label>Menu</label>
          <select id="transaksi-menu" onchange="isiHargaTransaksi()" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;">
            <option value="">-- Pilih Menu --</option>
          </select>
        </div>
      </div>

      <div class="form-row three">
        <div class="form-group">
          <label>Jumlah (pcs)</label>
          <input type="number" id="transaksi-qty" min="1" value="1" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        </div>
        <div class="form-group">
          <label>HPP/pcs</label>
          <input type="number" id="transaksi-hpp" readonly style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;background:#F5F5F5;" />
        </div>
        <div class="form-group">
          <label>Harga Jual/pcs</label>
          <input type="number" id="transaksi-harga" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <button class="btn btn-primary" onclick="simpanTransaksi()">ğŸ’¾ Simpan Transaksi</button>
      </div>
    </div>

    <!-- CHART -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:12px;">ğŸ“ˆ Tren Profit</div>
      <canvas id="chart-profit" style="max-height:280px;"></canvas>
    </div>

    <!-- TABEL TRANSAKSI -->
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;">ğŸ“‹ Riwayat Transaksi</div>
      <div id="tabel-transaksi" style="overflow-x:auto;"></div>
    </div>
  </div>

  <!-- TAB PROMO -->
  <div id="tab-promo" class="tab-content">

    <div class="section-title">ğŸ·ï¸ Kalkulator Promo</div>
    <div class="section-sub">Hitung apakah promo kamu masih untung atau malah boncos!</div>

    <div class="info-box">
      <span class="info-icon">ğŸ’¡</span>
      <div>
        Pilih jenis promo di bawah, isi angkanya, dan kalkulator akan langsung tunjukkin <strong>profit/rugi per transaksi</strong> + rekomendasi apakah promo layak dijalankan.
      </div>
    </div>

    <!-- PILIH TIPE PROMO -->
    <div class="promo-type-grid">
      <div class="promo-type-btn active" onclick="switchPromo('diskon', this)">
        <div class="pt-icon">%</div>
        <div class="pt-label">Diskon %</div>
        <div class="pt-desc">Potong harga sekian persen</div>
      </div>
      <div class="promo-type-btn" onclick="switchPromo('bundling', this)">
        <div class="pt-icon">ğŸ“¦</div>
        <div class="pt-label">Bundling</div>
        <div class="pt-desc">Paket beberapa menu</div>
      </div>
      <div class="promo-type-btn" onclick="switchPromo('beli-dapat', this)">
        <div class="pt-icon">ğŸ</div>
        <div class="pt-label">Beli X Gratis Y</div>
        <div class="pt-desc">Gratis item/cashback</div>
      </div>
      <div class="promo-type-btn" onclick="switchPromo('aktif', this)">
        <div class="pt-icon">ğŸ“‹</div>
        <div class="pt-label">Promo Aktif</div>
        <div class="pt-desc">Kelola promo tersimpan</div>
      </div>
    </div>

    <!-- PANEL: DISKON % -->
    <div id="panel-diskon" class="promo-panel active">
      <div class="card">
        <div class="card-title" style="margin-bottom:16px;">âœ‚ï¸ Simulasi Diskon Persen</div>

        <!-- PILIH DARI RINGKASAN -->
        <div class="form-group" style="margin-bottom:14px;">
          <label>Pilih Menu dari Ringkasan <span style="color:var(--orange)">â˜…</span></label>
          <div style="display:flex;gap:10px;align-items:center;">
            <select id="d-pilih-menu" onchange="isiDariRingkasan()" style="flex:1;">
              <option value="">â€” Pilih menu yang sudah dihitung HPP-nya â€”</option>
            </select>
            <button class="btn btn-secondary" onclick="refreshDropdownDiskon()" title="Refresh daftar menu" style="padding:10px 14px;white-space:nowrap;">ğŸ”„ Refresh</button>
          </div>
        </div>

        <!-- INFO MENU TERPILIH -->
        <div id="d-menu-info" style="display:none; margin-bottom:14px;">
          <div style="background:linear-gradient(135deg,var(--red),var(--orange));border-radius:12px;padding:14px 18px;color:white;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
            <div>
              <div style="font-family:'Fredoka One',cursive;font-size:18px;" id="d-menu-info-nama">â€”</div>
              <div style="font-size:11px;opacity:0.85;margin-top:2px;" id="d-menu-info-kategori">â€”</div>
            </div>
            <div style="display:flex;gap:16px;flex-wrap:wrap;">
              <div style="text-align:center;">
                <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">HPP/pcs</div>
                <div style="font-family:'Fredoka One',cursive;font-size:20px;" id="d-menu-info-hpp">â€”</div>
              </div>
              <div style="text-align:center;">
                <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">Harga Jual</div>
                <div style="font-family:'Fredoka One',cursive;font-size:20px;" id="d-menu-info-hj">â€”</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ATAU INPUT MANUAL -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
          <div style="flex:1;height:1px;background:var(--border);"></div>
          <span style="font-size:11px;font-weight:800;color:var(--muted);white-space:nowrap;">atau input manual</span>
          <div style="flex:1;height:1px;background:var(--border);"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nama Menu</label>
            <input type="text" id="d-nama" placeholder="cth: Takoyaki Original" />
          </div>
          <div class="form-group">
            <label>HPP per Pcs (Rp) <span style="color:var(--orange)">*</span></label>
            <input type="number" id="d-hpp" placeholder="5000" min="0" oninput="hitungDiskon()" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Harga Jual Normal (Rp)</label>
            <input type="number" id="d-harga-normal" placeholder="12000" min="0" oninput="hitungDiskon()" />
          </div>
          <div class="form-group">
            <label>Platform Fee (%) â€” GoFood/Shopee</label>
            <input type="number" id="d-platform-fee" value="20" min="0" max="100" oninput="hitungDiskon()" />
          </div>
        </div>

        <div class="form-group">
          <label>Besar Diskon: <span id="d-diskon-label" style="color:var(--red);font-size:16px;font-family:'Fredoka One',cursive;">20%</span></label>
          <div class="slider-wrapper">
            <input type="range" id="d-diskon" min="5" max="70" value="20" step="5" oninput="updateDiskonSlider(); hitungDiskon();" />
            <div class="slider-label"><span>5%</span><span>70%</span></div>
          </div>
        </div>

        <div id="diskon-result" style="display:none;"></div>
        
        <!-- Form Simpan Promo -->
        <div id="form-simpan-diskon" style="display:none;margin-top:20px;background:var(--bg);padding:16px;border-radius:12px;border:2px dashed var(--orange);">
          <div style="font-weight:800;margin-bottom:12px;font-size:14px;">ğŸ’¾ Simpan Promo Ini</div>
          
          <div class="form-group" style="margin-bottom:12px;">
            <label style="font-weight:700;">Nama Promo</label>
            <input type="text" id="diskon-nama-promo" placeholder="cth: Diskon 20% Weekend" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
          </div>
          
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Mulai</label>
              <input type="date" id="diskon-tgl-mulai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Selesai</label>
              <input type="date" id="diskon-tgl-selesai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <button onclick="resetFormDiskon()" class="btn" style="background:var(--muted);color:white;">
              ğŸ”„ Reset
            </button>
            <button onclick="simpanPromoDiskon()" class="btn btn-primary">
              âœ… Simpan Promo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL: BUNDLING -->
    <div id="panel-bundling" class="promo-panel">
      <div class="card">
        <div class="card-title" style="margin-bottom:16px;">ğŸ“¦ Simulasi Harga Bundling / Paket</div>

        <div class="info-box" style="margin-bottom:16px;">
          <span class="info-icon">â„¹ï¸</span>
          <div>Pilih item dari <strong>Ringkasan Menu</strong> â€” HPP dan harga jual otomatis terisi.</div>
        </div>

        <div class="bundle-item-header">
          <span>Pilih / Nama Item</span>
          <span>HPP/pcs</span>
          <span>Harga Jual</span>
          <span>Qty</span>
          <span></span>
        </div>
        <div id="bundle-list"></div>
        <button class="btn btn-add" onclick="tambahBundleItem()">ï¼‹ Tambah Item dari Ringkasan</button>

        <div id="bundling-result" style="margin-top:16px;"></div>
        
        <!-- Form Simpan Promo Bundling -->
        <div id="form-simpan-bundling" style="margin-top:20px;background:var(--bg);padding:16px;border-radius:12px;border:2px dashed var(--orange);">
          <div style="font-weight:800;margin-bottom:12px;font-size:14px;">ğŸ’¾ Simpan Promo Bundling</div>
          
          <div class="form-group" style="margin-bottom:12px;">
            <label style="font-weight:700;">Nama Promo</label>
            <input type="text" id="bundling-nama-promo" placeholder="cth: Paket Hemat 3 Menu" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
          </div>
          
          <div style="margin-bottom:16px;">
            <label style="font-weight:700;display:block;margin-bottom:8px;">ğŸ’° Pilih Harga Bundling</label>
            <div id="bundling-harga-options" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
          
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Mulai</label>
              <input type="date" id="bundling-tgl-mulai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Selesai</label>
              <input type="date" id="bundling-tgl-selesai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <button onclick="resetFormBundling()" class="btn" style="background:var(--muted);color:white;">
              ğŸ”„ Reset
            </button>
            <button onclick="simpanPromoBundling()" class="btn btn-primary">
              âœ… Simpan Promo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL: PROMO AKTIF -->
    <div id="panel-aktif" class="promo-panel">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div class="card-title" style="margin:0;">ğŸ“‹ Daftar Promo Tersimpan</div>
          <button onclick="exportPromosPDF()" class="btn btn-secondary" style="padding:8px 14px;font-size:12px;">
            ğŸ“„ Export PDF
          </button>
        </div>

        <!-- Filter Status -->
        <div style="display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;">
          <button onclick="filterPromos('all')" id="filter-all" class="btn btn-secondary" style="padding:8px 16px;font-size:13px;white-space:nowrap;background:var(--orange);color:white;">
            ğŸ“‹ Semua
          </button>
          <button onclick="filterPromos('active')" id="filter-active" class="btn btn-secondary" style="padding:8px 16px;font-size:13px;white-space:nowrap;">
            âœ… Aktif
          </button>
          <button onclick="filterPromos('upcoming')" id="filter-upcoming" class="btn btn-secondary" style="padding:8px 16px;font-size:13px;white-space:nowrap;">
            ğŸ•’ Upcoming
          </button>
          <button onclick="filterPromos('expired')" id="filter-expired" class="btn btn-secondary" style="padding:8px 16px;font-size:13px;white-space:nowrap;">
            â° Expired
          </button>
          <button onclick="restorePromosFromCloud()" class="btn btn-secondary" style="padding:8px 16px;font-size:13px;white-space:nowrap;">
            â¬‡ï¸ Restore Cloud
          </button>
        </div>

        <!-- List Promo -->
        <div id="promo-list-container"></div>
      </div>
    </div>

    <!-- PANEL: BELI X GRATIS Y -->
    <div id="panel-beli-dapat" class="promo-panel">
      <div class="card">
        <div class="card-title" style="margin-bottom:16px;">ğŸ Simulasi Beli X Gratis Y</div>

        <div class="info-box" style="margin-bottom:16px;">
          <span class="info-icon">â„¹ï¸</span>
          <div>Pilih menu dari <strong>Ringkasan Menu</strong> untuk auto-fill HPP dan harga jual.</div>
        </div>

        <div class="form-group" style="margin-bottom:16px;">
          <label>Pilih Menu (opsional)</label>
          <select id="bg-menu-select" onchange="isiBeliGratis()" style="padding:12px;border-radius:12px;border:2px solid var(--border);font-size:14px;font-weight:700;width:100%;">
            <option value="">ğŸ” Pilih dari Ringkasan Menu...</option>
          </select>
        </div>

        <div class="beli-dapat-grid">
          <div class="form-group">
            <label>Beli (pcs)</label>
            <input type="number" id="bg-beli" value="2" min="1" oninput="hitungBeliGratis()" />
          </div>
          <div class="separator">â†’ Gratis</div>
          <div class="form-group">
            <label>Gratis (pcs)</label>
            <input type="number" id="bg-gratis" value="1" min="1" oninput="hitungBeliGratis()" />
          </div>
        </div>

        <div class="form-group" style="margin-bottom:16px;">
          <label style="font-weight:700;margin-bottom:8px;display:block;">Channel Penjualan</label>
          <select id="bg-channel" onchange="toggleBeliGratisChannel()" style="padding:12px;border-radius:12px;border:2px solid var(--border);font-size:14px;font-weight:700;width:100%;background:var(--card);">
            <option value="">-- Pilih Channel Penjualan --</option>
            <option value="offline">ğŸª Offline (tanpa platform fee)</option>
            <option value="online">ğŸ“± Online (GoFood/Shopee/Grab)</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>HPP per Pcs (Rp)</label>
            <input type="number" id="bg-hpp" placeholder="5000" min="0" oninput="hitungBeliGratis()" />
          </div>
          <div class="form-group">
            <label>Harga Jual Normal per Pcs (Rp)</label>
            <input type="number" id="bg-harga" placeholder="12000" min="0" oninput="hitungBeliGratis()" />
          </div>
        </div>
        <div class="form-row" id="bg-fee-row" style="display:none;">
          <div class="form-group">
            <label>Platform Fee (%) â€” GoFood/Shopee</label>
            <input type="number" id="bg-fee" value="20" min="0" max="100" oninput="hitungBeliGratis()" />
          </div>
          <div class="form-group">
            <label>Estimasi Transaksi per Hari</label>
            <input type="number" id="bg-transaksi" value="10" min="1" oninput="hitungBeliGratis()" />
          </div>
        </div>

        <div id="beli-gratis-result" style="display:none; margin-top:16px;"></div>
        
        <!-- Form Simpan Promo Beli Gratis -->
        <div id="form-simpan-beli-gratis" style="margin-top:20px;background:var(--bg);padding:16px;border-radius:12px;border:2px dashed var(--orange);">
          <div style="font-weight:800;margin-bottom:12px;font-size:14px;">ğŸ’¾ Simpan Promo Beli X Gratis Y</div>
          
          <div class="form-group" style="margin-bottom:12px;">
            <label style="font-weight:700;">Nama Promo</label>
            <input type="text" id="beli-gratis-nama-promo" placeholder="cth: Beli 2 Gratis 1" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
          </div>
          
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Mulai</label>
              <input type="date" id="beli-gratis-tgl-mulai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
            <div class="form-group">
              <label style="font-weight:700;">Tanggal Selesai</label>
              <input type="date" id="beli-gratis-tgl-selesai" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--border);font-weight:600;" />
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <button onclick="resetFormBeliGratis()" class="btn" style="background:var(--muted);color:white;">
              ğŸ”„ Reset
            </button>
            <button onclick="simpanPromoBeliGratis()" class="btn btn-primary">
              âœ… Simpan Promo
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- TAB POS (KASIR) -->
  <div id="tab-pos" class="tab-content">
  <!-- POS Split Layout: Left = menu grid, Right = cart panel -->
  <div id="pos-layout">

    <!-- LEFT: Menu Area -->
    <div id="pos-menu-area">

      <!-- Summary Bar -->
      <div style="background:linear-gradient(135deg,var(--orange),var(--red));border-radius:14px;padding:14px 16px;margin-bottom:20px;display:flex;justify-content:space-around;text-align:center;color:white;">
        <div>
          <div style="font-size:10px;font-weight:700;opacity:0.85;letter-spacing:1px;">PENJUALAN</div>
          <div style="font-size:17px;font-weight:800;" id="pos-total-revenue">Rp 0</div>
        </div>
        <div style="border-left:1px solid rgba(255,255,255,0.3);padding-left:16px;">
          <div style="font-size:10px;font-weight:700;opacity:0.85;letter-spacing:1px;">PROFIT</div>
          <div style="font-size:17px;font-weight:800;" id="pos-total-profit">Rp 0</div>
        </div>
        <div style="border-left:1px solid rgba(255,255,255,0.3);padding-left:16px;">
          <div style="font-size:10px;font-weight:700;opacity:0.85;letter-spacing:1px;">TRANSAKSI</div>
          <div style="font-size:17px;font-weight:800;" id="pos-total-trx">0</div>
        </div>
      </div>

      <!-- Item Satuan -->
      <div style="margin-bottom:24px;">
        <h3 style="font-size:12px;font-weight:800;color:var(--muted);letter-spacing:1px;margin-bottom:12px;">ITEM SATUAN</h3>
        <div id="pos-menu-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;"></div>
      </div>

      <!-- Bundling Promo -->
      <div id="pos-bundling-section" style="margin-bottom:24px;display:none;">
        <h3 style="font-size:12px;font-weight:800;color:var(--red);letter-spacing:1px;margin-bottom:12px;">ğŸ“¦ PROMO BUNDLING</h3>
        <div id="pos-bundling-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;"></div>
      </div>
    </div>

    <!-- RIGHT: Cart Panel (always visible on desktop) -->
    <!-- Mobile cart overlay -->
  <div id="pos-cart-overlay" onclick="toggleMobileCart()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:399;backdrop-filter:blur(2px);"></div>

  <div id="pos-cart-panel">
      
      <!-- Cart Header -->
      <div style="padding:16px 16px 12px;border-bottom:2px solid var(--border);background:var(--card);position:sticky;top:0;z-index:2;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div style="font-size:16px;font-weight:900;">ğŸ›’ Keranjang</div>
          <div id="pos-cart-badge" style="background:var(--orange);color:white;font-size:11px;font-weight:800;padding:3px 10px;border-radius:20px;display:none;">0 item</div>
        </div>
      </div>

      <!-- Cart Items -->
      <div id="pos-cart-items" style="flex:1;padding:12px;overflow-y:auto;"></div>

      <!-- Cart Footer: promo + payment + total -->
      <div style="padding:12px 16px;border-top:2px solid var(--border);background:var(--card);">
        
        <!-- Promo Selector -->
        <div id="pos-promo-section" style="margin-bottom:12px;display:none;">
          <label style="font-size:11px;font-weight:800;color:var(--muted);letter-spacing:0.5px;display:block;margin-bottom:6px;">ğŸ·ï¸ GUNAKAN PROMO</label>
          <select id="pos-promo-select" onchange="applyPromoToPOS()" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-weight:600;font-size:13px;background:var(--bg);">
            <option value="">Tanpa Promo</option>
          </select>
        </div>

        <!-- Diskon info -->
        <div id="pos-promo-discount" style="display:none;margin-bottom:8px;padding:6px 10px;background:#FFF0EF;border-radius:8px;">
          <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--red);">
            <span style="font-weight:700;">Diskon:</span>
            <span style="font-weight:800;" id="pos-discount-amount">- Rp 0</span>
          </div>
        </div>

        <!-- Subtotal + Profit -->
        <div style="background:var(--bg);border-radius:10px;padding:10px 12px;margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span style="font-size:13px;font-weight:700;color:var(--muted);">Subtotal</span>
            <span style="font-size:17px;font-weight:900;" id="pos-subtotal">Rp 0</span>
          </div>
          <div style="display:flex;justify-content:space-between;">
            <span style="font-size:12px;color:var(--green);font-weight:700;">Profit</span>
            <span style="font-size:12px;color:var(--green);font-weight:800;" id="pos-profit">Rp 0</span>
          </div>
        </div>

        <!-- Bayar input -->
        <div style="margin-bottom:8px;">
          <label style="font-size:11px;font-weight:800;color:var(--muted);letter-spacing:0.5px;display:block;margin-bottom:6px;">ğŸ’µ UANG DIBAYAR</label>
          <input type="number" id="pos-bayar" placeholder="0" oninput="hitungKembalianPOS()"
            style="width:100%;padding:10px 12px;border-radius:10px;border:2px solid var(--border);font-size:18px;font-weight:800;background:var(--bg);text-align:right;box-sizing:border-box;" />
        </div>

        <!-- Kembalian -->
        <div style="display:flex;justify-content:space-between;align-items:center;background:var(--bg);border-radius:10px;padding:10px 12px;margin-bottom:12px;">
          <span style="font-size:12px;font-weight:700;color:var(--muted);">Kembalian</span>
          <span id="pos-kembalian" style="font-size:18px;font-weight:900;color:var(--green);">Rp 0</span>
        </div>

        <!-- Action Buttons -->
        <button onclick="konfirmasiSimpanTransaksi()" id="btn-selesai-pos"
          style="width:100%;padding:13px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--red),var(--orange));color:white;font-size:15px;font-weight:900;cursor:pointer;margin-bottom:8px;font-family:'Nunito',sans-serif;box-shadow:0 3px 12px rgba(224,48,39,0.3);"
          disabled>
          âœ… SELESAI
        </button>
        <button onclick="clearPOSCart()"
          style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);background:transparent;color:var(--muted);font-size:13px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;">
          ğŸ—‘ï¸ Kosongkan
        </button>
      </div>
    </div>

  </div>

  <!-- Mobile: floating cart toggle button -->
  <button onclick="toggleMobileCart()" id="pos-cart-btn">
    ğŸ›’<span id="pos-cart-count" style="position:absolute;top:-4px;right:-4px;background:var(--red);width:22px;height:22px;border-radius:50%;font-size:11px;display:flex;align-items:center;justify-content:center;font-weight:800;">0</span>
  </button>
</div>



  <!-- TAB PANDUAN -->
  <div id="tab-panduan" class="tab-content">
    <div class="section-title">ğŸ“– Panduan Penggunaan</div>
    <div class="section-sub">Tips dan penjelasan cara pakai kalkulator ini.</div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">Apa itu HPP?</div>
      <p style="font-size:14px;line-height:1.7;color:#444;font-weight:600;">
        <strong>HPP (Harga Pokok Produksi)</strong> adalah total biaya yang dikeluarkan untuk memproduksi satu porsi/pcs makanan. HPP mencakup:
      </p>
      <br>
      <ul style="font-size:14px;line-height:2;color:#444;font-weight:600;padding-left:20px;">
        <li>ğŸ’° <strong>Bahan baku</strong> â€“ semua bahan yang dipakai</li>
        <li>ğŸ“¦ <strong>Kemasan</strong> â€“ box, plastik, tusuk, dll</li>
        <li>âš™ï¸ <strong>Biaya operasional</strong> â€“ gas, listrik, dll per batch</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">ğŸ§® Rumus Dasar</div>
      <div style="background:var(--bg);border-radius:10px;padding:16px;font-size:13px;font-weight:700;line-height:2;">
        <div>ğŸ“Œ <strong>Total Biaya Batch</strong> = Î£(Biaya Bahan) + Kemasan + Biaya Operasional</div>
        <div>ğŸ“Œ <strong>HPP per Pcs</strong> = Total Biaya Batch Ã· Jumlah Porsi</div>
        <div>ğŸ“Œ <strong>Harga Jual</strong> = HPP Ã· (1 - margin%)</div>
        <div>ğŸ“Œ <strong>BEP Online</strong> = HPP Ã· (1 - 30%) â†’ karena GoFood/ShopeeFood potong ~20-30%</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">ğŸ’¡ Tips Buat Kedai Heula</div>
      <ul style="font-size:14px;line-height:2;color:#444;font-weight:600;padding-left:20px;">
        <li>ğŸ™ <strong>Takoyaki:</strong> HPP biasanya Rp 2.500â€“4.000/pcs. Jual Rp 7.000â€“12.000/pcs (isi 6â€“8) oke!</li>
        <li>ğŸ¥Ÿ <strong>Dimsum:</strong> HPP bervariasi sesuai isian. Mentai sauce nambahin cost tapi bisa jual lebih mahal.</li>
        <li>ğŸ— <strong>Ayam Crispy:</strong> Perhatiin yield (susut saat goreng ~20-30% dari berat mentah).</li>
        <li>ğŸ“¦ <strong>Kemasan:</strong> Jangan anggap remeh! Kemasan keren = boleh jual lebih mahal.</li>
        <li>ğŸ›µ <strong>Platform fee:</strong> GoFood/ShopeeFood potong 20-30%. Harga di app harus udah cover ini!</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">ğŸ“± Cara Hitung Bahan yang Beli Kemasan Besar</div>
      <p style="font-size:14px;line-height:1.7;color:#444;font-weight:600;">
        Contoh: Tepung terigu beli 1 kg = Rp 12.000, tapi satu batch cuma pakai 150 gram.
      </p>
      <br>
      <div style="background:var(--bg);border-radius:10px;padding:16px;font-size:13px;font-weight:700;line-height:2;">
        <div>Isi kolom <strong>Qty Dipakai</strong> = 150</div>
        <div>Isi kolom <strong>Harga Beli</strong> = 12000</div>
        <div>Isi kolom <strong>Ukuran Beli</strong> = 1000 (gram)</div>
        <div>â†’ Kalkulator otomatis hitung: 150/1000 Ã— 12.000 = <strong>Rp 1.800</strong></div>
      </div>
    </div>

    <!-- ======================== -->
    <!-- TIPS KALKULATOR PROMO   -->
    <!-- ======================== -->
    <div style="margin-top:28px;">
      <div class="section-title">ğŸ·ï¸ Panduan Kalkulator Promo</div>
      <div class="section-sub">Tips biar promo Kedai Heula tetap untung, bukan boncos!</div>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">ğŸ§  Prinsip Dasar Promo yang Sehat</div>
      <p style="font-size:14px;line-height:1.7;color:#444;font-weight:600;">
        Promo bukan berarti harus rugi. Tujuannya adalah menarik perhatian pelanggan baru atau mendorong volume penjualan, tapi margin tetap harus dijaga. Aturan praktisnya:
      </p>
      <br>
      <div style="background:var(--bg);border-radius:10px;padding:16px;font-size:13px;font-weight:700;line-height:2.2;">
        <div>ğŸŸ¢ <strong>Margin â‰¥ 20%</strong> setelah promo â†’ Aman, bisa jalan terus</div>
        <div>ğŸŸ¡ <strong>Margin 10â€“20%</strong> â†’ Hati-hati, batasi durasi 7â€“14 hari</div>
        <div>ğŸ”´ <strong>Margin &lt; 10% atau minus</strong> â†’ Evaluasi ulang, promo ini boncos!</div>
        <div>ğŸ“Œ <strong>Selalu hitung platform fee</strong> (GoFood/Shopee ~20â€“30%) sebelum tentukan harga promo</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">âœ‚ï¸ Tips Promo Diskon %</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li><strong>Diskon 10â€“20%</strong> â†’ Paling aman, masih untung lumayan. Cocok buat promo rutin mingguan.</li>
        <li><strong>Diskon 25â€“30%</strong> â†’ Menarik perhatian tapi pastiin HPP-mu sudah efisien. Cek dulu di kalkulator.</li>
        <li><strong>Diskon &gt; 40%</strong> â†’ Risiko boncos tinggi. Hanya pakai buat <em>grand opening</em> atau flash sale 1â€“2 hari saja.</li>
        <li>ğŸ’¡ Trik: <strong>Naikkan harga normal dulu 10â€“15%</strong> sebelum bikin promo diskon, biar margin tetap aman.</li>
        <li>ğŸ›µ Kalau promo lewat GoFood/Shopee, pastikan harga promo di app sudah dikurangi platform fee. Jangan sampai harga promonya malah lebih kecil dari HPP!</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">ğŸ“¦ Tips Promo Bundling</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li><strong>Bundling beda kategori</strong> jauh lebih menarik daripada bundling item sama. Contoh: Takoyaki + Dimsum = "Paket Jajan Duo" lebih menggoda dari 2x Takoyaki.</li>
        <li>Tujuan bundling bukan cuma diskon â€” tapi juga <strong>naikin nilai transaksi per pelanggan</strong>. Kalau biasanya orang beli 1 item, dengan bundling bisa beli 2â€“3 item sekaligus.</li>
        <li>Harga bundling ideal: <strong>hemat 10â€“20%</strong> dibanding beli satuan. Lebih dari itu, cek margin dulu!</li>
        <li>ğŸ’¡ Nama paket yang kreatif bikin bundling lebih laku. Contoh: <em>"Paket Mantap Pisan"</em>, <em>"Combo Heula"</em>, <em>"Box Jajan Bareng"</em>.</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">ğŸ Tips Promo Beli X Gratis Y</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li><strong>Beli 2 Gratis 1</strong> = diskon efektif 33%. Ini promo paling populer dan mudah dipahami pelanggan.</li>
        <li><strong>Beli 3 Gratis 1</strong> = diskon efektif 25%, lebih aman di margin tapi tetap terasa "wow" buat pelanggan.</li>
        <li>Item yang digratiskan sebaiknya <strong>item dengan HPP paling rendah</strong> dalam daftar menu kamu, biar ruginya minimal.</li>
        <li>Promo ini sangat efektif buat <strong>mendorong repeat order</strong>. Pelanggan cenderung balik lagi karena merasa dapat nilai lebih.</li>
        <li>ğŸ’¡ Batasi promo ini pada jam sepi (misal: weekday siang) supaya margin harian tetap terjaga saat jam ramai.</li>
        <li>âš ï¸ Jangan jalankan promo ini tanpa hitung estimasi transaksi harian dulu. Kalau ramai, kerugian per transaksi bisa numpuk cepat!</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">ğŸ“… Kapan Waktu Terbaik Promo?</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="background:#FFF3CD;border-radius:12px;padding:14px;border:2px solid #FFD54F;">
          <div style="font-size:13px;font-weight:900;color:#856404;margin-bottom:8px;">ğŸš€ Grand Opening</div>
          <div style="font-size:12px;font-weight:700;color:#7B5800;line-height:1.8;">Diskon besar (30â€“40%) boleh, tapi batasi 3â€“7 hari saja. Tujuannya bikin orang penasaran dan nyobain.</div>
        </div>
        <div style="background:#D4EDDA;border-radius:12px;padding:14px;border:2px solid #86EFAC;">
          <div style="font-size:13px;font-weight:900;color:#155724;margin-bottom:8px;">ğŸ“† Promo Rutin</div>
          <div style="font-size:12px;font-weight:700;color:#1a6b30;line-height:1.8;">Diskon 10â€“20% atau bundling ringan. Jadwal tetap (misal: Seninâ€“Rabu) biar pelanggan hafal dan balik lagi.</div>
        </div>
        <div style="background:#FFE0D0;border-radius:12px;padding:14px;border:2px solid #FFAB91;">
          <div style="font-size:13px;font-weight:900;color:#B94A00;margin-bottom:8px;">âš¡ Flash Sale</div>
          <div style="font-size:12px;font-weight:700;color:#8B3A00;line-height:1.8;">Diskon besar tapi durasi pendek (2â€“4 jam). Efektif buat ngabisin stok atau nge-boost order di jam sepi.</div>
        </div>
        <div style="background:#E0E0FF;border-radius:12px;padding:14px;border:2px solid #B0B0FF;">
          <div style="font-size:13px;font-weight:900;color:#3030B0;margin-bottom:8px;">ğŸ‰ Momen Spesial</div>
          <div style="font-size:12px;font-weight:700;color:#252580;line-height:1.8;">Harbolnas, ulang tahun toko, Lebaran, dll. Kombinasi bundling + diskon ringan untuk maksimal dampak.</div>
        </div>
      </div>
    </div>

    <div class="card" style="background:linear-gradient(135deg,#FFF8F0,#FFF0E0);border-color:var(--orange);">
      <div class="card-title" style="margin-bottom:10px;color:var(--red);">âš ï¸ Kesalahan Promo yang Sering Terjadi</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li>âŒ <strong>Promo tanpa hitung HPP dulu</strong> â†’ Ujung-ujungnya boncos tanpa sadar.</li>
        <li>âŒ <strong>Promo terlalu lama</strong> â†’ Pelanggan jadi gak mau beli di harga normal.</li>
        <li>âŒ <strong>Lupa hitung platform fee</strong> â†’ Harga promo di GoFood/Shopee masih harus cover potongan 20â€“30%.</li>
        <li>âŒ <strong>Promo semua menu sekaligus</strong> â†’ Lebih baik promo 1â€“2 menu andalan saja, biar ada yang beli menu lain juga.</li>
        <li>âœ… <strong>Yang bener:</strong> Hitung di kalkulator dulu â†’ tentukan durasi â†’ evaluasi setelah promo selesai!</li>
      </ul>
    </div>

  </div>

</div>

<!-- MODAL DETAIL BAHAN -->
<div class="modal-overlay" id="modal-detail" onclick="if(event.target===this)tutupDetail()">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">ğŸ” Detail Bahan Baku</div>
      <button class="modal-close" onclick="tutupDetail()">âœ•</button>
    </div>
    <div class="modal-body" id="modal-detail-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="tutupDetail()">Tutup</button>
      <button class="btn btn-primary" onclick="exportDetailPDF()" style="background:linear-gradient(135deg,#E03027,#F47C20);">
        ğŸ“„ Export PDF
      </button>
    </div>
  </div>
</div>

<!-- TAB KELOLA AKUN (admin only) -->
<div id="tab-akun" class="tab-content" style="max-width:680px;margin:0 auto;width:100%;">
  <div class="section-title">ğŸ‘¥ Kelola Akun</div>
  <div class="section-sub">Tambah, hapus, dan kelola akun kasir</div>

  <!-- Info akun saya -->
  <div class="card" style="margin-bottom:16px;">
    <div class="card-title" style="margin-bottom:12px;">ğŸ™‹ Akun Saya</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
      <div style="flex:1;">
        <div style="font-size:15px;font-weight:800;" id="akun-saya-nama">â€”</div>
        <div style="font-size:12px;color:var(--muted);">ID: <span id="akun-saya-id">â€”</span></div>
      </div>
      <button class="btn btn-secondary" style="font-size:13px;" onclick="bukaGantiPassword()">ğŸ”‘ Ganti Password</button>
    </div>
  </div>

  <!-- Tambah akun baru -->
  <div class="card" style="margin-bottom:16px;">
    <div class="card-title" style="margin-bottom:14px;">â• Tambah Akun Kasir</div>
    <div class="form-row" style="margin-bottom:12px;">
      <div class="form-group">
        <label>ID Pengguna <span style="color:var(--muted);font-weight:400;">(unik, tidak bisa diubah)</span></label>
        <input type="text" id="new-user-id" placeholder="cth: kasir01" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
      <div class="form-group">
        <label>Nama Tampilan</label>
        <input type="text" id="new-user-nama" placeholder="cth: Siti" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
    </div>
    <div class="form-row" style="margin-bottom:12px;">
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="new-user-pass" placeholder="Min. 6 karakter" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
      <div class="form-group">
        <label>Role</label>
        <select id="new-user-role" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;background:var(--card);">
          <option value="kasir">ğŸ’° Kasir (POS saja)</option>
          <option value="admin">âš™ï¸ Admin (akses penuh)</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" onclick="tambahAkun()" style="font-size:14px;padding:10px 20px;">â• Tambah Akun</button>
  </div>

  <!-- Daftar akun -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <div class="card-title">ğŸ“‹ Daftar Akun</div>
      <button class="btn btn-secondary" style="font-size:12px;padding:6px 12px;" onclick="muatDaftarAkun()">ğŸ”„ Refresh</button>
    </div>
    <div id="daftar-akun-list">
      <div style="text-align:center;color:var(--muted);padding:20px;font-size:13px;">Memuat...</div>
    </div>
  </div>
</div>

<!-- Modal Ganti Password -->
<div class="modal-overlay" id="modal-ganti-pass" onclick="if(event.target===this)tutupGantiPassword()">
  <div class="modal-box" style="max-width:400px;">
    <div class="modal-header">
      <div class="modal-title">ğŸ”‘ Ganti Password</div>
      <button class="modal-close" onclick="tutupGantiPassword()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom:12px;">
        <label>Password Lama</label>
        <input type="password" id="ganti-pass-lama" placeholder="Password saat ini" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
      <div class="form-group" style="margin-bottom:12px;">
        <label>Password Baru</label>
        <input type="password" id="ganti-pass-baru" placeholder="Min. 6 karakter" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
      <div class="form-group">
        <label>Konfirmasi Password Baru</label>
        <input type="password" id="ganti-pass-konfirm" placeholder="Ulangi password baru" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-size:14px;" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="tutupGantiPassword()">Batal</button>
      <button class="btn btn-primary" onclick="simpanGantiPassword()">ğŸ’¾ Simpan</button>
    </div>
  </div>
</div>

<!-- Modal User Menu (logout dll) -->
<!-- User dropdown (pojok kanan atas, bukan modal) -->
<div id="modal-user-menu" style="display:none;position:fixed;top:72px;right:16px;z-index:9999;width:240px;background:white;border-radius:20px;box-shadow:0 12px 40px rgba(0,0,0,0.18),0 2px 8px rgba(0,0,0,0.08);border:1.5px solid var(--border);overflow:hidden;font-family:'Nunito',sans-serif;animation:modalIn 0.2s ease;">
  <!-- Header gradient -->
  <div style="background:linear-gradient(135deg,var(--red) 0%,var(--orange) 60%,var(--yellow) 100%);padding:16px 16px 14px;border-radius:18px 18px 0 0;">
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:42px;height:42px;border-radius:13px;background:rgba(255,255,255,0.22);display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ‘¤</div>
      <div>
        <div id="user-menu-title" style="color:white;font-size:14px;font-weight:800;line-height:1.2;">â€”</div>
        <div id="user-menu-role" style="color:rgba(255,255,255,0.8);font-size:11px;font-weight:600;margin-top:2px;"></div>
      </div>
    </div>
  </div>
  <!-- Menu items -->
  <div style="padding:8px;">
    <button onclick="tutupMenuUser();bukaGantiPassword()"
      style="width:100%;padding:11px 14px;border-radius:12px;border:none;background:transparent;color:var(--dark);font-size:13px;font-weight:700;font-family:'Nunito',sans-serif;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;"
      onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
      <span style="font-size:16px;">ğŸ”‘</span> <span>Ganti Password</span>
    </button>
    <div style="height:1px;background:var(--border);margin:2px 6px;"></div>
    <button onclick="doLogoutClick()"
      style="width:100%;padding:11px 14px;border-radius:12px;border:none;background:transparent;color:var(--red);font-size:13px;font-weight:700;font-family:'Nunito',sans-serif;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;"
      onmouseover="this.style.background='var(--light-red)'" onmouseout="this.style.background='transparent'">
      <span style="font-size:16px;">ğŸšª</span> <span>Keluar</span>
    </button>
  </div>
</div>

<!-- MODAL EDIT MENU -->
<div class="modal-overlay" id="modal-edit" onclick="if(event.target===this)tutupEdit()">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">âœï¸ Edit Menu</div>
      <button class="modal-close" onclick="tutupEdit()">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-idx" />

      <div class="form-row" style="margin-bottom:12px;">
        <div class="form-group">
          <label>Nama Menu</label>
          <input type="text" id="edit-nama" />
        </div>
        <div class="form-group">
          <label>Kategori</label>
          <select id="edit-kategori">
            <option value="takoyaki">ğŸ™ Takoyaki</option>
            <option value="dimsum">ğŸ¥Ÿ Dimsum</option>
            <option value="ayam">ğŸ— Ayam Crispy</option>
            <option value="lainnya">ğŸ± Lainnya</option>
          </select>
        </div>
      </div>

      <div class="form-group" style="margin-bottom:16px;">
        <label>Foto Menu</label>
        <input type="file" id="edit-foto-menu" accept="image/*" onchange="previewFoto(this, 'preview-edit-foto')" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        <div id="preview-edit-foto" style="margin-top:8px;"></div>
      </div>

      <div class="form-row" style="margin-bottom:16px;">
        <div class="form-group">
          <label>Porsi / Batch (pcs)</label>
          <input type="number" id="edit-porsi" min="1" oninput="hitungEditHPP()" />
        </div>
        <div class="form-group">
          <label>Biaya Kemasan / pcs (Rp)</label>
          <input type="number" id="edit-kemasan" min="0" oninput="hitungEditHPP()" />
        </div>
      </div>

      <!-- BAHAN BAKU -->
      <div class="card" style="margin-bottom:12px;">
        <div class="card-header">
          <div class="card-title">ğŸ§… Bahan Baku</div>
        </div>
        <div class="bahan-header">
          <span>Nama Bahan</span>
          <span>Qty Pakai</span>
          <span class="col-harga-satuan">Harga Beli (Rp)</span>
          <span class="col-harga-satuan">Ukuran Beli</span>
          <span></span>
        </div>
        <div id="edit-bahan-list"></div>
        <button class="btn btn-add" onclick="tambahEditBahan()">ï¼‹ Tambah Bahan</button>
      </div>

      <!-- BIAYA OPERASIONAL -->
      <div class="card" style="margin-bottom:12px;">
        <div class="card-header">
          <div class="card-title">âš™ï¸ Biaya Operasional / Batch</div>
        </div>
        <div id="edit-biaya-list"></div>
        <button class="btn btn-add" onclick="tambahEditBiaya()">ï¼‹ Tambah Biaya</button>
      </div>

      <!-- HARGA JUAL -->
      <div class="form-group" style="margin-bottom:8px;">
        <label>Harga Jual (Rp) â€” bisa disesuaikan manual</label>
        <input type="number" id="edit-harga-jual" min="0" />
      </div>

      <!-- HPP PREVIEW -->
      <div class="edit-hpp-preview" id="edit-hpp-preview">â€”</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="tutupEdit()">Batal</button>
      <button class="btn btn-primary" onclick="simpanEdit()">ğŸ’¾ Simpan Perubahan</button>
    </div>
  </div>
</div>

<!-- PRINT AREA -->
<div id="print-area"></div>

<!-- MODAL KONFIRMASI CUSTOM (pengganti confirm() yang diblok di sandbox) -->
<div id="modal-konfirmasi" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);">
  <div style="background:var(--card);border-radius:20px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;max-height:85vh;overflow-y:auto;">
    <div style="padding:20px 20px 0;">
      <div style="font-size:36px;text-align:center;margin-bottom:10px;" id="konfirmasi-icon">âš ï¸</div>
      <div style="font-family:'Fredoka One',cursive;font-size:18px;color:var(--dark);text-align:center;margin-bottom:8px;" id="konfirmasi-title">Konfirmasi</div>
      <div style="font-size:13px;color:var(--dark);font-weight:600;line-height:1.7;margin-bottom:20px;max-height:280px;overflow-y:auto;" id="konfirmasi-message">Yakin?</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:2px solid var(--border);">
      <button id="konfirmasi-batal" onclick="tutupKonfirmasi()" style="padding:16px;border:none;background:transparent;font-family:'Nunito',sans-serif;font-weight:800;font-size:14px;color:var(--muted);cursor:pointer;border-right:1px solid var(--border);">Batal</button>
      <button id="konfirmasi-ok" onclick="eksekusiKonfirmasi()" style="padding:16px;border:none;background:transparent;font-family:'Nunito',sans-serif;font-weight:800;font-size:14px;color:var(--red);cursor:pointer;">Ya, Lanjutkan</button>
    </div>
  </div>
</div>

<!-- MODAL NOTA / DETAIL ORDER -->
<div id="modal-nota" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:300;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(4px);">
  <div style="background:var(--card);border-radius:20px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
    <div style="position:sticky;top:0;background:var(--card);padding:16px 20px 12px;border-bottom:2px solid var(--border);display:flex;justify-content:space-between;align-items:center;border-radius:20px 20px 0 0;">
      <div style="font-family:'Fredoka One',cursive;font-size:18px;color:var(--red);">ğŸ§¾ Detail Order</div>
      <button onclick="tutupNota()" style="background:var(--bg);border:2px solid var(--border);border-radius:50%;width:34px;height:34px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;">âœ•</button>
    </div>
    <div id="nota-body" style="padding:20px;"></div>
    <div style="position:sticky;bottom:0;background:var(--card);padding:14px 20px;border-top:2px solid var(--border);display:flex;gap:10px;border-radius:0 0 20px 20px;">
      <button onclick="printNota()" class="btn btn-primary" style="flex:1;">ğŸ–¨ï¸ Print Nota</button>
      <button onclick="tutupNota()" class="btn btn-secondary" style="flex:1;">Tutup</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">âœ… Tersimpan!</div>
</div><!-- end app-layout -->

<script>

// =====================
// FIREBASE CONFIG
// =====================
const _FB_CONFIG = {
  apiKey: "AIzaSyCsGuVqaCm3kd2FDXSSGS2EAZ4hk7mvIiU",
  authDomain: "kedai-heula.firebaseapp.com",
  databaseURL: "https://kedai-heula-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kedai-heula",
  storageBucket: "kedai-heula.firebasestorage.app",
  messagingSenderId: "881486739937",
  appId: "1:881486739937:web:3ddedb1f882e7071c33aa0"
};

// Firebase SDK globals (loaded via CDN)
let _fbApp, _fbDb, _fbRef, _fbSet, _fbGet, _fbUpdate, _fbRemove, _fbOnValue, _fbOff, _fbPush, _fbChild, _fbOnDisconnect;

function initFirebase() {
  _fbApp    = firebase.initializeApp(_FB_CONFIG);
  _fbDb     = firebase.database();
  _fbRef    = (path) => firebase.database().ref(path);
  _fbSet    = (ref, val) => ref.set(val);
  _fbGet    = (ref) => ref.get();
  _fbUpdate = (ref, val) => ref.update(val);
  _fbRemove = (ref) => ref.remove();
  _fbOnValue = (ref, cb) => { ref.on('value', cb); return ref; };
  _fbPush   = (ref, val) => ref.push(val);
  _fbChild  = (ref, path) => ref.child(path);
}

// =====================
// FIREBASE SHA-256 HASH
// =====================
async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// =====================
// AUTH STATE
// =====================
let _authUser = null;
let _sessionCheckTimer = null;
let _kickCountdownTimer = null;
let _kickCountdownSeconds = 0;
let _fbListeners = {}; // track realtime listeners

// =====================
// REALTIME LISTENERS
// =====================
function startRealtimeListeners() {
  if (!_authUser) return;

  // Listen menu changes
  const menuRef = _fbRef('kedai_data/menu');
  _fbListeners.menu = menuRef;
  menuRef.on('value', (snap) => {
    const data = snap.val();
    if (data) {
      const arr = Object.values(data);
      menuList = arr;
      localStorage.setItem('kedaiHeula_menu', JSON.stringify(arr));
      renderRingkasan();
      renderPOSGrid();
      renderPOSBundling();
    } else {
      menuList = [];
      localStorage.setItem('kedaiHeula_menu', '[]');
      renderRingkasan();
      renderPOSGrid();
    }
  });

  // Listen promos changes
  const promoRef = _fbRef('kedai_data/promos');
  _fbListeners.promos = promoRef;
  promoRef.on('value', (snap) => {
    const data = snap.val();
    const arr = data ? Object.values(data) : [];
    localStorage.setItem('kedaiHeula_promos', JSON.stringify(arr));
    if (typeof renderPromoList === 'function') renderPromoList();
    if (typeof refreshPromoDropdown === 'function') refreshPromoDropdown();
    if (typeof refreshDropdownDiskon === 'function') refreshDropdownDiskon();
    if (typeof refreshAllBundleDropdowns === 'function') refreshAllBundleDropdowns();
    // Selalu re-render POS bundling saat promo berubah (kasir langsung lihat)
    renderPOSBundling();
    renderPOSGrid(); // refresh juga item satuan
  });

  // Listen transaksi changes
  const trxRef = _fbRef('kedai_data/transaksi');
  _fbListeners.transaksi = trxRef;
  trxRef.on('value', (snap) => {
    const data = snap.val();
    const arr = data ? Object.values(data) : [];
    localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(arr));
    updatePOSSummary();
    // Re-render laporan (realtime update saat kasir buat transaksi)
    const tabLaporan = document.getElementById('tab-laporan');
    if (tabLaporan && tabLaporan.classList.contains('active')) {
      renderLaporan();
    }
  });

  // Listen session kick: jika token berubah di Firebase, user lain sudah login
  const sessionRef = _fbRef(`users/${_authUser.userId}/currentToken`);
  _fbListeners.session = sessionRef;
  sessionRef.on('value', (snap) => {
    const remoteToken = snap.val();
    if (remoteToken && remoteToken !== _authUser.token) {
      // Token berubah = device lain login
      stopRealtimeListeners();
      startKickCountdown();
    }
  });
}

function stopRealtimeListeners() {
  Object.entries(_fbListeners).forEach(([key, ref]) => {
    if (ref && ref.off) ref.off('value');
  });
  _fbListeners = {};
}

// =====================
// LOGIN
// =====================
async function doLoginClick() {
  const userId   = document.getElementById('login-id').value.trim().toLowerCase();
  const password = document.getElementById('login-pass').value;
  const btn      = document.getElementById('login-btn');

  if (!userId || !password) { showLoginError('ID dan password tidak boleh kosong'); return; }

  btn.disabled = true;
  btn.textContent = 'â³ Masuk...';
  document.getElementById('login-error').style.display = 'none';

  try {
    // Ambil data user dari Firebase
    const snap = await _fbGet(_fbRef(`users/${userId}`));
    if (!snap.exists()) {
      showLoginError('ID pengguna tidak ditemukan');
      return;
    }

    const userData = snap.val();
    const inputHash = await sha256(password);

    if (inputHash !== userData.passwordHash) {
      showLoginError('Password salah');
      return;
    }

    // Buat token baru dan simpan ke Firebase (kick device lain)
    const newToken = 'tok_' + Date.now() + '_' + Math.random().toString(36).slice(2);
    await _fbUpdate(_fbRef(`users/${userId}`), { currentToken: newToken, lastLogin: new Date().toISOString() });

    _authUser = {
      userId: userData.userId,
      username: userData.username,
      role: userData.role,
      token: newToken
    };
    localStorage.setItem('kedaiHeula_auth', JSON.stringify(_authUser));
    onLoginSuccess();

  } catch(e) {
    showLoginError('Gagal terhubung: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ”“ Masuk';
  }
}

function showLoginError(msg) {
  const el = document.getElementById('login-error');
  el.textContent = 'âš ï¸ ' + msg;
  el.style.display = 'block';
}

// -- Session Check (realtime via Firebase listener sudah handle ini)
function startSessionCheck() {
  // Tidak perlu polling - Firebase listener di startRealtimeListeners() sudah handle
}

function startKickCountdown() {
  if (_kickCountdownTimer) return;
  _kickCountdownSeconds = 30;
  showKickBanner(_kickCountdownSeconds);

  _kickCountdownTimer = setInterval(() => {
    _kickCountdownSeconds--;
    updateKickBanner(_kickCountdownSeconds);
    if (_kickCountdownSeconds <= 0) {
      clearInterval(_kickCountdownTimer);
      _kickCountdownTimer = null;
      tutupKickBanner();
      forceLogout('Sesi berakhir - akun ini sudah login di perangkat lain.');
    }
  }, 1000);
}

function showKickBanner(secs) {
  let el = document.getElementById('kick-banner');
  if (!el) {
    el = document.createElement('div');
    el.id = 'kick-banner';
    el.style.cssText = `
      position:fixed;bottom:0;left:0;right:0;z-index:99999;
      background:linear-gradient(135deg,#E03027,#F47C20);
      color:white;padding:16px 20px;
      display:flex;align-items:center;gap:14px;flex-wrap:wrap;
      box-shadow:0 -4px 20px rgba(224,48,39,0.4);
      font-family:'Nunito',sans-serif;
    `;
    document.body.appendChild(el);
  }
  el.innerHTML = `
    <div style="flex:1;min-width:200px;">
      <div style="font-size:15px;font-weight:800;">âš ï¸ Perangkat Lain Login</div>
      <div style="font-size:13px;opacity:0.9;">Akun ini baru saja login di perangkat lain. Sesi ini akan berakhir dalam <strong id="kick-countdown">${secs}</strong> detik.</div>
    </div>
    <button onclick="tetapDisini()" style="
      background:white;color:var(--red);border:none;border-radius:10px;
      padding:10px 18px;font-size:13px;font-weight:800;cursor:pointer;
      font-family:'Nunito',sans-serif;white-space:nowrap;
    ">âœ‹ Tetap di Sini</button>
    <button onclick="doLogoutClick()" style="
      background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.4);
      border-radius:10px;padding:10px 18px;font-size:13px;font-weight:800;cursor:pointer;
      font-family:'Nunito',sans-serif;white-space:nowrap;
    ">ğŸšª Logout Sekarang</button>
  `;
}

function updateKickBanner(secs) {
  const el = document.getElementById('kick-countdown');
  if (el) el.textContent = secs;
}

function tutupKickBanner() {
  const el = document.getElementById('kick-banner');
  if (el) el.remove();
}

async function tetapDisini() {
  if (!_authUser) return;
  try {
    // Buat token baru - register device ini lagi
    const newToken = 'tok_' + Date.now() + '_' + Math.random().toString(36).slice(2);
    await _fbUpdate(_fbRef(`users/${_authUser.userId}`), { currentToken: newToken });
    _authUser.token = newToken;
    localStorage.setItem('kedaiHeula_auth', JSON.stringify(_authUser));
    clearInterval(_kickCountdownTimer);
    _kickCountdownTimer = null;
    tutupKickBanner();
    startRealtimeListeners();
    showToast('âœ… Kamu tetap masuk!');
  } catch(e) {
    showToast('âŒ Gagal: ' + e.message);
  }
}

// -- Logout
async function doLogoutClick() {
  showKonfirmasi({
    icon: 'ğŸšª', title: 'Keluar?',
    message: 'Kamu akan keluar dari akun ini.',
    labelOk: 'Ya, Keluar',
    onOk: () => forceLogout()
  });
}

function forceLogout(msg) {
  stopRealtimeListeners();
  _authUser = null;
  localStorage.removeItem('kedaiHeula_auth');

  const ls = document.getElementById('login-screen');
  ls.style.display = 'flex';
  ls.style.flexDirection = 'column';
  ls.style.alignItems = 'center';
  ls.style.justifyContent = 'center';
  ls.classList.remove('hidden');

  const appWrapper = document.getElementById('app-wrapper');
  if (appWrapper) appWrapper.style.display = 'none';

  document.getElementById('login-id').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('login-error').style.display = 'none';
  document.body.classList.remove('role-admin', 'role-kasir');

  tutupMenuUser();
  tutupKickBanner();

  if (msg) showLoginError(msg);
}

// -- Kelola Akun
async function muatDaftarAkun() {
  const container = document.getElementById('daftar-akun-list');
  container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;font-size:13px;">â³ Memuat...</div>';
  try {
    const snap = await _fbGet(_fbRef('users'));
    if (!snap.exists()) { container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;">Belum ada akun</div>'; return; }
    const users = snap.val();
    container.innerHTML = Object.values(users).map(u => `
      <div class="akun-row">
        <div class="ar-info">
          <div class="ar-id">${u.username} <span class="role-badge ${u.role}">${u.role}</span></div>
          <div class="ar-role">ID: ${u.userId} Â· Dibuat: ${u.createdAt ? u.createdAt.split('T')[0] : '-'}</div>
        </div>
        ${u.userId !== 'admin' ? `<button class="btn btn-danger" style="font-size:12px;padding:6px 12px;" onclick="hapusAkun('${u.userId}','${u.username}')">ğŸ—‘ï¸ Hapus</button>` : '<span style="font-size:11px;color:var(--muted);">Admin utama</span>'}
      </div>
    `).join('');
  } catch(e) { container.innerHTML = '<div style="color:var(--red);padding:16px;">âŒ Gagal memuat: ' + e.message + '</div>'; }
}

async function tambahAkun() {
  const userId   = document.getElementById('new-user-id').value.trim().toLowerCase();
  const username = document.getElementById('new-user-nama').value.trim();
  const password = document.getElementById('new-user-pass').value;
  const role     = document.getElementById('new-user-role').value;

  if (!userId || !username || !password) { showToast('âš ï¸ Lengkapi semua field'); return; }
  if (password.length < 6) { showToast('âš ï¸ Password minimal 6 karakter'); return; }
  if (!/^[a-zA-Z0-9_]+$/.test(userId)) { showToast('âš ï¸ ID hanya huruf, angka, underscore'); return; }

  try {
    // Cek apakah userId sudah ada
    const snap = await _fbGet(_fbRef(`users/${userId}`));
    if (snap.exists()) { showToast('âŒ ID pengguna sudah digunakan'); return; }

    const hash = await sha256(password);
    await _fbSet(_fbRef(`users/${userId}`), {
      userId, username, role,
      passwordHash: hash,
      createdAt: new Date().toISOString(),
      currentToken: null
    });

    showToast('âœ… Akun berhasil dibuat!');
    document.getElementById('new-user-id').value = '';
    document.getElementById('new-user-nama').value = '';
    document.getElementById('new-user-pass').value = '';
    muatDaftarAkun();
  } catch(e) { showToast('âŒ Error: ' + e.message); }
}

async function hapusAkun(userId, username) {
  showKonfirmasi({
    icon: 'ğŸ—‘ï¸', title: 'Hapus Akun?',
    message: `Akun "${username}" (ID: ${userId}) akan dihapus permanen.`,
    labelOk: 'Ya, Hapus',
    onOk: async () => {
      try {
        await _fbRemove(_fbRef(`users/${userId}`));
        showToast('âœ… Akun dihapus');
        muatDaftarAkun();
      } catch(e) { showToast('âŒ Error: ' + e.message); }
    }
  });
}

async function simpanGantiPassword() {
  const lama   = document.getElementById('ganti-pass-lama').value;
  const baru   = document.getElementById('ganti-pass-baru').value;
  const konfirm = document.getElementById('ganti-pass-konfirm').value;
  if (!lama || !baru) { showToast('âš ï¸ Isi semua field'); return; }
  if (baru.length < 6) { showToast('âš ï¸ Password baru minimal 6 karakter'); return; }
  if (baru !== konfirm) { showToast('âš ï¸ Konfirmasi tidak cocok'); return; }
  try {
    const snap = await _fbGet(_fbRef(`users/${_authUser.userId}`));
    const userData = snap.val();
    const lamaHash = await sha256(lama);
    if (lamaHash !== userData.passwordHash) { showToast('âŒ Password lama salah'); return; }
    const baruHash = await sha256(baru);
    await _fbUpdate(_fbRef(`users/${_authUser.userId}`), { passwordHash: baruHash });
    tutupGantiPassword();
    showToast('âœ… Password berhasil diubah!');
  } catch(e) { showToast('âŒ Error: ' + e.message); }
}

// =====================
// FIREBASE DATA OPS
// =====================

// Simpan menu ke Firebase (realtime push ke semua device)
async function fbSaveMenu(menuArr) {
  try {
    const obj = {};
    menuArr.forEach(item => { obj[item.id] = item; });
    await _fbSet(_fbRef('kedai_data/menu'), obj.length === 0 ? null : obj);
  } catch(e) { console.warn('fbSaveMenu error:', e); }
}

async function fbDeleteMenu(menuId) {
  try {
    await _fbRemove(_fbRef(`kedai_data/menu/${menuId}`));
  } catch(e) { console.warn('fbDeleteMenu error:', e); }
}

async function fbSavePromos(promosArr) {
  try {
    const obj = {};
    promosArr.forEach(p => { if (p.id) obj[p.id] = p; });
    await _fbSet(_fbRef('kedai_data/promos'), Object.keys(obj).length === 0 ? null : obj);
  } catch(e) { console.warn('fbSavePromos error:', e); }
}

async function fbSaveTransaksi(trxArr) {
  try {
    const obj = {};
    trxArr.forEach(t => { obj[t.id] = t; });
    await _fbSet(_fbRef('kedai_data/transaksi'), Object.keys(obj).length === 0 ? null : obj);
  } catch(e) { console.warn('fbSaveTransaksi error:', e); }
}

async function fbAddTransaksi(trx) {
  try {
    await _fbSet(_fbRef(`kedai_data/transaksi/${trx.id}`), trx);
  } catch(e) { console.warn('fbAddTransaksi error:', e); }
}

// Compat stubs - fungsi lama yang dipanggil dari core, kita redirect ke Firebase
function autoSyncPush(type = 'menu') {
  if (type === 'menu') {
    fbSaveMenu(menuList);
  } else if (type === 'promo') {
    const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
    fbSavePromos(promos);
  } else if (type === 'transaksi') {
    const allKeys = Object.keys(localStorage).filter(k => k.startsWith('kedaiHeula_pos_'));
    let allTrx = [];
    allKeys.forEach(k => {
      try { allTrx = allTrx.concat(JSON.parse(localStorage.getItem(k) || '[]')); } catch(e) {}
    });
    const laporan = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
    const allMerged = [...allTrx, ...laporan];
    const dedupMap = {};
    allMerged.forEach(t => { if (t.id) dedupMap[t.id] = t; });
    fbSaveTransaksi(Object.values(dedupMap));
  }
}

function syncPromosToCloud() {
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  fbSavePromos(promos);
}

function updateSyncStatus() {
  const el = document.getElementById('sync-status');
  if (!el) return;
  el.textContent = 'ğŸ”´ Firebase Realtime';
  el.style.color = 'var(--green)';
  const dot = el.previousElementSibling;
  if (dot && dot.textContent === 'ğŸ”´') {
    dot.textContent = 'ğŸŸ¢';
  }
}

// stubs yang tidak lagi diperlukan tapi mungkin dipanggil dari HTML
function getSheetsUrl() { return 'firebase'; }
function bukaSyncConfig() { showToast('â„¹ï¸ Menggunakan Firebase Realtime Database'); }
function tutupSyncConfig() {}
async function simpanSyncConfig() {}
async function syncKeSheets() { showToast('â„¹ï¸ Data otomatis tersimpan ke Firebase'); }
async function restoreFromSheets() {
  showToast('â³ Memuat ulang dari Firebase...');
  // Data sudah auto-sync via listener, cukup trigger render
  renderRingkasan();
  renderPOSGrid();
  renderPOSBundling();
}
async function autoSyncOnLoad() {
  // Tidak perlu, Firebase listeners sudah handle
}
async function syncManual() {
  showToast('â³ Menyinkronkan...');
  // Trigger fresh read dari Firebase
  try {
    const [menuSnap, promoSnap, trxSnap] = await Promise.all([
      _fbGet(_fbRef('kedai_data/menu')),
      _fbGet(_fbRef('kedai_data/promos')),
      _fbGet(_fbRef('kedai_data/transaksi'))
    ]);
    if (menuSnap.val()) {
      menuList = Object.values(menuSnap.val());
      localStorage.setItem('kedaiHeula_menu', JSON.stringify(menuList));
      renderRingkasan(); renderPOSGrid();
    }
    if (promoSnap.val()) {
      const arr = Object.values(promoSnap.val());
      localStorage.setItem('kedaiHeula_promos', JSON.stringify(arr));
      if (typeof renderPromoList === 'function') renderPromoList();
      refreshPromoDropdown(); renderPOSBundling();
    }
    showToast('âœ… Data tersinkronisasi!');
  } catch(e) { showToast('âŒ Gagal sync: ' + e.message); }
}
async function bersihkanDuplikat() {
  const bersih = dedupMenu(menuList);
  menuList = bersih;
  localStorage.setItem('kedaiHeula_menu', JSON.stringify(bersih));
  await fbSaveMenu(bersih);
  renderRingkasan();
  showToast('âœ… Duplikat dibersihkan! ' + bersih.length + ' menu tersisa.');
}
async function pullPromosFromCloud() {
  const snap = await _fbGet(_fbRef('kedai_data/promos'));
  if (snap.val()) {
    const arr = Object.values(snap.val());
    localStorage.setItem('kedaiHeula_promos', JSON.stringify(arr));
    if (typeof renderPromoList === 'function') renderPromoList();
    refreshPromoDropdown(); renderPOSBundling();
  }
}
async function pullTrxFromCloud() {
  const snap = await _fbGet(_fbRef('kedai_data/transaksi'));
  if (snap.val()) {
    const arr = Object.values(snap.val());
    localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(arr));
    updatePOSSummary();
  }
}
function syncTransaksiKeSheets() {
  autoSyncPush('transaksi');
}
async function restoreTransaksiFromSheets() {
  await pullTrxFromCloud();
}
async function restorePromosFromCloud() {
  await pullPromosFromCloud();
}
function debugLog(msg, isErr) {
  if (isErr) console.error(msg); else console.log(msg);
}
function simpanLoginUrl() { showToast('â„¹ï¸ Firebase tidak perlu URL manual'); }
function bukaLoginSetupUrl() { showToast('â„¹ï¸ Menggunakan Firebase Realtime Database'); }



// =====================
// STATE
// =====================
let bahanCount = 0;
let biayaCount = 0;
let menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
let lastHPP = 0;
let lastPorsi = 0;
let lastNama = '';

// =====================
// INIT
// =====================
// Ensure all functions are defined before DOM ready

window.onload = () => {
  try {
    tambahBahan(); tambahBahan(); tambahBahan();
    tambahBiaya();

    // Migrasi data lama
    const existingMenu = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
    let needsMigration = false;
    existingMenu.forEach(item => {
      if (!item.id) {
        item.id = 'menu_' + Date.now() + '_' + Math.floor(Math.random() * 9999);
        needsMigration = true;
      }
    });
    if (needsMigration) {
      menuList = existingMenu;
    }

    renderRingkasan();
    tambahBundleItem();
    tambahBundleItem();

    // Init Firebase
    initFirebase();

    // Cek saved session
    const savedAuth = localStorage.getItem('kedaiHeula_auth');
    if (savedAuth) {
      try {
        const parsed = JSON.parse(savedAuth);
        if (parsed.userId && parsed.token) {
          // Verifikasi token masih valid di Firebase
          _fbGet(_fbRef(`users/${parsed.userId}/currentToken`)).then(snap => {
            if (snap.val() === parsed.token) {
              _authUser = parsed;
              onLoginSuccess();
            } else {
              localStorage.removeItem('kedaiHeula_auth');
            }
          }).catch(() => {
            // Offline - masuk dengan saved session
            _authUser = parsed;
            onLoginSuccess();
          });
        } else {
          localStorage.removeItem('kedaiHeula_auth');
        }
      } catch(e) {
        localStorage.removeItem('kedaiHeula_auth');
      }
    }
  } catch(e) {
    console.error('Init error:', e);
  }

  window.onafterprint = () => {
    document.getElementById('print-area').innerHTML = '';
  };
};




// =====================
// USER MENU DROPDOWN
// =====================
function bukaMenuUser() {
  if (!_authUser) return;
  const menu = document.getElementById('modal-user-menu');
  if (menu.style.display === 'block') {
    menu.style.display = 'none';
    return;
  }
  document.getElementById('user-menu-title').textContent = _authUser.username;
  const roleEl = document.getElementById('user-menu-role');
  if (roleEl) roleEl.textContent = _authUser.role === 'admin' ? 'âš™ï¸ Administrator' : 'ğŸ’° Kasir';
  menu.style.display = 'block';
}

function tutupMenuUser() {
  const menu = document.getElementById('modal-user-menu');
  if (menu) menu.style.display = 'none';
}

// Close dropdown saat klik di luar
document.addEventListener('click', function(e) {
  const menu = document.getElementById('modal-user-menu');
  const badge = document.getElementById('user-badge');
  if (menu && badge && !menu.contains(e.target) && !badge.contains(e.target)) {
    menu.style.display = 'none';
  }
});

// =====================
// ON LOGIN SUCCESS
// =====================
function onLoginSuccess() {
  // Sembunyikan login screen, tampilkan app
  const loginScreen = document.getElementById('login-screen');
  loginScreen.style.display = 'none';
  loginScreen.classList.add('hidden');
  const appWrapper = document.getElementById('app-wrapper');
  if (appWrapper) appWrapper.style.display = 'block';
  document.getElementById('login-pass').value = '';

  // Set role di body untuk CSS
  document.body.classList.remove('role-admin', 'role-kasir');
  document.body.classList.add('role-' + _authUser.role);

  // Update user badge
  document.getElementById('ub-name').textContent = _authUser.username;
  document.getElementById('ub-role').textContent = _authUser.role === 'admin' ? 'âš™ï¸ Admin' : 'ğŸ’° Kasir';

  // Update halaman akun saya
  const akunNama = document.getElementById('akun-saya-nama');
  const akunId = document.getElementById('akun-saya-id');
  if (akunNama) akunNama.textContent = _authUser.username;
  if (akunId) akunId.textContent = _authUser.userId;

  // Aktifkan realtime listeners Firebase
  startRealtimeListeners();

  // Aktifkan tab yang sesuai
  if (_authUser.role === 'kasir') {
    // PAKSA sembunyikan semua tab admin via JS (bukan hanya CSS)
    document.querySelectorAll('.tab-admin-only').forEach(el => {
      el.style.display = 'none';
      el.setAttribute('hidden', '');
    });
    // Pastikan tabs-wrapper tidak terlihat di mobile
    if (window.innerWidth <= 768) {
      const tw = document.querySelector('.tabs-wrapper');
      if (tw) tw.style.display = 'none';
    }
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-icon').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-pos').classList.add('active');
    const posBtnEl = document.getElementById('tab-btn-pos');
    if (posBtnEl) posBtnEl.classList.add('active');
    renderPOSGrid(); updatePOSSummary();
    renderPOSBundling();
    setTimeout(() => { renderPOSBundling(); refreshPromoDropdown(); }, 1500);
  } else {
    // Admin - tab default Hitung HPP
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-icon').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-hitung').classList.add('active');
    const hitungBtn = document.querySelector(".tab-icon[onclick*=\'hitung\']");
    if (hitungBtn) hitungBtn.classList.add('active');
    renderRingkasan();
    muatDaftarAkun();
  }
}

// =====================
// TAB
// =====================
function switchTab(id) {
  // Kasir hanya boleh akses tab pos
  const adminOnlyTabs = ['hitung','ringkasan','laporan','promo','panduan','akun'];
  if (_authUser && _authUser.role === 'kasir' && adminOnlyTabs.includes(id)) {
    showToast('â›” Akses ditolak â€” hubungi admin', 'error');
    return;
  }
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-icon').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  if (event && event.currentTarget) event.currentTarget.classList.add('active');

  if (id === 'ringkasan') { renderRingkasan(); updateSyncStatus(); }
  if (id === 'laporan') initLaporan();

  // Fix 1: Pull promo terbaru dari cloud saat buka tab Promo
  if (id === 'promo') {
    refreshDropdownDiskon();
    refreshAllBundleDropdowns();
    refreshDropdownBeliGratis();
    renderPromoList();
    if (localStorage.getItem('kedaiHeula_sheetsUrl')) pullPromosFromCloud();
  }

  if (id === 'akun') {
    document.getElementById('akun-saya-nama').textContent = _authUser ? _authUser.username : '-';
    document.getElementById('akun-saya-id').textContent = _authUser ? _authUser.userId : '-';
    muatDaftarAkun();
  }
  if (id === 'pos') {
    renderPOSGrid();
    renderPOSBundling();
    updatePOSSummary();
    refreshPromoDropdown();
    if (localStorage.getItem('kedaiHeula_sheetsUrl')) pullTrxFromCloud();
  }
}



// =====================
// BAHAN
// =====================
function tambahBahan() {
  bahanCount++;
  const id = bahanCount;
  const div = document.createElement('div');
  div.className = 'bahan-row';
  div.id = 'bahan-' + id;
  div.innerHTML = `
    <input type="text" placeholder="cth: Tepung takoyaki" />
    <input type="number" min="0" step="any" placeholder="150" title="Qty yang dipakai per batch" />
    <input type="number" min="0" step="any" placeholder="12000" title="Harga beli total (Rp)" class="col-harga-satuan" />
    <input type="number" min="0" step="any" placeholder="1000" title="Ukuran/berat kemasan beli" class="col-harga-satuan" />
    <button class="btn btn-danger" onclick="hapusBahan(${id})" title="Hapus">âœ•</button>
  `;
  document.getElementById('bahan-list').appendChild(div);
}

function hapusBahan(id) {
  const el = document.getElementById('bahan-' + id);
  if (el) el.remove();
}

// =====================
// BIAYA OPERASIONAL
// =====================
function tambahBiaya() {
  biayaCount++;
  const id = biayaCount;
  const div = document.createElement('div');
  div.className = 'biaya-row';
  div.id = 'biaya-' + id;
  div.innerHTML = `
    <input type="text" placeholder="cth: Gas LPG per batch" />
    <input type="number" min="0" step="any" placeholder="1000" title="Biaya (Rp)" />
    <button class="btn btn-danger" onclick="hapusBiaya(${id})" title="Hapus">âœ•</button>
  `;
  document.getElementById('biaya-list').appendChild(div);
}

function hapusBiaya(id) {
  const el = document.getElementById('biaya-' + id);
  if (el) el.remove();
}

// =====================
// HITUNG HPP
// =====================
let lastSnapshot = {}; // simpan raw data bahan untuk disimpan ke ringkasan

function hitungHPP() {
  const nama = document.getElementById('nama-menu').value.trim() || 'Menu Tanpa Nama';
  const kategori = document.getElementById('kategori-menu').value;
  const porsi = parseFloat(document.getElementById('porsi').value) || 1;
  const kemasan = parseFloat(document.getElementById('biaya-kemasan').value) || 0;

  // Hitung bahan -- scope ke #bahan-list supaya tidak baca dari modal edit
  let totalBahan = 0;
  const bahanRows = document.querySelectorAll('#bahan-list .bahan-row');
  const bahanDetail = [];
  const bahanRaw = [];

  bahanRows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    const namaBahan = inputs[0].value.trim();
    const qty = parseFloat(inputs[1].value) || 0;
    const hargaBeli = parseFloat(inputs[2].value) || 0;
    const ukuranBeli = parseFloat(inputs[3].value) || 1;
    if (!namaBahan || qty === 0 || hargaBeli === 0) return;

    const biayaBahan = (qty / ukuranBeli) * hargaBeli;
    totalBahan += biayaBahan;
    bahanDetail.push({ nama: namaBahan, biaya: biayaBahan });
    bahanRaw.push({ nama: namaBahan, qty, hargaBeli, ukuranBeli, biaya: biayaBahan });
  });

  // Hitung biaya operasional -- scope ke #biaya-list supaya tidak baca dari modal edit
  let totalOperasional = 0;
  const biayaRows = document.querySelectorAll('#biaya-list .biaya-row');
  const biayaDetail = [];
  const biayaRaw = [];

  biayaRows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    const namaB = inputs[0].value.trim();
    const nominal = parseFloat(inputs[1].value) || 0;
    if (!namaB || nominal === 0) return;
    totalOperasional += nominal;
    biayaDetail.push({ nama: namaB, biaya: nominal });
    biayaRaw.push({ nama: namaB, biaya: nominal });
  });

  const totalKemasan = kemasan * porsi;
  const totalBatch = Math.round(totalBahan + totalKemasan + totalOperasional);
  const hpp = Math.round(totalBatch / porsi);
  const bep = Math.round(hpp / (1 - 0.30));

  lastHPP = hpp;
  lastPorsi = porsi;
  lastNama = nama;

  // Simpan snapshot lengkap untuk disimpan ke ringkasan
  lastSnapshot = { nama, kategori, porsi, kemasan, bahanRaw, biayaRaw, totalBatch, hpp, foto: currentFotoBase64 };

  // Update UI
  document.getElementById('res-total-batch').textContent = formatRp(totalBatch);
  document.getElementById('res-batch-info').textContent = `untuk ${porsi} pcs / batch`;
  document.getElementById('res-hpp').textContent = formatRp(hpp);
  document.getElementById('res-bep').textContent = formatRp(bep);

  // Saran harga jual - offline & online
  const harga30 = roundHargaMakanan(hpp / (1 - 0.30));
  const harga50 = roundHargaMakanan(hpp / (1 - 0.50));
  const harga70 = roundHargaMakanan(hpp / (1 - 0.70));

  // Simpan ke hidden input (dipakai oleh updateHargaTerpilih)
  document.getElementById('harga-30-offline').value = harga30;
  document.getElementById('harga-50-offline').value = harga50;
  document.getElementById('harga-70-offline').value = harga70;
  document.getElementById('harga-30-online').value = roundHargaMakanan(harga30 * 1.25);
  document.getElementById('harga-50-online').value = roundHargaMakanan(harga50 * 1.25);
  document.getElementById('harga-70-online').value = roundHargaMakanan(harga70 * 1.25);

  // Set default ke STANDAR & OFFLINE, lalu update tampilan
  selectedMargin = 50;
  selectedChannel = 'offline';
  selectedHargaJual = harga50;

  // Highlight tombol STANDAR sebagai default
  [30, 50, 70].forEach(m => {
    const btn = document.getElementById('btn-kategori-' + m);
    if (!btn) return;
    btn.style.boxShadow = m === 50 ? '0 4px 12px rgba(0,0,0,0.15)' : '';
    btn.style.transform = m === 50 ? 'scale(1.05)' : '';
  });

  // Tampilkan channel selector
  document.getElementById('channel-selector').style.display = 'block';
  updateHargaTerpilih();

  // Breakdown table
  const tbody = document.getElementById('breakdown-body');
  tbody.innerHTML = '';

  const addRow = (nama, keterangan, biaya) => {
    const pct = totalBatch > 0 ? ((biaya / totalBatch) * 100).toFixed(1) : '0.0';
    tbody.innerHTML += `
      <tr>
        <td>${nama}</td>
        <td style="color:var(--muted);font-size:12px;">${keterangan}</td>
        <td class="text-right">${formatRp(biaya)}</td>
        <td class="text-right" style="color:var(--muted);">${pct}%</td>
      </tr>
    `;
  };

  bahanDetail.forEach(b => addRow(b.nama, 'Bahan baku', b.biaya));
  if (totalKemasan > 0) addRow('Kemasan', `${formatRp(kemasan)} Ã— ${porsi} pcs`, totalKemasan);
  biayaDetail.forEach(b => addRow(b.nama, 'Biaya operasional', b.biaya));

  tbody.innerHTML += `
    <tr class="total-row">
      <td colspan="2"><strong>TOTAL BIAYA BATCH</strong></td>
      <td class="text-right"><strong>${formatRp(totalBatch)}</strong></td>
      <td class="text-right"><strong>100%</strong></td>
    </tr>
    <tr class="total-row">
      <td colspan="2"><strong>HPP PER PCS</strong></td>
      <td class="text-right"><strong>${formatRp(hpp)}</strong></td>
      <td></td>
    </tr>
  `;

  document.getElementById('hasil-section').style.display = 'block';
  document.getElementById('hasil-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// =====================
// SIMPAN
// =====================
function simpanMenu() {
  const nama = lastSnapshot.nama || document.getElementById('nama-menu').value.trim() || 'Menu Tanpa Nama';
  const kategori = lastSnapshot.kategori || document.getElementById('kategori-menu').value;
  const hpp = lastHPP;
  
  // Pakai harga yang dipilih user, fallback ke STANDAR offline jika belum pilih
  const hargaJual = selectedHargaJual > 0
    ? selectedHargaJual
    : roundHargaMakanan(hpp / (1 - 0.50));
  const margin = selectedHargaJual > 0 ? selectedMargin : 50;

  const obj = {
    id: null, // akan diisi di bawah
    nama, kategori,
    porsi: lastSnapshot.porsi,
    kemasan: lastSnapshot.kemasan,
    hpp, hargaJual, margin,
    channel: selectedChannel,
    tanggal: getWIBDateTimeString(),
    totalBatch: lastSnapshot.totalBatch,
    bahanRaw: lastSnapshot.bahanRaw || [],
    biayaRaw: lastSnapshot.biayaRaw || [],
    foto: lastSnapshot.foto || null,
  };

  // Cari existing berdasarkan id (jika ada) atau nama sebagai fallback
  const existing = menuList.findIndex(m =>
    (lastSnapshot.id && m.id === lastSnapshot.id) ||
    (!lastSnapshot.id && m.nama === nama)
  );

  if (existing >= 0) {
    obj.id = menuList[existing].id || ('menu_' + Date.now()); // Pertahankan id lama
    menuList[existing] = obj;
  } else {
    obj.id = 'menu_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
    menuList.push(obj);
  }

  localStorage.setItem('kedaiHeula_menu', JSON.stringify(menuList));
  showToast(`âœ… "${nama}" tersimpan!`);
  autoSyncPush('menu'); // Auto push ke cloud

  setTimeout(() => {
    showKonfirmasi({
      icon: 'ğŸ‰',
      title: `"${nama}" Tersimpan!`,
      message: 'Mau langsung input menu baru? Atau tetap di halaman ini.',
      labelOk: 'â• Input Menu Baru',
      onOk: () => {
        resetForm();
        lastSnapshot = {};
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
    document.getElementById('konfirmasi-batal').textContent = 'Tetap di sini';
  }, 300);
}

function renderRingkasan() {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const container = document.getElementById('ringkasan-list');

  if (menuList.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="es-icon">ğŸ±</div>
        <p>Belum ada menu tersimpan</p>
        <small>Hitung HPP dulu di tab "Hitung HPP", lalu klik "Simpan ke Ringkasan Menu"</small>
      </div>`;
    return;
  }

  let html = '';

  const totalMenu = menuList.length;
  const rataHPP = menuList.reduce((s, m) => s + m.hpp, 0) / totalMenu;
  html += `
    <div class="result-box" style="margin-bottom:20px;">
      <h3>ğŸ“Š Statistik Menu</h3>
      <div class="result-grid">
        <div class="result-item">
          <span class="label">Total Menu</span>
          <div class="value">${totalMenu}</div>
          <div class="sub">menu terdaftar</div>
        </div>
        <div class="result-item">
          <span class="label">Rata-rata HPP</span>
          <div class="value">${formatRp(rataHPP)}</div>
          <div class="sub">per pcs</div>
        </div>
        <div class="result-item">
          <span class="label">Rata-rata Harga Jual</span>
          <div class="value">${formatRp(menuList.reduce((s, m) => s + m.hargaJual, 0) / totalMenu)}</div>
          <div class="sub">margin 50%</div>
        </div>
      </div>
    </div>
  `;

  menuList.forEach((m, i) => {
    const hj = m.hargaJual;
    const profit = hj - m.hpp;
    const hasBahan = m.bahanRaw && m.bahanRaw.length > 0;
    const h30 = roundHargaMakanan(m.hpp / (1 - 0.30));
    const h50 = roundHargaMakanan(m.hpp / (1 - 0.50));
    const h70 = roundHargaMakanan(m.hpp / (1 - 0.70));
    const bep  = Math.round(m.hpp / (1 - 0.30));
    html += `
      <div class="menu-card" style="cursor:default;flex-direction:column;align-items:stretch;gap:14px;">
        <!-- Baris atas: foto + info + angka -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;">
          ${m.foto ? `
            <div style="flex-shrink:0;">
              <img src="${m.foto}" style="width:80px;height:80px;object-fit:cover;border-radius:12px;border:2px solid var(--border);" />
            </div>
          ` : ''}
          <div class="mc-left" style="flex:1;min-width:200px;">
            <div class="mc-name">${m.nama}</div>
            <div style="margin-top:4px;">
              <span class="tag tag-${m.kategori}">${getCategoryLabel(m.kategori)}</span>
              <span style="font-size:11px;color:var(--muted);font-weight:700;">${m.tanggal}</span>
              ${hasBahan ? `<span style="font-size:10px;background:#E8F5E9;color:#2E7D32;font-weight:800;padding:2px 8px;border-radius:10px;margin-left:4px;">ğŸ“‹ Ada ${m.bahanRaw.length} bahan</span>` : ''}
            </div>
          </div>
          <div class="mc-right">
            <div class="mc-hpp">HPP: ${formatRp(m.hpp)}/pcs</div>
            <div class="mc-price">${formatRp(hj)}</div>
            <div class="mc-margin">+${formatRp(profit)} profit/pcs</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px;">${m.porsi} pcs/batch</div>
          </div>
        </div>

        <!-- Rekomendasi harga -->
        <div style="background:var(--bg);border-radius:12px;padding:12px;">
          <div style="font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">ğŸ’¡ Rekomendasi Harga</div>
          
          <!-- Header kolom -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;margin-bottom:6px;font-size:9px;font-weight:700;color:#666;">
            <div></div>
            <div style="text-align:center;">ğŸª OFFLINE</div>
            <div style="text-align:center;">ğŸ“± ONLINE</div>
          </div>

          <!-- Ekonomis -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;margin-bottom:4px;">
            <div style="font-size:8px;font-weight:700;color:#999;display:flex;align-items:center;">ğŸŸ¡ 30%</div>
            <div style="background:#FFF9E6;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(h30)}</div>
            </div>
            <div style="background:#FFF9E6;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(roundHargaMakanan(h30*1.25))}</div>
            </div>
          </div>

          <!-- Standar -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;margin-bottom:4px;">
            <div style="font-size:8px;font-weight:700;color:#999;display:flex;align-items:center;">ğŸŸ¢ 50%</div>
            <div style="background:#E8F5E9;border:2px solid ${Math.round(hj)===h50?'#27AE60':'#C8E6C9'};border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(h50)}</div>
            </div>
            <div style="background:#E8F5E9;border:2px solid ${Math.round(hj)===roundHargaMakanan(h50*1.25)?'#27AE60':'#C8E6C9'};border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(roundHargaMakanan(h50*1.25))}</div>
            </div>
          </div>

          <!-- Premium -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;">
            <div style="font-size:8px;font-weight:700;color:#999;display:flex;align-items:center;">ğŸ”¥ 70%</div>
            <div style="background:#FFF0EF;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(h70)}</div>
            </div>
            <div style="background:#FFF0EF;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(roundHargaMakanan(h70*1.25))}</div>
            </div>
          </div>
        </div>

        <!-- Tombol aksi -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 12px;" onclick="lihatDetail(${i})">ğŸ” Detail Bahan</button>
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 12px;" onclick="editMenu(${i})">âœï¸ Edit</button>
          <button class="btn btn-danger" style="font-size:11px;padding:6px 12px;" onclick="hapusItem(${i})">ğŸ—‘ï¸</button>
        </div>
      </div>
    `;
  });

  html += `
    <div style="text-align:right;margin-top:8px;">
      <button class="btn btn-secondary" onclick="hapusSemua()">ğŸ—‘ï¸ Hapus Semua</button>
    </div>
  `;

  container.innerHTML = html;
}

function hapusSemua() {
  showKonfirmasi({
    icon: 'ğŸ—‘ï¸',
    title: 'Hapus Semua Menu?',
    message: 'Semua data menu yang tersimpan akan dihapus permanen.',
    labelOk: 'Ya, Hapus Semua',
    onOk: () => {
      menuList = [];
      localStorage.removeItem('kedaiHeula_menu');
      renderRingkasan();
      showToast('ğŸ—‘ï¸ Semua menu dihapus');
      autoSyncPush('menu');
    }
  });
}

function hapusItem(i) {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  if (!menuList[i]) return;
  showKonfirmasi({
    icon: 'ğŸ—‘ï¸',
    title: `Hapus "${menuList[i].nama}"?`,
    message: 'Menu ini akan dihapus dari Ringkasan secara permanen.',
    labelOk: 'Ya, Hapus',
    onOk: () => {
      menuList.splice(i, 1);
      localStorage.setItem('kedaiHeula_menu', JSON.stringify(menuList));
      renderRingkasan();
      showToast('ğŸ—‘ï¸ Menu dihapus');
      autoSyncPush('menu');
    }
  });
}

// =====================
// DETAIL BAHAN MODAL
// =====================
function lihatDetail(i) {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const m = menuList[i];
  if (!m) return;

  const totalBahan = (m.bahanRaw || []).reduce((s, b) => s + b.biaya, 0);
  const totalBiaya = (m.biayaRaw || []).reduce((s, b) => s + b.biaya, 0);
  const totalKemasan = (m.kemasan || 0) * (m.porsi || 1);

  let bahanRows = (m.bahanRaw || []).map(b => `
    <tr>
      <td>${b.nama}</td>
      <td class="text-right">${b.qty}</td>
      <td class="text-right">${b.ukuranBeli}</td>
      <td class="text-right">${formatRp(b.hargaBeli)}</td>
      <td class="text-right" style="font-weight:800;">${formatRp(b.biaya)}</td>
    </tr>`).join('');

  if (!bahanRows) bahanRows = `<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:16px;">Tidak ada data bahan tersimpan</td></tr>`;

  let biayaRows = (m.biayaRaw || []).map(b => `
    <tr><td>${b.nama}</td><td colspan="3"></td><td class="text-right" style="font-weight:800;">${formatRp(b.biaya)}</td></tr>
  `).join('');

  document.getElementById('modal-detail-body').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
      <div>
        <div style="font-family:'Fredoka One',cursive;font-size:22px;color:var(--red);">${m.nama}</div>
        <div style="margin-top:4px;">
          <span class="tag tag-${m.kategori}">${getCategoryLabel(m.kategori)}</span>
          <span style="font-size:12px;color:var(--muted);font-weight:700;margin-left:6px;">Tersimpan ${m.tanggal}</span>
        </div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:12px;color:var(--muted);font-weight:700;">HPP / pcs</div>
        <div style="font-family:'Fredoka One',cursive;font-size:26px;color:var(--red);">${formatRp(m.hpp)}</div>
        <div style="font-size:11px;color:var(--muted);">Batch: ${m.porsi} pcs Â· Kemasan: ${formatRp(m.kemasan)}/pcs</div>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <div class="card-title" style="margin-bottom:12px;">ğŸ§… Bahan Baku</div>
      <table class="breakdown-table">
        <thead>
          <tr>
            <th>Nama Bahan</th>
            <th class="text-right">Qty Pakai</th>
            <th class="text-right">Ukuran Beli</th>
            <th class="text-right">Harga Beli</th>
            <th class="text-right">Biaya</th>
          </tr>
        </thead>
        <tbody>
          ${bahanRows}
          <tr class="total-row">
            <td colspan="4"><strong>Total Bahan</strong></td>
            <td class="text-right"><strong>${formatRp(totalBahan)}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>

    ${m.biayaRaw && m.biayaRaw.length > 0 ? `
    <div class="card" style="margin-bottom:12px;">
      <div class="card-title" style="margin-bottom:12px;">âš™ï¸ Biaya Operasional</div>
      <table class="breakdown-table">
        <thead><tr><th>Keterangan</th><th colspan="3"></th><th class="text-right">Biaya</th></tr></thead>
        <tbody>
          ${biayaRows}
          <tr class="total-row">
            <td colspan="4"><strong>Total Operasional</strong></td>
            <td class="text-right"><strong>${formatRp(totalBiaya)}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>` : ''}

    <div style="background:linear-gradient(135deg,var(--red),var(--orange));border-radius:14px;padding:16px;color:white;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;">
      <div>
        <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">Total Biaya Batch</div>
        <div style="font-family:'Fredoka One',cursive;font-size:18px;">${formatRp(m.totalBatch || (totalBahan + totalBiaya + totalKemasan))}</div>
      </div>
      <div>
        <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">HPP / pcs</div>
        <div style="font-family:'Fredoka One',cursive;font-size:18px;">${formatRp(m.hpp)}</div>
      </div>
      <div>
        <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">Harga Jual</div>
        <div style="font-family:'Fredoka One',cursive;font-size:18px;">${formatRp(m.hargaJual)}</div>
      </div>
    </div>
  `;

  document.getElementById('modal-detail').style.display = 'flex';
  // Simpan index ke modal supaya bisa dipakai tombol export
  document.getElementById('modal-detail').dataset.menuIdx = i;
}

function tutupDetail() {
  document.getElementById('modal-detail').style.display = 'none';
}

function exportDetailPDF() {
  try {
    const i = parseInt(document.getElementById('modal-detail').dataset.menuIdx);
    menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
    const m = menuList[i];
    if (!m) {
      showToast('âŒ Menu tidak ditemukan');
      return;
    }

    const totalBahan   = (m.bahanRaw  || []).reduce((s, b) => s + (b.biaya || 0), 0);
    const totalBiaya   = (m.biayaRaw  || []).reduce((s, b) => s + (b.biaya || 0), 0);
    const totalKemasan = (m.kemasan   || 0) * (m.porsi || 1);
    const totalBatch   = m.totalBatch || (totalBahan + totalBiaya + totalKemasan);
    const h30 = roundHargaMakanan(m.hpp / (1 - 0.30));
    const h50 = roundHargaMakanan(m.hpp / (1 - 0.50));
    const h70 = roundHargaMakanan(m.hpp / (1 - 0.70));
    const bep = Math.round(m.hpp / (1 - 0.30));

  const bahanRows = (m.bahanRaw || []).map(b => `
    <tr>
      <td>${b.nama}</td>
      <td class="pr-num">${b.qty}</td>
      <td class="pr-num">${b.ukuranBeli}</td>
      <td class="pr-num">${formatRp(b.hargaBeli)}</td>
      <td class="pr-num"><strong>${formatRp(b.biaya)}</strong></td>
    </tr>`).join('') || `<tr><td colspan="5" style="text-align:center;color:#999;padding:12px;">Tidak ada data bahan</td></tr>`;

  const kemasanRow = m.kemasan > 0 ? `
    <tr>
      <td>Kemasan</td>
      <td colspan="3" style="color:#888;font-size:11px;">${formatRp(m.kemasan)} Ã— ${m.porsi} pcs</td>
      <td class="pr-num"><strong>${formatRp(totalKemasan)}</strong></td>
    </tr>` : '';

  const biayaRows = (m.biayaRaw || []).map(b => `
    <tr>
      <td>${b.nama}</td>
      <td colspan="3"></td>
      <td class="pr-num"><strong>${formatRp(b.biaya)}</strong></td>
    </tr>`).join('');

  const biayaSection = (m.biayaRaw && m.biayaRaw.length > 0) ? `
    <h3>âš™ï¸ Biaya Operasional per Batch</h3>
    <table>
      <thead><tr><th>Keterangan</th><th colspan="3"></th><th class="pr-num">Biaya</th></tr></thead>
      <tbody>
        ${biayaRows}
        <tr class="total-row">
          <td colspan="4"><strong>Total Operasional</strong></td>
          <td class="pr-num"><strong>${formatRp(totalBiaya)}</strong></td>
        </tr>
      </tbody>
    </table>` : '';

  const tanggalCetak = new Date().toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });

  const printContent = `
    <div class="doc-header">
      <div>
        <div class="brand">ğŸ± Kedai Heula</div>
        <div class="brand-sub">Kalkulator HPP - Referensi Bahan Baku</div>
      </div>
      <div class="doc-meta">
        <div class="menu-name">${m.nama}</div>
        <div class="meta-sub">${getCategoryLabel(m.kategori)} Â· Tersimpan ${m.tanggal} Â· ${m.porsi} pcs/batch</div>
      </div>
    </div>

    <div class="summary-bar">
      <div class="sum-box">
        <span class="sum-label">Total Biaya Batch</span>
        <span class="sum-value">${formatRp(totalBatch)}</span>
        <span class="sum-sub">${m.porsi} pcs</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">HPP / pcs</span>
        <span class="sum-value">${formatRp(m.hpp)}</span>
        <span class="sum-sub">harga pokok</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">Min. BEP</span>
        <span class="sum-value">${formatRp(bep)}</span>
        <span class="sum-sub">incl. platform fee</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">Harga Jual</span>
        <span class="sum-value">${formatRp(m.hargaJual)}</span>
        <span class="sum-sub">tersimpan</span>
      </div>
    </div>

    <h3>ğŸ§… Bahan Baku</h3>
    <table>
      <thead>
        <tr>
          <th>Nama Bahan</th>
          <th class="pr-num">Qty Pakai</th>
          <th class="pr-num">Ukuran Beli</th>
          <th class="pr-num">Harga Beli</th>
          <th class="pr-num">Biaya</th>
        </tr>
      </thead>
      <tbody>
        ${bahanRows}
        ${kemasanRow}
        <tr class="total-row">
          <td colspan="4"><strong>Total Bahan + Kemasan</strong></td>
          <td class="pr-num"><strong>${formatRp(totalBahan + totalKemasan)}</strong></td>
        </tr>
      </tbody>
    </table>

    ${biayaSection}

    <div class="harga-section">
      <div class="harga-title">âœ… Rekomendasi Harga Jual</div>
      <div class="harga-grid">
        <div class="harga-box ekonomis">
          <span class="hb-label">ğŸŸ¡ Ekonomis</span>
          <span class="hb-value">${formatRp(h30)}</span>
          <span class="hb-margin">Margin 30%</span>
        </div>
        <div class="harga-box standar">
          <span class="hb-label">ğŸŸ¢ Standar</span>
          <span class="hb-value">${formatRp(h50)}</span>
          <span class="hb-margin">Margin 50%</span>
        </div>
        <div class="harga-box premium">
          <span class="hb-label">ğŸ”¥ Premium</span>
          <span class="hb-value">${formatRp(h70)}</span>
          <span class="hb-margin">Margin 70%</span>
        </div>
      </div>
    </div>

    <div class="doc-footer">
      <span>Kedai Heula - Manajemen Bisnis Kuliner</span>
      <span>Dicetak: ${tanggalCetak}</span>
    </div>
  `;

  const printArea = document.getElementById('print-area');
  if (!printArea) {
    showToast('âŒ Error: print-area tidak ditemukan');
    console.error('print-area element tidak ada');
    return;
  }
  
  printArea.innerHTML = printContent;
  
  // Deteksi platform
  const isTelegram = /telegram/i.test(navigator.userAgent.toLowerCase());
  const isMobile = isMobileOrTelegram();
  
  if (isMobile && isTelegram) {
    // Telegram Mobile: kasih tau fitur tidak tersedia
    showToast('â„¹ï¸ Export PDF: Gunakan Telegram Desktop atau screenshot halaman ini');
  } else {
    // Desktop atau mobile browser biasa: print
    window.print();
  }
  
  } catch (error) {
    console.error('Error di exportDetailPDF:', error);
    showToast('âŒ Error: ' + error.message);
  }
}

// =====================
// EDIT MENU MODAL
// =====================
function editMenu(i) {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const m = menuList[i];
  if (!m) return;

  console.log('ğŸ“ Edit menu:', m.nama);
  console.log('ğŸ§… bahanRaw:', m.bahanRaw);
  console.log('âš™ï¸ biayaRaw:', m.biayaRaw);

  document.getElementById('edit-idx').value = i;
  document.getElementById('edit-nama').value = m.nama;
  document.getElementById('edit-kategori').value = m.kategori;
  document.getElementById('edit-porsi').value = m.porsi;
  document.getElementById('edit-kemasan').value = m.kemasan || 0;
  document.getElementById('edit-harga-jual').value = Math.round(m.hargaJual);

  // Load foto jika ada
  const previewEdit = document.getElementById('preview-edit-foto');
  if (m.foto) {
    currentFotoBase64 = m.foto; // Set foto saat ini
    previewEdit.innerHTML = `
      <div style="position:relative;display:inline-block;">
        <img src="${m.foto}" style="max-width:200px;max-height:200px;border-radius:12px;border:2px solid var(--border);" />
        <button onclick="hapusFoto('preview-edit-foto', 'edit-foto-menu')" style="position:absolute;top:4px;right:4px;background:var(--red);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-weight:bold;font-size:12px;">Ã—</button>
      </div>
    `;
  } else {
    currentFotoBase64 = null;
    previewEdit.innerHTML = '';
    document.getElementById('edit-foto-menu').value = '';
  }

  // Render bahan
  const bahanContainer = document.getElementById('edit-bahan-list');
  bahanContainer.innerHTML = '';
  const bahanData = m.bahanRaw || [];
  console.log(`ğŸ”„ Rendering ${bahanData.length} bahan...`);
  bahanData.forEach((b, j) => {
    console.log(`  - ${b.nama}: ${b.qty} @ Rp ${b.hargaBeli}`);
    bahanContainer.appendChild(buatEditBahanRow(j, b));
  });

  // Render biaya
  const biayaContainer = document.getElementById('edit-biaya-list');
  biayaContainer.innerHTML = '';
  const biayaData = m.biayaRaw || [];
  console.log(`ğŸ”„ Rendering ${biayaData.length} biaya...`);
  biayaData.forEach((b, j) => {
    console.log(`  - ${b.nama}: Rp ${b.biaya}`);
    biayaContainer.appendChild(buatEditBiayaRow(j, b));
  });

  hitungEditHPP();
  document.getElementById('modal-edit').style.display = 'flex';
}

let editBahanCount = 0;
let editBiayaCount = 0;

function buatEditBahanRow(j, b) {
  editBahanCount++;
  const id = editBahanCount;
  const div = document.createElement('div');
  div.className = 'bahan-row';
  div.id = 'edit-bahan-' + id;
  div.innerHTML = `
    <input type="text" value="${b.nama}" placeholder="Nama bahan" oninput="hitungEditHPP()" />
    <input type="number" value="${b.qty}" min="0" step="any" placeholder="Qty" oninput="hitungEditHPP()" />
    <input type="number" value="${b.hargaBeli}" min="0" step="any" placeholder="Harga beli" class="col-harga-satuan" oninput="hitungEditHPP()" />
    <input type="number" value="${b.ukuranBeli}" min="0" step="any" placeholder="Ukuran beli" class="col-harga-satuan" oninput="hitungEditHPP()" />
    <button class="btn btn-danger" onclick="document.getElementById('edit-bahan-${id}').remove(); hitungEditHPP();">âœ•</button>
  `;
  return div;
}

function buatEditBiayaRow(j, b) {
  editBiayaCount++;
  const id = editBiayaCount;
  const div = document.createElement('div');
  div.className = 'biaya-row';
  div.id = 'edit-biaya-' + id;
  div.innerHTML = `
    <input type="text" value="${b.nama}" placeholder="Nama biaya" oninput="hitungEditHPP()" />
    <input type="number" value="${b.biaya}" min="0" step="any" placeholder="Biaya (Rp)" oninput="hitungEditHPP()" />
    <button class="btn btn-danger" onclick="document.getElementById('edit-biaya-${id}').remove(); hitungEditHPP();">âœ•</button>
  `;
  return div;
}

function tambahEditBahan() {
  const container = document.getElementById('edit-bahan-list');
  container.appendChild(buatEditBahanRow(editBahanCount, { nama:'', qty:0, hargaBeli:0, ukuranBeli:1, biaya:0 }));
}

function tambahEditBiaya() {
  const container = document.getElementById('edit-biaya-list');
  container.appendChild(buatEditBiayaRow(editBiayaCount, { nama:'', biaya:0 }));
}

function hitungEditHPP() {
  const porsi = parseFloat(document.getElementById('edit-porsi').value) || 1;
  const kemasan = parseFloat(document.getElementById('edit-kemasan').value) || 0;

  let totalBahan = 0;
  document.querySelectorAll('#edit-bahan-list .bahan-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const qty = parseFloat(inputs[1].value) || 0;
    const hargaBeli = parseFloat(inputs[2].value) || 0;
    const ukuranBeli = parseFloat(inputs[3].value) || 1;
    totalBahan += (qty / ukuranBeli) * hargaBeli;
  });

  let totalBiaya = 0;
  document.querySelectorAll('#edit-biaya-list .biaya-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    totalBiaya += parseFloat(inputs[1].value) || 0;
  });

  const totalKemasan = kemasan * porsi;
  const totalBatch = Math.round(totalBahan + totalKemasan + totalBiaya);
  const hpp = Math.round(totalBatch / porsi);
  const bep = Math.round(hpp / (1 - 0.30));

  const h30 = roundHargaMakanan(hpp / (1 - 0.30));
  const h50 = roundHargaMakanan(hpp / (1 - 0.50));
  const h70 = roundHargaMakanan(hpp / (1 - 0.70));

  document.getElementById('edit-hpp-preview').innerHTML = hpp <= 0 ? '-' : `
    <div style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:baseline;flex-wrap:wrap;gap:4px;">
      <span style="font-size:13px;font-weight:800;color:var(--dark);">
        HPP: <span style="color:var(--red);font-size:16px;">${formatRp(hpp)}/pcs</span>
      </span>
      <span style="font-size:11px;color:var(--muted);font-weight:700;">
        Total batch: ${formatRp(totalBatch)} &nbsp;Â·&nbsp; Min. BEP: ${formatRp(bep)}
      </span>
    </div>
    <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">
      âœ… Klik untuk pakai sebagai harga jual
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
      <div onclick="pakeHargaEdit(${Math.round(h30)})" style="background:linear-gradient(135deg,#FFF9E6,#FFF3CC);border:2px solid #F5C518;border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:10px;font-weight:800;color:#B8860B;">ğŸŸ¡ EKONOMIS</div>
        <div style="font-family:'Fredoka One',cursive;font-size:17px;color:var(--dark);margin:3px 0;">${formatRp(h30)}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:700;">Margin 30%</div>
      </div>
      <div onclick="pakeHargaEdit(${Math.round(h50)})" style="background:linear-gradient(135deg,#E8F5E9,#C8E6C9);border:2px solid #27AE60;border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:10px;font-weight:800;color:#1B5E20;">ğŸŸ¢ STANDAR</div>
        <div style="font-family:'Fredoka One',cursive;font-size:17px;color:var(--dark);margin:3px 0;">${formatRp(h50)}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:700;">Margin 50%</div>
      </div>
      <div onclick="pakeHargaEdit(${Math.round(h70)})" style="background:linear-gradient(135deg,#FFF0EF,#FFD5D3);border:2px solid var(--red);border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:10px;font-weight:800;color:var(--red);">ğŸ”¥ PREMIUM</div>
        <div style="font-family:'Fredoka One',cursive;font-size:17px;color:var(--dark);margin:3px 0;">${formatRp(h70)}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:700;">Margin 70%</div>
      </div>
    </div>
  `;
}

function pakeHargaEdit(harga) {
  document.getElementById('edit-harga-jual').value = harga;
  // Feedback visual singkat
  const input = document.getElementById('edit-harga-jual');
  input.style.borderColor = 'var(--green)';
  input.style.background = '#F0FDF4';
  setTimeout(() => { input.style.borderColor = ''; input.style.background = ''; }, 1200);
}

function simpanEdit() {
  const i = parseInt(document.getElementById('edit-idx').value);
  const m = menuList[i];
  if (!m) return;

  const porsi = parseFloat(document.getElementById('edit-porsi').value) || 1;
  const kemasan = parseFloat(document.getElementById('edit-kemasan').value) || 0;

  const bahanRaw = [];
  document.querySelectorAll('#edit-bahan-list .bahan-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const nama = inputs[0].value.trim();
    const qty = parseFloat(inputs[1].value) || 0;
    const hargaBeli = parseFloat(inputs[2].value) || 0;
    const ukuranBeli = parseFloat(inputs[3].value) || 1;
    if (!nama || qty === 0) return;
    bahanRaw.push({ nama, qty, hargaBeli, ukuranBeli, biaya: (qty / ukuranBeli) * hargaBeli });
  });

  const biayaRaw = [];
  document.querySelectorAll('#edit-biaya-list .biaya-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const nama = inputs[0].value.trim();
    const biaya = parseFloat(inputs[1].value) || 0;
    if (!nama || biaya === 0) return;
    biayaRaw.push({ nama, biaya });
  });

  const totalBahan = bahanRaw.reduce((s, b) => s + b.biaya, 0);
  const totalBiaya = biayaRaw.reduce((s, b) => s + b.biaya, 0);
  const totalKemasan = kemasan * porsi;
  const totalBatch = totalBahan + totalKemasan + totalBiaya;
  const hpp = totalBatch / porsi;
  const hargaJual = parseFloat(document.getElementById('edit-harga-jual').value) || hpp / (1 - 0.5);

  menuList[i] = {
    ...m,
    id: m.id || ('menu_' + Date.now() + '_' + Math.floor(Math.random() * 1000)), // Pertahankan id lama, buat baru jika belum ada
    nama: document.getElementById('edit-nama').value.trim() || m.nama,
    kategori: document.getElementById('edit-kategori').value,
    porsi, kemasan, bahanRaw, biayaRaw,
    totalBatch, hpp, hargaJual,
    tanggal: getWIBDateTimeString(),
    foto: currentFotoBase64,
  };

  localStorage.setItem('kedaiHeula_menu', JSON.stringify(menuList));
  tutupEdit();
  renderRingkasan();
  showToast(`âœ… "${menuList[i].nama}" diperbarui!`);
  autoSyncPush('menu');
}

function tutupEdit() {
  document.getElementById('modal-edit').style.display = 'none';
}


// =====================
// POS (POINT OF SALE) - Grid + Sidebar Cart
// =====================
let posCart = {}; // { menuIdx: qty }

// Global Laporan variables
let currentPeriode = 'hari';
let chartProfit = null;

// Global bundling harga (populated by hitungBundling)
let bundlingHargaData = {
  offlineHemat: 0,
  offlineStandar: 0,
  offlinePremium: 0,
  onlineHemat: 0,
  onlineStandar: 0,
  onlinePremium: 0,
  profitOfflineHemat: 0,
  profitOfflineStandar: 0,
  profitOfflinePremium: 0,
  profitOnlineHemat: 0,
  profitOnlineStandar: 0,
  profitOnlinePremium: 0
};

function renderPOSGrid() {
  const grid = document.getElementById('pos-menu-grid');
  if (!grid) return;
  
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  
  if (data.length === 0) {
    grid.innerHTML = `
      <div style="grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--muted);">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ±</div>
        <p style="font-weight:700;">Belum ada menu</p>
        <small>Hitung HPP dulu di tab "Hitung HPP"</small>
      </div>
    `;
    return;
  }
  
  let html = '';
  const cartType = getCartType();
  const isBlocked = cartType === 'bundling'; // item satuan diblok kalau cart ada bundling

  data.forEach((menu, idx) => {
    const inCart = posCart[idx] || 0;
    const fotoUrl = menu.foto || '';
    const blocked = isBlocked;
    const opacity = blocked ? '0.4' : '1';
    const cursor = blocked ? 'not-allowed' : 'pointer';
    const borderColor = inCart > 0 ? 'var(--orange)' : 'var(--border)';
    
    html += `
      <div onclick="addToCart(${idx})" title="${blocked ? 'Kosongkan keranjang dulu untuk tambah item satuan' : ''}" style="background:var(--card);border:2px solid ${borderColor};border-radius:16px;padding:12px;cursor:${cursor};transition:all 0.2s;position:relative;opacity:${opacity};" ${!blocked ? `onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'"` : ''}>
        ${fotoUrl ? `<img src="${fotoUrl}" style="width:100%;height:100px;object-fit:cover;border-radius:12px;margin-bottom:8px;" />` : `<div style="width:100%;height:100px;background:linear-gradient(135deg,var(--bg),var(--border));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:48px;margin-bottom:8px;">${getCategoryEmoji(menu.kategori)}</div>`}
        <div style="font-weight:800;font-size:13px;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${menu.nama}</div>
        <div style="font-weight:800;color:var(--orange);font-size:14px;">${formatRp(menu.hargaJual)}</div>
        ${inCart > 0 ? `<div style="position:absolute;top:8px;right:8px;background:var(--orange);color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;">${inCart}</div>` : ''}
        ${blocked ? `<div style="position:absolute;inset:0;border-radius:14px;display:flex;align-items:center;justify-content:center;"><span style="background:rgba(0,0,0,0.55);color:white;font-size:10px;font-weight:800;padding:4px 8px;border-radius:8px;">ğŸš« Item Promo Aktif</span></div>` : ''}
      </div>
    `;
  });
  
  grid.innerHTML = html;
}

function renderPOSBundling() {
  const grid = document.getElementById('pos-bundling-grid');
  const section = document.getElementById('pos-bundling-section');
  if (!grid || !section) return;
  
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const today = getWIBDateString(); // Pakai WIB bukan UTC
  
  // Filter active bundling promos only
  const activeBundling = promos.filter(p => 
    p.type === 'bundling' && 
    p.periodeMulai <= today && 
    p.periodeSelesai >= today
  );
  
  if (activeBundling.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  
  let html = '';
  const cartType = getCartType();
  const isBlocked = cartType === 'satuan'; // bundling diblok kalau cart ada item satuan

  activeBundling.forEach((promo, idx) => {
    const inCart = posCart['b-' + promo.id] || 0;
    const blocked = isBlocked;
    const opacity = blocked ? '0.4' : '1';
    const cursor = blocked ? 'not-allowed' : 'pointer';

    html += `
      <div onclick="addBundlingToCart('${promo.id}')" title="${blocked ? 'Kosongkan keranjang dulu untuk tambah item promo' : ''}" style="background:linear-gradient(135deg,#FFF4E6,#FFEBCD);border:2px solid ${inCart > 0 ? 'var(--red)' : 'var(--orange)'};border-radius:16px;padding:12px;cursor:${cursor};transition:all 0.2s;position:relative;opacity:${opacity};" ${!blocked ? `onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'"` : ''}>
        <div style="width:100%;height:100px;background:linear-gradient(135deg,var(--orange),var(--red));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:48px;margin-bottom:8px;">ğŸ“¦</div>
        <div style="font-weight:800;font-size:13px;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${promo.nama}</div>
        <div style="font-weight:800;color:var(--red);font-size:14px;">${formatRp(promo.harga || 0)}</div>
        <div style="position:absolute;top:8px;right:8px;background:var(--red);color:white;padding:4px 8px;border-radius:8px;font-weight:700;font-size:10px;">PROMO</div>
        ${inCart > 0 ? `<div style="position:absolute;top:8px;left:8px;background:var(--orange);color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;">${inCart}</div>` : ''}
        ${blocked ? `<div style="position:absolute;inset:0;border-radius:14px;display:flex;align-items:center;justify-content:center;"><span style="background:rgba(0,0,0,0.55);color:white;font-size:10px;font-weight:800;padding:4px 8px;border-radius:8px;">ğŸš« Item Satuan Aktif</span></div>` : ''}
      </div>
    `;
  });
  
  grid.innerHTML = html;
}

// Bangun objek transaksi dari cart aktif (tanpa simpan)
function buildTransaksiFromCart() {
  const cartKeys = Object.keys(posCart);
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const subtotalEl = document.getElementById('pos-subtotal');
  const subtotal = parseFloat((subtotalEl?.textContent || '').replace(/[^0-9]/g, '')) || 0;
  const bayar = parseFloat(document.getElementById('pos-bayar')?.value) || 0;

  const items = cartKeys.map(key => {
    const qty = posCart[key];
    const isBundling = key.toString().startsWith('b-');
    if (isBundling) {
      const promo = promos.find(p => p.id == key.slice(2));
      if (!promo) return null;
      return { nama: 'ğŸ“¦ ' + promo.nama, kategori: 'bundling', qty, hpp: 0, harga: promo.harga || 0, subtotal: (promo.harga || 0) * qty, profit: (promo.harga || 0) * qty };
    } else {
      const menu = data[parseInt(key)];
      if (!menu) return null;
      return { nama: menu.nama, kategori: menu.kategori, qty, hpp: menu.hpp, harga: menu.hargaJual, subtotal: menu.hargaJual * qty, profit: (menu.hargaJual - menu.hpp) * qty };
    }
  }).filter(Boolean);

  return { id: 'PREVIEW-' + Date.now(), timestamp: new Date().toISOString(), items, total: subtotal, bayar, kembalian: Math.max(0, bayar - subtotal) };
}

function lihatDetailOrderCart() {
  if (Object.keys(posCart).length === 0) {
    showToast('âš ï¸ Keranjang masih kosong');
    return;
  }
  const t = buildTransaksiFromCart();
  lihatNota(t);
}
function getCartType() {
  const keys = Object.keys(posCart);
  if (keys.length === 0) return 'empty';
  const hasBundling = keys.some(k => k.toString().startsWith('b-'));
  const hasSatuan   = keys.some(k => !k.toString().startsWith('b-'));
  if (hasBundling) return 'bundling';
  if (hasSatuan)   return 'satuan';
  return 'empty';
}

function addBundlingToCart(promoId) {
  // Cek konflik: kalau cart sudah ada item satuan, tolak
  const cartType = getCartType();
  if (cartType === 'satuan') {
    showToast('âš ï¸ Kosongkan keranjang dulu sebelum tambah item promo');
    return;
  }

  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const promo = promos.find(p => p.id == promoId);
  if (!promo) { showToast('âš ï¸ Promo tidak ditemukan'); return; }

  const key = 'b-' + promoId;
  if (!posCart[key]) posCart[key] = 0;
  posCart[key]++;

  renderPOSGrid();
  renderPOSBundling();
  updateCartSidebar();
  showToast(`â• ${promo.nama} ditambahkan`);
}

function addToCart(menuIdx) {
  // Cek konflik: kalau cart sudah ada item bundling, tolak
  const cartType = getCartType();
  if (cartType === 'bundling') {
    showToast('âš ï¸ Kosongkan keranjang dulu sebelum tambah item satuan');
    return;
  }

  if (!posCart[menuIdx]) posCart[menuIdx] = 0;
  posCart[menuIdx]++;
  
  renderPOSGrid();
  renderPOSBundling();
  updateCartSidebar();
  showToast('â• Item ditambahkan');
}

function updateCartQty(menuIdx, qty) {
  if (qty <= 0) {
    delete posCart[menuIdx];
  } else {
    posCart[menuIdx] = qty;
  }
  
  renderPOSGrid();
  renderPOSBundling();
  updateCartSidebar();
}

function updateCartSidebar() {
  const container = document.getElementById('pos-cart-items');
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  
  const cartKeys = Object.keys(posCart);
  const totalQty = cartKeys.reduce((s, k) => s + posCart[k], 0);

  // Update badge & floating button
  const cntEl = document.getElementById('pos-cart-count');
  if (cntEl) cntEl.textContent = totalQty;
  const badge = document.getElementById('pos-cart-badge');
  if (badge) { badge.textContent = totalQty + ' item'; badge.style.display = totalQty > 0 ? 'block' : 'none'; }
  
  // Enable/disable SELESAI button
  const btnSelesai = document.getElementById('btn-selesai-pos');
  if (btnSelesai) btnSelesai.disabled = cartKeys.length === 0;
  
  if (cartKeys.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:var(--muted);">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ›’</div>
        <p style="font-weight:700;">Keranjang kosong</p>
        <small>Pilih menu di sebelah kiri</small>
      </div>
    `;
    document.getElementById('pos-subtotal').textContent = 'Rp 0';
    document.getElementById('pos-profit').textContent = 'Rp 0';
    document.getElementById('pos-kembalian').textContent = 'Rp 0';
    const bayarEl = document.getElementById('pos-bayar');
    if (bayarEl) bayarEl.value = '';
    return;
  }
  
  let html = '';
  let subtotal = 0;
  let totalHPP = 0;
  
  cartKeys.forEach(key => {
    const qty = posCart[key];
    const isBundling = key.startsWith('b-');

    if (isBundling) {
      // Item bundling
      const promoId = key.slice(2);
      const promo = promos.find(p => p.id == promoId);
      if (!promo) return;
      const harga = promo.harga || 0;
      const itemTotal = harga * qty;
      subtotal += itemTotal;
      // HPP bundling tidak diketahui secara tepat, set 0 (profit = harga bundling)
      html += `
        <div style="background:linear-gradient(135deg,#FFF4E6,#FFEBCD);border:2px solid var(--orange);border-radius:12px;padding:12px;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;">
                <span style="background:var(--red);color:white;font-size:9px;font-weight:800;padding:2px 6px;border-radius:6px;">PROMO</span>
                <span style="font-weight:800;">ğŸ“¦ ${promo.nama}</span>
              </div>
              <div style="font-size:13px;color:var(--muted);">${formatRp(harga)} Ã— ${qty}</div>
            </div>
            <div style="font-weight:800;color:var(--orange);">${formatRp(itemTotal)}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button onclick="updateCartQty('${key}', ${qty - 1})" style="width:32px;height:32px;border-radius:8px;border:2px solid var(--border);background:var(--card);font-size:18px;font-weight:800;cursor:pointer;">âˆ’</button>
            <input type="number" value="${qty}" onchange="updateCartQty('${key}', parseInt(this.value) || 0)" style="width:60px;text-align:center;padding:6px;border-radius:8px;border:2px solid var(--border);font-weight:800;background:var(--card);" />
            <button onclick="updateCartQty('${key}', ${qty + 1})" style="width:32px;height:32px;border-radius:8px;border:2px solid var(--border);background:var(--card);font-size:18px;font-weight:800;cursor:pointer;">+</button>
            <button onclick="updateCartQty('${key}', 0)" style="margin-left:auto;padding:6px 12px;border-radius:8px;border:none;background:var(--light-red);color:var(--red);font-weight:700;cursor:pointer;">ğŸ—‘ï¸</button>
          </div>
        </div>
      `;
    } else {
      // Item menu biasa
      const menu = data[parseInt(key)];
      if (!menu) return;
      const itemTotal = menu.hargaJual * qty;
      const itemHPP = menu.hpp * qty;
      subtotal += itemTotal;
      totalHPP += itemHPP;
      html += `
        <div style="background:var(--bg);border-radius:12px;padding:12px;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
            <div style="flex:1;">
              <div style="font-weight:800;margin-bottom:4px;">${menu.nama}</div>
              <div style="font-size:13px;color:var(--muted);">${formatRp(menu.hargaJual)} Ã— ${qty}</div>
            </div>
            <div style="font-weight:800;color:var(--orange);">${formatRp(itemTotal)}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button onclick="updateCartQty(${key}, ${qty - 1})" style="width:32px;height:32px;border-radius:8px;border:2px solid var(--border);background:var(--card);font-size:18px;font-weight:800;cursor:pointer;">âˆ’</button>
            <input type="number" value="${qty}" onchange="updateCartQty(${key}, parseInt(this.value) || 0)" style="width:60px;text-align:center;padding:6px;border-radius:8px;border:2px solid var(--border);font-weight:800;background:var(--card);" />
            <button onclick="updateCartQty(${key}, ${qty + 1})" style="width:32px;height:32px;border-radius:8px;border:2px solid var(--border);background:var(--card);font-size:18px;font-weight:800;cursor:pointer;">+</button>
            <button onclick="updateCartQty(${key}, 0)" style="margin-left:auto;padding:6px 12px;border-radius:8px;border:none;background:var(--light-red);color:var(--red);font-weight:700;cursor:pointer;">ğŸ—‘ï¸</button>
          </div>
        </div>
      `;
    }
  });
  
  container.innerHTML = html;
  
  const profit = subtotal - totalHPP;
  document.getElementById('pos-subtotal').textContent = formatRp(subtotal);
  document.getElementById('pos-profit').textContent = formatRp(profit);

  // Tampilkan/sembunyikan "Gunakan Promo?" berdasarkan tipe cart
  const cartType = getCartType();
  const promoSection = document.getElementById('pos-promo-section');
  if (promoSection) {
    if (cartType === 'satuan') {
      promoSection.style.display = 'block';
      refreshPromoDropdown();
    } else {
      promoSection.style.display = 'none';
      // Reset diskon kalau disembunyikan
      document.getElementById('pos-promo-discount').style.display = 'none';
      document.getElementById('pos-promo-select').value = '';
    }
  }
  
  hitungKembalianPOS();
}

function toggleMobileCart() {
  const panel   = document.getElementById('pos-cart-panel');
  const overlay = document.getElementById('pos-cart-overlay');
  if (!panel) return;
  const isOpen = panel.classList.contains('mobile-open');
  if (isOpen) {
    panel.classList.remove('mobile-open');
    if (overlay) overlay.classList.remove('active');
    document.body.style.overflow = '';
    document.body.classList.remove('cart-mobile-open');
  } else {
    panel.classList.add('mobile-open');
    if (overlay) overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    document.body.classList.add('cart-mobile-open');
    const items = document.getElementById('pos-cart-items');
    if (items) items.scrollTop = 0;
  }
}
function togglePOSCart() { toggleMobileCart(); }

function clearPOSCart() {
  showKonfirmasi({
    icon: 'ğŸ—‘ï¸',
    title: 'Kosongkan Keranjang?',
    message: 'Semua item di keranjang akan dihapus.',
    labelOk: 'Ya, Kosongkan',
    onOk: () => {
      posCart = {};
      renderPOSGrid();
      renderPOSBundling();
      updateCartSidebar();
      showToast('ğŸ—‘ï¸ Keranjang dikosongkan');
    }
  });
}

function hitungKembalianPOS() {
  const subtotalText = document.getElementById('pos-subtotal').textContent;
  const subtotal = parseFloat(subtotalText.replace(/[^0-9]/g, '')) || 0;
  const bayar = parseFloat(document.getElementById('pos-bayar').value) || 0;
  const kembalian = bayar - subtotal;
  
  const kembalianEl = document.getElementById('pos-kembalian');
  kembalianEl.textContent = formatRp(kembalian >= 0 ? kembalian : 0);
  kembalianEl.style.color = kembalian >= 0 ? 'var(--green)' : 'var(--red)';
}

function konfirmasiSimpanTransaksi() {
  const cartKeys = Object.keys(posCart);
  if (cartKeys.length === 0) { showToast('âš ï¸ Keranjang kosong'); return; }
  const subtotalText = document.getElementById('pos-subtotal').textContent;
  const subtotal = parseFloat(subtotalText.replace(/[^0-9]/g, '')) || 0;
  const bayar = parseFloat(document.getElementById('pos-bayar').value) || 0;
  if (bayar <= 0) { showToast('âš ï¸ Masukkan uang dibayar dulu!'); document.getElementById('pos-bayar').focus(); return; }
  if (bayar < subtotal) { showToast('âš ï¸ Uang dibayar kurang!'); return; }
  const kembalian = bayar - subtotal;
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  // Build summary items
  const cartKeys2 = Object.keys(posCart);
  const itemLines = cartKeys2.map(key => {
    const qty = posCart[key];
    const isBundling = key.toString().startsWith('b-');
    if (isBundling) {
      const promo = promos.find(p => p.id == key.slice(2));
      return promo ? `â€¢ ${qty}x ${promo.nama} = ${formatRp((promo.harga||0)*qty)}` : null;
    } else {
      const menu = data[parseInt(key)];
      return menu ? `â€¢ ${qty}x ${menu.nama} = ${formatRp(menu.hargaJual*qty)}` : null;
    }
  }).filter(Boolean).join('<br>');
  showKonfirmasi({
    icon: 'ğŸ§¾',
    title: 'Konfirmasi Transaksi',
    message: `<div style="text-align:left;font-size:13px;line-height:1.8;">${itemLines}<br><div style="border-top:1px solid #eee;margin-top:8px;padding-top:8px;"><b>Total: ${subtotalText}</b><br>Bayar: ${formatRp(bayar)}<br><b style="color:var(--green);">Kembalian: ${formatRp(kembalian)}</b></div></div>`,
    labelOk: 'âœ… Simpan Transaksi',
    onOk: simpanTransaksiPOS
  });
}

function simpanTransaksiPOS() {
  const cartKeys = Object.keys(posCart);
  if (cartKeys.length === 0) { showToast('âš ï¸ Keranjang kosong'); return; }

  const subtotalText = document.getElementById('pos-subtotal').textContent;
  const subtotal = parseFloat(subtotalText.replace(/[^0-9]/g, '')) || 0;
  const bayar = parseFloat(document.getElementById('pos-bayar').value) || 0;
  if (bayar < subtotal) { showToast('âš ï¸ Uang dibayar kurang!'); return; }

  const menuData = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const promos   = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const now      = new Date();
  const wibStr   = getWIBDateString(); // YYYY-MM-DD WIB
  const trxId    = Date.now();

  // Build items untuk nota (format POS)
  const items = cartKeys.map(key => {
    const qty = posCart[key];
    const isBundling = key.toString().startsWith('b-');
    if (isBundling) {
      const promo = promos.find(p => p.id == key.slice(2));
      if (!promo) return null;
      return { nama: 'ğŸ“¦ ' + promo.nama, kategori: 'bundling', qty, hpp: 0,
               harga: promo.harga || 0, subtotal: (promo.harga || 0) * qty,
               profit: (promo.harga || 0) * qty };
    } else {
      const menu = menuData[parseInt(key)];
      if (!menu) return null;
      return { nama: menu.nama, kategori: menu.kategori, qty,
               hpp: menu.hpp, harga: menu.hargaJual,
               subtotal: menu.hargaJual * qty,
               profit: (menu.hargaJual - menu.hpp) * qty };
    }
  }).filter(Boolean);

  const transaksi = { id: trxId, timestamp: now.toISOString(),
                      items, total: subtotal, bayar, kembalian: bayar - subtotal };

  // Simpan ke POS harian (untuk summary kasir)
  const dayKey = `kedaiHeula_pos_${wibStr}`;
  const dayList = JSON.parse(localStorage.getItem(dayKey) || '[]');
  dayList.push(transaksi);
  localStorage.setItem(dayKey, JSON.stringify(dayList));

  // Flatten items â†’ format Laporan (1 record per item, kompatibel dengan renderLaporan)
  const laporanList = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  items.forEach((item, i) => {
    const record = {
      id: trxId + i,             // unique per item
      tanggal: wibStr,
      menu: item.nama,
      kategori: item.kategori || '-',
      qty: item.qty,
      hpp: item.hpp,
      hargaJual: item.harga,
      profit: item.profit,
      trxId: trxId,              // group dengan transaksi yang sama
      kasir: _authUser ? _authUser.username : 'Kasir'
    };
    laporanList.push(record);
  });
  localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(laporanList));

  // Push ke Firebase realtime â†’ admin langsung lihat di Laporan
  fbSaveTransaksi(laporanList);

  // Reset cart & UI
  posCart = {};
  const bayarEl = document.getElementById('pos-bayar');
  if (bayarEl) bayarEl.value = '';
  const kemEl = document.getElementById('pos-kembalian');
  if (kemEl) { kemEl.textContent = 'Rp 0'; kemEl.style.color = 'var(--green)'; }
  renderPOSGrid();
  renderPOSBundling();
  updateCartSidebar();
  updatePOSSummary();
  renderLaporan();
  // Tutup mobile cart + overlay
  const cartPanel = document.getElementById('pos-cart-panel');
  const cartOverlay = document.getElementById('pos-cart-overlay');
  if (cartPanel) cartPanel.classList.remove('mobile-open');
  if (cartOverlay) cartOverlay.classList.remove('active');
  document.body.style.overflow = '';

  lihatNota(transaksi);
  showToast('âœ… Transaksi berhasil!');
}

function updatePOSSummary() {
  // Baca dari kedaiHeula_transaksi (Firebase-synced flat records)
  // Filter hanya hari ini (WIB)
  const today = getWIBDateString();
  const allRecords = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  const todayRecords = allRecords.filter(r => r.tanggal === today);
  
  let totalRevenue = 0;
  let totalProfit  = 0;
  // trxId unik = 1 transaksi kasir, hitung per trxId
  const trxIds = new Set();
  todayRecords.forEach(r => {
    totalRevenue += (r.hargaJual || 0) * (r.qty || 0);
    totalProfit  += r.profit || 0;
    if (r.trxId) trxIds.add(r.trxId);
    else trxIds.add(r.id); // record tanpa trxId = 1 transaksi lama
  });
  
  document.getElementById('pos-total-revenue').textContent = formatRp(totalRevenue);
  document.getElementById('pos-total-profit').textContent  = formatRp(totalProfit);
  document.getElementById('pos-total-trx').textContent     = trxIds.size;
}

// =====================
// PROMO MANAGEMENT
// =====================
// Simpan Promo Diskon
function simpanPromoDiskon() {
  const nama = document.getElementById('diskon-nama-promo')?.value?.trim();
  const mulai = document.getElementById('diskon-tgl-mulai')?.value;
  const selesai = document.getElementById('diskon-tgl-selesai')?.value;
  
  if (!nama || !mulai || !selesai) {
    showToast('âš ï¸ Lengkapi semua field (nama, tanggal mulai & selesai)');
    return;
  }
  
  // Get data from simulation form
  const menuNama = document.getElementById('d-nama')?.value || '';
  const persen = parseFloat(document.getElementById('d-diskon')?.value) || 0;
  const hargaNormal = parseFloat(document.getElementById('d-harga-normal')?.value) || 0;
  
  if (!menuNama || persen <= 0 || hargaNormal <= 0) {
    showToast('âš ï¸ Harap lakukan simulasi terlebih dahulu');
    return;
  }
  
  const hargaPromo = Math.round(hargaNormal * (1 - persen/100));
  
  const promo = {
    id: Date.now(),
    nama,
    type: 'diskon',
    periodeMulai: mulai,
    periodeSelesai: selesai,
    menuNama,
    persen,
    hargaNormal,
    hargaPromo,
    created: new Date().toISOString()
  };
  
  savePromo(promo);
}

// Helper untuk highlight selected harga bundling
function selectBundlingHarga(radio) {
  // Reset all labels
  document.querySelectorAll('input[name="bundling-harga-promo"]').forEach(r => {
    const lbl = r.closest('label');
    if (lbl) {
      lbl.style.borderColor = 'var(--border)';
      lbl.style.background = 'var(--card)';
    }
  });
  
  // Check radio dan highlight label yang dipilih
  radio.checked = true;
  const lbl = radio.closest('label');
  if (lbl) {
    lbl.style.borderColor = 'var(--orange)';
    lbl.style.background = '#FFF4E6';
  }
}

// Simpan Promo Bundling
function simpanPromoBundling() {
  const nama = document.getElementById('bundling-nama-promo')?.value?.trim();
  const mulai = document.getElementById('bundling-tgl-mulai')?.value;
  const selesai = document.getElementById('bundling-tgl-selesai')?.value;
  
  if (!nama || !mulai || !selesai) {
    showToast('âš ï¸ Lengkapi semua field');
    return;
  }
  
  // Get selected harga
  const selectedHarga = document.querySelector('input[name="bundling-harga-promo"]:checked');
  if (!selectedHarga) {
    showToast('âš ï¸ Pilih harga bundling');
    return;
  }
  
  const harga = parseFloat(selectedHarga.value);
  const hargaLabel = selectedHarga.getAttribute('data-label');
  
  const promo = {
    id: Date.now(),
    nama,
    type: 'bundling',
    periodeMulai: mulai,
    periodeSelesai: selesai,
    harga,
    hargaLabel,
    created: new Date().toISOString()
  };
  
  savePromo(promo);
}

// Simpan Promo Beli Gratis
function simpanPromoBeliGratis() {
  const nama = document.getElementById('beli-gratis-nama-promo')?.value?.trim();
  const mulai = document.getElementById('beli-gratis-tgl-mulai')?.value;
  const selesai = document.getElementById('beli-gratis-tgl-selesai')?.value;
  
  if (!nama || !mulai || !selesai) {
    showToast('âš ï¸ Lengkapi semua field');
    return;
  }
  
  const beli = parseInt(document.getElementById('bg-beli')?.value) || 0;
  const gratis = parseInt(document.getElementById('bg-gratis')?.value) || 0;
  
  if (beli <= 0 || gratis <= 0) {
    showToast('âš ï¸ Masukkan jumlah beli dan gratis');
    return;
  }
  
  const promo = {
    id: Date.now(),
    nama,
    type: 'beli-gratis',
    periodeMulai: mulai,
    periodeSelesai: selesai,
    beli,
    gratis,
    created: new Date().toISOString()
  };
  
  savePromo(promo);
}

// Helper save promo
function savePromo(promo) {
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  promos.push(promo);
  localStorage.setItem('kedaiHeula_promos', JSON.stringify(promos));
  
  showToast(`âœ… Promo "${promo.nama}" disimpan!`);
  refreshPromoDropdown();
  renderPromoList();
  syncPromosToCloud();
  autoSyncPush('promo');
  
  // Reset form simpan & simulasi ke default
  if (promo.type === 'diskon') {
    document.getElementById('diskon-nama-promo').value = '';
    document.getElementById('diskon-tgl-mulai').value = '';
    document.getElementById('diskon-tgl-selesai').value = '';
    document.getElementById('form-simpan-diskon').style.display = 'none';
    // Reset simulasi diskon
    document.getElementById('d-nama').value = '';
    document.getElementById('d-hpp').value = '';
    document.getElementById('d-harga-normal').value = '';
    document.getElementById('d-diskon').value = '20';
    document.getElementById('d-diskon-label').textContent = '20%';
    document.getElementById('diskon-result').style.display = 'none';
    document.getElementById('diskon-result').innerHTML = '';
    const dMenuSel = document.getElementById('d-menu-select');
    if (dMenuSel) dMenuSel.value = '';
  } else if (promo.type === 'bundling') {
    document.getElementById('bundling-nama-promo').value = '';
    document.getElementById('bundling-tgl-mulai').value = '';
    document.getElementById('bundling-tgl-selesai').value = '';
    // Reset pilihan harga bundling
    document.querySelectorAll('input[name="bundling-harga-promo"]').forEach(r => {
      r.checked = false;
      const lbl = r.closest('label');
      if (lbl) { lbl.style.borderColor = 'var(--border)'; lbl.style.background = 'var(--card)'; }
    });
    // Reset simulasi bundling
    document.getElementById('bundling-result').innerHTML = '';
    document.getElementById('bundling-result').style.display = 'none';
    // Reset item bundling ke default
    bundleCount = 0;
    document.getElementById('bundle-items-list').innerHTML = '';
    tambahBundleItem(); tambahBundleItem();
  } else if (promo.type === 'beli-gratis') {
    document.getElementById('beli-gratis-nama-promo').value = '';
    document.getElementById('beli-gratis-tgl-mulai').value = '';
    document.getElementById('beli-gratis-tgl-selesai').value = '';
    // Reset simulasi beli gratis
    document.getElementById('bg-beli').value = '2';
    document.getElementById('bg-gratis').value = '1';
    document.getElementById('bg-hpp').value = '';
    document.getElementById('bg-harga').value = '';
    document.getElementById('bg-channel').value = '';
    document.getElementById('beli-gratis-result').style.display = 'none';
    document.getElementById('beli-gratis-result').innerHTML = '';
    const bgMenuSel = document.getElementById('bg-menu-select');
    if (bgMenuSel) bgMenuSel.value = '';
  }
}



function refreshPromoDropdown() {
  const sel = document.getElementById('pos-promo-select');
  if (!sel) return;
  
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const today = new Date().toISOString().split('T')[0];
  
  // Filter hanya promo aktif
  const activePromos = promos.filter(p => 
    p.periodeMulai <= today && p.periodeSelesai >= today
  );
  
  let html = '<option value="">Tanpa Promo</option>';
  activePromos.forEach(p => {
    const idx = promos.indexOf(p);
    const label = p.type === 'diskon' ? `${p.persen}%` : 
                  p.type === 'bundling' ? 'Paket' : 
                  p.type === 'beli-dapat' ? 'Beli X Gratis Y' : '';
    html += `<option value="${idx}">ğŸ·ï¸ ${p.nama} ${label ? `(${label})` : ''}</option>`;
  });
  
  if (activePromos.length === 0) {
    html += '<option value="" disabled>âš ï¸ Tidak ada promo aktif</option>';
  }
  
  sel.innerHTML = html;
}

function applyPromoToPOS() {
  const sel = document.getElementById('pos-promo-select');
  const idx = sel.value;
  
  if (idx === '') {
    // No promo
    document.getElementById('pos-promo-discount').style.display = 'none';
    updateCartSidebar();
    return;
  }
  
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const promo = promos[parseInt(idx)];
  
  if (!promo) return;
  
  // Calculate discount
  const subtotalText = document.getElementById('pos-subtotal').textContent;
  const subtotal = parseFloat(subtotalText.replace(/[^0-9]/g, '')) || 0;
  
  let discount = 0;
  if (promo.type === 'diskon') {
    discount = subtotal * (promo.persen / 100);
  }
  
  // Show discount
  document.getElementById('pos-promo-discount').style.display = 'block';
  document.getElementById('pos-discount-amount').textContent = '- ' + formatRp(discount);
  
  // Update subtotal
  const newSubtotal = subtotal - discount;
  document.getElementById('pos-subtotal').textContent = formatRp(newSubtotal);
  
  hitungKembalianPOS();
}

// Render daftar promo
function renderPromoList(filter = 'all') {
  const container = document.getElementById('promo-list-container');
  if (!container) return;
  
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const today = new Date().toISOString().split('T')[0];
  
  let filtered = promos.filter(p => {
    if (filter === 'all') return true;
    if (filter === 'active') return p.periodeMulai <= today && p.periodeSelesai >= today;
    if (filter === 'upcoming') return p.periodeMulai > today;
    if (filter === 'expired') return p.periodeSelesai < today;
    return true;
  });
  
  if (filtered.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="es-icon">ğŸ·ï¸</div>
        <p>Belum ada promo tersimpan</p>
        <small>Buat promo di tab Diskon/Bundling/Beli Gratis, lalu klik Simpan</small>
      </div>
    `;
    return;
  }
  
  let html = '';
  filtered.forEach((p, idx) => {
    const isActive = p.periodeMulai <= today && p.periodeSelesai >= today;
    const isUpcoming = p.periodeMulai > today;
    const status = isActive ? 'âœ… Aktif' : isUpcoming ? 'ğŸ•’ Upcoming' : 'â° Expired';
    const statusColor = isActive ? 'var(--green)' : isUpcoming ? 'var(--orange)' : 'var(--muted)';
    
    // Find real index in full promos array
    const realIdx = promos.findIndex(promo => promo.id === p.id);
    
    html += `
      <div style="background:var(--card);border:2px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
          <div style="flex:1;">
            <div style="font-weight:800;font-size:15px;margin-bottom:4px;">${p.nama}</div>
            <div style="font-size:12px;color:${statusColor};font-weight:700;">${status}</div>
          </div>
          <span style="background:var(--bg);padding:6px 12px;border-radius:8px;font-size:12px;font-weight:700;">
            ${p.type === 'diskon' ? `${p.persen}%` : p.type}
          </span>
        </div>
        
        <div style="font-size:13px;color:var(--muted);margin-bottom:10px;">
          ğŸ“… ${formatTanggal(p.periodeMulai)} - ${formatTanggal(p.periodeSelesai)}
        </div>
        
        ${p.menuNama ? `<div style="font-size:13px;margin-bottom:10px;">Menu: <strong>${p.menuNama}</strong></div>` : ''}
        ${p.harga ? `<div style="font-size:13px;margin-bottom:10px;">Harga: <strong>${formatRp(p.harga)}</strong> ${p.hargaLabel ? `(${p.hargaLabel})` : ''}</div>` : ''}
        
        <div style="display:flex;gap:8px;">
          <button onclick="hapusPromo('${p.id}')" style="padding:8px 14px;font-size:12px;border-radius:8px;border:none;background:var(--light-red);color:var(--red);font-weight:700;cursor:pointer;">ğŸ—‘ï¸ Hapus</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function filterPromos(filter) {
  // Update button styles
  ['all', 'active', 'upcoming', 'expired'].forEach(f => {
    const btn = document.getElementById(`filter-${f}`);
    if (btn) {
      if (f === filter) {
        btn.style.background = 'var(--orange)';
        btn.style.color = 'white';
      } else {
        btn.style.background = '';
        btn.style.color = '';
      }
    }
  });
  
  renderPromoList(filter);
}

// Reset Form Functions
function resetFormDiskon() {
  document.getElementById('diskon-nama-promo').value = '';
  document.getElementById('diskon-tgl-mulai').value = '';
  document.getElementById('diskon-tgl-selesai').value = '';
  document.getElementById('d-nama').value = '';
  document.getElementById('d-hpp').value = '';
  document.getElementById('d-harga-normal').value = '';
  document.getElementById('d-diskon').value = '10';
  document.getElementById('d-platform-fee').value = '0';
  document.getElementById('diskon-result').style.display = 'none';
  showToast('ğŸ”„ Form direset');
}

function resetFormBundling() {
  document.getElementById('bundling-nama-promo').value = '';
  document.getElementById('bundling-tgl-mulai').value = '';
  document.getElementById('bundling-tgl-selesai').value = '';
  // Reset bundle items to default 2 items
  bundleCount = 0;
  tambahBundleItem();
  tambahBundleItem();
  showToast('ğŸ”„ Form direset');
}

function resetFormBeliGratis() {
  document.getElementById('beli-gratis-nama-promo').value = '';
  document.getElementById('beli-gratis-tgl-mulai').value = '';
  document.getElementById('beli-gratis-tgl-selesai').value = '';
  document.getElementById('bg-menu-select').value = '';
  document.getElementById('bg-beli').value = '2';
  document.getElementById('bg-gratis').value = '1';
  document.getElementById('bg-channel').value = '';
  document.getElementById('bg-hpp').value = '';
  document.getElementById('bg-harga').value = '';
  document.getElementById('bg-fee').value = '20';
  document.getElementById('bg-transaksi').value = '10';
  document.getElementById('bg-fee-row').style.display = 'none';
  document.getElementById('beli-gratis-result').style.display = 'none';
  document.getElementById('beli-gratis-result').innerHTML = '';
  showToast('ğŸ”„ Form direset');
}

function editPromo(promoId) {
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  const idx = promos.findIndex(p => p.id == promoId);
  const promo = promos[idx];
  if (!promo) return;
  
  const nama = prompt('Nama promo:', promo.nama);
  if (!nama) return;
  
  const mulai = prompt('Tanggal mulai (YYYY-MM-DD):', promo.periodeMulai);
  if (!mulai) return;
  
  const selesai = prompt('Tanggal selesai (YYYY-MM-DD):', promo.periodeSelesai);
  if (!selesai) return;
  
  promo.nama = nama;
  promo.periodeMulai = mulai;
  promo.periodeSelesai = selesai;
  
  promos[idx] = promo;
  localStorage.setItem('kedaiHeula_promos', JSON.stringify(promos));
  
  showToast('âœ… Promo diupdate!');
  renderPromoList();
  syncPromosToCloud();
}

function hapusPromo(promoId) {
  showKonfirmasi({
    icon: 'ğŸ—‘ï¸',
    title: 'Hapus Promo?',
    message: 'Promo ini akan dihapus permanen dari daftar.',
    labelOk: 'Ya, Hapus',
    onOk: () => {
      const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
      const filtered = promos.filter(p => p.id != promoId);
      localStorage.setItem('kedaiHeula_promos', JSON.stringify(filtered));
      showToast('ğŸ—‘ï¸ Promo dihapus');
      renderPromoList();
      refreshPromoDropdown();
      syncPromosToCloud();
      autoSyncPush('promo');
    }
  });
}

function exportPromosPDF() {
  showToast('ğŸ“„ Export PDF coming soon...');
  // TODO: Implement PDF export
}

function syncPromosToCloud() {
  const sheetsURL = localStorage.getItem('kedaiHeula_sheetsURL');
  if (!sheetsURL) return;
  
  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  
  fetch(sheetsURL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      action: 'syncPromos',
      data: promos
    })
  }).catch(err => console.error('Sync error:', err));
}

// =====================
// HELPERS

// HELPER FUNCTIONS
// =====================

let currentFotoBase64 = null; // Store foto saat ini

// Deteksi apakah di mobile/Telegram
function isMobileOrTelegram() {
  const ua = navigator.userAgent.toLowerCase();
  return /mobile|android|iphone|ipad|telegram/i.test(ua) || window.innerWidth < 768;
}

// Preview foto yang diupload
function previewFoto(input, previewId) {
  const preview = document.getElementById(previewId);
  
  if (input.files && input.files[0]) {
    const file = input.files[0];
    
    // Validasi ukuran (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
      alert('Ukuran foto terlalu besar! Maksimal 2MB.');
      input.value = '';
      preview.innerHTML = '';
      currentFotoBase64 = null;
      return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const original = e.target.result;
      
      // Tampilkan preview dulu (pakai original)
      preview.innerHTML = `
        <div style="position:relative;display:inline-block;">
          <img src="${original}" style="max-width:200px;max-height:200px;border-radius:12px;border:2px solid var(--border);" />
          <button onclick="hapusFoto('${previewId}', '${input.id}')" style="position:absolute;top:4px;right:4px;background:var(--red);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-weight:bold;font-size:12px;">Ã—</button>
          <div style="font-size:10px;color:var(--muted);margin-top:4px;">â³ Mengompres foto...</div>
        </div>
      `;
      
      // Kompres foto untuk sync (async)
      try {
        kompresGambar(original, 400, 400, 0.7, (compressed) => {
          currentFotoBase64 = compressed;
          // Update preview message
          const msg = preview.querySelector('div[style*="font-size:10px"]');
          if (msg) msg.textContent = 'âœ“ Siap untuk sync';
        });
      } catch (err) {
        console.error('Kompresi gagal, pakai original:', err);
        currentFotoBase64 = original; // Fallback ke original
      }
    };
    
    reader.readAsDataURL(file);
  } else {
    preview.innerHTML = '';
    currentFotoBase64 = null;
  }
}

// Kompres gambar untuk mengurangi ukuran base64
function kompresGambar(base64, maxWidth, maxHeight, quality, callback) {
  try {
    const img = new Image();
    
    img.onerror = function() {
      console.error('Gagal load image untuk kompresi');
      callback(base64); // Fallback ke original
    };
    
    img.onload = function() {
      try {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // Hitung resize ratio
        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width = Math.round(width * ratio);
          height = Math.round(height * ratio);
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // Convert ke base64 dengan kompresi
        const compressed = canvas.toDataURL('image/jpeg', quality);
        callback(compressed);
      } catch (err) {
        console.error('Gagal kompres canvas:', err);
        callback(base64); // Fallback ke original
      }
    };
    
    img.src = base64;
  } catch (err) {
    console.error('Error di kompresGambar:', err);
    callback(base64); // Fallback ke original
  }
}

// Hapus foto
function hapusFoto(previewId, inputId) {
  document.getElementById(previewId).innerHTML = '';
  document.getElementById(inputId).value = '';
  currentFotoBase64 = null;
}

// Get current date/time in WIB (UTC+7)
function getWIBDate() {
  const now = new Date();
  // Offset UTC ke WIB (+7 jam = +420 menit)
  const wibOffset = 7 * 60; // menit
  const localOffset = now.getTimezoneOffset(); // offset browser dalam menit (negatif untuk timezones di timur UTC)
  const wibTime = new Date(now.getTime() + (wibOffset + localOffset) * 60000);
  return wibTime;
}

// Format WIB date ke YYYY-MM-DD (untuk input type="date")
function getWIBDateString() {
  const wib = getWIBDate();
  const year = wib.getFullYear();
  const month = String(wib.getMonth() + 1).padStart(2, '0');
  const day = String(wib.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// Format WIB datetime untuk display (DD/MM/YYYY HH:MM)
function getWIBDateTimeString() {
  const wib = getWIBDate();
  return wib.toLocaleString('id-ID', { 
    timeZone: 'Asia/Jakarta',
    year: 'numeric',
    month: '2-digit', 
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Parse tanggal string YYYY-MM-DD dengan asumsi WIB
function parseWIBDate(dateStr) {
  // Parse sebagai midnight WIB, bukan UTC
  return new Date(dateStr + 'T00:00:00+07:00');
}

// Bulatkan harga makanan ke kelipatan yang lebih realistis
function roundHargaMakanan(harga) {
  const rounded = Math.round(harga);
  
  if (rounded < 1000) {
    // Di bawah 1000: bulatkan ke kelipatan 100
    return Math.round(rounded / 100) * 100;
  } else if (rounded < 5000) {
    // 1000-5000: bulatkan ke kelipatan 500
    return Math.round(rounded / 500) * 500;
  } else if (rounded < 10000) {
    // 5000-10000: bulatkan ke kelipatan 1000
    return Math.round(rounded / 1000) * 1000;
  } else {
    // Di atas 10000: bulatkan ke kelipatan 1000
    return Math.round(rounded / 1000) * 1000;
  }
}

function formatRp(num) {
  if (isNaN(num) || !isFinite(num)) return 'Rp 0';
  return 'Rp ' + Math.round(num).toLocaleString('id-ID');
}

function formatTanggal(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  const options = { day: 'numeric', month: 'short', year: 'numeric' };
  return date.toLocaleDateString('id-ID', options);
}

function getCategoryLabel(cat) {
  const map = { takoyaki: 'ğŸ™ Takoyaki', dimsum: 'ğŸ¥Ÿ Dimsum', ayam: 'ğŸ— Ayam Crispy', lainnya: 'ğŸ± Lainnya' };
  return map[cat] || cat;
}

function getCategoryEmoji(cat) {
  const map = { takoyaki: 'ğŸ™', dimsum: 'ğŸ¥Ÿ', ayam: 'ğŸ—', lainnya: 'ğŸ±' };
  return map[cat] || 'ğŸ½ï¸';
}

// State untuk pilihan harga
let selectedMargin = 50;
let selectedChannel = 'offline';
let selectedHargaJual = 0;

function pilihKategoriHarga(margin) {
  selectedMargin = margin;
  
  // Reset highlight semua tombol kategori
  [30, 50, 70].forEach(m => {
    const btn = document.getElementById('btn-kategori-' + m);
    if (!btn) return;
    if (m === 30) { btn.style.boxShadow = ''; btn.style.transform = ''; btn.style.borderColor = '#F5C518'; }
    if (m === 50) { btn.style.boxShadow = ''; btn.style.transform = ''; btn.style.borderColor = '#27AE60'; }
    if (m === 70) { btn.style.boxShadow = ''; btn.style.transform = ''; btn.style.borderColor = '#E03027'; }
  });
  
  // Highlight tombol terpilih
  const selected = document.getElementById('btn-kategori-' + margin);
  if (selected) {
    selected.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    selected.style.transform = 'scale(1.05)';
  }

  // Tampilkan channel selector
  document.getElementById('channel-selector').style.display = 'block';
  
  // Update tampilan harga jika channel sudah dipilih
  updateHargaTerpilih();
}

function pilihChannelHarga(channel) {
  selectedChannel = channel;

  // Reset highlight tombol channel
  ['offline', 'online'].forEach(c => {
    const btn = document.getElementById('btn-channel-' + c);
    if (btn) {
      btn.style.background = 'var(--card)';
      btn.style.borderColor = 'var(--border)';
      btn.style.color = '';
    }
  });

  // Highlight yang dipilih
  const sel = document.getElementById('btn-channel-' + channel);
  if (sel) {
    sel.style.background = channel === 'online' ? '#E8F5E9' : '#EFF8FF';
    sel.style.borderColor = channel === 'online' ? '#27AE60' : '#2196F3';
  }

  updateHargaTerpilih();
}

function updateHargaTerpilih() {
  const hargaEl = document.getElementById('harga-terpilih-display');
  const nilaiEl = document.getElementById('harga-terpilih-nilai');
  const labelEl = document.getElementById('harga-terpilih-label');
  const infoEl  = document.getElementById('harga-terpilih-info');

  if (!hargaEl || !nilaiEl) return;

  // Ambil nilai dari hidden input
  const offlineVal = parseFloat(document.getElementById('harga-' + selectedMargin + '-offline').value) || 0;
  const onlineVal  = parseFloat(document.getElementById('harga-' + selectedMargin + '-online').value) || 0;

  if (offlineVal === 0 && onlineVal === 0) return; // Belum ada data HPP

  const harga = selectedChannel === 'online' ? onlineVal : offlineVal;
  const hpp = lastHPP || 0;
  const profitPerPcs = selectedChannel === 'online'
    ? Math.round(harga * (1 - 0.20)) - hpp  // estimasi setelah fee 20%
    : harga - hpp;

  const kategoriLabel = selectedMargin === 30 ? 'ğŸŸ¡ EKONOMIS' : selectedMargin === 50 ? 'ğŸŸ¢ STANDAR' : 'ğŸ”¥ PREMIUM';
  const channelLabel  = selectedChannel === 'online' ? 'ğŸ“± Online (GoFood/Shopee)' : 'ğŸª Offline';

  labelEl.textContent = `${kategoriLabel} Â· ${channelLabel}`;
  nilaiEl.textContent = formatRp(harga);
  infoEl.textContent  = `Profit: ${formatRp(profitPerPcs)}/pcs Â· Margin ${selectedMargin}%${selectedChannel === 'online' ? ' (setelah fee ~20%)' : ''}`;

  hargaEl.style.display = 'block';

  // Simpan ke selectedHargaJual untuk dipakai saat simpanMenu
  selectedHargaJual = harga;
}

function pilihHarga(el, type) {
  // Fungsi lama -- sekarang tidak dipakai tapi tetap ada untuk backward compat
}

function resetForm() {
  document.getElementById('nama-menu').value = '';
  document.getElementById('porsi').value = '6';
  document.getElementById('biaya-kemasan').value = '500';
  document.getElementById('bahan-list').innerHTML = '';
  document.getElementById('biaya-list').innerHTML = '';
  document.getElementById('hasil-section').style.display = 'none';
  
  // Reset foto
  document.getElementById('foto-menu').value = '';
  document.getElementById('preview-foto').innerHTML = '';
  currentFotoBase64 = null;
  
  // Reset pilihan harga
  selectedHargaJual = 0;
  selectedMargin = 50;
  selectedChannel = 'offline';
  const channelSel = document.getElementById('channel-selector');
  if (channelSel) channelSel.style.display = 'none';
  const hargaDisp = document.getElementById('harga-terpilih-display');
  if (hargaDisp) hargaDisp.style.display = 'none';
  
  bahanCount = 0; biayaCount = 0;
  tambahBahan(); tambahBahan(); tambahBahan();
  tambahBiaya();
}

function konfirmasiMenuBaru() {
  showKonfirmasi({
    icon: 'â•',
    title: 'Input Menu Baru?',
    message: 'Reset form untuk menu baru. Data yang belum disimpan ke Ringkasan akan hilang.',
    labelOk: 'Ya, Reset Form',
    onOk: () => {
      resetForm();
      lastSnapshot = {};
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });
}

function cetakHasil() {
  window.print();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// =====================
// MODAL KONFIRMASI CUSTOM
// =====================
let _konfirmasiCallback = null;

function showKonfirmasi({ icon = 'âš ï¸', title = 'Konfirmasi', message = 'Yakin?', labelOk = 'Ya, Lanjutkan', onOk }) {
  _konfirmasiCallback = onOk;
  document.getElementById('konfirmasi-icon').textContent = icon;
  document.getElementById('konfirmasi-title').textContent = title;
  const _kmsg = document.getElementById('konfirmasi-message');
  if (message && message.includes('<')) _kmsg.innerHTML = message;
  else _kmsg.textContent = message;
  document.getElementById('konfirmasi-ok').textContent = labelOk;
  document.getElementById('modal-konfirmasi').style.display = 'flex';
}

function tutupKonfirmasi() {
  document.getElementById('modal-konfirmasi').style.display = 'none';
  _konfirmasiCallback = null;
}

function eksekusiKonfirmasi() {
  document.getElementById('modal-konfirmasi').style.display = 'none';
  if (_konfirmasiCallback) _konfirmasiCallback();
  _konfirmasiCallback = null;
}

// =====================
// MODAL NOTA / DETAIL ORDER
// =====================
let _notaTransaksi = null;

function lihatNota(transaksiObj) {
  _notaTransaksi = transaksiObj;
  renderNotaBody(transaksiObj);
  document.getElementById('modal-nota').style.display = 'flex';
}

function tutupNota() {
  document.getElementById('modal-nota').style.display = 'none';
}

function renderNotaBody(t) {
  const tglDisplay = new Date(t.timestamp).toLocaleString('id-ID', {
    timeZone: 'Asia/Jakarta',
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  });

  let itemRows = '';
  t.items.forEach(item => {
    itemRows += `
      <div style="display:flex;justify-content:space-between;align-items:start;padding:8px 0;border-bottom:1px dashed var(--border);">
        <div style="flex:1;">
          <div style="font-weight:700;font-size:14px;">${item.nama}</div>
          <div style="font-size:12px;color:var(--muted);">${formatRp(item.harga)} Ã— ${item.qty}</div>
        </div>
        <div style="font-weight:800;font-size:14px;">${formatRp(item.subtotal)}</div>
      </div>`;
  });

  const profit = t.items.reduce((s, i) => s + (i.profit || 0), 0);

  document.getElementById('nota-body').innerHTML = `
    <!-- Header Nota -->
    <div style="text-align:center;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid var(--border);">
      <div style="font-family:'Fredoka One',cursive;font-size:24px;color:var(--red);">ğŸ± Kedai Heula</div>
      <div style="font-size:11px;color:var(--muted);font-weight:700;margin-top:4px;">Jajanan Mantap Pisan!</div>
      <div style="font-size:12px;color:var(--muted);margin-top:6px;">ğŸ“… ${tglDisplay}</div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px;">#${t.id}</div>
    </div>

    <!-- Item List -->
    <div style="margin-bottom:16px;">${itemRows}</div>

    <!-- Summary -->
    <div style="background:var(--bg);border-radius:12px;padding:14px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:15px;font-weight:800;">
        <span>Total</span>
        <span style="color:var(--red);">${formatRp(t.total)}</span>
      </div>
      <div style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:13px;color:var(--muted);font-weight:700;">
        <span>ğŸ’µ Dibayar</span>
        <span>${formatRp(t.bayar)}</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--green);font-weight:700;">
        <span>ğŸ’° Kembalian</span>
        <span>${formatRp(t.kembalian)}</span>
      </div>
    </div>

    <div style="text-align:center;margin-top:16px;font-size:12px;color:var(--muted);font-weight:700;">
      - Terima kasih sudah belanja! -
    </div>
  `;
}

function printNota() {
  if (!_notaTransaksi) return;
  const t = _notaTransaksi;
  const tglDisplay = new Date(t.timestamp).toLocaleString('id-ID', {
    timeZone: 'Asia/Jakarta',
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  });

  let itemRows = t.items.map(item => `
    <tr>
      <td style="padding:4px 0;">${item.nama}</td>
      <td style="text-align:center;padding:4px 6px;">${item.qty}x</td>
      <td style="text-align:right;padding:4px 0;">${formatRp(item.harga)}</td>
      <td style="text-align:right;padding:4px 0;font-weight:700;">${formatRp(item.subtotal)}</td>
    </tr>`).join('');

  const htmlParts = [
    '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Nota Kedai Heula<\/title>',
    '<style>* { box-sizing: border-box; margin: 0; padding: 0; }',
    'body { font-family: \'Courier New\', monospace; font-size: 12px; width: 80mm; padding: 8px; }',
    '.center { text-align: center; } .bold { font-weight: bold; }',
    '.line { border-top: 1px dashed #000; margin: 6px 0; }',
    'table { width: 100%; border-collapse: collapse; }',
    '.total-row td { font-weight: bold; font-size: 14px; border-top: 1px solid #000; padding-top: 6px; }',
    '@media print { body { margin: 0; } }',
    '<\/style><\/head><body>',
    '<div class="center bold" style="font-size:16px;margin-bottom:4px;">KEDAI HEULA<\/div>',
    '<div class="center" style="font-size:10px;margin-bottom:2px;">Jajanan Mantap Pisan!<\/div>',
    '<div class="center" style="font-size:10px;">' + tglDisplay + '<\/div>',
    '<div class="center" style="font-size:10px;margin-bottom:6px;">#' + t.id + '<\/div>',
    '<div class="line"><\/div>',
    '<table><tbody>' + itemRows + '<\/tbody>',
    '<tr class="total-row"><td colspan="3">TOTAL<\/td><td style="text-align:right;">' + formatRp(t.total) + '<\/td><\/tr>',
    '<\/table><div class="line"><\/div>',
    '<table>',
    '<tr><td>Dibayar<\/td><td style="text-align:right;">' + formatRp(t.bayar) + '<\/td><\/tr>',
    '<tr><td>Kembalian<\/td><td style="text-align:right;font-weight:bold;">' + formatRp(t.kembalian) + '<\/td><\/tr>',
    '<\/table><div class="line"><\/div>',
    '<div class="center" style="margin-top:8px;font-size:11px;">-- Terima kasih! --<\/div>'
  ];
  const htmlContent = htmlParts.join('') + '<scr' + 'ipt>window.onload=function(){window.print();window.onafterprint=function(){window.close();};}<\/scr' + 'ipt><\/body><\/html>';

  // Buka di popup window terpisah agar layout utama tidak terpengaruh
  const popup = window.open('', 'nota_print', 'width=350,height=600,menubar=no,toolbar=no,status=no');
  if (popup) {
    popup.document.write(htmlContent);
    popup.document.close();
  } else {
    showToast('âš ï¸ Popup diblok browser. Izinkan popup untuk print nota.');
  }
}

// =====================
// PROMO - SWITCH PANEL
// =====================
let bundleCount = 0;

function switchPromo(type, el) {
  document.querySelectorAll('.promo-type-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.promo-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-' + type).classList.add('active');
  if (type === 'diskon') refreshDropdownDiskon();
  if (type === 'bundling') refreshAllBundleDropdowns();
  if (type === 'aktif') renderPromoList('all');
}

function refreshAllBundleDropdowns() {
  document.querySelectorAll('.bundle-item-row').forEach(row => {
    const idMatch = row.id.match(/bundle-(\d+)/);
    if (!idMatch) return;
    const id = idMatch[1];
    const sel = row.querySelector('select');
    if (!sel) return;
    const currentNama = (document.getElementById('bname-' + id) || {}).value || '';
    sel.innerHTML = getBundleMenuOptions(currentNama);
  });
}

// =====================
// DROPDOWN DARI RINGKASAN
// =====================
function refreshDropdownDiskon() {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const sel = document.getElementById('d-pilih-menu');
  const current = sel.value;

  sel.innerHTML = '<option value="">- Pilih menu yang sudah dihitung HPP-nya -</option>';

  if (data.length === 0) {
    sel.innerHTML += '<option value="" disabled>âš ï¸ Belum ada menu tersimpan di Ringkasan</option>';
    return;
  }

  data.forEach((m, i) => {
    const label = getCategoryLabel(m.kategori);
    sel.innerHTML += `<option value="${i}">${label} ${m.nama} - HPP: ${formatRp(m.hpp)}</option>`;
  });

  // Pertahankan pilihan sebelumnya jika masih ada
  if (current !== '') sel.value = current;
}

function isiDariRingkasan() {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const idx = document.getElementById('d-pilih-menu').value;

  if (idx === '') {
    document.getElementById('d-menu-info').style.display = 'none';
    return;
  }

  const menu = data[parseInt(idx)];
  if (!menu) return;

  // Isi form
  document.getElementById('d-nama').value = menu.nama;
  document.getElementById('d-hpp').value = Math.round(menu.hpp);
  document.getElementById('d-harga-normal').value = Math.round(menu.hargaJual);

  // Tampilkan info card
  document.getElementById('d-menu-info').style.display = 'block';
  document.getElementById('d-menu-info-nama').textContent = menu.nama;
  document.getElementById('d-menu-info-kategori').textContent = getCategoryLabel(menu.kategori) + ' Â· Tersimpan ' + menu.tanggal;
  document.getElementById('d-menu-info-hpp').textContent = formatRp(menu.hpp);
  document.getElementById('d-menu-info-hj').textContent = formatRp(menu.hargaJual);

  // Langsung hitung
  hitungDiskon();
}

// =====================
// PROMO - DISKON %
// =====================
function updateDiskonSlider() {
  const val = document.getElementById('d-diskon').value;
  document.getElementById('d-diskon-label').textContent = val + '%';
}

function hitungDiskon() {
  const hpp = parseFloat(document.getElementById('d-hpp').value) || 0;
  const hargaNormal = parseFloat(document.getElementById('d-harga-normal').value) || 0;
  const diskon = parseFloat(document.getElementById('d-diskon').value) || 0;
  const platformFee = parseFloat(document.getElementById('d-platform-fee').value) || 0;
  const nama = document.getElementById('d-nama').value || 'Menu';

  if (hpp === 0 || hargaNormal === 0) return;

  const hargaSetelahDiskon = hargaNormal * (1 - diskon / 100);
  const pendapatanBersih = hargaSetelahDiskon * (1 - platformFee / 100);
  const profitPerPcs = pendapatanBersih - hpp;
  const marginNormal = ((hargaNormal * (1 - platformFee / 100) - hpp) / (hargaNormal * (1 - platformFee / 100))) * 100;
  const marginPromo = pendapatanBersih > 0 ? ((profitPerPcs) / pendapatanBersih) * 100 : 0;
  const minHargaDiskon = hpp / (1 - platformFee / 100);

  const isProfit = profitPerPcs > 0;
  const isDangerous = profitPerPcs < 0;
  const isWarning = profitPerPcs >= 0 && profitPerPcs < hpp * 0.1;

  let boxClass = isProfit && !isWarning ? 'profit' : isWarning ? 'warning' : 'danger';

  let verdictText = '';
  if (isDangerous) {
    verdictText = `âš ï¸ <strong>BONCOS!</strong> Promo diskon ${diskon}% ini bikin kamu rugi ${formatRp(Math.abs(profitPerPcs))} per pcs. Minimal harga jual setelah diskon harus <strong>${formatRp(Math.ceil(minHargaDiskon))}</strong> biar balik modal.`;
  } else if (isWarning) {
    verdictText = `ğŸ˜¬ <strong>Hati-hati!</strong> Masih untung tipis (${marginPromo.toFixed(1)}%). Promo ini oke buat menarik pelanggan baru tapi jangan kelamaan ya. Maksimal 7-14 hari.`;
  } else {
    verdictText = `âœ… <strong>Aman dijalankan!</strong> Margin promo masih ${marginPromo.toFixed(1)}%, turun dari ${marginNormal.toFixed(1)}% normal. Cocok buat promo pembukaan atau flash sale!`;
  }

  const el = document.getElementById('diskon-result');
  el.style.display = 'block';
  el.innerHTML = `
    <div class="promo-result-box ${boxClass}">
      <div style="font-family:'Fredoka One',cursive;font-size:17px;margin-bottom:12px;">
        ğŸ“Š Hasil Simulasi: ${nama} Diskon ${diskon}%
      </div>
      <div class="promo-result-grid">
        <div class="promo-result-item">
          <span class="pri-label">Harga Normal</span>
          <div class="pri-value">${formatRp(hargaNormal)}</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Harga Setelah Diskon</span>
          <div class="pri-value">${formatRp(hargaSetelahDiskon)}</div>
          <div class="pri-sub">hemat ${formatRp(hargaNormal - hargaSetelahDiskon)}</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Pendapatan Bersih/pcs</span>
          <div class="pri-value">${formatRp(pendapatanBersih)}</div>
          <div class="pri-sub">setelah platform fee ${platformFee}%</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Profit / Rugi per Pcs</span>
          <div class="pri-value">${profitPerPcs >= 0 ? '+' : ''}${formatRp(profitPerPcs)}</div>
          <div class="pri-sub">margin ${marginPromo.toFixed(1)}%</div>
        </div>
      </div>
      <div class="verdict-box">
        <div class="verdict-title">Verdict</div>
        ${verdictText}
      </div>
    </div>
  `;
  
  // Show form simpan promo
  const formSimpan = document.getElementById('form-simpan-diskon');
  if (formSimpan) formSimpan.style.display = 'block';
}

// =====================
// PROMO - BUNDLING
// =====================
function getBundleMenuOptions(selectedNama = '') {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  let opts = `<option value="">- Pilih dari ringkasan -</option>`;
  data.forEach((m, i) => {
    const sel = m.nama === selectedNama ? 'selected' : '';
    opts += `<option value="${i}" ${sel}>${getCategoryLabel(m.kategori)} ${m.nama}</option>`;
  });
  if (data.length === 0) opts += `<option value="" disabled>âš ï¸ Belum ada menu tersimpan</option>`;
  return opts;
}

function tambahBundleItem() {
  bundleCount++;
  const id = bundleCount;
  const div = document.createElement('div');
  div.className = 'bundle-item-row';
  div.id = 'bundle-' + id;
  div.innerHTML = `
    <select onchange="isiBundle(${id}, this)" style="font-size:13px;padding:10px 12px;border:2px solid var(--border);border-radius:10px;font-family:'Nunito',sans-serif;font-weight:700;background:var(--bg);outline:none;width:100%;">
      ${getBundleMenuOptions()}
    </select>
    <div style="display:flex;flex-direction:column;gap:4px;">
      <div id="bhpp-display-${id}" style="font-size:10px;font-weight:800;color:var(--muted);padding:2px 4px;min-height:16px;"></div>
      <input type="number" id="bhpp-${id}" min="0" step="any" placeholder="HPP/pcs" oninput="hitungBundling()" style="font-size:13px;" />
    </div>
    <div style="display:flex;flex-direction:column;gap:4px;">
      <div id="bhj-display-${id}" style="font-size:10px;font-weight:800;color:var(--green);padding:2px 4px;min-height:16px;"></div>
      <input type="number" id="bhj-${id}" min="0" step="any" placeholder="Harga jual" oninput="hitungBundling()" style="font-size:13px;" />
    </div>
    <input type="number" id="bqty-${id}" min="1" step="1" value="1" oninput="hitungBundling()" style="font-size:13px;" />
    <button class="btn btn-danger" onclick="hapusBundleItem(${id})">âœ•</button>
  `;
  document.getElementById('bundle-list').appendChild(div);
  hitungBundling();
}

function isiBundle(id, selectEl) {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const idx = selectEl.value;
  if (idx === '') return;
  const menu = data[parseInt(idx)];
  if (!menu) return;

  // Set HPP dan Harga Jual
  document.getElementById('bhpp-' + id).value = Math.round(menu.hpp);
  document.getElementById('bhj-' + id).value = Math.round(menu.hargaJual);
  document.getElementById('bhpp-display-' + id).textContent = 'HPP: ' + formatRp(menu.hpp);
  document.getElementById('bhj-display-' + id).innerHTML = 'ğŸ’° Jual: ' + formatRp(menu.hargaJual);
  
  hitungBundling();
}

function hapusBundleItem(id) {
  const el = document.getElementById('bundle-' + id);
  if (el) { el.remove(); hitungBundling(); }
}

function hitungBundling() {
  let totalHPP = 0;
  let totalHargaJualNormal = 0;
  const itemDetail = [];

  // Cari semua row bundle
  const rows = document.querySelectorAll('.bundle-item-row');
  rows.forEach(row => {
    const idMatch = row.id.match(/bundle-(\d+)/);
    if (!idMatch) return;
    const id = idMatch[1];

    const selectEl  = row.querySelector('select');
    const hppInput  = document.getElementById('bhpp-' + id);
    const hjInput   = document.getElementById('bhj-' + id);
    const qtyInput  = document.getElementById('bqty-' + id);

    if (!selectEl || !hppInput) return;

    const nama  = selectEl.options[selectEl.selectedIndex]?.text || '';
    const hpp   = parseFloat(hppInput.value) || 0;
    const hj    = parseFloat(hjInput ? hjInput.value : 0) || 0;
    const qty   = parseFloat(qtyInput ? qtyInput.value : 1) || 1;

    if (!nama || hpp === 0 || selectEl.value === '') return;

    const subtotalHPP = hpp * qty;
    const subtotalHJ  = hj * qty;
    totalHPP += subtotalHPP;
    totalHargaJualNormal += subtotalHJ;
    itemDetail.push({ nama, hpp, hj, qty, subtotalHPP, subtotalHJ });
  });

  if (totalHPP === 0) {
    document.getElementById('bundling-result').style.display = 'none';
    return;
  }

  const platformFee = 20; // Platform fee default GoFood/Shopee

  // REKOMENDASI OFFLINE (tanpa platform fee)
  const offlineHemat = roundHargaMakanan(totalHPP / (1 - 0.10)); // Margin 10%
  const offlineStandar = roundHargaMakanan(totalHPP / (1 - 0.25)); // Margin 25%
  const offlinePremium = roundHargaMakanan(totalHPP / (1 - 0.35)); // Margin 35%

  // REKOMENDASI ONLINE (dengan platform fee, markup 1.25x dari offline)
  const onlineHemat = roundHargaMakanan(offlineHemat * 1.25); // 25% markup dari offline
  const onlineStandar = roundHargaMakanan(offlineStandar * 1.25);
  const onlinePremium = roundHargaMakanan(offlinePremium * 1.25);

  // Hitung profit untuk setiap skenario
  const profitOfflineHemat = offlineHemat - totalHPP;
  const profitOfflineStandar = offlineStandar - totalHPP;
  const profitOfflinePremium = offlinePremium - totalHPP;

  const profitOnlineHemat = (onlineHemat * (1 - platformFee/100)) - totalHPP;
  const profitOnlineStandar = (onlineStandar * (1 - platformFee/100)) - totalHPP;
  const profitOnlinePremium = (onlinePremium * (1 - platformFee/100)) - totalHPP;
  
  // Save to global for form populate
  bundlingHargaData = {
    offlineHemat, offlineStandar, offlinePremium,
    onlineHemat, onlineStandar, onlinePremium,
    profitOfflineHemat, profitOfflineStandar, profitOfflinePremium,
    profitOnlineHemat, profitOnlineStandar, profitOnlinePremium
  };

  const normalInfo = totalHargaJualNormal > 0
    ? `<div style="font-size:12px;color:#666;margin-bottom:12px;">ğŸ’° Total harga satuan: <strong>${formatRp(totalHargaJualNormal)}</strong> -> hemat <strong>${formatRp(totalHargaJualNormal - offlineStandar)}</strong> dengan paket standar</div>`
    : '';

  const el = document.getElementById('bundling-result');
  el.style.display = 'block';
  el.innerHTML = `
    ${normalInfo}
    
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;">ğŸ” Detail Item Bundling</div>
      <table class="breakdown-table">
        <thead>
          <tr>
            <th>Item</th>
            <th class="text-right">Qty</th>
            <th class="text-right">HPP/pcs</th>
            <th class="text-right">Harga Jual/pcs</th>
            <th class="text-right">Subtotal HPP</th>
          </tr>
        </thead>
        <tbody>
          ${itemDetail.map(i => `
            <tr>
              <td>${i.nama}</td>
              <td class="text-right">${i.qty}x</td>
              <td class="text-right">${formatRp(i.hpp)}</td>
              <td class="text-right">${i.hj > 0 ? formatRp(i.hj) : '<span style="color:var(--muted)">-</span>'}</td>
              <td class="text-right">${formatRp(i.subtotalHPP)}</td>
            </tr>`).join('')}
          <tr style="border-top:2px solid var(--border);font-weight:800;">
            <td colspan="4" style="text-align:right;padding-top:8px;">Total HPP Paket:</td>
            <td class="text-right" style="padding-top:8px;color:var(--red);">${formatRp(totalHPP)}</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
  
  // Populate pilihan harga bundling  
  const hargaOptions = document.getElementById('bundling-harga-options');
  if (hargaOptions) {
    hargaOptions.innerHTML = `
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${offlineHemat}" data-label="Offline Hemat ~10%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">ğŸŸ¡ Offline Hemat</div>
          <div style="color:var(--orange);">${formatRp(offlineHemat)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOfflineHemat)}</div>
        </div>
      </label>
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${onlineHemat}" data-label="Online Hemat ~10%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">ğŸ“± Online Hemat</div>
          <div style="color:var(--orange);">${formatRp(onlineHemat)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOnlineHemat)}</div>
        </div>
      </label>
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${offlineStandar}" data-label="Offline Standar ~25%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">ğŸŸ¢ Offline Standar</div>
          <div style="color:var(--green);">${formatRp(offlineStandar)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOfflineStandar)}</div>
        </div>
      </label>
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${onlineStandar}" data-label="Online Standar ~25%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">ğŸ“± Online Standar</div>
          <div style="color:var(--green);">${formatRp(onlineStandar)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOnlineStandar)}</div>
        </div>
      </label>
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${offlinePremium}" data-label="Offline Premium ~35%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">ğŸ”¥ Offline Premium</div>
          <div style="color:var(--red);">${formatRp(offlinePremium)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOfflinePremium)}</div>
        </div>
      </label>
      <label style="border:2px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;" onclick="selectBundlingHarga(this.querySelector('input'))">
        <input type="radio" name="bundling-harga-promo" value="${onlinePremium}" data-label="Online Premium ~35%" style="cursor:pointer;" />
        <div>
          <div style="font-weight:700;">ğŸ“± Online Premium</div>
          <div style="color:var(--red);">${formatRp(onlinePremium)}</div>
          <div style="font-size:11px;color:var(--muted);">Profit: ${formatRp(profitOnlinePremium)}</div>
        </div>
      </label>
    `;
  }
}


// =====================
// PROMO - BELI X GRATIS Y
// =====================
function refreshDropdownBeliGratis() {
  // Populate dropdown menu untuk Beli X Gratis Y
  const menuData = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const sel = document.getElementById('bg-menu-select');
  if (!sel) return;
  
  let html = '<option value="">-- Pilih Menu --</option>';
  menuData.forEach((m, idx) => {
    html += `<option value="${idx}">${m.nama} - ${formatRp(m.hargaJual || 0)}</option>`;
  });
  sel.innerHTML = html;
}

  

function isiBeliGratis() {
  const sel = document.getElementById('bg-menu-select');
  const idx = sel.value;
  if (idx === '') return;
  
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const menu = data[parseInt(idx)];
  if (!menu) return;
  
  document.getElementById('bg-hpp').value = Math.round(menu.hpp);
  document.getElementById('bg-harga').value = Math.round(menu.hargaJual);
  hitungBeliGratis();
  showToast(`âœ… ${menu.nama} dipilih`);
}

function toggleBeliGratisChannel() {
  const channel = document.getElementById('bg-channel').value;
  const feeRow = document.getElementById('bg-fee-row');
  
  if (channel === 'online') {
    // Online - show platform fee
    if (feeRow) feeRow.style.display = 'grid';
    document.getElementById('bg-fee').value = 20;
  } else {
    // Offline or neutral - hide platform fee
    if (feeRow) feeRow.style.display = 'none';
    document.getElementById('bg-fee').value = 0;
  }
  
  hitungBeliGratis();
}

function hitungBeliGratis() {
  const beli = parseFloat(document.getElementById('bg-beli').value) || 1;
  const gratis = parseFloat(document.getElementById('bg-gratis').value) || 1;
  const hpp = parseFloat(document.getElementById('bg-hpp').value) || 0;
  const harga = parseFloat(document.getElementById('bg-harga').value) || 0;
  const fee = parseFloat(document.getElementById('bg-fee').value) || 0;
  const transaksiPerHari = parseFloat(document.getElementById('bg-transaksi').value) || 1;

  if (hpp === 0 || harga === 0) return;

  const totalUnit = beli + gratis;
  const totalBayar = beli * harga;
  const totalHPP = totalUnit * hpp;
  const pendapatanBersih = totalBayar * (1 - fee / 100);
  const profitPerTransaksi = pendapatanBersih - totalHPP;
  const marginPerTransaksi = pendapatanBersih > 0 ? (profitPerTransaksi / pendapatanBersih) * 100 : 0;
  const hargaEfektif = totalBayar / totalUnit; // harga rata-rata yang dibayar per pcs
  const diskonEfektif = ((harga - hargaEfektif) / harga) * 100;

  // Estimasi dampak harian
  const profitHarian = profitPerTransaksi * transaksiPerHari;
  const profitHarianNormal = (harga * (1 - fee / 100) - hpp) * beli * transaksiPerHari;

  const isProfit = profitPerTransaksi > 0;
  const isWarning = profitPerTransaksi >= 0 && marginPerTransaksi < 10;
  let boxClass = !isProfit ? 'danger' : isWarning ? 'warning' : 'profit';

  let verdict = '';
  if (!isProfit) {
    verdict = `âš ï¸ <strong>Boncos!</strong> Promo beli ${beli} gratis ${gratis} ini rugi ${formatRp(Math.abs(profitPerTransaksi))} per transaksi. Harga jualmu terlalu rendah untuk menanggung item gratis. Coba naikkan harga jual ke minimal ${formatRp(Math.ceil(totalHPP / (1 - fee / 100) / beli))} per pcs.`;
  } else if (isWarning) {
    verdict = `ğŸ˜¬ <strong>Margin sangat tipis (${marginPerTransaksi.toFixed(1)}%).</strong> Masih bisa jalan tapi riskan. Promo ini setara diskon efektif ${diskonEfektif.toFixed(1)}%. Batasi durasi promo maksimal 1 minggu.`;
  } else {
    verdict = `âœ… <strong>Promo ini layak!</strong> Beli ${beli} gratis ${gratis} = diskon efektif ${diskonEfektif.toFixed(1)}% di mata pelanggan. Kamu tetap untung ${formatRp(profitPerTransaksi)} per transaksi!`;
  }

  const el = document.getElementById('beli-gratis-result');
  el.style.display = 'block';
  el.innerHTML = `
    <div class="promo-result-box ${boxClass}">
      <div style="font-family:'Fredoka One',cursive;font-size:17px;margin-bottom:12px;">
        ğŸ Hasil: Beli ${beli} Gratis ${gratis}
      </div>
      <div class="promo-result-grid">
        <div class="promo-result-item">
          <span class="pri-label">Total Unit Keluar</span>
          <div class="pri-value">${totalUnit} pcs</div>
          <div class="pri-sub">beli ${beli} + gratis ${gratis}</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Pendapatan per Transaksi</span>
          <div class="pri-value">${formatRp(pendapatanBersih)}</div>
          <div class="pri-sub">bayar ${beli}x${formatRp(harga)}, fee ${fee}%</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Diskon Efektif</span>
          <div class="pri-value">${diskonEfektif.toFixed(1)}%</div>
          <div class="pri-sub">persepsi pelanggan</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Profit per Transaksi</span>
          <div class="pri-value">${profitPerTransaksi >= 0 ? '+' : ''}${formatRp(profitPerTransaksi)}</div>
          <div class="pri-sub">margin ${marginPerTransaksi.toFixed(1)}%</div>
        </div>
      </div>
      <div class="verdict-box">
        <div class="verdict-title">Verdict</div>
        ${verdict}
        <div style="margin-top:8px;font-size:12px;opacity:0.9;">
          ğŸ“… Estimasi dampak harian (${transaksiPerHari} transaksi/hari): 
          <strong>${profitHarian >= 0 ? '+' : ''}${formatRp(profitHarian)}</strong> profit
          vs <strong>+${formatRp(profitHarianNormal)}</strong> tanpa promo
        </div>
      </div>
    </div>
  `;
  
  // Show form simpan promo
  const formBeliGratis = document.getElementById('form-simpan-beli-gratis');
  if (formBeliGratis) formBeliGratis.style.display = 'block';
}

// =====================
// AUTO SYNC REALTIME
// =====================

// Debounce timer untuk auto-push
let _autoSyncTimer = null;

// -- Helper: parse tanggal WIB string ke timestamp number -------------------
function parseTanggal(str) {
  if (!str) return 0;
  // Format: "21/02/2026, 05.34" atau ISO string
  try {
    if (str.includes('/')) {
      const [tgl, jam] = str.split(', ');
      const [d, m, y] = tgl.split('/');
      const [h, mn] = (jam || '00.00').split('.');
      return new Date(`${y}-${m}-${d}T${h}:${mn}:00`).getTime();
    }
    return new Date(str).getTime() || 0;
  } catch(e) { return 0; }
}

// -- Deduplikasi array menu: per id, ambil yang tanggal paling baru ----------
function dedupMenu(arr) {
  const map = {};
  arr.forEach(item => {
    if (!item.id) {
      // Item lama tanpa id: pakai nama+hpp sebagai fallback key
      item.id = 'menu_' + btoa(encodeURIComponent((item.nama || '') + '_' + (item.hpp || 0))).substring(0, 20);
    }
    const existing = map[item.id];
    if (!existing) {
      map[item.id] = item;
    } else {
      // Ambil yang lebih baru berdasarkan tanggal
      if (parseTanggal(item.tanggal) > parseTanggal(existing.tanggal)) {
        map[item.id] = item;
      }
    }
  });
  return Object.values(map);
}

// -- Helper: parse tanggal WIB string ke timestamp number -------------------
function parseTanggal(str) {
  if (!str) return 0;
  // Format: "21/02/2026, 05.34" atau ISO string
  try {
    if (str.includes('/')) {
      const [tgl, jam] = str.split(', ');
      const [d, m, y] = tgl.split('/');
      const [h, mn] = (jam || '00.00').split('.');
      return new Date(`${y}-${m}-${d}T${h}:${mn}:00`).getTime();
    }
    return new Date(str).getTime() || 0;
  } catch(e) { return 0; }
}

// -- Deduplikasi array menu: per id, ambil yang tanggal paling baru ----------
function dedupMenu(arr) {
  const map = {};
  arr.forEach(item => {
    if (!item.id) {
      // Item lama tanpa id: pakai nama+hpp sebagai fallback key
      item.id = 'menu_' + btoa(encodeURIComponent((item.nama || '') + '_' + (item.hpp || 0))).substring(0, 20);
    }
    const existing = map[item.id];
    if (!existing) {
      map[item.id] = item;
    } else {
      // Ambil yang lebih baru berdasarkan tanggal
      if (parseTanggal(item.tanggal) > parseTanggal(existing.tanggal)) {
        map[item.id] = item;
      }
    }
  });
  return Object.values(map);
}


// =====================
// LAPORAN & TRANSAKSI
// =====================
function initLaporan() {
  // Set tanggal hari ini (WIB)
  document.getElementById('transaksi-tanggal').value = getWIBDateString();
  
  // Populate dropdown menu
  const menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const select = document.getElementById('transaksi-menu');
  select.innerHTML = '<option value="">-- Pilih Menu --</option>' +
    menuList.map((m, i) => `<option value="${i}">${m.nama} (${formatRp(m.hargaJual)})</option>`).join('');
  
  setPeriodeLaporan('semua'); // Default: tampilkan semua transaksi
}

function setTanggalTransaksi(mode) {
  const input = document.getElementById('transaksi-tanggal');
  const wib = getWIBDate();
  
  if (mode === 'kemarin') {
    wib.setDate(wib.getDate() - 1);
  }
  // mode 'hari-ini' tidak perlu ubah date
  
  const year = wib.getFullYear();
  const month = String(wib.getMonth() + 1).padStart(2, '0');
  const day = String(wib.getDate()).padStart(2, '0');
  input.value = `${year}-${month}-${day}`;
}

function isiHargaTransaksi() {
  const idx = parseInt(document.getElementById('transaksi-menu').value);
  if (isNaN(idx)) return;
  const menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const m = menuList[idx];
  if (!m) return;
  document.getElementById('transaksi-hpp').value = m.hpp;
  document.getElementById('transaksi-harga').value = m.hargaJual;
}

function simpanTransaksi() {
  const tanggal = document.getElementById('transaksi-tanggal').value;
  const menuIdx = parseInt(document.getElementById('transaksi-menu').value);
  const qty     = parseInt(document.getElementById('transaksi-qty').value) || 0;
  const hpp     = parseFloat(document.getElementById('transaksi-hpp').value) || 0;
  const harga   = parseFloat(document.getElementById('transaksi-harga').value) || 0;

  if (!tanggal || isNaN(menuIdx) || qty <= 0 || hpp <= 0 || harga <= 0) {
    alert('Isi semua field dengan benar');
    return;
  }

  const menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const menu = menuList[menuIdx];
  if (!menu) return;

  const transaksi = {
    id: Date.now() + Math.floor(Math.random() * 1000), // Tambah random untuk hindari collision
    tanggal: tanggal,
    menu: menu.nama,
    qty: qty,
    hpp: hpp,
    hargaJual: harga,
    profit: (harga - hpp) * qty,
    timestamp: getWIBDateTimeString() // WIB timezone
  };

  const listTransaksi = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  listTransaksi.push(transaksi);
  localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(listTransaksi));

  console.log('Transaksi tersimpan:', transaksi);
  console.log('Total transaksi di localStorage:', listTransaksi.length);

  showToast(`âœ… Transaksi tersimpan! Profit: ${formatRp(transaksi.profit)}`);
  
  // Reset form
  document.getElementById('transaksi-qty').value = 1;
  document.getElementById('transaksi-menu').value = '';
  document.getElementById('transaksi-hpp').value = '';
  document.getElementById('transaksi-harga').value = '';
  
  // Re-render laporan untuk update tampilan
  renderLaporan();
}

function setPeriodeLaporan(periode) {
  currentPeriode = periode;
  ['hari', 'minggu', 'bulan', 'semua'].forEach(p => {
    const btn = document.getElementById(`btn-period-${p}`);
    if (btn) {
      if (p === periode) {
        btn.style.background = 'linear-gradient(135deg, var(--red), var(--orange))';
        btn.style.color = 'white';
        btn.style.borderColor = 'transparent';
      } else {
        btn.style.background = 'white';
        btn.style.color = 'var(--dark)';
        btn.style.borderColor = 'var(--border)';
      }
    }
  });
  renderLaporan();
}

function filterTransaksiByPeriode(transaksiList) {
  if (currentPeriode === 'semua') {
    return transaksiList; // Return semua tanpa filter
  }
  
  const wibNow = getWIBDate();
  wibNow.setHours(0, 0, 0, 0); // Reset ke awal hari
  const today = getWIBDateString(); // Format YYYY-MM-DD
  
  return transaksiList.filter(t => {
    const tDate = parseWIBDate(t.tanggal); // Parse dengan timezone WIB
    tDate.setHours(0, 0, 0, 0);
    
    if (currentPeriode === 'hari') {
      return t.tanggal === today;
    } else if (currentPeriode === 'minggu') {
      // 7 hari terakhir termasuk hari ini
      const weekAgo = new Date(wibNow);
      weekAgo.setDate(weekAgo.getDate() - 6);
      return tDate >= weekAgo && tDate <= wibNow;
    } else {
      // Bulan ini = dari tanggal 1 bulan ini sampai hari ini
      const startOfMonth = new Date(wibNow.getFullYear(), wibNow.getMonth(), 1);
      return tDate >= startOfMonth && tDate <= wibNow;
    }
  });
}

function renderLaporan() {
  const allTransaksi = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  const filtered = filterTransaksiByPeriode(allTransaksi);

  // Summary - hitung transaksi = jumlah trxId unik (bukan jumlah rows)
  const totalProfit = filtered.reduce((s, t) => s + (t.profit||0), 0);
  const totalRevenue = filtered.reduce((s, t) => s + ((t.hargaJual||0)*(t.qty||0)), 0);
  const totalItem   = filtered.reduce((s, t) => s + (t.qty||0), 0);
  // Hitung transaksi unik per trxId
  const uniqTrx = new Set(filtered.map(t => t.trxId ? String(t.trxId) : String(t.id)));
  const totalTransaksi = uniqTrx.size;

  document.getElementById('lap-profit').textContent = formatRp(totalProfit);
  document.getElementById('lap-transaksi').textContent = totalTransaksi;
  document.getElementById('lap-item').textContent = totalItem + ' pcs';

  // Breakdown per menu
  renderBreakdownMenu(filtered);

  // Chart
  renderChart(filtered);

  // Tabel
  renderTabelTransaksi(filtered);
}

function renderBreakdownMenu(transaksiList) {
  const container = document.getElementById('breakdown-menu');
  
  if (transaksiList.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px;">Belum ada transaksi</p>';
    return;
  }

  // Group by menu
  const byMenu = {};
  transaksiList.forEach(t => {
    if (!byMenu[t.menu]) {
      byMenu[t.menu] = { qty: 0, profit: 0, transaksi: 0 };
    }
    byMenu[t.menu].qty += t.qty;
    byMenu[t.menu].profit += t.profit;
    byMenu[t.menu].transaksi += 1;
  });

  // Sort by profit descending
  const menuList = Object.keys(byMenu).map(menu => ({
    menu: menu,
    ...byMenu[menu]
  })).sort((a, b) => b.profit - a.profit);

  const totalProfit = menuList.reduce((s, m) => s + m.profit, 0);

  let html = `<table class="breakdown-table">
    <thead>
      <tr>
        <th>Menu</th>
        <th class="text-right">Qty Terjual</th>
        <th class="text-right">Transaksi</th>
        <th class="text-right">Total Profit</th>
        <th class="text-right">% Kontribusi</th>
        <th class="text-right">Avg/Item</th>
      </tr>
    </thead>
    <tbody>`;

  menuList.forEach((item, idx) => {
    const avgProfit = item.profit / item.qty;
    const percentage = totalProfit > 0 ? (item.profit / totalProfit * 100) : 0;
    const isTop = idx < 3; // Top 3 menu
    
    const bgColor = isTop ? '#FFF8E6' : '';
    const badge = isTop ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][idx] : '';
    
    html += `<tr style="background:${bgColor};">
      <td>
        ${badge ? `<span style="font-size:16px;margin-right:6px;">${badge}</span>` : ''}
        <strong style="color:${isTop ? 'var(--orange)' : 'inherit'};">${item.menu}</strong>
      </td>
      <td class="text-right">${item.qty} pcs</td>
      <td class="text-right">${item.transaksi}x</td>
      <td class="text-right" style="font-weight:800;color:var(--green);">${formatRp(item.profit)}</td>
      <td class="text-right">
        <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
          <div style="background:#E8F5E9;height:20px;width:${Math.min(percentage, 100)}%;min-width:2px;border-radius:4px;"></div>
          <span style="font-weight:700;font-size:11px;color:var(--green);">${percentage.toFixed(1)}%</span>
        </div>
      </td>
      <td class="text-right">${formatRp(avgProfit)}</td>
    </tr>`;
  });

  // Total row
  const totalQty = menuList.reduce((s, m) => s + m.qty, 0);
  const totalTransaksi = menuList.reduce((s, m) => s + m.transaksi, 0);

  html += `<tr class="total-row">
    <td><strong>Total</strong></td>
    <td class="text-right"><strong>${totalQty} pcs</strong></td>
    <td class="text-right"><strong>${totalTransaksi}x</strong></td>
    <td class="text-right"><strong>${formatRp(totalProfit)}</strong></td>
    <td class="text-right"><strong>100%</strong></td>
    <td class="text-right">-</td>
  </tr>`;

  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderChart(transaksiList) {
  const ctx = document.getElementById('chart-profit');
  if (!ctx) return;

  if (transaksiList.length === 0) {
    if (chartProfit) chartProfit.destroy();
    ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
    return;
  }

  // Group by date
  const byDate = {};
  transaksiList.forEach(t => {
    if (!byDate[t.tanggal]) byDate[t.tanggal] = 0;
    byDate[t.tanggal] += t.profit;
  });

  // Sort tanggal ascending (dari lama ke baru)
  const dates = Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b));
  const profits = dates.map(d => byDate[d]);

  // Format label tanggal
  const labels = dates.map(d => {
    const date = new Date(d + 'T00:00:00');
    return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
  });

  if (chartProfit) chartProfit.destroy();

  chartProfit = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Profit (Rp)',
        data: profits,
        borderColor: '#E03027',
        backgroundColor: 'rgba(224, 48, 39, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.3,
        pointBackgroundColor: '#E03027',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => 'Profit: Rp ' + ctx.parsed.y.toLocaleString('id-ID')
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => 'Rp ' + val.toLocaleString('id-ID')
          }
        }
      }
    }
  });
}

function renderTabelTransaksi(transaksiList) {
  const container = document.getElementById('tabel-transaksi');
  if (transaksiList.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px;">Belum ada transaksi</p>';
    return;
  }

  // Group flat records by trxId â†’ tampilkan per transaksi kasir
  // Record tanpa trxId (input manual) = masing-masing 1 transaksi sendiri
  const trxMap = {}; // trxId/id â†’ { tanggal, items[], totalProfit, id_for_delete }
  transaksiList.forEach(r => {
    const key = r.trxId ? String(r.trxId) : String(r.id);
    if (!trxMap[key]) {
      trxMap[key] = {
        tanggal: r.tanggal,
        kasir: r.kasir || '-',
        items: [],
        totalProfit: 0,
        totalHarga: 0,
        deleteIds: [],   // semua id yang ikut dalam transaksi ini
        trxId: key
      };
    }
    trxMap[key].items.push(r);
    trxMap[key].totalProfit += r.profit || 0;
    trxMap[key].totalHarga  += (r.hargaJual || 0) * (r.qty || 0);
    trxMap[key].deleteIds.push(r.id);
  });

  // Sort terbaru dulu
  const grouped = Object.values(trxMap).sort((a, b) =>
    new Date(b.tanggal) - new Date(a.tanggal) || Number(b.trxId) - Number(a.trxId)
  );

  let html = `<table class="breakdown-table">
    <thead>
      <tr>
        <th style="width:90px">Tanggal</th>
        <th>Item</th>
        <th class="text-right" style="width:60px">Qty</th>
        <th class="text-right" style="width:90px">Total</th>
        <th class="text-right" style="width:90px">Profit</th>
        <th style="width:40px"></th>
      </tr>
    </thead>
    <tbody>`;

  grouped.forEach((trx, gi) => {
    const displayDate = parseWIBDate(trx.tanggal).toLocaleDateString('id-ID', { timeZone: 'Asia/Jakarta' });
    const deleteIdsJson = JSON.stringify(trx.deleteIds);
    const rowBg = gi % 2 === 0 ? '' : 'background:#FFFAF5;';

    if (trx.items.length === 1) {
      // Single item: tampilkan 1 baris biasa
      const r = trx.items[0];
      html += `<tr style="${rowBg}">
        <td style="font-size:12px;">${displayDate}</td>
        <td>${r.menu}<br><small style="color:var(--muted);font-size:10px;">${r.kasir || ''}</small></td>
        <td class="text-right">${r.qty} pcs</td>
        <td class="text-right" style="font-weight:700;">${formatRp((r.hargaJual||0)*(r.qty||0))}</td>
        <td class="text-right" style="font-weight:800;color:var(--green);">${formatRp(r.profit)}</td>
        <td><button class="btn-hapus-transaksi" data-ids='${deleteIdsJson}' title="Klik 2x hapus" style="background:var(--red);color:white;border:none;border-radius:6px;font-size:11px;padding:4px 8px;cursor:pointer;font-weight:700;">ğŸ—‘ï¸</button></td>
      </tr>`;
    } else {
      // Multi item: baris header transaksi + detail items
      const itemNames = trx.items.map(r => `${r.qty}x ${r.menu}`).join(', ');
      const totalQty  = trx.items.reduce((s, r) => s + (r.qty||0), 0);
      html += `<tr style="${rowBg}">
        <td style="font-size:12px;" rowspan="${trx.items.length + 1}">${displayDate}<br><small style="color:var(--muted);font-size:10px;">${trx.kasir || ''}</small></td>
        <td colspan="2" style="font-size:11px;color:var(--muted);font-weight:700;padding-bottom:4px;">ğŸ§¾ ${trx.items.length} item Â· ${totalQty} pcs</td>
        <td class="text-right" style="font-weight:800;">${formatRp(trx.totalHarga)}</td>
        <td class="text-right" style="font-weight:900;color:var(--green);">${formatRp(trx.totalProfit)}</td>
        <td><button class="btn-hapus-transaksi" data-ids='${deleteIdsJson}' title="Klik 2x hapus semua" style="background:var(--red);color:white;border:none;border-radius:6px;font-size:11px;padding:4px 8px;cursor:pointer;font-weight:700;">ğŸ—‘ï¸</button></td>
      </tr>`;
      trx.items.forEach(r => {
        html += `<tr style="${rowBg}border-top:none;">
          <td style="padding-left:16px;font-size:12px;color:var(--dark);">â†³ ${r.menu}</td>
          <td class="text-right" style="font-size:12px;">${r.qty} pcs</td>
          <td class="text-right" style="font-size:12px;">${formatRp((r.hargaJual||0)*(r.qty||0))}</td>
          <td class="text-right" style="font-size:12px;color:var(--green);">${formatRp(r.profit)}</td>
          <td></td>
        </tr>`;
      });
    }
  });

  html += '</tbody></table>';
  container.innerHTML = html;

  // Attach event listeners - double tap to delete
  container.querySelectorAll('.btn-hapus-transaksi').forEach(btn => {
    let clickCount = 0;
    let clickTimer = null;
    
    btn.addEventListener('click', function() {
      // Support both data-ids (array) and data-id (single)
      let idsToDelete = [];
      try {
        const idsAttr = this.getAttribute('data-ids');
        if (idsAttr) idsToDelete = JSON.parse(idsAttr);
        else {
          const singleId = parseInt(this.getAttribute('data-id'));
          if (!isNaN(singleId)) idsToDelete = [singleId];
        }
      } catch(e) {}
      
      clickCount++;
      
      if (clickCount === 1) {
        this.style.background = '#F39C12';
        this.textContent = 'âš ï¸ Klik lagi';
        clickTimer = setTimeout(() => {
          clickCount = 0;
          this.style.background = 'var(--red)';
          this.textContent = 'ğŸ—‘ï¸';
        }, 2000);
        
      } else if (clickCount === 2) {
        clearTimeout(clickTimer);
        clickCount = 0;
        
        let list = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
        const before = list.length;
        
        list = list.filter(t => !idsToDelete.includes(t.id));
        const after = list.length;
        
        if (before === after) {
          console.error('Transaksi tidak ditemukan, ID:', id);
          showToast('âŒ Transaksi tidak ditemukan');
          return;
        }
        
        localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(list));
        console.log(`Transaksi ID ${id} dihapus. Sisa: ${after} transaksi`);
        
        renderLaporan();
        showToast('ğŸ—‘ï¸ Transaksi dihapus');
      }
    });
  });
}

// =====================
// EXPORT LAPORAN PDF
// =====================

function syncTransaksiKeSheets() {
  const url = getSheetsUrl();
  if (!url) {
    showToast('âš ï¸ Setup Google Sheets dulu di Ringkasan Menu -> Setup Cloud');
    bukaSyncConfig();
    return;
  }

  // Kumpulkan semua transaksi POS dari localStorage (format V2 multi-item)
  const allKeys = Object.keys(localStorage).filter(k => k.startsWith('kedaiHeula_pos_'));
  let allTransaksi = [];
  allKeys.forEach(k => {
    try {
      const data = JSON.parse(localStorage.getItem(k) || '[]');
      allTransaksi = allTransaksi.concat(data);
    } catch(e) {}
  });

  if (allTransaksi.length === 0) {
    showToast('âš ï¸ Tidak ada transaksi POS untuk di-backup');
    return;
  }

  showKonfirmasi({
    icon: 'â˜ï¸',
    title: 'Backup Transaksi POS?',
    message: `${allTransaksi.length} transaksi akan di-backup ke Google Sheets.`,
    labelOk: 'Ya, Backup',
    onOk: () => {
      showToast('â˜ï¸ Menyimpan transaksi...');
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(authPostBody({ action: 'backup_transaksi_v2', data: allTransaksi })),
        redirect: 'follow'
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === 'ok') {
          const now = getWIBDateTimeString();
          localStorage.setItem('kedaiHeula_lastSyncTransaksi', now);
          showToast(`âœ… ${result.count} transaksi baru berhasil disimpan ke Sheets!`);
        } else {
          throw new Error(result.message || 'Unknown error');
        }
      })
      .catch(e => {
        showToast('âŒ Gagal backup transaksi: ' + e.message);
        console.error(e);
      });
    }
  });
}

async function restoreTransaksiFromSheets() {
  const url = getSheetsUrl();
  if (!url) {
    showToast('âš ï¸ Setup Google Sheets dulu');
    bukaSyncConfig();
    return;
  }

  const lokal = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  const lokalCount = lokal.length;
  
  const pesanConfirm = lokalCount > 0
    ? `Data lokal: ${lokalCount} transaksi. Data cloud akan digabung (tidak menghapus data lokal).`
    : 'Data lokal kosong. Data akan diisi dari cloud.';

  showKonfirmasi({
    icon: 'â˜ï¸',
    title: 'Restore Transaksi?',
    message: pesanConfirm,
    labelOk: 'Ya, Restore',
    onOk: async () => {

  showToast('â³ Memuat transaksi dari cloud...');

  try {
    const fetchUrl = url.includes('?') ? url + '&action=restore_transaksi' : url + '?action=restore_transaksi';
    const res = await fetch(fetchUrl, { 
      method: 'GET',
      redirect: 'follow'
    });
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const result = await res.json();
    
    if (result.status === 'ok' && Array.isArray(result.data)) {
      const cloud = result.data;
      
      if (cloud.length === 0) {
        showToast('âš ï¸ Tidak ada transaksi di Google Sheets. Backup dulu sebelum restore.');
        return;
      }
      
      // Merge: gabungkan data cloud dengan lokal, hindari duplikat berdasarkan id
      const merged = [...lokal];
      let added = 0;
      
      cloud.forEach(item => {
        const exists = merged.some(t => t.id === item.id);
        if (!exists) {
          merged.push(item);
          added++;
        }
      });
      
      localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(merged));
      
      showToast(`âœ… Restore berhasil! ${cloud.length} transaksi dari cloud, ${added} transaksi baru ditambahkan. Total: ${merged.length} transaksi.`);
      
      // Re-render laporan
      renderLaporan();
    } else {
      throw new Error(result.message || 'Data tidak valid dari server');
    }
  } catch (e) {
    showToast('âŒ Gagal restore: ' + e.message);
    console.error('Restore error:', e);
  }

  } // end onOk
  }); // end showKonfirmasi
}

// Sync promo ke Google Sheets
function syncPromosToCloud() {
  const url = getSheetsUrl();
  if (!url) return; // silent fail jika belum setup

  const promos = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');
  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(authPostBody({ action: 'syncPromos', data: promos })),
    redirect: 'follow'
  }).catch(err => console.warn('Sync promo error:', err));
}

// Restore promo dari Google Sheets
async function restorePromosFromCloud() {
  const url = getSheetsUrl();
  if (!url) {
    showToast('âš ï¸ Setup Google Sheets dulu');
    bukaSyncConfig();
    return;
  }

  const lokal = JSON.parse(localStorage.getItem('kedaiHeula_promos') || '[]');

  showKonfirmasi({
    icon: 'ğŸ·ï¸',
    title: 'Restore Promo dari Cloud?',
    message: lokal.length > 0
      ? `Ada ${lokal.length} promo lokal. Data cloud akan digabung.`
      : 'Data promo akan diisi dari cloud.',
    labelOk: 'Ya, Restore',
    onOk: async () => {
      showToast('â³ Memuat promo dari cloud...');
      try {
        const fetchUrl = url.includes('?') ? url + '&action=restore_promos' : url + '?action=restore_promos';
        const res = await fetch(fetchUrl, { method: 'GET', redirect: 'follow' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const result = await res.json();
        if (result.status === 'ok' && Array.isArray(result.data)) {
          const merged = [...lokal];
          let added = 0;
          result.data.forEach(p => {
            if (!merged.some(m => m.id == p.id)) { merged.push(p); added++; }
          });
          localStorage.setItem('kedaiHeula_promos', JSON.stringify(merged));
          renderPromoList();
          refreshPromoDropdown();
          showToast(`âœ… ${added} promo baru ditambahkan dari cloud!`);
        } else {
          throw new Error(result.message || 'Data tidak valid');
        }
      } catch(e) {
        showToast('âŒ Gagal restore promo: ' + e.message);
      }
    }
  });
}

function exportLaporanPDF() {
  try {
    const allTransaksi = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
    const filtered = filterTransaksiByPeriode(allTransaksi);
    
    if (filtered.length === 0) {
      showToast('âš ï¸ Tidak ada transaksi untuk di-export');
      return;
    }

  // Summary data
  const totalProfit = filtered.reduce((s, t) => s + t.profit, 0);
  const totalTransaksi = filtered.length;
  const totalItem = filtered.reduce((s, t) => s + t.qty, 0);

  // Breakdown per menu
  const byMenu = {};
  filtered.forEach(t => {
    if (!byMenu[t.menu]) {
      byMenu[t.menu] = { qty: 0, profit: 0, transaksi: 0 };
    }
    byMenu[t.menu].qty += t.qty;
    byMenu[t.menu].profit += t.profit;
    byMenu[t.menu].transaksi += 1;
  });

  const menuList = Object.keys(byMenu).map(menu => ({
    menu: menu,
    ...byMenu[menu]
  })).sort((a, b) => b.profit - a.profit);

  // Periode label
  const periodeLabel = {
    'hari': 'Hari Ini',
    'minggu': '7 Hari Terakhir',
    'bulan': 'Bulan Ini',
    'semua': 'Semua Periode'
  }[currentPeriode] || 'Periode Terpilih';

  const tanggalCetak = getWIBDateTimeString();

  // Build breakdown table
  let breakdownRows = '';
  menuList.forEach((item, idx) => {
    const avgProfit = item.profit / item.qty;
    const percentage = totalProfit > 0 ? (item.profit / totalProfit * 100) : 0;
    const isTop = idx < 3;
    const badge = isTop ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][idx] : '';
    
    breakdownRows += `
      <tr style="background:${isTop ? '#FFF8E6' : 'white'};">
        <td>${badge} <strong>${item.menu}</strong></td>
        <td class="pr-num">${item.qty} pcs</td>
        <td class="pr-num">${item.transaksi}x</td>
        <td class="pr-num"><strong>${formatRp(item.profit)}</strong></td>
        <td class="pr-num">${percentage.toFixed(1)}%</td>
        <td class="pr-num">${formatRp(avgProfit)}</td>
      </tr>`;
  });

  // Build transaksi table
  let transaksiRows = '';
  filtered.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).forEach(t => {
    const displayDate = parseWIBDate(t.tanggal).toLocaleDateString('id-ID', { timeZone: 'Asia/Jakarta' });
    transaksiRows += `
      <tr>
        <td>${displayDate}</td>
        <td>${t.menu}</td>
        <td class="pr-num">${t.qty} pcs</td>
        <td class="pr-num">${formatRp(t.hpp)}</td>
        <td class="pr-num">${formatRp(t.hargaJual)}</td>
        <td class="pr-num"><strong>${formatRp(t.profit)}</strong></td>
      </tr>`;
  });

  const printContent = `
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: Arial, sans-serif; color: #1A1A1A; font-size: 12px; }

      .doc-header { display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 3px solid #E03027; margin-bottom: 16px; }
      .brand { font-size: 18px; font-weight: 900; color: #E03027; }
      .brand-sub { font-size: 9px; color: #888; font-weight: 700; text-transform: uppercase; margin-top: 2px; }
      .doc-meta { text-align: right; }
      .doc-meta .meta-title { font-size: 14px; font-weight: 900; }
      .doc-meta .meta-sub { font-size: 9px; color: #888; margin-top: 2px; }

      .summary-bar { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 16px; }
      .sum-box { background: #FFF8F0; border: 2px solid #F0E0CC; border-radius: 8px; padding: 10px; text-align: center; }
      .sum-label { font-size: 8px; font-weight: 700; color: #888; text-transform: uppercase; display: block; }
      .sum-value { font-size: 14px; font-weight: 900; color: #E03027; display: block; margin-top: 3px; }

      h3 { font-size: 12px; font-weight: 900; color: #E03027; margin: 14px 0 6px; padding-bottom: 4px; border-bottom: 2px solid #F0E0CC; }
      h3:first-of-type { margin-top: 0; }
      
      table { width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 10px; }
      thead tr { background: #F47C20 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      thead th { padding: 6px 8px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
      tbody tr:nth-child(even) { background: #FFF8F0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      tbody td { padding: 6px 8px; border-bottom: 1px solid #F0E0CC; }
      .pr-num { text-align: right; }
      .total-row td { background: #FFF3E0 !important; font-weight: 700; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

      .doc-footer { margin-top: 16px; padding-top: 8px; border-top: 2px solid #F0E0CC; display: flex; justify-content: space-between; font-size: 9px; color: #aaa; }
    <\/style>

    <div class="doc-header">
      <div>
        <div class="brand">ğŸ± Kedai Heula</div>
        <div class="brand-sub">Laporan Penjualan</div>
      </div>
      <div class="doc-meta">
        <div class="meta-title">${periodeLabel}</div>
        <div class="meta-sub">${totalTransaksi} transaksi Â· ${totalItem} pcs terjual</div>
      </div>
    </div>

    <div class="summary-bar">
      <div class="sum-box">
        <span class="sum-label">ğŸ’° Total Profit</span>
        <span class="sum-value">${formatRp(totalProfit)}</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">ğŸ“¦ Total Transaksi</span>
        <span class="sum-value">${totalTransaksi}</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">ğŸ± Item Terjual</span>
        <span class="sum-value">${totalItem} pcs</span>
      </div>
    </div>

    <h3>ğŸ“Š Breakdown per Menu</h3>
    <table>
      <thead>
        <tr>
          <th>Menu</th>
          <th class="pr-num">Qty</th>
          <th class="pr-num">Transaksi</th>
          <th class="pr-num">Total Profit</th>
          <th class="pr-num">% Kontribusi</th>
          <th class="pr-num">Avg/Item</th>
        </tr>
      </thead>
      <tbody>
        ${breakdownRows}
        <tr class="total-row">
          <td><strong>Total</strong></td>
          <td class="pr-num"><strong>${totalItem} pcs</strong></td>
          <td class="pr-num"><strong>${totalTransaksi}x</strong></td>
          <td class="pr-num"><strong>${formatRp(totalProfit)}</strong></td>
          <td class="pr-num"><strong>100%</strong></td>
          <td class="pr-num">-</td>
        </tr>
      </tbody>
    </table>

    <h3>ğŸ“‹ Riwayat Transaksi</h3>
    <table>
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Menu</th>
          <th class="pr-num">Qty</th>
          <th class="pr-num">HPP</th>
          <th class="pr-num">Harga Jual</th>
          <th class="pr-num">Profit</th>
        </tr>
      </thead>
      <tbody>
        ${transaksiRows}
      </tbody>
    </table>

    <div class="doc-footer">
      <span>Kedai Heula - Laporan Penjualan</span>
      <span>Dicetak: ${tanggalCetak}</span>
    </div>
  `;

  const printArea = document.getElementById('print-area');
  if (!printArea) {
    showToast('âŒ Error: print-area tidak ditemukan');
    console.error('print-area element tidak ada');
    return;
  }
  
  printArea.innerHTML = printContent;
  
  const isTelegram = /telegram/i.test(navigator.userAgent.toLowerCase());
  const isMobile = isMobileOrTelegram();
  
  if (isMobile && isTelegram) {
    showToast('â„¹ï¸ Export PDF: Gunakan Telegram Desktop atau screenshot halaman ini');
  } else {
    window.print();
  }
  
  } catch (error) {
    console.error('Error di exportLaporanPDF:', error);
    showToast('âŒ Error: ' + error.message);
  }
}

// Init: sudah digabung di window.onload di atas


</script>
</div><!-- end app-wrapper -->
</body>
</html>
